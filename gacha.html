<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è¬çˆ¾å¤ï½œæ‰­è›‹ç³»çµ±2.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- é¸æ± å€«æ³¢å¤–æ› CSS -->
  <link rel="stylesheet" href="https://shierusha.github.io/library/assets/css/pool-carousel.css"/>

  <style>
/* ==============================
   å…¨åŸŸèƒŒæ™¯ / å­—é«”
============================== */
body {
  background: url('https://shierusha.github.io/create-student/imgs/citybg.png') center center no-repeat;
  background-size: cover;
  min-height: 100vh;
  font-family: 'Noto Sans TC', sans-serif;
  overflow: hidden;
}
body.dark-bg::before {
  content: "";
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.3);
  z-index: 0; pointer-events: none;
}

/* ==============================
   16:9 å®¹å™¨
============================== */
.container-16-9 {
  position: relative;
  max-width: 90%;
  max-height: 80vh;
  aspect-ratio: 16/9;
  overflow: hidden;
  border-radius: 16px;
  box-shadow: 0 0 24px #0004;
  margin: 3vh auto;
}
.bg_img {
  position: absolute; inset: 0;
  width: 100%; height: 100%;
  object-fit: cover;
  z-index: 1;
}

/* ==============================
   Modalï¼ˆæ—‹è½‰ / èƒŒåŒ…ï¼‰
============================== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  z-index: 2000;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: modal-fadein-bg 0.25s;
}
@keyframes modal-fadein-bg {
  from { background: rgba(0,0,0,0); }
  to   { background: rgba(0,0,0,0.45); }
}
.modal-content {
  background: rgb(13 27 77 / 82%);
  border-radius: 18px;
  border: 2px solid #1eb5e5;
  box-shadow: 0 0 16px 2px #62f1fe88, 0 8px 32px #1eb5e5aa;
  width: 500px; max-width: 93vw;
  height: 340px; max-height: 80vh;
  display: flex; flex-direction: column;
  overflow: hidden;
  animation: modal-pop 0.32s cubic-bezier(.42,1.4,.51,1.01);
}
@keyframes modal-pop {
  from { opacity: 0; transform: scale(0.92); }
  to   { opacity: 1; transform: scale(1); }
}
.modal-header {
  background: none;
  padding: 15px 20px 0px 24px;
  color: #fff; font-size: 1.5em; font-weight: bold;
  letter-spacing: 1px; text-shadow: 0 1px 4px #000a;
}
.modal-header::after {
  content: ""; display: block; height: 5px; width: 70%;
  margin:.5rem 0 0; border-radius: 2px;
  background: linear-gradient(to right,#53e2ff99 65%,#53e2ff00 100%);
  pointer-events: none;
}
.modal-body {
  color:#fff; padding: 12px 24px 24px 24px;
  font-size: 1.2em; line-height:1.5; text-shadow:0 1px 4px #0008;
  overflow-y:auto; max-height:240px; white-space: pre-line;
  scrollbar-width:none;
}
.modal-body::-webkit-scrollbar { display:none; }

/* ==============================
   æŠ½å¡æŒ‰éˆ•
============================== */
.gacha-buttons {
  position: absolute;
  bottom: 15%;
  left: 50%; transform: translateX(-50%);
  display: flex; gap: 10%;
  width: 60%; height: 11%;
  z-index: 10;
  transition: bottom 0.4s ease;
}
.gacha-btn.inactive { border: none; box-shadow: none; }
.gacha-btn {
  flex: 1; height: 100%;
  border-radius: 12px;
  background: rgb(13 27 77 / 82%);
  border: 2px solid #1eb5e5; color: #fff; font-weight: bold;
  cursor: pointer; transition: all 0.25s;
  box-shadow: 0 0 12px #53e2ff88, 0 0 24px #1eb5e577 inset;
}
.gacha-btn:hover {
  background: #1eb5e5cc;
  box-shadow: 0 0 18px #53e2ffdd, 0 0 36px #1eb5e5aa inset;
}

/* ==============================
   æŠ½å¡çµæœå®¹å™¨
============================== */
.gacha-results {
  position: absolute;
  top: 5%; left: 50%; transform: translateX(-50%);
  display: flex; flex-direction: column;
  width: 80%; height: 66%;
  z-index: 9;
}
.gacha-row {
  display: flex; justify-content: space-between;
  width: 100%; gap: 12px;
  margin-top: 4%;
}
.gacha-orb {
  position: relative; flex: 1;
  aspect-ratio: 1/1; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  overflow: hidden; cursor: pointer; user-select: none;
  transition: all 0.3s ease;
}
.orb-inner {
  width: 90%; height: 35%;
  display: flex; align-items: center; justify-content: center;
  text-align: center; line-height: 1.2; font-weight: bold;
}
.orb-normal  { background: #fff;    border: 3px solid #ccc; }
.orb-hidden  { background: #c0c0c0; border: 3px solid #aaa; }
.orb-limited { background: gold;    border: 3px solid orange; }
.gacha-orb.revealed { background: transparent; }
.orb-normal.revealed  { border: 3px solid #fff;    color: #fff; }
.orb-hidden.revealed  { border: 3px solid #c0c0c0; color: #c0c0c0; }
.orb-limited.revealed { border: 3px solid gold;    color: #ffd700; }

.gacha-results.single { display: flex; align-items: center; justify-content: center; }
.gacha-orb.big { aspect-ratio: 1/1; max-width: 25%; }

/* ==============================
   HUDï¼ˆå³ä¸‹è§’ï¼‰
============================== */
.gacha-hud {
  position: absolute;
  bottom: 6%;
  right: 4%;
  display: flex;
  align-items: center;
  gap: 1rem;
  z-index: 30;
  color: #fff;
  text-shadow: 0 1px 4px #000a;
  height: 10%;
}
.counter-box {
  height: 100%;
  display: flex; align-items: center;
  font-weight: bold; padding: 0 6px;
  border-radius: 4px;
  background: rgba(255,255,255,0.01);
}
.gacha-counter {
  position: absolute;
  bottom: 5%; right: 17%;
  gap: 1rem; z-index: 30;
  color: #fff; text-shadow: 0 1px 4px #000a;
  height: 10%;
}
.gacha-results { z-index: 10; }

/* èƒŒåŒ…æŒ‰éˆ• */
.gacha-backpack {
  height: 100%; aspect-ratio: 2/1;
  border: 2px solid #1eb5e5; border-radius: 8px;
  background: rgb(13 27 77 / 82%); color: #fff;
  cursor: pointer; transition: all 0.25s;
  box-shadow: 0 0 8px #53e2ff88, 0 0 16px #1eb5e577 inset;
  display: flex; align-items: center; justify-content: center;
}
.backpack-box { height: 100%; display: flex; align-items: center; justify-content: center; }
.backpack-section { margin: 0.5rem 0; }
.backpack-section h3 { color: #53e2ff; margin-bottom: 0.3rem; }
.backpack-items { color: #fff; }
.backpack-items span { color: #ffe082; font-weight: bold; }

/* ==============================
   Loader
============================== */
.gacha-loader{ position:absolute; left:10%; right:10%; top: 45%; height: 15%; z-index:60; display:none; }
.gacha-loader.show{ display:block; }
.gacha-loader .loader-box{ position:relative; height:100%; display:flex; flex-direction:column; gap:8px; justify-content:center; }
.loader-bar{ position:relative; height:42%; background:#263257; border-radius:999px; overflow:hidden; box-shadow: inset 0 0 10px #000a; }
.loader-fill{ position:absolute; left:0; top:0; height:100%; width:0%; background: linear-gradient(90deg,#2de0ff88,#6dffae88); box-shadow: 0 0 18px #53e2ff99 inset; transition: width .26s cubic-bezier(.22,.61,.36,1); }
.loader-cat{ position:absolute; top:-15%; left:0; transform: translate(-50%,-90%); height: 100%; aspect-ratio: 1/1; filter: drop-shadow(0 3px 8px #000c); transition: left .26s cubic-bezier(.22,.61,.36,1); pointer-events:none; }
.loader-text{ text-align:center; color:#e9efff; font-weight:900; text-shadow:0 2px 6px #000c; height: 100%; display:flex; align-items:center; justify-content:center; }

/* è‡ªå‹•å­—ç´š */
.auto-resize {}

/* ==============================
   æ¸¸æ¨™èˆ‡ç®­é ­å±¤ç´š
============================== */
.gacha-btn:disabled { cursor: pointer; } /* ä¸é¡¯ç¤ºç¦æ­¢ç¬¦è™Ÿ */
.back { z-index: 60; cursor: pointer; }  /* ç¢ºä¿å¯é»åˆ° */

/* ==============================
   Orb å…§åœ–è¦†è“‹åå­—ï¼ˆä¿®æ­£ç‰ˆï¼šåœ–å…ˆè—ï¼Œç¿»ç‰Œæ‰é¡¯ç¤ºï¼›åœ–å£“åœ¨åå­—ä¸Šï¼‰
============================== */
.gacha-orb .orb-inner{
  position: relative;
  display: block;
  width: 90%;
  height: 90%;
  margin: auto;
}
.gacha-orb.big .orb-inner{
  width: 95%;
  height: 95%;
}

/* åœ–ç‰‡é å…ˆæ”¾é€²çƒè£¡ï¼Œä½†å…ˆéš±å½¢ï¼›ç¿»ç‰Œå¾Œå†é¡¯ç¤º */
.gacha-orb .orb-inner .orb-icon {
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%); /* âœ… å¹¾ä½•ç½®ä¸­ */
  max-width: 100%;
  max-height: 100%;
  width: auto;                     /* ä¿æŒæ¯”ä¾‹ï¼Œä¸ç¡¬æ’æ»¿ */
  height: auto;
  object-fit: contain;
  z-index: 0;                      /* åœ–å£“åœ¨åå­—ä¸Š */
  pointer-events: none;
  filter: drop-shadow(0 2px 6px rgba(0, 0, 0, .35));
  opacity: 0;                      /* å…ˆè—ï¼Œç¿»ç‰Œå†é¡¯ç¤º */
  transition: opacity .2s ease;    /* â† åˆ¥æ–·è¡Œ */
}

.gacha-orb.revealed .orb-inner .orb-icon{
  opacity: 1;               /* â˜… ç¿»ç‰Œå¾Œç«‹åˆ»é¡¯ç¤ºï¼ˆåœ–å·²é è¼‰ï¼‰ */
}

/* åå­—å›ºå®šåœ¨åº•éƒ¨ï¼Œé è¨­ä¹Ÿéš±å½¢ï¼Œç¿»ç‰Œå¾Œä¸€èµ·å‡ºç¾ */
.gacha-orb .orb-inner .orb-name{
  position: absolute;
  left: 50%;
  bottom: 0%;
  transform: translateX(-50%);
  width: 70%;
  height: 20%;
  text-align: center;
  line-height: 1.1;
  font-weight: 900;
  white-space: normal;
  word-break: keep-all;
  z-index: 1;               /* åœ¨åœ–ç‰‡ä¸‹æ–¹ */
  font-size: .36em;
  opacity: 0;               /* â˜… å…ˆè— */
  transition: opacity .2s ease;
}
.gacha-orb.revealed .orb-inner .orb-name{
  opacity: 1;               /* â˜… ç¿»ç‰Œå¾Œæ‰é¡¯ç¤ºæ–‡å­— */
}

/* ä¸åŒç¨€æœ‰åº¦çš„åå­—é¡è‰²ï¼ˆè¢«åœ–ç‰‡é®ä½ä¹Ÿä½œç‚ºå‚™æ´ï¼‰ */
.orb-normal.revealed  .orb-name { color:#ffffff; text-shadow:0 2px 6px #000c, 0 0 3px #000; }
.orb-hidden.revealed  .orb-name { color:#e0e0e0; text-shadow:0 2px 6px #000c, 0 0 3px #000; }
.orb-limited.revealed .orb-name { color:#ffd54f; text-shadow:0 2px 6px #000c, 0 0 6px #000; }



/* ==============================
   ç‰¹æ®Šå‡ç´šå‹•ç•«é®ç½©ï¼ˆéŠ€â†’é‡‘â†’ç¿»ç‰Œï¼‰
============================== */
#special-mask{
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.65);
  display: none;
  z-index: 4000;
}
#special-cat{
  position: absolute;
  width: 7vw;          /* â˜… å¯å¾®èª¿ï¼šç‰¹æ•ˆè²“å°ºå¯¸ï¼ˆæ”¹ç™¾åˆ†æ¯”æˆ– pxï¼‰ */
  max-width: 120px;    /* â˜… å¯å¾®èª¿ï¼šæœ€å¤§å°ºå¯¸ä¸Šé™ */
  aspect-ratio: 1/1;
  transform: translate(-50%,-50%);
  filter: drop-shadow(0 6px 14px rgba(0,0,0,.6));
  transition: left .45s cubic-bezier(.22,.61,.36,1), top .45s cubic-bezier(.22,.61,.36,1); /* â˜… å¯å¾®èª¿ï¼šç§»å‹•é€Ÿåº¦/æ›²ç·š */
}
.special-bounce {
  animation: cat-bounce 250ms ease-out; /* æ™‚é–“è·Ÿä½  JS çš„ SPECIAL.hopDurMs å°é½Š */
}
/* â˜… ç¿»è½‰ï¼šå·¦å³ç¿»åœ–ï¼Œä¸å½±éŸ¿ translate å®šä½ */
#special-cat.flipX {
  transform: translate(-50%, -50%) scaleX(-1);
}
/* é€£çºŒå½ˆè·³ï¼ˆç§»å‹•ä¸­ç”¨ï¼‰ */
#special-cat.bounce-loop {
  /* å¯æ”¹é€Ÿåº¦ï¼šå°æ‡‰ JS æœƒè¨­ --bounceMs */
  animation: cat-bounce var(--bounceMs, 180ms) ease-in-out infinite;
}


/* â˜… å½ˆè·³ï¼šç”¨ margin-top å‹•ç•«ï¼Œé¿å…å’Œ transform/ç¿»è½‰è¡çª */
@keyframes cat-bounce {
  0%   { margin-top: 0; }
  50%  { margin-top: -14px; } /* â† é«˜åº¦å¯æ”¹ */
  100% { margin-top: 0; }
}

  </style>
</head>
<body class="dark-bg">
  <!-- 16:9 ä¸»è¦å®¹å™¨ -->
  <div class="container-16-9">
    <!-- å·¦ä¸Šï¼šè¿”å›ç®­é ­å°ˆç”¨æ¡†ï¼ˆæ»¿ç‰ˆé»ƒè‰²ç®­é ­ç”±å¤–æ›CSSç•«ï¼‰ -->
    <div class="back" id="btnBack" style="position:absolute; left:2%; width:7%; height:16%;"></div>

    <!-- æŠ½å¡çµæœå®¹å™¨ & é¸æ± è³‡è¨Š -->
    <div class="gacha-results" id="gacha-results">
      <div id="poolName" class="auto-resize" style="position:absolute; top:2%; left:4%; width:80%; height:17%; color:#FFF; display:flex; align-items:center;"></div>
      <div id="poolDesc" class="auto-resize" style="position:absolute; bottom:-2%; width:100%; height:13%; color:#FFF; display:flex; justify-content:center; align-items:center; text-align:center;"></div>
      <div id="poolLink" class="auto-resize" style="position:absolute; top:16%; right:8%; width:13%; height:11%; color:#FFF; display:flex; justify-content:center; align-items:center; text-align:center;">æŒæœ‰æ¦œ</div>
    </div>
    
    <!-- è½‰è›‹è®€æ¢ Loader -->
    <div id="gacha-loader" class="gacha-loader">
      <div class="loader-box">
        <img class="loader-cat" id="loader-cat" src="https://shierusha.github.io/library/img/cat.png" alt="cat">
        <div class="loader-bar"><div class="loader-fill" id="loader-fill"></div></div>
        <div class="loader-text auto-resize" id="loader-text">Roroçˆ†è‚ä¸­â€¦â€¦</div>
      </div>
    </div>

    <!-- æŠ½å¡æŒ‰éˆ• -->
    <div class="gacha-buttons">
      <button id="btn-single" class="gacha-btn auto-resize">å–®æŠ½</button>
      <button id="btn-ten" class="gacha-btn auto-resize">åé€£æŠ½</button>
    </div>

    <!-- HUD -->
    <div class="gacha-hud">
      <button id="btn-backpack" class="gacha-backpack">
        <div class="backpack-box auto-resize">èƒŒåŒ…</div>
      </button>
    </div>

    <!-- å‰©é¤˜æŠ½æ•¸ -->
    <div class="gacha-counter auto-resize">
      <div class="counter-box">å‰©é¤˜æŠ½æ•¸ï¼š<span id="draw-count">0</span></div>
    </div>

    <!-- èƒŒæ™¯åœ– -->
    <img class="bg_img" src="https://shierusha.github.io/school-battle/teachers/img/8.webp" alt="background">

    <!-- ç‰¹æ•ˆé®ç½©ï¼ˆéŠ€â†’é‡‘â†’ç¿»ç‰Œï¼‰ -->
    <div id="special-mask">
      <img id="special-cat" src="https://shierusha.github.io/library/img/cat2.png" alt="">
    </div>
  </div>

  <!-- æ—‹è½‰æç¤ºï¼ˆä¸å¯é—œé–‰ï¼‰ -->
  <div id="orientation-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <div class="modal-header">è«‹æ—‹è½‰è¢å¹•</div>
      <div class="modal-body">ç‚ºäº†æœ€ä½³é«”é©—ï¼Œè«‹å°‡è£ç½®è½‰æˆæ©«å‘æ¨¡å¼</div>
    </div>
  </div>

  <!-- èƒŒåŒ… Modalï¼ˆå¯é»èƒŒæ™¯é—œé–‰ï¼‰ -->
  <div id="info-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <div class="modal-header" id="info-modal-title">æ¨™é¡Œ</div>
      <div class="modal-body" id="info-modal-body"></div>
    </div>
  </div>

<script>
/* ==============================
   å°å·¥å…·
============================== */
const $  = (s, r=document) => r.querySelector(s);
const $$ = (s, r=document) => [...r.querySelectorAll(s)];
const sleep = (ms) => new Promise(res => setTimeout(res, ms));
const escapeHtml = s => (s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

/* ==============================
   DC Webhookï¼ˆéŠ€/é‡‘ï¼‰
   ç”¨ï¼šsendGachaWebhook(rarity, name, { mode: 'congrats'|'swap' })
============================== */
async function sendGachaWebhook(rarity, itemName, { mode = 'congrats' } = {}) {
  // ç™½çƒæ°¸é ä¸é€
  if (rarity !== 'limited' && rarity !== 'hidden') return;
  try {
    const threadId = (window.CURRENT_POOL && window.CURRENT_POOL.threadId) || null;
    if (!threadId) return;
    const url = `${B_URL}/functions/v1/gacha-notify`;
    const resp = await fetch(url, {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({
        rarity,
        playerName: PLAYER_NAME || 'ç©å®¶',
        itemName,
        threadId,
        mode // Edge ç«¯ç”¨ mode æ±ºå®šæ–‡æ¡ˆ
      })
    });
    if (!resp.ok) console.warn('[gacha-notify] status=', resp.status, await resp.text().catch(()=>'(no body)'));
  } catch (e) { console.warn('[gacha-notify] failed:', e); }
}

/* ==============================
   Supabase
============================== */
const B_URL  = 'https://ogzpfrkwnqqaitytncla.supabase.co';
const B_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9nenBmcmt3bnFxYWl0eXRuY2xhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxODQzNzEsImV4cCI6MjA3MDc2MDM3MX0.Ls83xOXcKIW7FUcavr8_sOs37I18VGFWYNW3sNFRS24';

const B_TOKEN     = localStorage.getItem('gacha_b_jwt') || '';
const B_TOKEN_EXP = Number(localStorage.getItem('gacha_b_jwt_exp') || 0);
const PLAYER_NAME = localStorage.getItem('gacha_player_name') || 'æˆ‘çš„';
const REDIRECT_PLAYER = 'https://shierusha.github.io/create-student/player';
const DEFAULT_EVENT   = 'è¬çˆ¾å¤é¥…é ­æ‰­è›‹';

function decodeJWT(t){
  if (!t) return null;
  const pad = s => s + '='.repeat((4 - s.length % 4) % 4);
  try { return JSON.parse(atob(pad(t.split('.')[1]).replace(/-/g,'+').replace(/_/g,'/'))); }
  catch { return null; }
}
const payload = decodeJWT(B_TOKEN);
const user = B_TOKEN && payload ? { id: payload.sub } : null;

let sb = window.supabase.createClient(B_URL, B_ANON, {
  global: { headers: B_TOKEN ? { Authorization: `Bearer ${B_TOKEN}` } : {} }
});
if (B_TOKEN) sb.realtime.setAuth(B_TOKEN);
const G = (t) => sb.schema('gacha').from(t);

/* âœ… è§’è‰²åç¨±/åœ–ç‰‡ç´¢å¼•ï¼ˆèƒŒåŒ…é¡¯ç¤ºåå­—ç”¨ï¼‰ */
const CHAR = {
  normal:  new Map(),                          // id -> { name, image_url }
  hidden:  new Map(),                          // id -> { name, image_url }
  limited: new Map()                           // `${event_name}|${id}` -> { name, image_url }
};

/* ==============================
   DOM å¿«å–
============================== */
const resultsContainer   = $('#gacha-results');
const btnSingle          = $('#btn-single');
const btnTen             = $('#btn-ten');
const btnBag             = $('#btn-backpack');
const btnBack            = $('#btnBack');
const gachaBtns          = $('.gacha-buttons');
const infoModal          = $('#info-modal');
const infoTitle          = $('#info-modal-title');
const infoBody           = $('#info-modal-body');
const drawCounterEl      = $('#draw-count');
const orientationModal   = $('#orientation-modal');



/* ==============================
   è‡ªå‹•å­—ç´šï¼ˆå¥— auto-resizeï¼‰
============================== */
function resizeAllTexts() {
  $$('.auto-resize').forEach(el => {
    const h = el.offsetHeight || el.getBoundingClientRect().height || 20;
    el.style.fontSize = (h * 0.50) + 'px';
  });
}
window.addEventListener('load', resizeAllTexts);
window.addEventListener('resize', resizeAllTexts);

/* ==============================
   å¼·åˆ¶æ©«å‘
============================== */
function isPortrait(){
  return window.matchMedia('(orientation: portrait)').matches || window.innerHeight > window.innerWidth;
}
function enforceLandscape(){
  const portrait = isPortrait();
  if (orientationModal) orientationModal.style.display = portrait ? 'flex' : 'none';
  document.body.style.overflow = portrait ? 'hidden' : '';
}
enforceLandscape();
window.addEventListener('resize', enforceLandscape);
window.addEventListener('orientationchange', enforceLandscape);
if (orientationModal) orientationModal.addEventListener('click', e => e.stopPropagation());

/* ==============================
   æœƒè©± / é€¾æœŸä¿è­·
============================== */
function ensureAuthOrRedirect(){
  const now = Math.floor(Date.now()/1000);
  if (!user || !B_TOKEN || (B_TOKEN_EXP && now >= B_TOKEN_EXP)) {
    alert('ç™»å…¥é€¾æœŸï¼Œå°‡è¿”å›ç©å®¶ä¸­å¿ƒã€‚');
    location.href = REDIRECT_PLAYER;
    return false;
  }
  return true;
}
setInterval(ensureAuthOrRedirect, 60*1000);
ensureAuthOrRedirect();

/* ==============================
   ç‹€æ…‹ & è¿”å›éµæ§åˆ¶
============================== */
let canDraw = true;
let unlockAt = 0;

/* è¿”å›éµï¼šæŠ½å¡ä¸­å®Œå…¨ç¦ç”¨ï¼ˆç„¡æç¤ºï¼‰ */
function setBackDisabled(disabled){
  if (!btnBack) return;
  btnBack.dataset.disabled = disabled ? '1':'0';
  btnBack.style.pointerEvents = disabled ? 'none' : 'auto';
  btnBack.style.opacity = disabled ? '0.6' : '1';
}

/* æŠ½å¡æŒ‰éˆ•é– */
function lockButtons()  { [btnSingle, btnTen, btnBag].forEach(b => b && (b.disabled = true,  b._forceDisabled = true)); }
function unlockButtons(){ [btnSingle, btnTen, btnBag].forEach(b => b && (b.disabled = false, b._forceDisabled = false)); }

/* ==============================
   Edge å–®æŠ½ï¼ˆåªèµ° Edgeï¼‰
============================== */
async function drawOnce(){
  const currentPoolKey = (window.CURRENT_POOL && window.CURRENT_POOL.key) ? window.CURRENT_POOL.key : DEFAULT_EVENT;

  const resp = await fetch(`${B_URL}/functions/v1/gacha-draw`, {
    method: 'POST',
    headers: { 'content-type':'application/json', 'authorization': `Bearer ${B_TOKEN}` },
    body: JSON.stringify({ pool: currentPoolKey })
  });
  const out = await resp.json().catch(()=>null);
  if (!resp.ok) {
    alert(out?.message || out?.error || 'æŠ½å¡å¤±æ•—'); 
    return null;
  }
  return out; // { rarity, name, character_id, event_name, image_url?, special_anim?, is_11x? }
}

async function drawTenTimes(){
  const c = await getCounter();
  const remain = Math.max(0, c.max_draws - c.total_draws);
  if (remain < 10) { return null; }

  const results = [];
  for (let i=0;i<10;i++){
    const r = await drawOnce();
    if (!r) break;
    results.push(r);
  }
  return results;
}

/* ==============================
   åˆå§‹åŒ–
============================== */
(async function boot(){
  if (!ensureAuthOrRedirect()) return;

  /* âœ… å…ˆè¼‰å…¥è§’è‰²æ¸…å–®å»ºç«‹ç´¢å¼•ï¼ˆèƒŒåŒ…é¡¯ç¤ºåå­—éœ€è¦ï¼‰ */
  try {
    const [nChars, hChars, lChars] = await Promise.all([
      G('normal_characters').select('id,name,image_url'),
      G('hidden_characters').select('id,name,image_url'),
      G('limited_characters').select('id,event_name,name,image_url'),
    ]);
    (nChars.data || []).forEach(r => CHAR.normal.set(r.id, { name: r.name, image_url: r.image_url || null }));
    (hChars.data || []).forEach(r => CHAR.hidden.set(r.id, { name: r.name, image_url: r.image_url || null }));
    (lChars.data || []).forEach(r => CHAR.limited.set(`${r.event_name}|${r.id}`, { name: r.name, image_url: r.image_url || null }));
  } catch(e) {
    console.warn('[CHAR index] load failed:', e);
  }

  await ensureCounter();
  await refreshUIFromCounter();

  bindUI();

  // å€«æ³¢é¡¯ç¤ºåˆ‡æ›ï¼ˆæœ‰çµæœå°±éš±è—ï¼‰
  new MutationObserver(()=>{
    const hasResults = document.querySelectorAll('.gacha-row').length > 0;
    const car = document.querySelector('.pool-carousel');
    if (car) car.style.display = hasResults ? 'none' : 'block';
  }).observe(resultsContainer, { childList:true, subtree:true });

  setInterval(refreshUIFromCounter, 15000);

  setBackDisabled(false);
})();

/* ==============================
   Counterï¼ˆå‰©é¤˜æŠ½æ•¸ = max_draws - total_drawsï¼‰
============================== */
async function ensureCounter(){
  const { data } = await G('counters').select('*').eq('player_id', user?.id).single();
  if (!data){
    await G('counters').insert({ player_id: user?.id, total_draws: 0, next_pity: 50 });
  }
}
async function getCounter(){
  const { data } = await G('counters')
    .select('total_draws,next_pity,max_draws')
    .eq('player_id', user?.id).single();
  return data || { total_draws: 0, next_pity: 50, max_draws: 0 };
}
async function refreshUIFromCounter(){
  const c = await getCounter();
  const remain = Math.max(0, (c?.max_draws||0) - (c?.total_draws||0));
  if (drawCounterEl) drawCounterEl.textContent = remain;
  if (btnTen)    btnTen.disabled    = remain < 10 || btnTen._forceDisabled === true || isPortrait();
  if (btnSingle) btnSingle.disabled = remain <  1 || btnSingle._forceDisabled === true || isPortrait();
}

/* ==============================
   Loader
============================== */
const loaderEl  = $('#gacha-loader');
const fillEl    = $('#loader-fill');
const catEl     = $('#loader-cat');
const loaderTxt = $('#loader-text');

const Loader = {
  show(label='Roroçˆ†è‚ä¸­â€¦â€¦'){
    if (loaderTxt) loaderTxt.textContent = label;
    if (fillEl) fillEl.style.width = '0%';
    if (catEl)  catEl.style.left  = '0%';
    loaderEl?.classList.add('show');
    resizeAllTexts();
  },
  async step(stepIndex, total){
    const pct = Math.max(0, Math.min(100, Math.round(stepIndex * (100/total))));
    fillEl && (fillEl.style.width = pct + '%');
    catEl  && (catEl.style.left  = pct + '%');
    await sleep(240);
  },
  hide(){ loaderEl?.classList.remove('show'); }
};

function clearResults(){
  resultsContainer.classList.remove('single');
  resultsContainer.innerHTML = '';
}

/* è»Ÿé‡ç½®ï¼šæ¸…çµæœã€é‚„åŸæŒ‰éˆ•èˆ‡å€«æ³¢ï¼Œä¸æ›é  */
function softResetToIdle(){
  clearResults();
  const car = document.querySelector('.pool-carousel');
  if (car) car.style.display = 'block';
  canDraw = true;
  unlockAt = 0;
  unlockButtons();
  setBackDisabled(false);
  resizeAllTexts();
}

/* ==============================
   ç‰¹æ•ˆé‚è¼¯ï¼ˆéŠ€â†’é‡‘â†’ç¿»ç‰Œï¼‰
============================== */

const specialMask = document.getElementById('special-mask');
const specialCat  = document.getElementById('special-cat');

/* â˜… ä½ çš„é€Ÿåº¦åƒæ•¸ï¼ˆå·²å¥—ç”¨ï¼‰ */
const SPECIAL = {
  preDarkDelayMs: 800,  // â˜… æ–°å¢ï¼šå…ˆç­‰ 1 ç§’å†è®Šæš—
  darkWaitMs:      2000,  // æš—å ´(å…¨é»‘) 2s
  axisMoveTotalMs: 3000,  // å››æ®µç¸½ç§»å‹•æ™‚é–“ï¼ˆå°‡å‡åˆ†æˆ 4 ä»½ï¼‰
  moveBounceMs:     180,  // é€£çºŒå½ˆè·³ç¯€å¥ï¼ˆç§»å‹•æœŸé–“ç”¨ï¼›å’Œ CSS ç„¡é™å‹•ç•«ä¸€è‡´ï¼‰
  hopDelayMs:       200,  // æ¯æ®µã€Œâ€¦0.5ç§’å¾Œâ€¦ã€â†’ ä½ æ”¹æˆ 0.2s
  hopDurMs:         250,  // å–®æ¬¡å½ˆè·³æ™‚é–“
  exitMs:           220,  // é«˜é€Ÿé›¢å ´æ™‚é–“
  targetOffset:    0.78,  // çƒå…§è½é»ï¼ˆè¶Šå¤§è¶Šé å³ä¸‹ï¼‰
  timingFn: 'cubic-bezier(.22,.61,.36,1)'
};

function setCatTransition(ms){
  specialCat.style.transitionProperty = 'left, top';
  specialCat.style.transitionDuration = `${ms}ms`;
  specialCat.style.transitionTimingFunction = SPECIAL.timingFn;
}

function viewportTargets(orbEl){
  const r = orbEl.getBoundingClientRect();
  const t = SPECIAL.targetOffset;
  const rb = { x: r.left + r.width * t,     y: r.top  + r.height * t };     // å³ä¸‹
  const lb = { x: r.left + r.width * (1-t), y: rb.y };                      // å·¦ä¸‹ï¼ˆåŒ yï¼‰
  return { rb, lb };
}

function randomEdgeStart(){
  const w = window.innerWidth, h = window.innerHeight;
  const side = Math.floor(Math.random()*4);
  if (side === 0) return { x: -50,  y: Math.random()*h }; // å·¦å¤–
  if (side === 1) return { x: w+50, y: Math.random()*h }; // å³å¤–
  if (side === 2) return { x: Math.random()*w, y: -50  }; // ä¸Šå¤–
  return { x: Math.random()*w, y: h+50 };                  // ä¸‹å¤–
}

/* å–®è»¸ç§»å‹• */
async function moveHoriz(toX, dur){ setCatTransition(dur); specialCat.style.left = `${toX}px`; await sleep(dur); }
async function moveVert (toY, dur){ setCatTransition(dur); specialCat.style.top  = `${toY}px`; await sleep(dur); }

/* åœåœ¨åŸåœ°çš„ã€Œn æ¬¡å½ˆè·³ã€ */
async function bounce(times=1, dur=SPECIAL.hopDurMs){
  return new Promise(resolve=>{
    specialCat.style.animation = `cat-bounce ${dur}ms ease-out ${times}`;
    const onEnd = () => { specialCat.style.animation = ''; specialCat.removeEventListener('animationend', onEnd); resolve(); };
    specialCat.addEventListener('animationend', onEnd);
  });
}

/* é€£çºŒå½ˆè·³ï¼ˆç§»å‹•æ™‚ï¼‰ */
function startLoopBounce(ms=SPECIAL.moveBounceMs){
  specialCat.classList.add('bounce-loop');
  specialCat.style.setProperty('--bounceMs', `${ms}ms`);
}
function stopLoopBounce(){
  specialCat.classList.remove('bounce-loop');
  specialCat.style.removeProperty('--bounceMs');
}

/* å·¦å³ç¿»è½‰ */
function setFlip(on){ specialCat.classList.toggle('flipX', !!on); }

/* ä¾ä½ æ–°ç‰ˆæ™‚åºï¼š
   æš—å ´â†’ å‡ºç¾
   â†’ å››æ®µç§»å‹•åˆ°å³ä¸‹ï¼ˆå‚ç›´â†’æ°´å¹³â†’å‚ç›´â†’æ°´å¹³ï¼›å…¨ç¨‹é€£çºŒå½ˆè·³ï¼‰
   â†’ +0.5s è·³1
   â†’ +0.5s ç¿»è½‰ + ç§»åˆ°å·¦ä¸‹ â†’ è·³1
   â†’ +0.5s è·³1 â†’ ç¿»å› + ç§»å›å³ä¸‹ â†’ è·³1
   â†’ +0.5s è·³2
   â†’ +0.5s è·³2 ä¸¦ ç™½â†’éŠ€
   â†’ +0.5s ç¿»è½‰ + å·¦ä¸‹ â†’ è·³1
   â†’ +0.5s è·³1 â†’ ç¿»å› + å³ä¸‹ â†’ è·³1
   â†’ +0.5s è·³3 ä¸¦ éŠ€â†’é‡‘
   â†’ +0.5s è·³3 ä¸¦ é‡‘â†’æ‰“é–‹ï¼ˆrevealFnï¼‰
   â†’ +0.5s è·³3 â†’ é«˜é€Ÿé›¢å ´
   ï¼ˆæ³¨æ„ï¼šä½ æŠŠ 0.5s æ”¹æˆ hopDelayMs=200msï¼Œæˆ‘å°±ç…§ 0.2s è·‘ï¼‰
*/
async function runSpecialUpgradeAnimation(targetOrb, revealFn){
  if (!targetOrb) { revealFn?.(); return; }

  // å°å·¥å…·ï¼šæ ¹æ“šæ°´å¹³ç§»å‹•æ–¹å‘è¨­å®šç¿»è½‰ï¼ˆtoX < fromX => å¾€å·¦ => flipï¼‰
  const faceForMove = (fromX, toX) => setFlip(toX < fromX);

  // é€²å ´å‰å…ˆç­‰
  await sleep(SPECIAL.preDarkDelayMs);

  // é¡¯ç¤ºé®ç½© + èµ·å§‹ä½ç½®ï¼ˆèµ·å§‹æœå³ï¼‰
  specialMask.style.display = 'block';
  specialCat.style.opacity = '0';
  const start = randomEdgeStart();
  specialCat.style.left = `${start.x}px`;
  specialCat.style.top  = `${start.y}px`;
  setFlip(false); // â˜… èµ·å§‹æœå³

  // æš—å ´
  await sleep(SPECIAL.darkWaitMs);
  specialCat.style.opacity = '1';

// === å…­æ®µç›´ç·šç§»å‹•ï¼šå‚ç›´1/3 â†’ æ°´å¹³1/3 â†’ å‚ç›´2/3 â†’ æ°´å¹³2/3 â†’ å‚ç›´åˆ°ç›®æ¨™ â†’ æ°´å¹³æˆç›®æ¨™ ===
const { rb, lb } = viewportTargets(targetOrb);
const q = Math.max(0, Math.floor(SPECIAL.axisMoveTotalMs / 6));

const dyThird = (rb.y - start.y) / 3;
const dxThird = (rb.x - start.x) / 3;

const y1_3 = start.y + dyThird;
const y2_3 = start.y + dyThird * 2;
const x1_3 = start.x + dxThird;
const x2_3 = start.x + dxThird * 2;

// è¿½è¹¤ç›®å‰ä½ç½®ï¼ˆçµ¦ç¿»é ­ç”¨ï¼‰
let curX = start.x, curY = start.y;

// 1) å‚ç›´åˆ° 1/3 Yï¼ˆä¸å½ˆï¼‰
stopLoopBounce();
await moveVert(y1_3, q); curY = y1_3;

// 2) æ°´å¹³åˆ° 1/3 Xï¼ˆå½ˆï¼Œä¸¦ä¾æ–¹å‘ç¿»é ­ï¼‰
faceForMove(curX, x1_3);
startLoopBounce();
await moveHoriz(x1_3, q); curX = x1_3;
stopLoopBounce();

// 3) å‚ç›´åˆ° 2/3 Yï¼ˆä¸å½ˆï¼‰
await moveVert(y2_3, q); curY = y2_3;

// 4) æ°´å¹³åˆ° 2/3 Xï¼ˆå½ˆï¼Œä¸¦ä¾æ–¹å‘ç¿»é ­ï¼‰
faceForMove(curX, x2_3);
startLoopBounce();
await moveHoriz(x2_3, q); curX = x2_3;
stopLoopBounce();

// 5) å‚ç›´åˆ°ç›®æ¨™ Yï¼ˆä¸å½ˆï¼‰
await moveVert(rb.y, q); curY = rb.y;

// 6) æ°´å¹³æˆç›®æ¨™ Xï¼ˆå½ˆï¼Œä¸¦ä¾æ–¹å‘ç¿»é ­ï¼‰
faceForMove(curX, rb.x);
startLoopBounce();
await moveHoriz(rb.x, q); curX = rb.x;
stopLoopBounce();

  // === å¾ŒçºŒå›ºå®šç¯€å¥ ===
  await sleep(SPECIAL.hopDelayMs);  await bounce(1);

  await sleep(SPECIAL.hopDelayMs);
  // å¾€å·¦åˆ°å·¦ä¸‹ï¼šå½ˆã€ç¿»é ­â†’å·¦
  faceForMove(curX, lb.x);
  startLoopBounce();
  await moveHoriz(lb.x, SPECIAL.hopDurMs); curX = lb.x;
  stopLoopBounce();
  await bounce(1);

  await sleep(SPECIAL.hopDelayMs);
  await bounce(1);
  // å¾€å³å›å³ä¸‹ï¼šå½ˆã€ç¿»é ­â†’å³
  faceForMove(curX, rb.x);
  startLoopBounce();
  await moveHoriz(rb.x, SPECIAL.hopDurMs); curX = rb.x;
  stopLoopBounce();
  await bounce(1);

  await sleep(SPECIAL.hopDelayMs);  await bounce(2);

  await sleep(SPECIAL.hopDelayMs);  await bounce(2);
  // ç™½ â†’ éŠ€
  targetOrb.classList.remove('orb-normal');
  targetOrb.classList.add('orb-hidden');

  await sleep(SPECIAL.hopDelayMs);
  // å·¦ä¸‹ï¼šå½ˆã€ç¿»é ­â†’å·¦
  faceForMove(curX, lb.x);
  startLoopBounce();
  await moveHoriz(lb.x, SPECIAL.hopDurMs); curX = lb.x;
  stopLoopBounce();
  await bounce(1);

  await sleep(SPECIAL.hopDelayMs);
  await bounce(1);
  // å³ä¸‹ï¼šå½ˆã€ç¿»é ­â†’å³
  faceForMove(curX, rb.x);
  startLoopBounce();
  await moveHoriz(rb.x, SPECIAL.hopDurMs); curX = rb.x;
  stopLoopBounce();
  await bounce(1);

  await sleep(SPECIAL.hopDelayMs);  await bounce(3);
  // éŠ€ â†’ é‡‘
  targetOrb.classList.remove('orb-hidden');
  targetOrb.classList.add('orb-limited');

  await sleep(SPECIAL.hopDelayMs);  await bounce(3);
  // é‡‘ â†’ æ‰“é–‹ï¼ˆé¡¯ç¤ºåœ–èˆ‡åå­—ï¼›ä¸é€æ­å–œï¼‰
  revealFn?.();


 await sleep(SPECIAL.hopDelayMs);
  faceForMove(curX, lb.x);        // å¾€å·¦ â†’ flip
  startLoopBounce();              // æ°´å¹³ç§»å‹•æ™‚ä¿æŒå½ˆè·³
  await moveHoriz(lb.x, SPECIAL.hopDurMs);
  curX = lb.x;
  stopLoopBounce();
  await bounce(1);

  await sleep(SPECIAL.hopDelayMs);  await bounce(3);

  // é«˜é€Ÿé›¢å ´ï¼ˆä¿æŒç•¶å‰æœå‘å³å¯ï¼‰
  const end = randomEdgeStart();
  setCatTransition(SPECIAL.exitMs);
  specialCat.style.left = `${end.x}px`;
  specialCat.style.top  = `${end.y}px`;
  await sleep(SPECIAL.exitMs);

  // æ”¶å°¾
  specialMask.style.display = 'none';
}


/* ==============================
   UIï¼šå»ºç«‹çƒ / ç¿»ç‰Œï¼ˆçƒå…§æ”¾åœ–ã€å¯é®åï¼‰
============================== */
function createOrb(res, { autoReveal=false, revealDelay=0, big=false, forceInitialNormal=false } = {}){
  const orb = document.createElement('div');
  const initialClass = forceInitialNormal ? 'orb-normal' : `orb-${res.rarity}`;
  orb.className = `gacha-orb ${initialClass}` + (big?' big':'');
  const inner = document.createElement('div');
  inner.className = 'orb-inner';

  // âœ… å…ˆæŠŠåœ–ç‰‡æ”¾é€²å»ï¼ˆéš±å½¢ï¼Œä½†æœƒé–‹å§‹ä¸‹è¼‰ï¼‰
  if (res.image_url) {
    const img = document.createElement('img');
    img.src = res.image_url;
    img.alt = res.name;
    img.className = 'orb-icon';
    // æç¤ºç€è¦½å™¨å„ªå…ˆè¼‰å…¥
    img.setAttribute('loading', 'eager');
    img.setAttribute('decoding', 'async');
    img.setAttribute('fetchpriority', 'high');
    inner.appendChild(img);
  }

  // ç¿»ç‰Œæ‰è£œåå­—ï¼‹é¡¯ç¤ºï¼ˆä¸è¦æ¸… innerï¼Œå¦å‰‡æœƒæŠŠé è¼‰åœ–ç§»é™¤ï¼‰
  const doRevealContent = () => {
    if (!inner.querySelector('.orb-name')) {
      const nameEl = document.createElement('span');
      nameEl.className = 'orb-name auto-resize';
      nameEl.textContent = res.name;
      inner.appendChild(nameEl);
    }
    orb.classList.add('revealed');  // è§¸ç™¼ CSSï¼šè®“åœ–å¾ opacity:0 â†’ 1
    resizeAllTexts();
    checkAllRevealed();
  };

  // åªåœ¨ã€Œç©å®¶æ‰‹å‹• + éŠ€/é‡‘ã€æ™‚é€æ­å–œ
  const reveal = (isManual=false) => {
    if (orb.classList.contains('revealed')) return;
    doRevealContent();
    if (isManual && (res.rarity === 'limited' || res.rarity === 'hidden')) {
      sendGachaWebhook(res.rarity, res.name, { mode: 'congrats' });
    }
  };

  if (autoReveal) setTimeout(() => reveal(false), revealDelay);
  else orb.addEventListener('click', () => reveal(true));

  orb.appendChild(inner);
  return { el: orb, reveal, rawReveal: doRevealContent }; // rawRevealï¼šçµ¦ç‰¹æ•ˆç”¨ï¼Œä¸é€æ­å–œ
}


function checkAllRevealed(){
  const orbs = $$('.gacha-orb', resultsContainer);
  if (orbs.length === 0) return;
  const all = orbs.every(o => o.classList.contains('revealed'));
  if (all) {
    unlockAt = Date.now() + 500;
    setTimeout(()=>{
      canDraw = true;
      unlockButtons();
      setBackDisabled(false); // å…¨éƒ¨ç¿»å®Œæ‰è§£é–è¿”å›
    }, 500);
  }
}

function showResultsTen(results){
  canDraw = false;
  setBackDisabled(true);

  resultsContainer.classList.remove('single');
  resultsContainer.innerHTML = '';

  const spIndex = results.findIndex(r => r.special_anim);
  const hasSpecial = spIndex >= 0;

  const allOrbs = [];

  for (let row=0; row<2; row++){
    const rowDiv = document.createElement('div');
    rowDiv.className = 'gacha-row';

    results.slice(row*5, row*5+5).forEach((res, idx)=>{
      const index = row*5 + idx;
      const isSpecialTarget = (index === spIndex);
      // æœ‰ç‰¹æ•ˆæ™‚ï¼Œç™½çƒå»¶å¾Œï¼›ç„¡ç‰¹æ•ˆæ™‚ç™½çƒç…§èˆŠè‡ªå‹•ç¿»
      const auto = (!hasSpecial && res.rarity === 'normal');
      const { el, reveal, rawReveal } = createOrb(res, {
        autoReveal: auto,
        revealDelay: index*200,
        forceInitialNormal: isSpecialTarget
      });
      el.dataset.index = String(index);
      rowDiv.appendChild(el);
      allOrbs.push({ el, res, reveal, rawReveal, index });
    });

    resultsContainer.appendChild(rowDiv);
  }
  resizeAllTexts();

  if (hasSpecial) {
    const target = allOrbs.find(o => o.index === spIndex);
    // ç‰¹æ•ˆå…§ç¿»é–‹ã€Œç›®æ¨™é‡‘è›‹ã€ï¼ˆä¸é€æ­å–œï¼‰
    runSpecialUpgradeAnimation(target?.el, () => target?.rawReveal()).then(async ()=>{
      // ğŸ¯ ç‰¹æ•ˆå‰›çµæŸï¼šå…ˆé€ã€Œå·å·èª¿åŒ…ã€
      try { await sendGachaWebhook(target.res.rarity, target.res.name, { mode: 'swap' }); } catch(e){}

      // ç„¶å¾Œåªè‡ªå‹•ç¿»ã€Œç™½çƒã€ï¼ŒéŠ€/é‡‘ç•™çµ¦ç©å®¶æ‰‹å‹•é»
      for (const o of allOrbs){
        if (o.index === spIndex) continue; // ç‰¹æ•ˆé‚£é¡†å·²ç¿»
        if (o.res.rarity === 'normal' && !o.el.classList.contains('revealed')) {
          await sleep(120); // â˜… å¯å¾®èª¿ï¼šè£œç¿»é–“éš”
          o.reveal(false);  // éæ‰‹å‹• â†’ ä¸é€æ­å–œ
        }
      }
    });
  }
}

function showResultSingle(res){
  canDraw = false;
  setBackDisabled(true);

  resultsContainer.classList.add('single');
  resultsContainer.innerHTML = '';

  const needSpecial = !!res.special_anim;
  const { el: orb, reveal, rawReveal } = createOrb(res, {
    autoReveal: !needSpecial && res.rarity==='normal',  // ç™½çƒç„¡ç‰¹æ•ˆç›´æ¥è‡ªå‹•ç¿»
    revealDelay: 0,
    big: true,
    forceInitialNormal: needSpecial
  });

  const rowDiv = document.createElement('div');
  rowDiv.className = 'gacha-row';
  rowDiv.style.justifyContent = 'center';
  rowDiv.appendChild(orb);
  resultsContainer.appendChild(rowDiv);
  resizeAllTexts();

  if (needSpecial) {
    // ç‰¹æ•ˆå…§ç¿»ç‰Œï¼ˆä¸é€æ­å–œï¼‰
    runSpecialUpgradeAnimation(orb, () => rawReveal()).then(async () => {
      // ğŸ¯ ç‰¹æ•ˆçµæŸå¾Œé€ã€Œå·å·èª¿åŒ…ã€
      try { await sendGachaWebhook(res.rarity, res.name, { mode: 'swap' }); } catch(e){}
      // å–®æŠ½æ²’æœ‰å…¶ä»–ç™½çƒè¦è£œç¿»ï¼›æ­å–œä¹Ÿä¸é€ï¼ˆå› ç‚ºä¸æ˜¯ç©å®¶é»é–‹ï¼‰
    });
  } else if (res.rarity === 'normal') {
    // ç™½çƒï¼šè‡ªå‹•ç¿»å¾Œç›´æ¥è§£é–
    unlockAt = Date.now() + 500;
    setTimeout(()=>{ canDraw = true; unlockButtons(); setBackDisabled(false); }, 500);
  }
}

/* ==============================
   èƒŒåŒ…ï¼ˆå±•ç¤ºï¼‰
============================== */
function nameFromPools(rarity, character_id, event_name){
  if (rarity === 'normal') {
    return CHAR.normal.get(character_id)?.name || `#${character_id}`;
  }
  if (rarity === 'hidden') {
    return CHAR.hidden.get(character_id)?.name || `#${character_id}`;
  }
  // limited
  return CHAR.limited.get(`${event_name}|${character_id}`)?.name
      || `#${character_id}`;
}

async function openBackpack(){
  const orbs = $$('.gacha-orb', resultsContainer);
  if (orbs.some(o=>!o.classList.contains('revealed'))) { alert('è«‹å…ˆç¿»é–‹æ‰€æœ‰æ‰­è›‹ï¼'); return; }

  infoTitle.textContent = `${PLAYER_NAME}çš„èƒŒåŒ…`;

  const { data, error } = await G('owned_characters')
    .select('rarity,event_name,character_id,count')
    .eq('player_id', user?.id);

  if (error) { console.error('[owned_characters] query error:', error); alert('è®€å–èƒŒåŒ…å¤±æ•—'); return; }
  const rows = Array.isArray(data) ? data : [];

  const byKey = new Map();
  for (const r of rows){
    const key = `${r.rarity}|${r.event_name}|${r.character_id}`;
    const v = byKey.get(key);
    byKey.set(key, v ? { ...r, count: v.count + r.count } : { ...r });
  }
  const merged = [...byKey.values()];

  const limitedGroups = new Map(); // event_name -> [{id, html}]
  const hiddenList = [];
  const normalList = [];

  merged.forEach(r=>{
    const nm = nameFromPools(r.rarity, r.character_id, r.event_name);
    const item = { id:r.character_id, html:`${escapeHtml(nm)} Ã— <span>${r.count}</span>` };
    if (r.rarity === 'limited') {
      const arr = limitedGroups.get(r.event_name) || [];
      arr.push(item);
      limitedGroups.set(r.event_name, arr);
    } else if (r.rarity === 'hidden') hiddenList.push(item);
    else normalList.push(item);
  });

  const byId = a => a.sort((x,y)=>(x.id??0)-(y.id??0));
  for (const [k, arr] of limitedGroups) limitedGroups.set(k, byId(arr));
  byId(hiddenList); byId(normalList);

  const joinRows = (arr, perLine=3)=>{
    const lines=[]; for(let i=0;i<arr.length;i+=perLine){ lines.push(arr.slice(i,i+perLine).map(x=>x.html).join('ã€ ')); }
    return lines.join('<br>');
  };

  let html='';
  const limitedKeys = [...limitedGroups.keys()].sort();
  if (limitedKeys.length){
    html += `<div class="backpack-section"><h3>æ´»å‹•é™å®šé¥…é ­ï¼š</h3><div class="backpack-items">`;
    limitedKeys.forEach((evName, idx)=>{
      const rowsHtml = joinRows(limitedGroups.get(evName)||[], 2) || 'ï¼ˆç„¡ï¼‰';
      html += `<div class="backpack-event-block" style="margin:.25rem 0;">${escapeHtml(evName)}</div>`;
      html += `<div class="backpack-event-items" style="margin:0 0 .5rem 0;">${rowsHtml}</div>`;
      if (idx !== limitedKeys.length-1) html += `<div style="height:.4rem;"></div>`;
    });
    html += `</div></div>`;
  }
  if (hiddenList.length){
    html += `<div class="backpack-section"><h3>éš±è—é¥…é ­ï¼š</h3><div class="backpack-items">${joinRows(hiddenList,2)}</div></div>`;
  }
  if (normalList.length){
    html += `<div class="backpack-section"><h3>æ™®é€šé¥…é ­ï¼š</h3><div class="backpack-items">${joinRows(normalList,3)}</div></div>`;
  }
  if (!html) html = '<div class="backpack-items">ç›®å‰æ²’æœ‰ä»»ä½•é¥…é ­</div>';

  infoBody.innerHTML = html;
  infoModal.style.display = 'flex';
}
infoModal?.addEventListener('click', ()=> infoModal.style.display='none');
infoModal?.querySelector('.modal-content')?.addEventListener('click', e=> e.stopPropagation());

/* ==============================
   ç¶å®šæŒ‰éˆ•ï¼ˆè¿”å›éµï¼šæŠ½å¡æœŸé–“å®Œå…¨ç¦ç”¨ï¼›ç¿»å®Œæ‰è§£é–ï¼›æœ‰çµæœâ†’è»Ÿé‡ç½®ï¼‰
============================== */
function bindUI(){
  btnBag?.addEventListener('click', openBackpack);

  btnBack?.addEventListener('click', ()=>{
    if (btnBack?.dataset.disabled === '1') return; // è¢«ç¦ç”¨ç›´æ¥ç„¡è¦–
    const hasResults = $$('.gacha-orb', resultsContainer).length > 0;
    if (hasResults) {
      softResetToIdle(); // ä¸æ›é 
    } else {
      location.href = REDIRECT_PLAYER;
    }
  });

  btnSingle?.addEventListener('click', async ()=>{
    if (!ensureAuthOrRedirect()) return;
    if (isPortrait()) return;
    if (!canDraw || Date.now() < unlockAt) return alert('ç¨ç­‰ä¸€ä¸‹â€¦');

    setBackDisabled(true);
    gachaBtns?.classList.add('bottom');
    lockButtons();

    clearResults();
    Loader.show('Roroçˆ†è‚ä¸­â€¦â€¦');

    const r = await drawOnce();
    if (!r) {
      Loader.hide();
      await refreshUIFromCounter();
      unlockButtons();
      setBackDisabled(false);
      return;
    }

    await Loader.step(1, 1);
    Loader.hide();

    await refreshUIFromCounter();
    showResultSingle(r);
  });

  btnTen?.addEventListener('click', async ()=>{
    if (!ensureAuthOrRedirect()) return;
    if (isPortrait()) return;
    if (!canDraw || Date.now() < unlockAt) return alert('ç¨ç­‰ä¸€ä¸‹â€¦');

    const c = await getCounter();
    if ((c?.max_draws||0) - (c?.total_draws||0) < 10) return alert('å‰©é¤˜æŠ½æ•¸ä¸è¶³ 10 æŠ½');

    setBackDisabled(true);
    gachaBtns?.classList.add('bottom');
    lockButtons();

    clearResults();
    Loader.show('Roroçˆ†è‚ä¸­â€¦â€¦');

    const results = [];
    for (let i = 0; i < 10; i++) {
      const r = await drawOnce();
      if (!r) break;
      results.push(r);
      await Loader.step(i + 1, 10);
    }

    Loader.hide();

    if (!results.length) { unlockButtons(); setBackDisabled(false); return; }

    await refreshUIFromCounter();
    showResultsTen(results);
  });

  const obs = new MutationObserver(()=>{ resizeAllTexts(); checkAllRevealed(); });
  obs.observe(resultsContainer, { childList:true, subtree:true });
}
</script>


  <!-- ç™»å‡ºè…³æœ¬ -->
  <script src="https://shierusha.github.io/library/assets/js/logout.js"></script>

  <!-- é¸æ± å€«æ³¢å¤–æ› JS -->
  <script src="https://shierusha.github.io/library/assets/js/pool-carousel.js"></script>
</body>
</html>
