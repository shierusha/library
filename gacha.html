<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>謝爾夏｜扭蛋系統1.0 </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>

/* ==============================
   全域背景 / 字體
============================== */
body {
  background: url('https://shierusha.github.io/create-student/imgs/citybg.png') center center no-repeat;
  background-size: cover;
  min-height: 100vh;
  font-family: 'Noto Sans TC', sans-serif;
  overflow: hidden;
}
body.dark-bg::before {
  content: "";
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.3);
  z-index: 0; pointer-events: none;
}

/* ==============================
   16:9 容器
============================== */
.container-16-9 {
  position: relative;
  max-width: 90%;
  max-height: 90vh;
  aspect-ratio: 16/9;
  overflow: hidden;
  border-radius: 16px;
  box-shadow: 0 0 24px #0004;
  margin: 5vh auto;
}
.bg-img {
  position: absolute; inset: 0;
  width: 100%; height: 100%;
  object-fit: cover;
  z-index: 1;
}

/* ==============================
   Modal（旋轉 / 背包）
============================== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  z-index: 2000;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: modal-fadein-bg 0.25s;
}
@keyframes modal-fadein-bg {
  from { background: rgba(0,0,0,0); }
  to   { background: rgba(0,0,0,0.45); }
}
.modal-content {
  background: rgb(13 27 77 / 82%);
  border-radius: 18px;
  border: 2px solid #1eb5e5;
  box-shadow: 0 0 16px 2px #62f1fe88, 0 8px 32px #1eb5e5aa;
  width: 500px; max-width: 93vw;
  height: 340px; max-height: 80vh;
  display: flex; flex-direction: column;
  overflow: hidden;
  animation: modal-pop 0.32s cubic-bezier(.42,1.4,.51,1.01);
}
@keyframes modal-pop {
  from { opacity: 0; transform: scale(0.92); }
  to   { opacity: 1; transform: scale(1); }
}
.modal-header {
  background: none;
  padding: 15px 20px 0px 24px;
  color: #fff; font-size: 1.5em; font-weight: bold;
  letter-spacing: 1px; text-shadow: 0 1px 4px #000a;
}
.modal-header::after {
  content: ""; display: block; height: 5px; width: 70%;
  margin:.5rem 0 0; border-radius: 2px;
  background: linear-gradient(to right,#53e2ff99 65%,#53e2ff00 100%);
  pointer-events: none;
}
.modal-body {
  color:#fff; padding: 12px 24px 24px 24px;
  font-size: 1.2em; line-height:1.5; text-shadow:0 1px 4px #0008;
  overflow-y:auto; max-height:240px; white-space: pre-line;
  scrollbar-width:none;
}
.modal-body::-webkit-scrollbar { display:none; }

/* ==============================
   抽卡按鈕（初始置中 → 抽卡後移到底部）
============================== */
.gacha-buttons {
  position: absolute;
  bottom: 45%; /* 初始居中 */
  left: 50%; transform: translateX(-50%);
  display: flex; gap: 10%;
  width: 60%; height: 11%;
  z-index: 10;
  transition: bottom 0.4s ease;
}
.gacha-buttons.bottom { bottom: 16%; } /* 抽卡後固定下方 */
.gacha-btn {
  flex: 1; height: 100%;
  border-radius: 12px;
  background: rgb(13 27 77 / 82%);
  border: 2px solid #1eb5e5; color: #fff; font-weight: bold;
  cursor: pointer; transition: all 0.25s;
  box-shadow: 0 0 12px #53e2ff88, 0 0 24px #1eb5e577 inset;
}
.gacha-btn:hover {
  background: #1eb5e5cc;
  box-shadow: 0 0 18px #53e2ffdd, 0 0 36px #1eb5e5aa inset;
}

/* ==============================
   抽卡結果（十連 / 單抽共用容器）
============================== */
.gacha-results {
  position: absolute;
  top: 12%; left: 50%; transform: translateX(-50%);
  display: flex; flex-direction: column;
  gap: 16px; width: 80%; height: 55%;
  z-index: 9;
}

/* 十連抽：兩行五顆 */
.gacha-row {
  display: flex; justify-content: space-between;
  width: 100%; gap: 12px;
}

/* 抽卡球（圓形 + 內部不可見方框承載文字） */
.gacha-orb {
  position: relative; flex: 1;
  aspect-ratio: 1/1; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  overflow: hidden; cursor: pointer; user-select: none;
  transition: all 0.3s ease;
}
.orb-inner {
  width: 90%; height: 35%;
  display: flex; align-items: center; justify-content: center;
  text-align: center; line-height: 1.2; font-weight: bold;
}

/* 球初始顏色（未翻開） */
.orb-normal  { background: #fff;    border: 3px solid #ccc; }
.orb-hidden  { background: #c0c0c0; border: 3px solid #aaa; }
.orb-limited { background: gold;    border: 3px solid orange; }

/* 翻開後 → 空心圓框 + 對應顏色文字 */
.gacha-orb.revealed { background: transparent; }
.orb-normal.revealed  { border: 3px solid #fff;    color: #fff; }
.orb-hidden.revealed  { border: 3px solid #c0c0c0; color: #c0c0c0; }
.orb-limited.revealed { border: 3px solid gold;    color: #ffd700; }

/* 單抽模式容器：置中 */
.gacha-results.single {
  display: flex;
  align-items: center;
  justify-content: center;
}

/* 大球：佔滿容器高度（保持正圓） */
.gacha-orb.big {
  aspect-ratio: 1/1;
  max-width: 25%;
}

/* ==============================
   HUD（右下角）
============================== */
.gacha-hud {
  position: absolute;
  bottom: 6%;
  right: 4%;
  display: flex;
  align-items: center;
  gap: 1rem;
  z-index: 30;
  color: #fff;
  text-shadow: 0 1px 4px #000a;
  height: 10%;
}
.counter-box {
  height: 100%;
  display: flex; align-items: center;
  font-weight: bold; padding: 0 6px;
  border-radius: 4px;
  background: rgba(255,255,255,0.01);
}
.gacha-counter {
  position: absolute;
  bottom: 5%; right: 17%;
  gap: 1rem; z-index: 30;
  color: #fff; text-shadow: 0 1px 4px #000a;
  height: 10%;
}
.gacha-results { z-index: 10; }

/* 背包按鈕 */
.gacha-backpack {
  height: 100%; aspect-ratio: 2/1;
  border: 2px solid #1eb5e5; border-radius: 8px;
  background: rgb(13 27 77 / 82%); color: #fff;
  cursor: pointer; transition: all 0.25s;
  box-shadow: 0 0 8px #53e2ff88, 0 0 16px #1eb5e577 inset;
  display: flex; align-items: center; justify-content: center;
}
.backpack-box {
  height: 100%;
  display: flex; align-items: center; justify-content: center;
}
.backpack-section { margin: 0.5rem 0; }
.backpack-section h3 { color: #53e2ff; margin-bottom: 0.3rem; }
.backpack-items { color: #fff; }
.backpack-items span { color: #ffe082; font-weight: bold; }

/* ==============================
   Loader（百分比定位/尺寸；不靠 JS 算大小）
============================== */
.gacha-loader{
  position:absolute; 
  left:10%; 
  right:10%;
  top: 45%;          /* 你要改位置就改這裡的百分比 */
  height: 15%;      /* 你要改高度就改這裡的百分比 */
  z-index:60; 
  display:none;
}
.gacha-loader.show{ display:block; }
.gacha-loader .loader-box{
  position:relative; 
  height:100%;
  display:flex; 
  flex-direction:column; 
  gap:8px; justify-content:center;
}
.loader-bar{
  position:relative; height:42%;
  background:#263257; border-radius:999px; overflow:hidden;
  box-shadow: inset 0 0 10px #000a;
}
.loader-fill{
  position:absolute; left:0; top:0; height:100%; width:0%;
  background: linear-gradient(90deg,#2de0ff88,#6dffae88);
  box-shadow: 0 0 18px #53e2ff99 inset;
  transition: width .26s cubic-bezier(.22,.61,.36,1);
}
.loader-cat{
  position:absolute; 
  top:-35%; left:0%;
  transform: translate(-50%, -50%);
  height: 70%;            /* 貓大小 = 進度條高的 90% */
  aspect-ratio: 1 / 1;    /* 不變形 */
  filter: drop-shadow(0 3px 8px #000c);
  transition: left .26s cubic-bezier(.22,.61,.36,1);
  pointer-events:none;
}
.loader-text{
  text-align:center; color:#e9efff; font-weight:900;
  text-shadow:0 2px 6px #000c;
  height: 100%;            /* 讓 JS 可以用這個高度算字體 */
  display:flex; align-items:center; justify-content:center;
}

/* 自動字級：給需要自動縮放的元素加 .auto-resize */
.auto-resize { /* 無樣式，純標記 */ }


</style>
</head>
<body class="dark-bg">
  <!-- 16:9 主要容器 -->
  <div class="container-16-9">
    <!-- 抽卡結果容器（單抽/十連共用） -->
    <div class="gacha-results" id="gacha-results"></div>

    <!-- 轉蛋讀條 Loader（百分比定位/尺寸） -->
    <div id="gacha-loader" class="gacha-loader">
      <div class="loader-box">
        <div class="loader-bar">
          <div class="loader-fill" id="loader-fill"></div>
          <img class="loader-cat" id="loader-cat"
               src="https://shierusha.github.io/library/img/cat.png" alt="cat">
        </div>
        <div class="loader-text auto-resize" id="loader-text">Roro爆肝中……</div>
      </div>
    </div>

    <!-- 抽卡按鈕（初始置中，抽卡後會滑到下方） -->
    <div class="gacha-buttons">
      <button id="btn-single" class="gacha-btn auto-resize">單抽</button>
      <button id="btn-ten" class="gacha-btn auto-resize">十連抽</button>
    </div>

    <!-- HUD -->
    <div class="gacha-hud">
      <button id="btn-backpack" class="gacha-backpack">
        <div class="backpack-box auto-resize">背包</div>
      </button>
    </div>

    <div class="gacha-counter auto-resize">
      <div class="counter-box">累積抽數：
        <span id="draw-count">0</span>
      </div>
    </div>

    <!-- 背景圖 -->
    <img class="bg-img" src="https://shierusha.github.io/school-battle/teachers/img/8.webp" alt="background">
  </div>

  <!-- 旋轉提示（不可關閉） -->
  <div id="orientation-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <div class="modal-header">請旋轉螢幕</div>
      <div class="modal-body">為了最佳體驗，請將裝置轉成橫向模式</div>
    </div>
  </div>

  <!-- 背包 Modal（可點背景關閉） -->
  <div id="info-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <div class="modal-header" id="info-modal-title">標題</div>
      <div class="modal-body" id="info-modal-body"></div>
    </div>
  </div>












<script>
/* ==============================
   小工具
============================== */
const $  = (s, r=document) => r.querySelector(s);
const $$ = (s, r=document) => [...r.querySelectorAll(s)];
const sleep = (ms) => new Promise(res => setTimeout(res, ms));
const escapeHtml = s => (s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
const pick = arr => arr[Math.floor(Math.random()*arr.length)];

/* ==============================
   Supabase（圖書館 B 專案）
============================== */
const B_URL  = 'https://ogzpfrkwnqqaitytncla.supabase.co';
const B_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9nenBmcmt3bnFxYWl0eXRuY2xhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxODQzNzEsImV4cCI6MjA3MDc2MDM3MX0.Ls83xOXcKIW7FUcavr8_sOs37I18VGFWYNW3sNFRS24';

const B_TOKEN     = localStorage.getItem('gacha_b_jwt') || '';
const B_TOKEN_EXP = Number(localStorage.getItem('gacha_b_jwt_exp') || 0);
const PLAYER_NAME = localStorage.getItem('gacha_player_name') || '我的';
const REDIRECT_PLAYER = 'https://shierusha.github.io/create-student/player';
const DEFAULT_EVENT   = '常駐'; // normal/hidden 的 event_name

function decodeJWT(t){
  if (!t) return null;
  const pad = s => s + '='.repeat((4 - s.length % 4) % 4);
  try { return JSON.parse(atob(pad(t.split('.')[1]).replace(/-/g,'+').replace(/_/g,'/'))); }
  catch { return null; }
}
const payload = decodeJWT(B_TOKEN);
const user = B_TOKEN && payload ? { id: payload.sub } : null;

let sb = window.supabase.createClient(B_URL, B_ANON, {
  global: { headers: B_TOKEN ? { Authorization: `Bearer ${B_TOKEN}` } : {} }
});
if (B_TOKEN) sb.realtime.setAuth(B_TOKEN);

// ✅ 正確指定 gacha schema 的 helper
const G = (t) => sb.schema('gacha').from(t);

/* ==============================
   DOM 快取
============================== */
const resultsContainer = $('#gacha-results');
const btnSingle  = $('#btn-single');
const btnTen     = $('#btn-ten');
const btnBag     = $('#btn-backpack');
const gachaBtns  = $('.gacha-buttons');
const infoModal  = $('#info-modal');
const infoTitle  = $('#info-modal-title');
const infoBody   = $('#info-modal-body');
const drawCounterEl = $('#draw-count');
const orientationModal = $('#orientation-modal');

/* ==============================
   自動字級（統一倍率，凡是 .auto-resize 都吃）
============================== */
function resizeAllTexts() {
  $$('.auto-resize').forEach(el => {
    const h = el.offsetHeight || el.getBoundingClientRect().height || 20;
    el.style.fontSize = (h * 0.50) + 'px'; // 想改整體倍率改這裡
  });
}
resizeAllTexts();
window.addEventListener('resize', resizeAllTexts);

/* ==============================
   強制橫向（不可手動關閉）
============================== */
const interElems = [btnSingle, btnTen, btnBag];
function isPortrait(){
  return window.matchMedia('(orientation: portrait)').matches || window.innerHeight > window.innerWidth;
}
function enforceLandscape(){
  const portrait = isPortrait();
  if (orientationModal) orientationModal.style.display = portrait ? 'flex' : 'none';
  document.body.style.overflow = portrait ? 'hidden' : '';
  interElems.forEach(el => el && (el.disabled = portrait || el._forceDisabled === true));
}
enforceLandscape();
window.addEventListener('resize', enforceLandscape);
window.addEventListener('orientationchange', enforceLandscape);
if (orientationModal) orientationModal.addEventListener('click', e => e.stopPropagation()); // 不能關

/* ==============================
   會話 / 逾期保護
============================== */
function ensureAuthOrRedirect(){
  const now = Math.floor(Date.now()/1000);
  if (!user || !B_TOKEN || (B_TOKEN_EXP && now >= B_TOKEN_EXP)) {
    alert('登入逾期，將返回玩家中心。');
    location.href = REDIRECT_PLAYER;
    return false;
  }
  return true;
}
setInterval(ensureAuthOrRedirect, 60*1000);
ensureAuthOrRedirect();

/* ==============================
   工具 & 狀態
============================== */
let pools = { normal: [], hidden: [], limited: [] };
let canDraw = true;   // 翻完才可再抽
let unlockAt = 0;     // 抽完 0.5 秒節流
function lockButtons(force=true){ [btnSingle,btnTen].forEach(b=>{ if(!b) return; b._forceDisabled = force; enforceLandscape(); }); }
function unlockButtons(){ [btnSingle,btnTen].forEach(b=>{ if(!b) return; b._forceDisabled = false; enforceLandscape(); }); }

/* ==============================
   初始化
============================== */
(async function boot(){
  if (!ensureAuthOrRedirect()) return;

  // 一次載三個池
  const [n, h, l] = await Promise.all([
    G('normal_characters').select('*').order('id',{ascending:true}),
    G('hidden_characters').select('*').order('id',{ascending:true}),
    G('limited_characters').select('*').order('id',{ascending:true}),
  ]);
  pools.normal  = Array.isArray(n.data) ? n.data : [];
  pools.hidden  = Array.isArray(h.data) ? h.data : [];
  pools.limited = Array.isArray(l.data) ? l.data : [];

  await ensureCounter();
  await refreshUIFromCounter();

  bindUI();

  // 管理端若改 max_draws，前端 15 秒同步一次
  setInterval(refreshUIFromCounter, 15000);
})();

/* ==============================
   Counter（吃資料庫 max_draws）
============================== */
async function ensureCounter(){
  const { data } = await G('counters').select('*').eq('player_id', user.id).single();
  if (!data){
    await G('counters').insert({ player_id: user.id, total_draws: 0, next_pity: 50 }); // max_draws 走 DB 預設
  }
}
async function getCounter(){
  const { data } = await G('counters')
    .select('total_draws,next_pity,max_draws')
    .eq('player_id', user.id).single();
  return data || { total_draws: 0, next_pity: 50, max_draws: 0 };
}
async function setCounter(total_draws, next_pity){
  await G('counters').upsert({ player_id: user.id, total_draws, next_pity }, { onConflict: 'player_id' });
}
async function refreshUIFromCounter(){
  const c = await getCounter();
  if (drawCounterEl) drawCounterEl.textContent = c.total_draws;
  const remain = Math.max(0, c.max_draws - c.total_draws);
  if (btnTen)    btnTen.disabled    = remain < 10 || btnTen._forceDisabled === true || isPortrait();
  if (btnSingle) btnSingle.disabled = remain <  1 || btnSingle._forceDisabled === true || isPortrait();
}

/* ==============================
   Owned 變更（穩定 upsert）
============================== */
async function addOwned(rarity, character_id, event_name){
  const { data: rows } = await G('owned_characters')
    .select('count')
    .eq('player_id', user.id)
    .eq('rarity', rarity)
    .eq('character_id', character_id)
    .eq('event_name', event_name)
    .limit(1);
  const prev = rows?.[0]?.count || 0;

  await G('owned_characters').upsert({
    player_id: user.id,
    rarity,
    event_name,
    character_id,
    count: prev + 1
  }, { onConflict: 'player_id,rarity,event_name,character_id' });
}

/* ==============================
   抽卡核心
   - 100 顆：1=銀、100=金、其餘白
   - 每 50 抽保底金
   - 上限吃 DB 的 max_draws
============================== */
async function drawOnce(){
  const c = await getCounter();
  if (c.total_draws >= c.max_draws) {
    alert('已達抽卡上限'); await refreshUIFromCounter(); return null;
  }

  let totalNext = c.total_draws + 1;
  let nextPity  = c.next_pity;

  let rarity, chosen, event_name = DEFAULT_EVENT;

  if (totalNext === nextPity) {
    rarity = 'limited';
    chosen = pick(pools.limited);
    event_name = chosen?.event_name || '活動';
    nextPity += 50;
  } else {
    const r = Math.floor(Math.random()*100) + 1; // 1..100
    if (r === 1)       { rarity = 'hidden';  chosen = pick(pools.hidden);  event_name = DEFAULT_EVENT; }
    else if (r === 100){ rarity = 'limited'; chosen = pick(pools.limited); event_name = chosen?.event_name || '活動'; }
    else               { rarity = 'normal';  chosen = pick(pools.normal);  event_name = DEFAULT_EVENT; }
  }

  if (!chosen) { alert('對應池子沒有資料'); return null; }

  await addOwned(rarity, chosen.id, event_name);
await setCounter(totalNext, nextPity);

  return { rarity, name: chosen.name, id: chosen.id, event_name, totalAfter: totalNext };
}

async function drawTenTimes(){
  const c = await getCounter();
  const remain = Math.max(0, c.max_draws - c.total_draws);
  if (remain < 10) { alert('剩餘抽數不足 10 抽'); return null; }

  const results = [];
  for (let i=0;i<10;i++){
    const r = await drawOnce();
    if (!r) break;
    results.push({ rarity: r.rarity, name: r.name });
  }
  return results;
}

/* ==============================
   Loader（百分比移動；字體大小交給 .auto-resize）
============================== */
const loaderEl  = $('#gacha-loader');
const fillEl    = $('#loader-fill');
const catEl     = $('#loader-cat');
const loaderTxt = $('#loader-text');

const Loader = {
  show(label='Roro爆肝中……'){
    if (loaderTxt) loaderTxt.textContent = label;
    if (fillEl) fillEl.style.width = '0%';
    if (catEl)  catEl.style.left  = '0%';
    loaderEl?.classList.add('show');
    resizeAllTexts();
  },
  async step(stepIndex, total){ // stepIndex: 1..total
    const pct = Math.max(0, Math.min(100, Math.round(stepIndex * (100/total))));
    fillEl && (fillEl.style.width = pct + '%');
    catEl  && (catEl.style.left  = pct + '%');
    await sleep(240); // 調節節奏（跟 CSS transition 差不多即可）
  },
  hide(){ loaderEl?.classList.remove('show'); }
};




function clearResults(){
  resultsContainer.classList.remove('single'); // 確保不是 single 佈局
  resultsContainer.innerHTML = '';             // 清空球
}

/* ==============================
   UI：建立球 / 翻牌與節流
============================== */
function createOrb(res, { autoReveal=false, revealDelay=0, big=false } = {}){
  const orb = document.createElement('div');
  orb.className = `gacha-orb orb-${res.rarity}` + (big?' big':'');
  const inner = document.createElement('div');
  inner.className = 'orb-inner auto-resize';
  inner.textContent = '';

  const reveal = () => {
    if (orb.classList.contains('revealed')) return;
    inner.textContent = res.name;
    orb.classList.add('revealed');
    resizeAllTexts();
    checkAllRevealed();
  };

  if (autoReveal) setTimeout(reveal, revealDelay);
  else orb.addEventListener('click', reveal);

  orb.appendChild(inner);
  return orb;
}

function checkAllRevealed(){
  const orbs = $$('.gacha-orb', resultsContainer);
  if (orbs.length === 0) return;
  const all = orbs.every(o => o.classList.contains('revealed'));
  if (all) {
    unlockAt = Date.now() + 500;
    setTimeout(()=>{ canDraw = true; unlockButtons(); }, 500); // 0.5s 節流
  }
}

function showResultsTen(results){
  canDraw = false; lockButtons(true);
  resultsContainer.classList.remove('single');
  resultsContainer.innerHTML = '';
  for (let row=0; row<2; row++){
    const rowDiv = document.createElement('div');
    rowDiv.className = 'gacha-row';
    results.slice(row*5, row*5+5).forEach((res, idx)=>{
      const index = row*5 + idx;
      const orb = createOrb(res, { autoReveal: res.rarity==='normal', revealDelay: index*200 });
      rowDiv.appendChild(orb);
    });
    resultsContainer.appendChild(rowDiv);
  }
  resizeAllTexts();
}

function showResultSingle(res){
  canDraw = false; lockButtons(true);
  resultsContainer.classList.add('single');
  resultsContainer.innerHTML = '';
  const isWhite = res.rarity === 'normal';
  const orb = createOrb(res, { autoReveal:isWhite, revealDelay:0, big:true });
  const rowDiv = document.createElement('div');
  rowDiv.className = 'gacha-row';
  rowDiv.style.justifyContent = 'center';
  rowDiv.appendChild(orb);
  resultsContainer.appendChild(rowDiv);
  resizeAllTexts();
  if (isWhite) { unlockAt = Date.now() + 500; setTimeout(()=>{ canDraw = true; unlockButtons(); }, 500); }
}

/* ==============================
   背包（需翻完；每行 3 個；依 ID 排序；合併重複）
============================== */
function nameFromPools(rarity, character_id, event_name){
  if (rarity === 'normal') return pools.normal.find(x=>x.id===character_id)?.name || `#${character_id}`;
  if (rarity === 'hidden') return pools.hidden.find(x=>x.id===character_id)?.name || `#${character_id}`;
  const hit = pools.limited.find(x=>x.id===character_id && x.event_name===event_name) || pools.limited.find(x=>x.id===character_id);
  return hit ? hit.name : `#${character_id}`;
}

async function openBackpack(){
  const orbs = $$('.gacha-orb', resultsContainer);
  if (orbs.some(o=>!o.classList.contains('revealed'))) {
    alert('請先翻開所有扭蛋！'); return;
  }

  infoTitle.textContent = `${PLAYER_NAME}的背包`;

  const { data, error } = await G('owned_characters')
    .select('rarity,event_name,character_id,count')
    .eq('player_id', user.id);

  if (error) { console.error('[owned_characters] query error:', error); alert('讀取背包失敗'); return; }
  const rows = Array.isArray(data) ? data : [];

  // 合併同 key
  const byKey = new Map();
  for (const r of rows){
    const key = `${r.rarity}|${r.event_name}|${r.character_id}`;
    const v = byKey.get(key);
    byKey.set(key, v ? { ...r, count: v.count + r.count } : { ...r });
  }
  const merged = [...byKey.values()];

  // 排序 & 分組
  const limited=[], hidden=[], normal=[];
  const byId = a=>a.sort((x,y)=>(x.id??0)-(y.id??0));
  merged.forEach(r=>{
    const nm = nameFromPools(r.rarity, r.character_id, r.event_name);
    const item = { id:r.character_id, html:`${escapeHtml(nm)} × <span>${r.count}</span>` };
    if (r.rarity==='limited')      limited.push(item);
    else if (r.rarity==='hidden')  hidden.push(item);
    else                           normal.push(item);
  });
  byId(limited); byId(hidden); byId(normal);

  const joinRows = (arr, len=3)=>{
    const lines=[]; for(let i=0;i<arr.length;i+=len){ lines.push(arr.slice(i,i+len).map(x=>x.html).join('、 ')); }
    return lines.join('<br>');
  };

  let html='';
  if (limited.length) html += `<div class="backpack-section"><h3>活動限定饅頭：</h3><div class="backpack-items">${joinRows(limited,3)}</div></div>`;
  if (hidden.length)  html += `<div class="backpack-section"><h3>隱藏饅頭：</h3><div class="backpack-items">${joinRows(hidden,3)}</div></div>`;
  if (normal.length)  html += `<div class="backpack-section"><h3>普通饅頭：</h3><div class="backpack-items">${joinRows(normal,3)}</div></div>`;
  if (!html) html = '<div class="backpack-items">目前沒有任何饅頭</div>';

  infoBody.innerHTML = html;
  infoModal.style.display = 'flex';
  resizeAllTexts();
}
infoModal?.addEventListener('click', ()=> infoModal.style.display='none');
infoModal?.querySelector('.modal-content')?.addEventListener('click', e=> e.stopPropagation());

/* ==============================
   綁定按鈕 + Loader 節奏（先抽→再推進→關閉→顯示）
============================== */
function bindUI(){
  btnBag?.addEventListener('click', openBackpack);

btnSingle?.addEventListener('click', async ()=>{
  if (!ensureAuthOrRedirect()) return;
  if (!canDraw || Date.now() < unlockAt) return alert('稍等一下…');

  gachaBtns?.classList.add('bottom');
  lockButtons(true);

  // 先清空畫面，再顯示跑條
  clearResults();
  Loader.show('Roro爆肝中……');

  // 真抽
  const r = await drawOnce();
  if (!r) {
    Loader.hide();
    await refreshUIFromCounter();
    unlockButtons();
    return;
  }

  // 跑條前進到 1/1
  await Loader.step(1, 1);
  Loader.hide();

  await refreshUIFromCounter();
  showResultSingle({ rarity: r.rarity, name: r.name });
});


btnTen?.addEventListener('click', async ()=>{
  if (!ensureAuthOrRedirect()) return;
  if (!canDraw || Date.now() < unlockAt) return alert('稍等一下…');

  const c = await getCounter();
  if (c.max_draws - c.total_draws < 10) {
    return alert('剩餘抽數不足 10 抽');
  }

  gachaBtns?.classList.add('bottom');
  lockButtons(true);

  // 先清空畫面，再顯示跑條
  clearResults();
  Loader.show('Roro爆肝中……');

  const results = [];
  for (let i = 0; i < 10; i++) {
    const r = await drawOnce();
    if (!r) break;
    results.push({ rarity: r.rarity, name: r.name });

    // 每抽到一顆，就把跑條往前推一格
    await Loader.step(i + 1, 10);
  }

  Loader.hide();

  if (!results.length) {
    unlockButtons();
    return;
  }

  await refreshUIFromCounter();
  showResultsTen(results);
});


  const obs = new MutationObserver(()=>{ resizeAllTexts(); checkAllRevealed(); });
  obs.observe(resultsContainer, { childList:true, subtree:true });
}

</script>

</body>
</html>
