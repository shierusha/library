<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>謝爾夏｜扭蛋系統1.0 </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* ==============================
   全域背景 / 字體
============================== */
body {
  background: url('https://shierusha.github.io/create-student/imgs/citybg.png') center center no-repeat;
  background-size: cover;
  min-height: 100vh;
  font-family: 'Noto Sans TC', sans-serif;
  overflow: hidden;
}
body::before {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(255,255,255,0.3);
  z-index: 0;
  pointer-events: none;
}
body.dark-bg::before {
  background: rgba(0,0,0,0.3);
}

/* ==============================
   16:9 容器
============================== */
.container-16-9 {
  position: relative;
  max-width: 90%;
  max-height: 90vh;
  aspect-ratio: 16/9;
  overflow: hidden;
  border-radius: 16px;
  box-shadow: 0 0 24px #0004;
  margin: 5vh auto;
}
.bg-img {
  position: absolute; inset: 0;
  width: 100%; height: 100%;
  object-fit: cover;
  z-index: 1;
}

/* ==============================
   Modal（旋轉 / 背包）
============================== */


.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  z-index: 2000;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: modal-fadein-bg 0.25s;
}
@keyframes modal-fadein-bg {
  from { background: rgba(0,0,0,0);}
  to   { background: rgba(0,0,0,0.45);}
}

.modal-content {

  background: rgb(13 27 77 / 82%);      /* 深藍色 + 70%透明 */
  border-radius: 18px;
  border: 2px solid #1eb5e5;              /* 藍色外框 */
  box-shadow: 0 0 16px 2px #62f1fe88,     /* 外發光 */
              0 8px 32px #1eb5e5aa;       /* 藍色下陰影 */
  width: 500px;
  max-width: 93vw;
  height: 340px;
  max-height: 80vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  animation: modal-pop 0.32s cubic-bezier(.42,1.4,.51,1.01);
}
@keyframes modal-pop {
  from { opacity: 0; transform: scale(0.92);}
  to   { opacity: 1; transform: scale(1);}
}

.modal-header {
  background: none;
  padding: 15px 20px 0px 24px;
  color: #fff;
  font-size: 1.5em;
  font-weight: bold;
  letter-spacing: 1px;
  text-shadow: 0 1px 4px #000a;
}

.modal-header::after {
content: "";
display: block;
height: 5px;
width: 70%;
margin: 0.5rem 0 0 0;
border-radius: 2px;
background: linear-gradient(
to right,
 #53e2ff99 65%,
#53e2ff00 100%
);
pointer-events: none;

}


.modal-body {
  color: #fff;
  padding: 12px 24px 24px 24px;
  font-size: 1.2em;
  line-height: 1.5;
  text-shadow: 0 1px 4px #0008;
  overflow-y: auto;
  word-break: break-all;  /* or break-word; 都可以 */
  max-height: 240px;      /* 依照 modal 高度調整 */
  white-space: pre-line;
  overflow: auto;
  scrollbar-width: none;          /* Firefox */
  -ms-overflow-style: none;       /* IE & Edge */
}

.modal-body::-webkit-scrollbar {
  display: none;                  /* Chrome & Safari */
}





 /*翻轉按鈕 */
 .row-flip-btn {
  display: flex;
width: 80%; 
height: 80%;
}


.flip-btn {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  background: rgba(250,250,250,0.8); 
  color: #495079;
  border: none;
  border-radius: 12px;
  font-weight: 900;
  cursor: pointer;
  box-shadow: 0 2px 8px #0002;
  transition: background 0.18s, transform 0.13s;
  position: relative;
  outline: none;
  align-items: center;
  justify-content: center; /* 讓內文居中 */

}

.flip-btn:hover {
  background: #fdffb8; 
  transform: translateY(-2px) scale(1.04);
}

/* 箭頭樣式 */
.flip-btn .arrow {
  display: inline-block;
  width: 0.35em;
  height: 0.4em;
  margin-left: 0.12em;
  margin-top: 0.1em;
border-right: 0.22em solid #495079;
border-bottom: 0.22em solid #495079;
  transform: rotate(-45deg);
  vertical-align: middle;
  content: "";
}

/* ==============================
   抽卡按鈕（初始置中 → 抽卡後移到底部）
============================== */
.gacha-buttons {
  position: absolute;
  bottom: 45%; /* 初始居中 */
  left: 50%; transform: translateX(-50%);
  display: flex; gap: 10%;
  width: 60%; height: 11%;
  z-index: 10;
  transition: bottom 0.4s ease;
}
.gacha-buttons.bottom { bottom: 16%; } /* 抽卡後固定下方 */
.gacha-btn {
  flex: 1; height: 100%;
  border-radius: 12px;
  background: rgb(13 27 77 / 82%);
  border: 2px solid #1eb5e5; color: #fff; font-weight: bold;
  cursor: pointer; transition: all 0.25s;
  box-shadow: 0 0 12px #53e2ff88, 0 0 24px #1eb5e577 inset;
}
.gacha-btn:hover {
  background: #1eb5e5cc;
  box-shadow: 0 0 18px #53e2ffdd, 0 0 36px #1eb5e5aa inset;
}

/* ==============================
   抽卡結果（十連 / 單抽共用容器）
============================== */
.gacha-results {
  position: absolute;
  top: 12%; left: 50%; transform: translateX(-50%);
  display: flex; flex-direction: column;
  gap: 16px; width: 80%; height: 55%;
  z-index: 9;
}

/* 十連抽：兩行五顆 */
.gacha-row {
  display: flex; justify-content: space-between;
  width: 100%; gap: 12px;
}

/* 抽卡球（圓形 + 內部不可見方框承載文字） */
.gacha-orb {
  position: relative; flex: 1;
  aspect-ratio: 1/1; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  overflow: hidden; cursor: pointer; user-select: none;
  transition: all 0.3s ease;
}
.orb-inner {
  width: 90%; height: 50%;
  display: flex; align-items: center; justify-content: center;
  text-align: center; line-height: 1.2; font-weight: bold;
}

/* 球初始顏色（未翻開） */
.orb-normal  { background: #fff;    border: 3px solid #ccc; }
.orb-hidden  { background: #c0c0c0; border: 3px solid #aaa; }
.orb-limited { background: gold;    border: 3px solid orange; }

/* 翻開後 → 空心圓框 + 對應顏色文字 */
.gacha-orb.revealed { background: transparent; }
.orb-normal.revealed  { border: 3px solid #fff;    color: #fff; }
.orb-hidden.revealed  { border: 3px solid #c0c0c0; color: #c0c0c0; }
.orb-limited.revealed { border: 3px solid gold;    color: #ffd700; }

/* 單抽模式容器：置中 */
.gacha-results.single {
  display: flex;
  align-items: center;
  justify-content: center;
}

/* 大球：佔滿容器高度（保持正圓） */
.gacha-orb.big {
  aspect-ratio: 1/1;   /* 保持正圓 */
  max-width: 25%;      /* 不要超過寬度 */
}


/* ==============================
   HUD（右下角）
============================== */
.gacha-hud {
  position: absolute;
  bottom: 7%;
  right: 4%;
  display: flex;
  align-items: center;
  gap: 1rem;
  z-index: 30;
  color: #fff;
  text-shadow: 0 1px 4px #000a;
  height: 10%;    
}

/* 累積抽數：不可見框讓 JS 依高度算字體 */
.counter-box {
  height: 100%;
  display: flex;
  align-items: center;
  font-weight: bold;
  padding: 0 6px;
  border-radius: 4px;
  background: rgba(255,255,255,0.01); /* 1% 透明，確保有尺寸 */
}
.gacha-counter {
position: absolute;
  bottom: 7%;
  right: 20%;
  gap: 1rem;
  z-index: 30;
  color: #fff;
  text-shadow: 0 1px 4px #000a;
  height: 10%;    
}

.gacha-results { z-index: 10; }


/* 背包按鈕 + 不可見框 */
.gacha-backpack {
  height: 100%; aspect-ratio: 2.5/1;
  border: 2px solid #1eb5e5; border-radius: 8px;
  background: rgb(13 27 77 / 82%); color: #fff;
  cursor: pointer; transition: all 0.25s;
  box-shadow: 0 0 8px #53e2ff88, 0 0 16px #1eb5e577 inset;
  display: flex; align-items: center; justify-content: center;
}
.backpack-box {
  height: 100%; display: flex; align-items: center; justify-content: center;
}

/* 背包 modal 的列表字體與數字顏色（JS 亦會縮放） */
.backpack-section { margin: 0.5rem 0; }
.backpack-section h3 { color: #53e2ff; margin-bottom: 0.3rem; }
.backpack-items { color: #fff; }
.backpack-items span { color: #ffe082; font-weight: bold; }

</style>
</head>
<body class="dark-bg">
<!-- 16:9 主要容器 -->
<div class="container-16-9">
  <!-- 抽卡結果容器（單抽/十連共用） -->
  <div class="gacha-results" id="gacha-results"></div>

  <!-- 抽卡按鈕（初始置中，抽卡後會滑到下方） -->
  <div class="gacha-buttons">
    <button id="btn-single" class="gacha-btn">單抽</button>
    <button id="btn-ten" class="gacha-btn">十連抽</button>
  </div>


  <!--  HUD 要在這層 -->
  <div class="gacha-hud">
    <button id="btn-backpack" class="gacha-backpack">
      <div class="backpack-box">背包</div>
    </button>
  </div>
  
    <div class="gacha-counter">
      <div class="counter-box">累積抽數：
        <span id="draw-count">0</span>
      </div>
    </div>
  <!-- 背景圖 -->
  <img class="bg-img" src="https://shierusha.github.io/school-battle/teachers/img/8.webp" alt="background">
</div>

<!-- 旋轉提示（不可關閉） -->
<div id="orientation-modal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">請旋轉螢幕</div>
    <div class="modal-body">為了最佳體驗，請將裝置轉成橫向模式</div>
  </div>
</div>

<!-- 背包 Modal（可隨意點背景關閉） -->
<div id="info-modal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <div class="modal-header" id="info-modal-title">標題</div>
    <div class="modal-body" id="info-modal-body"></div>
  </div>
</div>
<script>
/* ==============================
   小工具
============================== */
function escapeHtml(s){return (s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]))}
function pick(arr){ return arr[Math.floor(Math.random() * arr.length)] }
function decodeJWT(t){
  if(!t) return null;
  const pad=s=>s+'='.repeat((4-s.length%4)%4);
  const [,p]=t.split('.');
  try{ return JSON.parse(atob(pad(p).replace(/-/g,'+').replace(/_/g,'/'))) }catch{ return null }
}
/* ==============================
   Supabase（圖書館 B 專案）
============================== */
const B_URL  = 'https://ogzpfrkwnqqaitytncla.supabase.co';
const B_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9nenBmcmt3bnFxYWl0eXRuY2xhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxODQzNzEsImV4cCI6MjA3MDc2MDM3MX0.Ls83xOXcKIW7FUcavr8_sOs37I18VGFWYNW3sNFRS24';
const B_TOKEN = localStorage.getItem('gacha_b_jwt') || '';
const B_TOKEN_EXP = Number(localStorage.getItem('gacha_b_jwt_exp') || 0);
const PLAYER_NAME = localStorage.getItem('gacha_player_name') || '我的';
const REDIRECT_PLAYER = 'https://shierusha.github.io/create-student/player';

function decodeJWT(t){
  if(!t) return null;
  const pad = s => s + '='.repeat((4 - s.length % 4) % 4);
  const payload = t.split('.')[1];
  try { return JSON.parse(atob(pad(payload).replace(/-/g,'+').replace(/_/g,'/'))); }
  catch { return null; }
}

let sb = window.supabase.createClient(B_URL, B_ANON, {
  global: { headers: B_TOKEN ? { Authorization: `Bearer ${B_TOKEN}` } : {} }
});
if (B_TOKEN) sb.realtime.setAuth(B_TOKEN);

const user = B_TOKEN ? { id: (decodeJWT(B_TOKEN)||{}).sub } : null;
const DEFAULT_EVENT = '常駐';

/* ==============================
   DOM 快取
============================== */
const resultsContainer = document.getElementById('gacha-results');
const btnSingle  = document.getElementById('btn-single');
const btnTen     = document.getElementById('btn-ten');
const btnBag     = document.getElementById('btn-backpack');
const gachaBtns  = document.querySelector('.gacha-buttons');
const infoModal  = document.getElementById('info-modal');
const infoTitle  = document.getElementById('info-modal-title');
const infoBody   = document.getElementById('info-modal-body');
const drawCounterEl = document.getElementById('draw-count');

/* ==============================
   強制橫向（不可手動關閉）
============================== */
const orientationModal = document.getElementById('orientation-modal');
const interElems = [btnSingle, btnTen, btnBag];
function isPortrait(){
  return window.matchMedia('(orientation: portrait)').matches || window.innerHeight > window.innerWidth;
}
function enforceLandscape(){
  const portrait = isPortrait();
  orientationModal.style.display = portrait ? 'flex' : 'none';
  document.body.style.overflow = portrait ? 'hidden' : '';
  interElems.forEach(el => el && (el.disabled = portrait || el._forceDisabled === true));
}
enforceLandscape();
window.addEventListener('resize', enforceLandscape);
window.addEventListener('orientationchange', enforceLandscape);
orientationModal.addEventListener('click', e => e.stopPropagation()); // 不能關

/* ==============================
   會話 / 逾期保護
============================== */
function ensureAuthOrRedirect(){
  const now = Math.floor(Date.now()/1000);
  if (!user || !B_TOKEN || (B_TOKEN_EXP && now >= B_TOKEN_EXP)){
    alert('登入逾期，將返回玩家中心。');
    location.href = REDIRECT_PLAYER;
    return false;
  }
  return true;
}
setInterval(ensureAuthOrRedirect, 60*1000); // 每分鐘檢查
ensureAuthOrRedirect();

/* ==============================
   工具 & 狀態
============================== */
const G = (t) => sb.from(`gacha.${t}`);
const escapeHtml = s => (s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
const pick = arr => arr[Math.floor(Math.random()*arr.length)];
let pools = { normal: [], hidden: [], limited: [] };

let canDraw = true;                 // 要翻完才會開
let unlockAt = 0;                   // 抽完後 0.5 秒節流
function lockButtons(force=true){ [btnSingle,btnTen].forEach(b=>{ if(!b) return; b._forceDisabled = force; enforceLandscape(); }); }
function unlockButtons(){ [btnSingle,btnTen].forEach(b=>{ if(!b) return; b._forceDisabled = false; enforceLandscape(); }); }

/* ==============================
   初始化
============================== */
(async function boot(){
  // 未登入只允許看背包空畫面
  if (!ensureAuthOrRedirect()) return;

  // 載池
  const [n, h, l] = await Promise.all([
    G('normal_characters').select('*').order('id',{ascending:true}),
    G('hidden_characters').select('*').order('id',{ascending:true}),
    G('limited_characters').select('*').order('id',{ascending:true}),
  ]);
  pools.normal  = n.data || [];
  pools.hidden  = h.data || [];
  pools.limited = l.data || [];

  // 建立/讀取保底
  await ensureCounter();
  await refreshUIFromCounter();

  // 綁定
  bindUI();
})();

/* ==============================
   Counter
============================== */
async function ensureCounter(){
  const { data, error } = await G('counters').select('*').eq('player_id', user.id).single();
  if (!data){
    await G('counters').insert({ player_id: user.id, total_draws: 0, next_pity: 50, max_draws: 1000 });
  }
}
async function getCounter(){
  const { data } = await G('counters').select('total_draws,next_pity,max_draws').eq('player_id', user.id).single();
  return data || { total_draws: 0, next_pity: 50, max_draws: 1000 };
}
async function setCounter(total_draws, next_pity){
  await G('counters').upsert({ player_id: user.id, total_draws, next_pity }, { onConflict: 'player_id' });
}
async function refreshUIFromCounter(){
  const c = await getCounter();
  drawCounterEl.textContent = c.total_draws;
  const remain = Math.max(0, (c.max_draws ?? 1000) - c.total_draws);
  btnTen.disabled   = remain < 10 || btnTen._forceDisabled === true || isPortrait();
  btnSingle.disabled= remain < 1  || btnSingle._forceDisabled === true || isPortrait();
}

/* ==============================
   Own 增量（穩定 upsert）
============================== */
async function addOwned(rarity, character_id, event_name){
  // 查現值
  let q = G('owned_characters')
    .select('count')
    .eq('player_id', user.id)
    .eq('rarity', rarity)
    .eq('character_id', character_id)
    .eq('event_name', event_name)
    .maybeSingle?.() ?? G('owned_characters').select('count').limit(1); // 兼容舊版
  const { data: row } = await q;
  const prev = row?.count || 0;

  await G('owned_characters').upsert({
    player_id: user.id,
    rarity,
    event_name,
    character_id,
    count: prev + 1
  }, { onConflict: 'player_id,rarity,event_name,character_id' });
}

/* ==============================
   抽卡核心
============================== */
async function drawOnce(){
  const c = await getCounter();
  if (c.total_draws >= (c.max_draws ?? 1000)) {
    alert('已達抽卡上限'); await refreshUIFromCounter(); return null;
  }

  let totalNext = c.total_draws + 1;
  let nextPity  = c.next_pity;

  let rarity, chosen, event_name = DEFAULT_EVENT;

  if (totalNext === nextPity) {
    rarity = 'limited';
    chosen = pick(pools.limited);
    event_name = chosen?.event_name || '活動';
    nextPity += 50;
  } else {
    const r = Math.floor(Math.random()*100) + 1; // 1..100
    if (r === 1) { // 銀
      rarity = 'hidden'; chosen = pick(pools.hidden); event_name = DEFAULT_EVENT;
    } else if (r === 100) { // 金
      rarity = 'limited'; chosen = pick(pools.limited); event_name = chosen?.event_name || '活動';
    } else { // 白
      rarity = 'normal'; chosen = pick(pools.normal); event_name = DEFAULT_EVENT;
    }
  }
  if (!chosen) return null;

  await addOwned(rarity, chosen.id, event_name);
  await setCounter(totalNext, nextPity);
  return { rarity, name: chosen.name, id: chosen.id, event_name, totalAfter: totalNext };
}

async function drawTenTimes(){
  const c = await getCounter();
  const remain = Math.max(0, (c.max_draws ?? 1000) - c.total_draws);
  if (remain < 10) { alert('剩餘抽數不足 10 抽'); return null; }

  const results = [];
  for (let i=0;i<10;i++){
    const r = await drawOnce();
    if (!r) break;
    results.push({ rarity: r.rarity, name: r.name });
  }
  return results;
}

/* ==============================
   UI：建立球 / 翻牌與節流
============================== */
function resizeAllTexts() {
  document.querySelectorAll('.gacha-btn').forEach(btn => btn.style.fontSize = (btn.offsetHeight * 0.40) + "px");
  document.querySelectorAll('.orb-inner').forEach(inner => inner.style.fontSize = (inner.offsetHeight * 0.35) + "px");
  document.querySelectorAll('.counter-box').forEach(box => box.style.fontSize = (box.offsetHeight * 0.50) + "px");
  document.querySelectorAll('.backpack-box').forEach(box => box.style.fontSize = (box.offsetHeight * 0.50) + "px");
  document.querySelectorAll('.backpack-items span').forEach(span => {
    const h = (span.offsetHeight || 20); span.style.fontSize = (h * 0.80) + "px";
  });
}
window.addEventListener('resize', resizeAllTexts);
resizeAllTexts();

function createOrb(res, { autoReveal=false, revealDelay=0, big=false } = {}){
  const orb = document.createElement('div');
  orb.className = `gacha-orb orb-${res.rarity}` + (big?' big':'');
  const inner = document.createElement('div');
  inner.className = 'orb-inner';
  inner.textContent = '';

  const reveal = () => {
    if (orb.classList.contains('revealed')) return;
    inner.textContent = res.name;
    orb.classList.add('revealed');
    resizeAllTexts();
    checkAllRevealed();
  };

  if (autoReveal) setTimeout(reveal, revealDelay);
  else orb.addEventListener('click', reveal);

  orb.appendChild(inner);
  return orb;
}

function checkAllRevealed(){
  const orbs = resultsContainer.querySelectorAll('.gacha-orb');
  if (orbs.length === 0) return;
  const all = [...orbs].every(o => o.classList.contains('revealed'));
  if (all) {
    // 抽完開放操作，但額外 0.5 秒節流
    unlockAt = Date.now() + 500;
    setTimeout(()=>{ canDraw = true; unlockButtons(); }, 500);
  }
}

function showResultsTen(results){
  canDraw = false; lockButtons(true);
  resultsContainer.classList.remove('single');
  resultsContainer.innerHTML = '';
  for (let row=0; row<2; row++){
    const rowDiv = document.createElement('div');
    rowDiv.className = 'gacha-row';
    results.slice(row*5, row*5+5).forEach((res, idx)=>{
      const index = row*5 + idx;
      const isWhite = res.rarity === 'normal';
      const orb = createOrb(res, { autoReveal:isWhite, revealDelay:index*200 });
      rowDiv.appendChild(orb);
    });
    resultsContainer.appendChild(rowDiv);
  }
  resizeAllTexts();
}

function showResultSingle(res){
  canDraw = false; lockButtons(true);
  resultsContainer.classList.add('single');
  resultsContainer.innerHTML = '';
  const isWhite = res.rarity === 'normal';
  const orb = createOrb(res, { autoReveal:isWhite, revealDelay:0, big:true });
  const rowDiv = document.createElement('div');
  rowDiv.className = 'gacha-row';
  rowDiv.style.justifyContent = 'center';
  rowDiv.appendChild(orb);
  resultsContainer.appendChild(rowDiv);
  resizeAllTexts();
  if (isWhite) { unlockAt = Date.now() + 500; setTimeout(()=>{ canDraw = true; unlockButtons(); }, 500); }
}

/* ==============================
   背包（每行 3 個，依 ID）
============================== */
function nameFromPools(rarity, character_id, event_name){
  if (rarity === 'normal') return pools.normal.find(x=>x.id===character_id)?.name || `#${character_id}`;
  if (rarity === 'hidden') return pools.hidden.find(x=>x.id===character_id)?.name || `#${character_id}`;
  const hit = pools.limited.find(x=>x.id===character_id && x.event_name===event_name) || pools.limited.find(x=>x.id===character_id);
  return hit ? hit.name : `#${character_id}`;
}

async function openBackpack(){
  // 必須翻完才能開
  const orbs = resultsContainer.querySelectorAll('.gacha-orb');
  if ([...orbs].some(o=>!o.classList.contains('revealed'))) {
    alert('請先翻開所有扭蛋！'); return;
  }

  infoTitle.textContent = `${PLAYER_NAME}的背包`;

  const { data: rows=[] } = await G('owned_characters')
    .select('rarity,event_name,character_id,count')
    .eq('player_id', user.id);

  // 合併保險（理論上不會重複）
  const byKey = new Map();
  for (const r of rows){
    const key = `${r.rarity}|${r.event_name}|${r.character_id}`;
    const v = byKey.get(key);
    byKey.set(key, v ? { ...r, count: v.count + r.count } : { ...r });
  }
  const merged = [...byKey.values()];

  // 排序 & 分組
  const limited=[], hidden=[], normal=[];
  merged.forEach(r=>{
    const nm = nameFromPools(r.rarity, r.character_id, r.event_name);
    const item = { id:r.character_id, html:`${escapeHtml(nm)} × <span>${r.count}</span>` };
    if (r.rarity==='limited') limited.push(item);
    else if (r.rarity==='hidden') hidden.push(item);
    else normal.push(item);
  });
  const byId = a=>a.sort((x,y)=>(x.id??0)-(y.id??0));
  byId(limited); byId(hidden); byId(normal);

  const joinRows = (arr, len=3)=>{
    const lines=[]; for(let i=0;i<arr.length;i+=len){ lines.push(arr.slice(i,i+len).map(x=>x.html).join('、 ')); }
    return lines.join('<br>');
  };

  let html='';
  if (limited.length) html += `<div class="backpack-section"><h3>活動限定饅頭：</h3><div class="backpack-items">${joinRows(limited)}</div></div>`;
  if (hidden.length)  html += `<div class="backpack-section"><h3>隱藏饅頭：</h3><div class="backpack-items">${joinRows(hidden)}</div></div>`;
  if (normal.length)  html += `<div class="backpack-section"><h3>普通饅頭：</h3><div class="backpack-items">${joinRows(normal)}</div></div>`;
  if (!html) html = '<div class="backpack-items">目前沒有任何饅頭</div>';

  infoBody.innerHTML = html;
  infoModal.style.display = 'flex';
  resizeAllTexts();
}
infoModal.addEventListener('click', ()=> infoModal.style.display='none');
infoModal.querySelector('.modal-content').addEventListener('click', e=> e.stopPropagation());

/* ==============================
   綁定按鈕
============================== */
function bindUI(){
  btnBag.addEventListener('click', openBackpack);

  btnSingle.addEventListener('click', async ()=>{
    if (!ensureAuthOrRedirect()) return;
    if (!canDraw || Date.now()<unlockAt) return alert('稍等一下…');
    gachaBtns.classList.add('bottom');
    lockButtons(true);

    const r = await drawOnce();
    if (!r) { unlockButtons(); return; }
    await refreshUIFromCounter();
    showResultSingle({ rarity:r.rarity, name:r.name });
  });

  btnTen.addEventListener('click', async ()=>{
    if (!ensureAuthOrRedirect()) return;
    if (!canDraw || Date.now()<unlockAt) return alert('稍等一下…');
    // 檢查剩餘抽數
    const c = await getCounter();
    if ((c.max_draws ?? 1000) - c.total_draws < 10) { alert('剩餘抽數不足 10 抽'); return; }

    gachaBtns.classList.add('bottom');
    lockButtons(true);

    const results = await drawTenTimes();
    if (!results) { unlockButtons(); return; }
    await refreshUIFromCounter();
    showResultsTen(results);
  });

  // 監控 DOM 變化，全部翻完即解鎖（已內建 0.5s 節流）
  const obs = new MutationObserver(()=>{ resizeAllTexts(); checkAllRevealed(); });
  obs.observe(resultsContainer, { childList:true, subtree:true });
}



</body>
</html>
