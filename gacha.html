<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>謝爾夏｜扭蛋系統2.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- 選池倫波外掛 CSS -->
  <link rel="stylesheet" href="https://shierusha.github.io/library/assets/css/pool-carousel.css"/>

  <style>
/* ==============================
   全域背景 / 字體
============================== */
body {
  background: url('https://shierusha.github.io/create-student/imgs/citybg.png') center center no-repeat;
  background-size: cover;
  min-height: 100vh;
  font-family: 'Noto Sans TC', sans-serif;
  overflow: hidden;
}
body.dark-bg::before {
  content: "";
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.3);
  z-index: 0; pointer-events: none;
}

/* ==============================
   16:9 容器
============================== */
.container-16-9 {
  position: relative;
  max-width: 90%;
  max-height: 80vh;
  aspect-ratio: 16/9;
  overflow: hidden;
  border-radius: 16px;
  box-shadow: 0 0 24px #0004;
  margin: 3vh auto;
}
.bg_img {
  position: absolute; inset: 0;
  width: 100%; height: 100%;
  object-fit: cover;
  z-index: 1;
}

/* ==============================
   Modal（旋轉 / 背包）
============================== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  z-index: 2000;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: modal-fadein-bg 0.25s;
}
@keyframes modal-fadein-bg {
  from { background: rgba(0,0,0,0); }
  to   { background: rgba(0,0,0,0.45); }
}
.modal-content {
  background: rgb(13 27 77 / 82%);
  border-radius: 18px;
  border: 2px solid #1eb5e5;
  box-shadow: 0 0 16px 2px #62f1fe88, 0 8px 32px #1eb5e5aa;
  width: 500px; max-width: 93vw;
  height: 340px; max-height: 80vh;
  display: flex; flex-direction: column;
  overflow: hidden;
  animation: modal-pop 0.32s cubic-bezier(.42,1.4,.51,1.01);
}
@keyframes modal-pop {
  from { opacity: 0; transform: scale(0.92); }
  to   { opacity: 1; transform: scale(1); }
}
.modal-header {
  background: none;
  padding: 15px 20px 0px 24px;
  color: #fff; font-size: 1.5em; font-weight: bold;
  letter-spacing: 1px; text-shadow: 0 1px 4px #000a;
}
.modal-header::after {
  content: ""; display: block; height: 5px; width: 70%;
  margin:.5rem 0 0; border-radius: 2px;
  background: linear-gradient(to right,#53e2ff99 65%,#53e2ff00 100%);
  pointer-events: none;
}
.modal-body {
  color:#fff; padding: 12px 24px 24px 24px;
  font-size: 1.2em; line-height:1.5; text-shadow:0 1px 4px #0008;
  overflow-y:auto; max-height:240px; white-space: pre-line;
  scrollbar-width:none;
}
.modal-body::-webkit-scrollbar { display:none; }

/* ==============================
   抽卡按鈕
============================== */
.gacha-buttons {
  position: absolute;
  bottom: 15%;
  left: 50%; transform: translateX(-50%);
  display: flex; gap: 10%;
  width: 60%; height: 11%;
  z-index: 10;
  transition: bottom 0.4s ease;
}
.gacha-btn.inactive { border: none; box-shadow: none; }
.gacha-btn {
  flex: 1; height: 100%;
  border-radius: 12px;
  background: rgb(13 27 77 / 82%);
  border: 2px solid #1eb5e5; color: #fff; font-weight: bold;
  cursor: pointer; transition: all 0.25s;
  box-shadow: 0 0 12px #53e2ff88, 0 0 24px #1eb5e577 inset;
}
.gacha-btn:hover {
  background: #1eb5e5cc;
  box-shadow: 0 0 18px #53e2ffdd, 0 0 36px #1eb5e5aa inset;
}

/* ==============================
   抽卡結果容器
============================== */
.gacha-results {
  position: absolute;
  top: 5%; left: 50%; transform: translateX(-50%);
  display: flex; flex-direction: column;
  width: 80%; height: 66%;
  z-index: 9;
}
.gacha-row {
  display: flex; justify-content: space-between;
  width: 100%; gap: 12px;
  margin-top: 4%;
}
.gacha-orb {
  position: relative; flex: 1;
  aspect-ratio: 1/1; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  overflow: hidden; cursor: pointer; user-select: none;
  transition: all 0.3s ease;
}
.orb-inner {
  width: 90%; height: 35%;
  display: flex; align-items: center; justify-content: center;
  text-align: center; line-height: 1.2; font-weight: bold;
}
.orb-normal  { background: #fff;    border: 3px solid #ccc; }
.orb-hidden  { background: #c0c0c0; border: 3px solid #aaa; }
.orb-limited { background: gold;    border: 3px solid orange; }
.gacha-orb.revealed { background: transparent; }
.orb-normal.revealed  { border: 3px solid #fff;    color: #fff; }
.orb-hidden.revealed  { border: 3px solid #c0c0c0; color: #c0c0c0; }
.orb-limited.revealed { border: 3px solid gold;    color: #ffd700; }

.gacha-results.single { display: flex; align-items: center; justify-content: center; }
.gacha-orb.big { aspect-ratio: 1/1; max-width: 25%; }

/* ==============================
   HUD（右下角）
============================== */
.gacha-hud {
  position: absolute;
  bottom: 6%;
  right: 4%;
  display: flex;
  align-items: center;
  gap: 1rem;
  z-index: 30;
  color: #fff;
  text-shadow: 0 1px 4px #000a;
  height: 10%;
}
.counter-box {
  height: 100%;
  display: flex; align-items: center;
  font-weight: bold; padding: 0 6px;
  border-radius: 4px;
  background: rgba(255,255,255,0.01);
}
.gacha-counter {
  position: absolute;
  bottom: 5%; right: 17%;
  gap: 1rem; z-index: 30;
  color: #fff; text-shadow: 0 1px 4px #000a;
  height: 10%;
}
.gacha-results { z-index: 10; }

/* 背包按鈕 */
.gacha-backpack {
  height: 100%; aspect-ratio: 2/1;
  border: 2px solid #1eb5e5; border-radius: 8px;
  background: rgb(13 27 77 / 82%); color: #fff;
  cursor: pointer; transition: all 0.25s;
  box-shadow: 0 0 8px #53e2ff88, 0 0 16px #1eb5e577 inset;
  display: flex; align-items: center; justify-content: center;
}
.backpack-box { height: 100%; display: flex; align-items: center; justify-content: center; }
.backpack-section { margin: 0.5rem 0; }
.backpack-section h3 { color: #53e2ff; margin-bottom: 0.3rem; }
.backpack-items { color: #fff; }
.backpack-items span { color: #ffe082; font-weight: bold; }

/* ==============================
   Loader
============================== */
.gacha-loader{ position:absolute; left:10%; right:10%; top: 45%; height: 15%; z-index:60; display:none; }
.gacha-loader.show{ display:block; }
.gacha-loader .loader-box{ position:relative; height:100%; display:flex; flex-direction:column; gap:8px; justify-content:center; }
.loader-bar{ position:relative; height:42%; background:#263257; border-radius:999px; overflow:hidden; box-shadow: inset 0 0 10px #000a; }
.loader-fill{ position:absolute; left:0; top:0; height:100%; width:0%; background: linear-gradient(90deg,#2de0ff88,#6dffae88); box-shadow: 0 0 18px #53e2ff99 inset; transition: width .26s cubic-bezier(.22,.61,.36,1); }
.loader-cat{ position:absolute; top:-15%; left:0; transform: translate(-50%,-90%); height: 100%; aspect-ratio: 1/1; filter: drop-shadow(0 3px 8px #000c); transition: left .26s cubic-bezier(.22,.61,.36,1); pointer-events:none; }
.loader-text{ text-align:center; color:#e9efff; font-weight:900; text-shadow:0 2px 6px #000c; height: 100%; display:flex; align-items:center; justify-content:center; }

/* 自動字級 */
.auto-resize {}

/* ==============================
   游標與箭頭層級
============================== */
.gacha-btn:disabled { cursor: pointer; } /* 不顯示禁止符號 */
.back { z-index: 60; cursor: pointer; }  /* 確保可點到 */

/* ==============================
   Orb 內圖覆蓋名字（修正版：圖先藏，翻牌才顯示；圖壓在名字上）
============================== */
.gacha-orb .orb-inner{
  position: relative;
  display: block;
  width: 90%;
  height: 90%;
  margin: auto;
}
.gacha-orb.big .orb-inner{
  width: 95%;
  height: 95%;
}

/* 圖片預先放進球裡，但先隱形；翻牌後再顯示 */
.gacha-orb .orb-inner .orb-icon {
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%); /* ✅ 幾何置中 */
  max-width: 100%;
  max-height: 100%;
  width: auto;                     /* 保持比例，不硬撐滿 */
  height: auto;
  object-fit: contain;
  z-index: 0;                      /* 圖壓在名字上 */
  pointer-events: none;
  filter: drop-shadow(0 2px 6px rgba(0, 0, 0, .35));
  opacity: 0;                      /* 先藏，翻牌再顯示 */
  transition: opacity .2s ease;    /* ← 別斷行 */
}

.gacha-orb.revealed .orb-inner .orb-icon{
  opacity: 1;               /* ★ 翻牌後立刻顯示（圖已預載） */
}

/* 名字固定在底部，預設也隱形，翻牌後一起出現 */
.gacha-orb .orb-inner .orb-name{
  position: absolute;
  left: 50%;
  bottom: 0%;
  transform: translateX(-50%);
  width: 70%;
  height: 20%;
  text-align: center;
  line-height: 1.1;
  font-weight: 900;
  white-space: normal;
  word-break: keep-all;
  z-index: 1;               /* 在圖片下方 */
  font-size: .36em;
  opacity: 0;               /* ★ 先藏 */
  transition: opacity .2s ease;
}
.gacha-orb.revealed .orb-inner .orb-name{
  opacity: 1;               /* ★ 翻牌後才顯示文字 */
}

/* 不同稀有度的名字顏色（被圖片遮住也作為備援） */
.orb-normal.revealed  .orb-name { color:#ffffff; text-shadow:0 2px 6px #000c, 0 0 3px #000; }
.orb-hidden.revealed  .orb-name { color:#e0e0e0; text-shadow:0 2px 6px #000c, 0 0 3px #000; }
.orb-limited.revealed .orb-name { color:#ffd54f; text-shadow:0 2px 6px #000c, 0 0 6px #000; }



/* ==============================
   特殊升級動畫遮罩（銀→金→翻牌）
============================== */
#special-mask{
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.65);
  display: none;
  z-index: 4000;
}
#special-cat{
  position: absolute;
  width: 7vw;          /* ★ 可微調：特效貓尺寸（改百分比或 px） */
  max-width: 120px;    /* ★ 可微調：最大尺寸上限 */
  aspect-ratio: 1/1;
  transform: translate(-50%,-50%);
  filter: drop-shadow(0 6px 14px rgba(0,0,0,.6));
  transition: left .45s cubic-bezier(.22,.61,.36,1), top .45s cubic-bezier(.22,.61,.36,1); /* ★ 可微調：移動速度/曲線 */
}
.special-bounce {
  animation: cat-bounce 250ms ease-out; /* 時間跟你 JS 的 SPECIAL.hopDurMs 對齊 */
}
/* ★ 翻轉：左右翻圖，不影響 translate 定位 */
#special-cat.flipX {
  transform: translate(-50%, -50%) scaleX(-1);
}
/* 連續彈跳（移動中用） */
#special-cat.bounce-loop {
  /* 可改速度：對應 JS 會設 --bounceMs */
  animation: cat-bounce var(--bounceMs, 180ms) ease-in-out infinite;
}


/* ★ 彈跳：用 margin-top 動畫，避免和 transform/翻轉衝突 */
@keyframes cat-bounce {
  0%   { margin-top: 0; }
  50%  { margin-top: -14px; } /* ← 高度可改 */
  100% { margin-top: 0; }
}

  </style>
</head>
<body class="dark-bg">
  <!-- 16:9 主要容器 -->
  <div class="container-16-9">
    <!-- 左上：返回箭頭專用框（滿版黃色箭頭由外掛CSS畫） -->
    <div class="back" id="btnBack" style="position:absolute; left:2%; width:7%; height:16%;"></div>

    <!-- 抽卡結果容器 & 選池資訊 -->
    <div class="gacha-results" id="gacha-results">
      <div id="poolName" class="auto-resize" style="position:absolute; top:2%; left:4%; width:80%; height:17%; color:#FFF; display:flex; align-items:center;"></div>
      <div id="poolDesc" class="auto-resize" style="position:absolute; bottom:-2%; width:100%; height:13%; color:#FFF; display:flex; justify-content:center; align-items:center; text-align:center;"></div>
      <div id="poolLink" class="auto-resize" style="position:absolute; top:16%; right:8%; width:13%; height:11%; color:#FFF; display:flex; justify-content:center; align-items:center; text-align:center;">持有榜</div>
    </div>
    
    <!-- 轉蛋讀條 Loader -->
    <div id="gacha-loader" class="gacha-loader">
      <div class="loader-box">
        <img class="loader-cat" id="loader-cat" src="https://shierusha.github.io/library/img/cat.png" alt="cat">
        <div class="loader-bar"><div class="loader-fill" id="loader-fill"></div></div>
        <div class="loader-text auto-resize" id="loader-text">Roro爆肝中……</div>
      </div>
    </div>

    <!-- 抽卡按鈕 -->
    <div class="gacha-buttons">
      <button id="btn-single" class="gacha-btn auto-resize">單抽</button>
      <button id="btn-ten" class="gacha-btn auto-resize">十連抽</button>
    </div>

    <!-- HUD -->
    <div class="gacha-hud">
      <button id="btn-backpack" class="gacha-backpack">
        <div class="backpack-box auto-resize">背包</div>
      </button>
    </div>

    <!-- 剩餘抽數 -->
    <div class="gacha-counter auto-resize">
      <div class="counter-box">剩餘抽數：<span id="draw-count">0</span></div>
    </div>

    <!-- 背景圖 -->
    <img class="bg_img" src="https://shierusha.github.io/school-battle/teachers/img/8.webp" alt="background">

    <!-- 特效遮罩（銀→金→翻牌） -->
    <div id="special-mask">
      <img id="special-cat" src="https://shierusha.github.io/library/img/cat2.png" alt="">
    </div>
  </div>

  <!-- 旋轉提示（不可關閉） -->
  <div id="orientation-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <div class="modal-header">請旋轉螢幕</div>
      <div class="modal-body">為了最佳體驗，請將裝置轉成橫向模式</div>
    </div>
  </div>

  <!-- 背包 Modal（可點背景關閉） -->
  <div id="info-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <div class="modal-header" id="info-modal-title">標題</div>
      <div class="modal-body" id="info-modal-body"></div>
    </div>
  </div>

<script>
/* ==============================
   小工具
============================== */
const $  = (s, r=document) => r.querySelector(s);
const $$ = (s, r=document) => [...r.querySelectorAll(s)];
const sleep = (ms) => new Promise(res => setTimeout(res, ms));
const escapeHtml = s => (s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

/* ==============================
   DC Webhook（銀/金）
   用：sendGachaWebhook(rarity, name, { mode: 'congrats'|'swap' })
============================== */
async function sendGachaWebhook(rarity, itemName, { mode = 'congrats' } = {}) {
  // 白球永遠不送
  if (rarity !== 'limited' && rarity !== 'hidden') return;
  try {
    const threadId = (window.CURRENT_POOL && window.CURRENT_POOL.threadId) || null;
    if (!threadId) return;
    const url = `${B_URL}/functions/v1/gacha-notify`;
    const resp = await fetch(url, {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({
        rarity,
        playerName: PLAYER_NAME || '玩家',
        itemName,
        threadId,
        mode // Edge 端用 mode 決定文案
      })
    });
    if (!resp.ok) console.warn('[gacha-notify] status=', resp.status, await resp.text().catch(()=>'(no body)'));
  } catch (e) { console.warn('[gacha-notify] failed:', e); }
}

/* ==============================
   Supabase
============================== */
const B_URL  = 'https://ogzpfrkwnqqaitytncla.supabase.co';
const B_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9nenBmcmt3bnFxYWl0eXRuY2xhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxODQzNzEsImV4cCI6MjA3MDc2MDM3MX0.Ls83xOXcKIW7FUcavr8_sOs37I18VGFWYNW3sNFRS24';

const B_TOKEN     = localStorage.getItem('gacha_b_jwt') || '';
const B_TOKEN_EXP = Number(localStorage.getItem('gacha_b_jwt_exp') || 0);
const PLAYER_NAME = localStorage.getItem('gacha_player_name') || '我的';
const REDIRECT_PLAYER = 'https://shierusha.github.io/create-student/player';
const DEFAULT_EVENT   = '謝爾夏饅頭扭蛋';

function decodeJWT(t){
  if (!t) return null;
  const pad = s => s + '='.repeat((4 - s.length % 4) % 4);
  try { return JSON.parse(atob(pad(t.split('.')[1]).replace(/-/g,'+').replace(/_/g,'/'))); }
  catch { return null; }
}
const payload = decodeJWT(B_TOKEN);
const user = B_TOKEN && payload ? { id: payload.sub } : null;

let sb = window.supabase.createClient(B_URL, B_ANON, {
  global: { headers: B_TOKEN ? { Authorization: `Bearer ${B_TOKEN}` } : {} }
});
if (B_TOKEN) sb.realtime.setAuth(B_TOKEN);
const G = (t) => sb.schema('gacha').from(t);

/* ✅ 角色名稱/圖片索引（背包顯示名字用） */
const CHAR = {
  normal:  new Map(),                          // id -> { name, image_url }
  hidden:  new Map(),                          // id -> { name, image_url }
  limited: new Map()                           // `${event_name}|${id}` -> { name, image_url }
};

/* ==============================
   DOM 快取
============================== */
const resultsContainer   = $('#gacha-results');
const btnSingle          = $('#btn-single');
const btnTen             = $('#btn-ten');
const btnBag             = $('#btn-backpack');
const btnBack            = $('#btnBack');
const gachaBtns          = $('.gacha-buttons');
const infoModal          = $('#info-modal');
const infoTitle          = $('#info-modal-title');
const infoBody           = $('#info-modal-body');
const drawCounterEl      = $('#draw-count');
const orientationModal   = $('#orientation-modal');



/* ==============================
   自動字級（套 auto-resize）
============================== */
function resizeAllTexts() {
  $$('.auto-resize').forEach(el => {
    const h = el.offsetHeight || el.getBoundingClientRect().height || 20;
    el.style.fontSize = (h * 0.50) + 'px';
  });
}
window.addEventListener('load', resizeAllTexts);
window.addEventListener('resize', resizeAllTexts);

/* ==============================
   強制橫向
============================== */
function isPortrait(){
  return window.matchMedia('(orientation: portrait)').matches || window.innerHeight > window.innerWidth;
}
function enforceLandscape(){
  const portrait = isPortrait();
  if (orientationModal) orientationModal.style.display = portrait ? 'flex' : 'none';
  document.body.style.overflow = portrait ? 'hidden' : '';
}
enforceLandscape();
window.addEventListener('resize', enforceLandscape);
window.addEventListener('orientationchange', enforceLandscape);
if (orientationModal) orientationModal.addEventListener('click', e => e.stopPropagation());

/* ==============================
   會話 / 逾期保護
============================== */
function ensureAuthOrRedirect(){
  const now = Math.floor(Date.now()/1000);
  if (!user || !B_TOKEN || (B_TOKEN_EXP && now >= B_TOKEN_EXP)) {
    alert('登入逾期，將返回玩家中心。');
    location.href = REDIRECT_PLAYER;
    return false;
  }
  return true;
}
setInterval(ensureAuthOrRedirect, 60*1000);
ensureAuthOrRedirect();

/* ==============================
   狀態 & 返回鍵控制
============================== */
let canDraw = true;
let unlockAt = 0;

/* 返回鍵：抽卡中完全禁用（無提示） */
function setBackDisabled(disabled){
  if (!btnBack) return;
  btnBack.dataset.disabled = disabled ? '1':'0';
  btnBack.style.pointerEvents = disabled ? 'none' : 'auto';
  btnBack.style.opacity = disabled ? '0.6' : '1';
}

/* 抽卡按鈕鎖 */
function lockButtons()  { [btnSingle, btnTen, btnBag].forEach(b => b && (b.disabled = true,  b._forceDisabled = true)); }
function unlockButtons(){ [btnSingle, btnTen, btnBag].forEach(b => b && (b.disabled = false, b._forceDisabled = false)); }

/* ==============================
   Edge 單抽（只走 Edge）
============================== */
async function drawOnce(){
  const currentPoolKey = (window.CURRENT_POOL && window.CURRENT_POOL.key) ? window.CURRENT_POOL.key : DEFAULT_EVENT;

  const resp = await fetch(`${B_URL}/functions/v1/gacha-draw`, {
    method: 'POST',
    headers: { 'content-type':'application/json', 'authorization': `Bearer ${B_TOKEN}` },
    body: JSON.stringify({ pool: currentPoolKey })
  });
  const out = await resp.json().catch(()=>null);
  if (!resp.ok) {
    alert(out?.message || out?.error || '抽卡失敗'); 
    return null;
  }
  return out; // { rarity, name, character_id, event_name, image_url?, special_anim?, is_11x? }
}

async function drawTenTimes(){
  const c = await getCounter();
  const remain = Math.max(0, c.max_draws - c.total_draws);
  if (remain < 10) { return null; }

  const results = [];
  for (let i=0;i<10;i++){
    const r = await drawOnce();
    if (!r) break;
    results.push(r);
  }
  return results;
}

/* ==============================
   初始化
============================== */
(async function boot(){
  if (!ensureAuthOrRedirect()) return;

  /* ✅ 先載入角色清單建立索引（背包顯示名字需要） */
  try {
    const [nChars, hChars, lChars] = await Promise.all([
      G('normal_characters').select('id,name,image_url'),
      G('hidden_characters').select('id,name,image_url'),
      G('limited_characters').select('id,event_name,name,image_url'),
    ]);
    (nChars.data || []).forEach(r => CHAR.normal.set(r.id, { name: r.name, image_url: r.image_url || null }));
    (hChars.data || []).forEach(r => CHAR.hidden.set(r.id, { name: r.name, image_url: r.image_url || null }));
    (lChars.data || []).forEach(r => CHAR.limited.set(`${r.event_name}|${r.id}`, { name: r.name, image_url: r.image_url || null }));
  } catch(e) {
    console.warn('[CHAR index] load failed:', e);
  }

  await ensureCounter();
  await refreshUIFromCounter();

  bindUI();

  // 倫波顯示切換（有結果就隱藏）
  new MutationObserver(()=>{
    const hasResults = document.querySelectorAll('.gacha-row').length > 0;
    const car = document.querySelector('.pool-carousel');
    if (car) car.style.display = hasResults ? 'none' : 'block';
  }).observe(resultsContainer, { childList:true, subtree:true });

  setInterval(refreshUIFromCounter, 15000);

  setBackDisabled(false);
})();

/* ==============================
   Counter（剩餘抽數 = max_draws - total_draws）
============================== */
async function ensureCounter(){
  const { data } = await G('counters').select('*').eq('player_id', user?.id).single();
  if (!data){
    await G('counters').insert({ player_id: user?.id, total_draws: 0, next_pity: 50 });
  }
}
async function getCounter(){
  const { data } = await G('counters')
    .select('total_draws,next_pity,max_draws')
    .eq('player_id', user?.id).single();
  return data || { total_draws: 0, next_pity: 50, max_draws: 0 };
}
async function refreshUIFromCounter(){
  const c = await getCounter();
  const remain = Math.max(0, (c?.max_draws||0) - (c?.total_draws||0));
  if (drawCounterEl) drawCounterEl.textContent = remain;
  if (btnTen)    btnTen.disabled    = remain < 10 || btnTen._forceDisabled === true || isPortrait();
  if (btnSingle) btnSingle.disabled = remain <  1 || btnSingle._forceDisabled === true || isPortrait();
}

/* ==============================
   Loader
============================== */
const loaderEl  = $('#gacha-loader');
const fillEl    = $('#loader-fill');
const catEl     = $('#loader-cat');
const loaderTxt = $('#loader-text');

const Loader = {
  show(label='Roro爆肝中……'){
    if (loaderTxt) loaderTxt.textContent = label;
    if (fillEl) fillEl.style.width = '0%';
    if (catEl)  catEl.style.left  = '0%';
    loaderEl?.classList.add('show');
    resizeAllTexts();
  },
  async step(stepIndex, total){
    const pct = Math.max(0, Math.min(100, Math.round(stepIndex * (100/total))));
    fillEl && (fillEl.style.width = pct + '%');
    catEl  && (catEl.style.left  = pct + '%');
    await sleep(240);
  },
  hide(){ loaderEl?.classList.remove('show'); }
};

function clearResults(){
  resultsContainer.classList.remove('single');
  resultsContainer.innerHTML = '';
}

/* 軟重置：清結果、還原按鈕與倫波，不換頁 */
function softResetToIdle(){
  clearResults();
  const car = document.querySelector('.pool-carousel');
  if (car) car.style.display = 'block';
  canDraw = true;
  unlockAt = 0;
  unlockButtons();
  setBackDisabled(false);
  resizeAllTexts();
}

/* ==============================
   特效邏輯（銀→金→翻牌）
============================== */

const specialMask = document.getElementById('special-mask');
const specialCat  = document.getElementById('special-cat');

/* ★ 你的速度參數（已套用） */
const SPECIAL = {
  preDarkDelayMs: 800,  // ★ 新增：先等 1 秒再變暗
  darkWaitMs:      2000,  // 暗場(全黑) 2s
  axisMoveTotalMs: 3000,  // 四段總移動時間（將均分成 4 份）
  moveBounceMs:     180,  // 連續彈跳節奏（移動期間用；和 CSS 無限動畫一致）
  hopDelayMs:       200,  // 每段「…0.5秒後…」→ 你改成 0.2s
  hopDurMs:         250,  // 單次彈跳時間
  exitMs:           220,  // 高速離場時間
  targetOffset:    0.78,  // 球內落點（越大越靠右下）
  timingFn: 'cubic-bezier(.22,.61,.36,1)'
};

function setCatTransition(ms){
  specialCat.style.transitionProperty = 'left, top';
  specialCat.style.transitionDuration = `${ms}ms`;
  specialCat.style.transitionTimingFunction = SPECIAL.timingFn;
}

function viewportTargets(orbEl){
  const r = orbEl.getBoundingClientRect();
  const t = SPECIAL.targetOffset;
  const rb = { x: r.left + r.width * t,     y: r.top  + r.height * t };     // 右下
  const lb = { x: r.left + r.width * (1-t), y: rb.y };                      // 左下（同 y）
  return { rb, lb };
}

function randomEdgeStart(){
  const w = window.innerWidth, h = window.innerHeight;
  const side = Math.floor(Math.random()*4);
  if (side === 0) return { x: -50,  y: Math.random()*h }; // 左外
  if (side === 1) return { x: w+50, y: Math.random()*h }; // 右外
  if (side === 2) return { x: Math.random()*w, y: -50  }; // 上外
  return { x: Math.random()*w, y: h+50 };                  // 下外
}

/* 單軸移動 */
async function moveHoriz(toX, dur){ setCatTransition(dur); specialCat.style.left = `${toX}px`; await sleep(dur); }
async function moveVert (toY, dur){ setCatTransition(dur); specialCat.style.top  = `${toY}px`; await sleep(dur); }

/* 停在原地的「n 次彈跳」 */
async function bounce(times=1, dur=SPECIAL.hopDurMs){
  return new Promise(resolve=>{
    specialCat.style.animation = `cat-bounce ${dur}ms ease-out ${times}`;
    const onEnd = () => { specialCat.style.animation = ''; specialCat.removeEventListener('animationend', onEnd); resolve(); };
    specialCat.addEventListener('animationend', onEnd);
  });
}

/* 連續彈跳（移動時） */
function startLoopBounce(ms=SPECIAL.moveBounceMs){
  specialCat.classList.add('bounce-loop');
  specialCat.style.setProperty('--bounceMs', `${ms}ms`);
}
function stopLoopBounce(){
  specialCat.classList.remove('bounce-loop');
  specialCat.style.removeProperty('--bounceMs');
}

/* 左右翻轉 */
function setFlip(on){ specialCat.classList.toggle('flipX', !!on); }

/* 依你新版時序：
   暗場→ 出現
   → 四段移動到右下（垂直→水平→垂直→水平；全程連續彈跳）
   → +0.5s 跳1
   → +0.5s 翻轉 + 移到左下 → 跳1
   → +0.5s 跳1 → 翻回 + 移回右下 → 跳1
   → +0.5s 跳2
   → +0.5s 跳2 並 白→銀
   → +0.5s 翻轉 + 左下 → 跳1
   → +0.5s 跳1 → 翻回 + 右下 → 跳1
   → +0.5s 跳3 並 銀→金
   → +0.5s 跳3 並 金→打開（revealFn）
   → +0.5s 跳3 → 高速離場
   （注意：你把 0.5s 改成 hopDelayMs=200ms，我就照 0.2s 跑）
*/
async function runSpecialUpgradeAnimation(targetOrb, revealFn){
  if (!targetOrb) { revealFn?.(); return; }

  // 小工具：根據水平移動方向設定翻轉（toX < fromX => 往左 => flip）
  const faceForMove = (fromX, toX) => setFlip(toX < fromX);

  // 進場前先等
  await sleep(SPECIAL.preDarkDelayMs);

  // 顯示遮罩 + 起始位置（起始朝右）
  specialMask.style.display = 'block';
  specialCat.style.opacity = '0';
  const start = randomEdgeStart();
  specialCat.style.left = `${start.x}px`;
  specialCat.style.top  = `${start.y}px`;
  setFlip(false); // ★ 起始朝右

  // 暗場
  await sleep(SPECIAL.darkWaitMs);
  specialCat.style.opacity = '1';

// === 六段直線移動：垂直1/3 → 水平1/3 → 垂直2/3 → 水平2/3 → 垂直到目標 → 水平成目標 ===
const { rb, lb } = viewportTargets(targetOrb);
const q = Math.max(0, Math.floor(SPECIAL.axisMoveTotalMs / 6));

const dyThird = (rb.y - start.y) / 3;
const dxThird = (rb.x - start.x) / 3;

const y1_3 = start.y + dyThird;
const y2_3 = start.y + dyThird * 2;
const x1_3 = start.x + dxThird;
const x2_3 = start.x + dxThird * 2;

// 追蹤目前位置（給翻頭用）
let curX = start.x, curY = start.y;

// 1) 垂直到 1/3 Y（不彈）
stopLoopBounce();
await moveVert(y1_3, q); curY = y1_3;

// 2) 水平到 1/3 X（彈，並依方向翻頭）
faceForMove(curX, x1_3);
startLoopBounce();
await moveHoriz(x1_3, q); curX = x1_3;
stopLoopBounce();

// 3) 垂直到 2/3 Y（不彈）
await moveVert(y2_3, q); curY = y2_3;

// 4) 水平到 2/3 X（彈，並依方向翻頭）
faceForMove(curX, x2_3);
startLoopBounce();
await moveHoriz(x2_3, q); curX = x2_3;
stopLoopBounce();

// 5) 垂直到目標 Y（不彈）
await moveVert(rb.y, q); curY = rb.y;

// 6) 水平成目標 X（彈，並依方向翻頭）
faceForMove(curX, rb.x);
startLoopBounce();
await moveHoriz(rb.x, q); curX = rb.x;
stopLoopBounce();

  // === 後續固定節奏 ===
  await sleep(SPECIAL.hopDelayMs);  await bounce(1);

  await sleep(SPECIAL.hopDelayMs);
  // 往左到左下：彈、翻頭→左
  faceForMove(curX, lb.x);
  startLoopBounce();
  await moveHoriz(lb.x, SPECIAL.hopDurMs); curX = lb.x;
  stopLoopBounce();
  await bounce(1);

  await sleep(SPECIAL.hopDelayMs);
  await bounce(1);
  // 往右回右下：彈、翻頭→右
  faceForMove(curX, rb.x);
  startLoopBounce();
  await moveHoriz(rb.x, SPECIAL.hopDurMs); curX = rb.x;
  stopLoopBounce();
  await bounce(1);

  await sleep(SPECIAL.hopDelayMs);  await bounce(2);

  await sleep(SPECIAL.hopDelayMs);  await bounce(2);
  // 白 → 銀
  targetOrb.classList.remove('orb-normal');
  targetOrb.classList.add('orb-hidden');

  await sleep(SPECIAL.hopDelayMs);
  // 左下：彈、翻頭→左
  faceForMove(curX, lb.x);
  startLoopBounce();
  await moveHoriz(lb.x, SPECIAL.hopDurMs); curX = lb.x;
  stopLoopBounce();
  await bounce(1);

  await sleep(SPECIAL.hopDelayMs);
  await bounce(1);
  // 右下：彈、翻頭→右
  faceForMove(curX, rb.x);
  startLoopBounce();
  await moveHoriz(rb.x, SPECIAL.hopDurMs); curX = rb.x;
  stopLoopBounce();
  await bounce(1);

  await sleep(SPECIAL.hopDelayMs);  await bounce(3);
  // 銀 → 金
  targetOrb.classList.remove('orb-hidden');
  targetOrb.classList.add('orb-limited');

  await sleep(SPECIAL.hopDelayMs);  await bounce(3);
  // 金 → 打開（顯示圖與名字；不送恭喜）
  revealFn?.();


 await sleep(SPECIAL.hopDelayMs);
  faceForMove(curX, lb.x);        // 往左 → flip
  startLoopBounce();              // 水平移動時保持彈跳
  await moveHoriz(lb.x, SPECIAL.hopDurMs);
  curX = lb.x;
  stopLoopBounce();
  await bounce(1);

  await sleep(SPECIAL.hopDelayMs);  await bounce(3);

  // 高速離場（保持當前朝向即可）
  const end = randomEdgeStart();
  setCatTransition(SPECIAL.exitMs);
  specialCat.style.left = `${end.x}px`;
  specialCat.style.top  = `${end.y}px`;
  await sleep(SPECIAL.exitMs);

  // 收尾
  specialMask.style.display = 'none';
}


/* ==============================
   UI：建立球 / 翻牌（球內放圖、可遮名）
============================== */
function createOrb(res, { autoReveal=false, revealDelay=0, big=false, forceInitialNormal=false } = {}){
  const orb = document.createElement('div');
  const initialClass = forceInitialNormal ? 'orb-normal' : `orb-${res.rarity}`;
  orb.className = `gacha-orb ${initialClass}` + (big?' big':'');
  const inner = document.createElement('div');
  inner.className = 'orb-inner';

  // ✅ 先把圖片放進去（隱形，但會開始下載）
  if (res.image_url) {
    const img = document.createElement('img');
    img.src = res.image_url;
    img.alt = res.name;
    img.className = 'orb-icon';
    // 提示瀏覽器優先載入
    img.setAttribute('loading', 'eager');
    img.setAttribute('decoding', 'async');
    img.setAttribute('fetchpriority', 'high');
    inner.appendChild(img);
  }

  // 翻牌才補名字＋顯示（不要清 inner，否則會把預載圖移除）
  const doRevealContent = () => {
    if (!inner.querySelector('.orb-name')) {
      const nameEl = document.createElement('span');
      nameEl.className = 'orb-name auto-resize';
      nameEl.textContent = res.name;
      inner.appendChild(nameEl);
    }
    orb.classList.add('revealed');  // 觸發 CSS：讓圖從 opacity:0 → 1
    resizeAllTexts();
    checkAllRevealed();
  };

  // 只在「玩家手動 + 銀/金」時送恭喜
  const reveal = (isManual=false) => {
    if (orb.classList.contains('revealed')) return;
    doRevealContent();
    if (isManual && (res.rarity === 'limited' || res.rarity === 'hidden')) {
      sendGachaWebhook(res.rarity, res.name, { mode: 'congrats' });
    }
  };

  if (autoReveal) setTimeout(() => reveal(false), revealDelay);
  else orb.addEventListener('click', () => reveal(true));

  orb.appendChild(inner);
  return { el: orb, reveal, rawReveal: doRevealContent }; // rawReveal：給特效用，不送恭喜
}


function checkAllRevealed(){
  const orbs = $$('.gacha-orb', resultsContainer);
  if (orbs.length === 0) return;
  const all = orbs.every(o => o.classList.contains('revealed'));
  if (all) {
    unlockAt = Date.now() + 500;
    setTimeout(()=>{
      canDraw = true;
      unlockButtons();
      setBackDisabled(false); // 全部翻完才解鎖返回
    }, 500);
  }
}

function showResultsTen(results){
  canDraw = false;
  setBackDisabled(true);

  resultsContainer.classList.remove('single');
  resultsContainer.innerHTML = '';

  const spIndex = results.findIndex(r => r.special_anim);
  const hasSpecial = spIndex >= 0;

  const allOrbs = [];

  for (let row=0; row<2; row++){
    const rowDiv = document.createElement('div');
    rowDiv.className = 'gacha-row';

    results.slice(row*5, row*5+5).forEach((res, idx)=>{
      const index = row*5 + idx;
      const isSpecialTarget = (index === spIndex);
      // 有特效時，白球延後；無特效時白球照舊自動翻
      const auto = (!hasSpecial && res.rarity === 'normal');
      const { el, reveal, rawReveal } = createOrb(res, {
        autoReveal: auto,
        revealDelay: index*200,
        forceInitialNormal: isSpecialTarget
      });
      el.dataset.index = String(index);
      rowDiv.appendChild(el);
      allOrbs.push({ el, res, reveal, rawReveal, index });
    });

    resultsContainer.appendChild(rowDiv);
  }
  resizeAllTexts();

  if (hasSpecial) {
    const target = allOrbs.find(o => o.index === spIndex);
    // 特效內翻開「目標金蛋」（不送恭喜）
    runSpecialUpgradeAnimation(target?.el, () => target?.rawReveal()).then(async ()=>{
      // 🎯 特效剛結束：先送「偷偷調包」
      try { await sendGachaWebhook(target.res.rarity, target.res.name, { mode: 'swap' }); } catch(e){}

      // 然後只自動翻「白球」，銀/金留給玩家手動點
      for (const o of allOrbs){
        if (o.index === spIndex) continue; // 特效那顆已翻
        if (o.res.rarity === 'normal' && !o.el.classList.contains('revealed')) {
          await sleep(120); // ★ 可微調：補翻間隔
          o.reveal(false);  // 非手動 → 不送恭喜
        }
      }
    });
  }
}

function showResultSingle(res){
  canDraw = false;
  setBackDisabled(true);

  resultsContainer.classList.add('single');
  resultsContainer.innerHTML = '';

  const needSpecial = !!res.special_anim;
  const { el: orb, reveal, rawReveal } = createOrb(res, {
    autoReveal: !needSpecial && res.rarity==='normal',  // 白球無特效直接自動翻
    revealDelay: 0,
    big: true,
    forceInitialNormal: needSpecial
  });

  const rowDiv = document.createElement('div');
  rowDiv.className = 'gacha-row';
  rowDiv.style.justifyContent = 'center';
  rowDiv.appendChild(orb);
  resultsContainer.appendChild(rowDiv);
  resizeAllTexts();

  if (needSpecial) {
    // 特效內翻牌（不送恭喜）
    runSpecialUpgradeAnimation(orb, () => rawReveal()).then(async () => {
      // 🎯 特效結束後送「偷偷調包」
      try { await sendGachaWebhook(res.rarity, res.name, { mode: 'swap' }); } catch(e){}
      // 單抽沒有其他白球要補翻；恭喜也不送（因為不是玩家點開）
    });
  } else if (res.rarity === 'normal') {
    // 白球：自動翻後直接解鎖
    unlockAt = Date.now() + 500;
    setTimeout(()=>{ canDraw = true; unlockButtons(); setBackDisabled(false); }, 500);
  }
}

/* ==============================
   背包（展示）
============================== */
function nameFromPools(rarity, character_id, event_name){
  if (rarity === 'normal') {
    return CHAR.normal.get(character_id)?.name || `#${character_id}`;
  }
  if (rarity === 'hidden') {
    return CHAR.hidden.get(character_id)?.name || `#${character_id}`;
  }
  // limited
  return CHAR.limited.get(`${event_name}|${character_id}`)?.name
      || `#${character_id}`;
}

async function openBackpack(){
  const orbs = $$('.gacha-orb', resultsContainer);
  if (orbs.some(o=>!o.classList.contains('revealed'))) { alert('請先翻開所有扭蛋！'); return; }

  infoTitle.textContent = `${PLAYER_NAME}的背包`;

  const { data, error } = await G('owned_characters')
    .select('rarity,event_name,character_id,count')
    .eq('player_id', user?.id);

  if (error) { console.error('[owned_characters] query error:', error); alert('讀取背包失敗'); return; }
  const rows = Array.isArray(data) ? data : [];

  const byKey = new Map();
  for (const r of rows){
    const key = `${r.rarity}|${r.event_name}|${r.character_id}`;
    const v = byKey.get(key);
    byKey.set(key, v ? { ...r, count: v.count + r.count } : { ...r });
  }
  const merged = [...byKey.values()];

  const limitedGroups = new Map(); // event_name -> [{id, html}]
  const hiddenList = [];
  const normalList = [];

  merged.forEach(r=>{
    const nm = nameFromPools(r.rarity, r.character_id, r.event_name);
    const item = { id:r.character_id, html:`${escapeHtml(nm)} × <span>${r.count}</span>` };
    if (r.rarity === 'limited') {
      const arr = limitedGroups.get(r.event_name) || [];
      arr.push(item);
      limitedGroups.set(r.event_name, arr);
    } else if (r.rarity === 'hidden') hiddenList.push(item);
    else normalList.push(item);
  });

  const byId = a => a.sort((x,y)=>(x.id??0)-(y.id??0));
  for (const [k, arr] of limitedGroups) limitedGroups.set(k, byId(arr));
  byId(hiddenList); byId(normalList);

  const joinRows = (arr, perLine=3)=>{
    const lines=[]; for(let i=0;i<arr.length;i+=perLine){ lines.push(arr.slice(i,i+perLine).map(x=>x.html).join('、 ')); }
    return lines.join('<br>');
  };

  let html='';
  const limitedKeys = [...limitedGroups.keys()].sort();
  if (limitedKeys.length){
    html += `<div class="backpack-section"><h3>活動限定饅頭：</h3><div class="backpack-items">`;
    limitedKeys.forEach((evName, idx)=>{
      const rowsHtml = joinRows(limitedGroups.get(evName)||[], 2) || '（無）';
      html += `<div class="backpack-event-block" style="margin:.25rem 0;">${escapeHtml(evName)}</div>`;
      html += `<div class="backpack-event-items" style="margin:0 0 .5rem 0;">${rowsHtml}</div>`;
      if (idx !== limitedKeys.length-1) html += `<div style="height:.4rem;"></div>`;
    });
    html += `</div></div>`;
  }
  if (hiddenList.length){
    html += `<div class="backpack-section"><h3>隱藏饅頭：</h3><div class="backpack-items">${joinRows(hiddenList,2)}</div></div>`;
  }
  if (normalList.length){
    html += `<div class="backpack-section"><h3>普通饅頭：</h3><div class="backpack-items">${joinRows(normalList,3)}</div></div>`;
  }
  if (!html) html = '<div class="backpack-items">目前沒有任何饅頭</div>';

  infoBody.innerHTML = html;
  infoModal.style.display = 'flex';
}
infoModal?.addEventListener('click', ()=> infoModal.style.display='none');
infoModal?.querySelector('.modal-content')?.addEventListener('click', e=> e.stopPropagation());

/* ==============================
   綁定按鈕（返回鍵：抽卡期間完全禁用；翻完才解鎖；有結果→軟重置）
============================== */
function bindUI(){
  btnBag?.addEventListener('click', openBackpack);

  btnBack?.addEventListener('click', ()=>{
    if (btnBack?.dataset.disabled === '1') return; // 被禁用直接無視
    const hasResults = $$('.gacha-orb', resultsContainer).length > 0;
    if (hasResults) {
      softResetToIdle(); // 不換頁
    } else {
      location.href = REDIRECT_PLAYER;
    }
  });

  btnSingle?.addEventListener('click', async ()=>{
    if (!ensureAuthOrRedirect()) return;
    if (isPortrait()) return;
    if (!canDraw || Date.now() < unlockAt) return alert('稍等一下…');

    setBackDisabled(true);
    gachaBtns?.classList.add('bottom');
    lockButtons();

    clearResults();
    Loader.show('Roro爆肝中……');

    const r = await drawOnce();
    if (!r) {
      Loader.hide();
      await refreshUIFromCounter();
      unlockButtons();
      setBackDisabled(false);
      return;
    }

    await Loader.step(1, 1);
    Loader.hide();

    await refreshUIFromCounter();
    showResultSingle(r);
  });

  btnTen?.addEventListener('click', async ()=>{
    if (!ensureAuthOrRedirect()) return;
    if (isPortrait()) return;
    if (!canDraw || Date.now() < unlockAt) return alert('稍等一下…');

    const c = await getCounter();
    if ((c?.max_draws||0) - (c?.total_draws||0) < 10) return alert('剩餘抽數不足 10 抽');

    setBackDisabled(true);
    gachaBtns?.classList.add('bottom');
    lockButtons();

    clearResults();
    Loader.show('Roro爆肝中……');

    const results = [];
    for (let i = 0; i < 10; i++) {
      const r = await drawOnce();
      if (!r) break;
      results.push(r);
      await Loader.step(i + 1, 10);
    }

    Loader.hide();

    if (!results.length) { unlockButtons(); setBackDisabled(false); return; }

    await refreshUIFromCounter();
    showResultsTen(results);
  });

  const obs = new MutationObserver(()=>{ resizeAllTexts(); checkAllRevealed(); });
  obs.observe(resultsContainer, { childList:true, subtree:true });
}
</script>


  <!-- 登出腳本 -->
  <script src="https://shierusha.github.io/library/assets/js/logout.js"></script>

  <!-- 選池倫波外掛 JS -->
  <script src="https://shierusha.github.io/library/assets/js/pool-carousel.js"></script>
</body>
</html>
