<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>謝爾夏｜扭蛋系統 1.1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* ==============================
       全域背景 / 字體
    ============================== */
    body {
      background: url('https://shierusha.github.io/create-student/imgs/citybg.png') center center no-repeat;
      background-size: cover;
      min-height: 100vh;
      font-family: 'Noto Sans TC', sans-serif;
      overflow: hidden;
    }
    body.dark-bg::before {
      content: "";
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.3);
      z-index: 0; pointer-events: none;
    }

    /* ==============================
       16:9 容器
    ============================== */
    .container-16-9 {
      position: relative;
      max-width: 90%;
      max-height: 80vh;
      aspect-ratio: 16/9;
      overflow: hidden;
      border-radius: 16px;
      box-shadow: 0 0 24px #0004;
      margin: 3vh auto;
    }
    .bg-img {
      position: absolute; inset: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      z-index: 1;
    }

    /* ==============================
       Modal（旋轉 / 背包）
    ============================== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: modal-fadein-bg 0.25s;
    }
    @keyframes modal-fadein-bg {
      from { background: rgba(0,0,0,0); }
      to   { background: rgba(0,0,0,0.45); }
    }
    .modal-content {
      background: rgb(13 27 77 / 82%);
      border-radius: 18px;
      border: 2px solid #1eb5e5;
      box-shadow: 0 0 16px 2px #62f1fe88, 0 8px 32px #1eb5e5aa;
      width: 500px; max-width: 93vw;
      height: 340px; max-height: 80vh;
      display: flex; flex-direction: column;
      overflow: hidden;
      animation: modal-pop 0.32s cubic-bezier(.42,1.4,.51,1.01);
    }
    @keyframes modal-pop {
      from { opacity: 0; transform: scale(0.92); }
      to   { opacity: 1; transform: scale(1); }
    }
    .modal-header {
      background: none;
      padding: 15px 20px 0px 24px;
      color: #fff; font-size: 1.5em; font-weight: bold;
      letter-spacing: 1px; text-shadow: 0 1px 4px #000a;
    }
    .modal-header::after {
      content: ""; display: block; height: 5px; width: 70%;
      margin:.5rem 0 0; border-radius: 2px;
      background: linear-gradient(to right,#53e2ff99 65%,#53e2ff00 100%);
      pointer-events: none;
    }
    .modal-body {
      color:#fff; padding: 12px 24px 24px 24px;
      font-size: 1.2em; line-height:1.5; text-shadow:0 1px 4px #0008;
      overflow-y:auto; max-height:240px; white-space: pre-line;
      scrollbar-width:none;
    }
    .modal-body::-webkit-scrollbar { display:none; }

    /* ==============================
       抽卡按鈕（初始置中 → 抽卡後移到底部）
    ============================== */
    .gacha-buttons {
      position: absolute;
      bottom: 16%;
      left: 50%; transform: translateX(-50%);
      display: flex; gap: 10%;
      width: 60%; height: 11%;
      z-index: 10;
      transition: bottom 0.4s ease;
    }
    .gacha-btn {
      flex: 1; height: 100%;
      border-radius: 12px;
      background: rgb(13 27 77 / 82%);
      border: 2px solid #1eb5e5; color: #fff; font-weight: bold;
      cursor: pointer; transition: all 0.25s;
      box-shadow: 0 0 12px #53e2ff88, 0 0 24px #1eb5e577 inset;
    }
    .gacha-btn:disabled { opacity: .65; cursor: not-allowed; }
    .gacha-btn:hover:not(:disabled) {
      background: #1eb5e5cc;
      box-shadow: 0 0 18px #53e2ffdd, 0 0 36px #1eb5e5aa inset;
    }

    /* ==============================
       抽卡結果（十連 / 單抽共用容器）
    ============================== */
    .gacha-results {
      position: absolute;
      top: 12%; left: 50%; transform: translateX(-50%);
      display: block;
      width: 80%; height: 57%;
      z-index: 9;
    }
    .gacha-row {
      display: flex; justify-content: space-between;
      width: 100%; gap: 12px;
    }
    .gacha-orb {
      position: relative; flex: 1;
      aspect-ratio: 1/1; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      overflow: hidden; cursor: pointer; user-select: none;
      transition: all 0.3s ease;
    }
    .orb-inner {
      width: 90%; height: 35%;
      display: flex; align-items: center; justify-content: center;
      text-align: center; line-height: 1.2; font-weight: bold;
    }
    .orb-normal  { background: #fff;    border: 3px solid #ccc; }
    .orb-hidden  { background: #c0c0c0; border: 3px solid #aaa; }
    .orb-limited { background: gold;    border: 3px solid orange; }
    .gacha-orb.revealed { background: transparent; }
    .orb-normal.revealed  { border: 3px solid #fff;    color: #fff; }
    .orb-hidden.revealed  { border: 3px solid #c0c0c0; color: #c0c0c0; }
    .orb-limited.revealed { border: 3px solid gold;    color: #ffd700; }
    .gacha-results.single { display: flex; align-items: center; justify-content: center; }
    .gacha-orb.big { aspect-ratio: 1/1; max-width: 25%; }

    /* ==============================
       HUD（右下角）
    ============================== */
    .gacha-hud {
      position: absolute;
      bottom: 6%;
      right: 4%;
      display: flex;
      align-items: center;
      gap: 1rem;
      z-index: 30;
      color: #fff;
      text-shadow: 0 1px 4px #000a;
      height: 10%;
    }
    .gacha-backpack {
      height: 100%; aspect-ratio: 2/1;
      border: 2px solid #1eb5e5; border-radius: 8px;
      background: rgb(13 27 77 / 82%); color: #fff;
      cursor: pointer; transition: all 0.25s;
      box-shadow: 0 0 8px #53e2ff88, 0 0 16px #1eb5e577 inset;
      display: flex; align-items: center; justify-content: center;
    }
    .backpack-box { height: 100%; display: flex; align-items: center; justify-content: center; }

    .gacha-counter {
      position: absolute;
      bottom: 5%; right: 17%;
      gap: 1rem; z-index: 30;
      color: #fff; text-shadow: 0 1px 4px #000a;
      height: 10%;
    }
    .counter-box {
      position:absolute;
      inset: 0 0 0 0;
      display:flex; align-items:center; justify-content:center;
      font-weight: bold;
      border-radius: 4px;
      background: rgba(255,255,255,0.01);
    }

    /* ==============================
       Loader（百分比定位）
    ============================== */
    .gacha-loader{
      position:absolute; 
      left:10%; 
      right:10%;
      top: 45%;
      height: 15%;
      z-index:60; 
      display:none;
    }
    .gacha-loader.show{ display:block; }
    .gacha-loader .loader-box{
      position:relative; 
      height:100%;
      display:flex; 
      flex-direction:column; 
      gap:8px; justify-content:center;
    }
    .loader-bar{
      position:relative; height:42%;
      background:#263257; border-radius:999px; overflow:hidden;
      box-shadow: inset 0 0 10px #000a;
    }
    .loader-fill{
      position:absolute; left:0; top:0; height:100%; width:0%;
      background: linear-gradient(90deg,#2de0ff88,#6dffae88);
      box-shadow: 0 0 18px #53e2ff99 inset;
      transition: width .26s cubic-bezier(.22,.61,.36,1);
    }
    .loader-cat{
      position:absolute; 
      top:-15%; left:0;
      transform: translate(-50%, -90%);
      height: 100%;
      aspect-ratio: 1 / 1;
      filter: drop-shadow(0 3px 8px #000c);
      transition: left .26s cubic-bezier(.22,.61,.36,1);
      pointer-events:none;
    }
    .loader-text{
      text-align:center; color:#e9efff; font-weight:900;
      text-shadow:0 2px 6px #000c;
      height: 100%;
      display:flex; align-items:center; justify-content:center;
    }
  </style>

  <!-- 外掛：卡池倫波樣式（使用百分比 + 絕對定位） -->
  <link rel="stylesheet" href="pool-carousel.css" />
</head>
<body class="dark-bg">
  <div class="container-16-9">
    <!-- 返回箭頭專用區塊 -->
    <div class="back" id="" style="position: absolute; top: 2%; left: 2%; width: 20%; height: 10%;"></div>

    <!-- 抽卡結果容器／倫波掛載位置 -->
    <div class="gacha-results" id="gacha-results">
      <!-- 這三塊由倫波外掛更新 -->
      <div id="poolNameSlot" class="auto-resize" style="position:absolute; top:2%; left:2%; width:50%; height:10%; color:#FFF;">
        這裡抓卡池名
      </div>
      <div id="poolDescSlot" class="auto-resize" style="position:absolute; bottom:2%; left:5%; width:90%; height:20%; color:#FFF; display:flex; justify-content:center; align-items:center; text-align:center;">
        這裡抓卡池簡介
      </div>
      <div id="poolLinkSlot" class="auto-resize" style="position:absolute; bottom:18%; right:10%; width:10%; height:10%; color:#FFF; display:flex; justify-content:center; align-items:center; text-align:center; cursor:pointer;">
        持有榜
      </div>
    </div>
    
    <!-- 轉蛋讀條 Loader -->
    <div id="gacha-loader" class="gacha-loader">
      <div class="loader-box">
        <img class="loader-cat" id="loader-cat" src="https://shierusha.github.io/library/img/cat.png" alt="cat">
        <div class="loader-bar"><div class="loader-fill" id="loader-fill"></div></div>
        <div class="loader-text auto-resize" id="loader-text">Roro爆肝中……</div>
      </div>
    </div>

    <!-- 抽卡按鈕 -->
    <div class="gacha-buttons">
      <button id="btn-single" class="gacha-btn auto-resize">單抽</button>
      <button id="btn-ten" class="gacha-btn auto-resize">十連抽</button>
    </div>

    <!-- HUD -->
    <div class="gacha-hud">
      <button id="btn-backpack" class="gacha-backpack">
        <div class="backpack-box auto-resize">背包</div>
      </button>
    </div>

    <!-- 右下角：剩餘抽數 -->
    <div class="gacha-counter">
      <div class="counter-box auto-resize">剩餘抽數：<span id="remain-count">0</span></div>
    </div>

    <!-- 背景圖 -->
    <img class="bg-img" src="https://shierusha.github.io/school-battle/teachers/img/8.webp" alt="background">
  </div>

  <!-- 旋轉提示 -->
  <div id="orientation-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <div class="modal-header auto-resize" style="position:absolute; top:8%; left:5%; width:90%; height:18%;">請旋轉螢幕</div>
      <div class="modal-body auto-resize" style="position:absolute; top:28%; left:5%; width:90%; height:60%;">為了最佳體驗，請將裝置轉成橫向模式</div>
    </div>
  </div>

  <!-- 背包 Modal -->
  <div id="info-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <div class="modal-header auto-resize" id="info-modal-title">標題</div>
      <div class="modal-body auto-resize" id="info-modal-body"></div>
    </div>
  </div>

  <script>
    /* ==============================
       小工具
    ============================== */
    const $  = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => [...r.querySelectorAll(s)];
    const sleep = (ms) => new Promise(res => setTimeout(res, ms));
    const escapeHtml = s => (s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    const pick = arr => arr[Math.floor(Math.random()*arr.length)];

    /* 自動字級（統一倍率） */
    function resizeAllTexts() {
      $$('.auto-resize').forEach(el => {
        const h = el.offsetHeight || el.getBoundingClientRect().height || 20;
        el.style.fontSize = (h * 0.50) + 'px';
      });
    }
    resizeAllTexts();
    window.addEventListener('resize', resizeAllTexts);

    /* ==============================
       Supabase（圖書館 B 專案）
    ============================== */
    const B_URL  = 'https://ogzpfrkwnqqaitytncla.supabase.co';
    const B_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9nenBmcmt3bnFxYWl0eXRuY2xhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxODQzNzEsImV4cCI6MjA3MDc2MDM3MX0.Ls83xOXcKIW7FUcavr8_sOs37I18VGFWYNW3sNFRS24';

    const B_TOKEN     = localStorage.getItem('gacha_b_jwt') || '';
    const B_TOKEN_EXP = Number(localStorage.getItem('gacha_b_jwt_exp') || 0);
    const PLAYER_NAME = localStorage.getItem('gacha_player_name') || '我的';
    const REDIRECT_PLAYER = 'https://shierusha.github.io/create-student/player';
    const DEFAULT_EVENT   = '常駐'; // normal/hidden 所屬 event

    function decodeJWT(t){
      if (!t) return null;
      const pad = s => s + '='.repeat((4 - s.length % 4) % 4);
      try { return JSON.parse(atob(pad(t.split('.')[1]).replace(/-/g,'+').replace(/_/g,'/'))); }
      catch { return null; }
    }
    const payload = decodeJWT(B_TOKEN);
    const user = B_TOKEN && payload ? { id: payload.sub } : null;

    let sb = window.supabase.createClient(B_URL, B_ANON, {
      global: { headers: B_TOKEN ? { Authorization: `Bearer ${B_TOKEN}` } : {} }
    });
    if (B_TOKEN) sb.realtime.setAuth(B_TOKEN);

    // 指到 gacha schema
    const G = (t) => sb.schema('gacha').from(t);

    /* ==============================
       DOM 快取
    ============================== */
    const resultsContainer = $('#gacha-results');
    const btnSingle  = $('#btn-single');
    const btnTen     = $('#btn-ten');
    theBtnBag        = $('#btn-backpack');
    const gachaBtns  = $('.gacha-buttons');
    const infoModal  = $('#info-modal');
    const infoTitle  = $('#info-modal-title');
    const infoBody   = $('#info-modal-body');
    const remainEl   = $('#remain-count');
    const orientationModal = $('#orientation-modal');

    const poolNameSlot = $('#poolNameSlot');
    const poolDescSlot = $('#poolDescSlot');
    const poolLinkSlot = $('#poolLinkSlot');

    /* ==============================
       旋轉鎖
    ============================== */
    const interElems = [btnSingle, btnTen, theBtnBag];
    function isPortrait(){
      return window.matchMedia('(orientation: portrait)').matches || window.innerHeight > window.innerWidth;
    }
    function enforceLandscape(){
      const portrait = isPortrait();
      if (orientationModal) orientationModal.style.display = portrait ? 'flex' : 'none';
      document.body.style.overflow = portrait ? 'hidden' : '';
      interElems.forEach(el => el && (el.disabled = portrait || el._forceDisabled === true));
    }
    enforceLandscape();
    window.addEventListener('resize', enforceLandscape);
    window.addEventListener('orientationchange', enforceLandscape);
    if (orientationModal) orientationModal.addEventListener('click', e => e.stopPropagation());

    /* ==============================
       會話 / 逾期保護
    ============================== */
    function ensureAuthOrRedirect(){
      const now = Math.floor(Date.now()/1000);
      if (!user || !B_TOKEN || (B_TOKEN_EXP && now >= B_TOKEN_EXP)) {
        alert('登入逾期，將返回玩家中心。');
        location.href = REDIRECT_PLAYER;
        return false;
      }
      return true;
    }
    setInterval(ensureAuthOrRedirect, 60*1000);
    ensureAuthOrRedirect();

    /* ==============================
       共享狀態
    ============================== */
    let pools = { normal: [], hidden: [], limited: [] };
    let eventsMap = new Map(); // event_name -> event row
    let canDraw = true;
    let unlockAt = 0;

    // 目前選到的卡池（由倫波外掛設定）
    window.CURRENT_POOL = {
      key: '常駐',      // = event_name；常駐要當 key
      name: '常駐',     // 顯示於卡面標題（= event_name）
      desc: '一般池（含隱藏機率）', // = display_name
      banner: '',
      active: true,
      threadId: null
    };

    function lockButtons(force = true) {
      [btnSingle, btnTen, theBtnBag].forEach(b => {
        if (!b) return;
        b._forceDisabled = force;
      });
      enforceLandscape();
    }
    function unlockButtons() {
      [btnSingle, btnTen, theBtnBag].forEach(b => {
        if (!b) return;
        b._forceDisabled = false;
      });
      enforceLandscape();
    }

    /* ==============================
       Loader
    ============================== */
    const loaderEl  = $('#gacha-loader');
    const fillEl    = $('#loader-fill');
    const catEl     = $('#loader-cat');
    const loaderTxt = $('#loader-text');

    const Loader = {
      show(label='Roro爆肝中……'){
        if (loaderTxt) loaderTxt.textContent = label;
        if (fillEl) fillEl.style.width = '0%';
        if (catEl)  catEl.style.left  = '0%';
        loaderEl?.classList.add('show');
        resizeAllTexts();
      },
      async step(stepIndex, total){
        const pct = Math.max(0, Math.min(100, Math.round(stepIndex * (100/total))));
        fillEl && (fillEl.style.width = pct + '%');
        catEl  && (catEl.style.left  = pct + '%');
        await sleep(240);
      },
      hide(){ loaderEl?.classList.remove('show'); }
    };

    /* ==============================
       SB：初始載入
    ============================== */
    (async function boot(){
      if (!ensureAuthOrRedirect()) return;

      // 角色池
      const [n, h, l] = await Promise.all([
        G('normal_characters').select('*').order('id',{ascending:true}),
        G('hidden_characters').select('*').order('id',{ascending:true}),
        G('limited_characters').select('*').order('event_name',{ascending:true}).order('id',{ascending:true}),
      ]);
      pools.normal  = Array.isArray(n.data) ? n.data : [];
      pools.hidden  = Array.isArray(h.data) ? h.data : [];
      pools.limited = Array.isArray(l.data) ? l.data : [];

      // 活動表（取 event_name=名稱、display_name=簡介、thread、圖）
      const ev = await G('events')
        .select('event_name,display_name,starts_at,ends_at,discord_thread_id,image_url')
        .order('starts_at', { ascending: true });
      const evRows = Array.isArray(ev.data) ? ev.data : [];
      eventsMap = new Map(evRows.map(e => [e.event_name, e]));

      await ensureCounter();
      await refreshUIFromCounter();

      // 建立卡池清單（常駐 + 所有活動），描述只顯示 display_name，不顯示時間
      const now = Date.now();
      const list = [];

      // 常駐（名稱=常駐，簡介=display_name 或預設）
      const baseEvent = eventsMap.get('常駐') || null;
      list.push({
        key: '常駐',
        name: '常駐',
        desc: (baseEvent?.display_name || '一般池（含隱藏機率）'),
        banner: baseEvent?.image_url || '',
        active: true, // 常駐永遠開放
        threadId: baseEvent?.discord_thread_id || null,
        starts_at: null, ends_at: null
      });

      // 其他活動（依 DB；active 依時間）
      evRows
        .filter(e => e.event_name !== '常駐')
        .forEach(e => {
          const st = new Date(e.starts_at).getTime();
          const ed = new Date(e.ends_at).getTime();
          const active = now >= st && now <= ed;
          list.push({
            key: e.event_name,               // 名稱 & URL 參數
            name: e.event_name,              // 顯示名稱就是 event_name
            desc: (e.display_name || ''),    // 簡介 = display_name，不顯示時間
            banner: e.image_url || '',
            active,
            threadId: e.discord_thread_id || null,
            starts_at: e.starts_at, ends_at: e.ends_at
          });
        });

      // 掛上倫波外掛
      PoolCarousel.init({
        mount: resultsContainer,
        nameEl: poolNameSlot,
        descEl: poolDescSlot,
        linkEl: poolLinkSlot,
        pools: list,
        onChange: (pool) => {
          window.CURRENT_POOL = pool;
          updateButtonsActiveState();
        }
      });

      bindUI();

      // 管理端若改 max_draws，前端 15 秒同步一次
      setInterval(refreshUIFromCounter, 15000);
    })();

    /* ==============================
       Counter
    ============================== */
    async function ensureCounter(){
      const { data } = await G('counters').select('*').eq('player_id', user.id).single();
      if (!data){
        await G('counters').insert({ player_id: user.id, total_draws: 0, next_pity: 50 });
      }
    }
    async function getCounter(){
      const { data } = await G('counters')
        .select('total_draws,next_pity,max_draws')
        .eq('player_id', user.id).single();
      return data || { total_draws: 0, next_pity: 50, max_draws: 0 };
    }
    async function setCounter(_total_draws, next_pity) {
      await G('counters').upsert({ player_id: user.id, next_pity }, { onConflict: 'player_id' });
    }
    async function refreshUIFromCounter(){
      const c = await getCounter();
      const remain = Math.max(0, c.max_draws - c.total_draws);
      if (remainEl) remainEl.textContent = remain;
      updateButtonsActiveState(remain);
    }
    function isCurrentPoolOpen() {
      // 常駐永遠可抽，活動看時間
      if (!window.CURRENT_POOL) return true;
      if (window.CURRENT_POOL.key === '常駐') return true;
      return !!window.CURRENT_POOL.active;
    }
    async function updateButtonsActiveState(remainCache){
      const c = remainCache ?? (await getCounter());
      const remain = typeof c === 'number' ? c : Math.max(0, c.max_draws - c.total_draws);
      const active = isCurrentPoolOpen();

      const tenOk = remain >= 10 && active && !isPortrait();
      const oneOk = remain >= 1  && active && !isPortrait();

      btnTen.disabled    = !tenOk || btnTen._forceDisabled === true;
      btnSingle.disabled = !oneOk || btnSingle._forceDisabled === true;

      // 顯示狀態（抽卡按鈕淺灰）
      gachaBtns.style.opacity = active ? 1 : .7;
    }

    /* ==============================
       Owned upsert
    ============================== */
    async function addOwned(rarity, character_id, event_name){
      const { data: rows } = await G('owned_characters')
        .select('count')
        .eq('player_id', user.id)
        .eq('rarity', rarity)
        .eq('event_name', event_name)
        .eq('character_id', character_id)
        .limit(1);
      const prev = rows?.[0]?.count || 0;

      await G('owned_characters').upsert({
        player_id: user.id,
        rarity,
        event_name,
        character_id,
        count: prev + 1
      }, { onConflict: 'player_id,rarity,event_name,character_id' });
    }

    /* ==============================
       廣播（用當前選池的 discord_thread_id）
       - 銀/金才廣播
    ============================== */
    async function sendGachaWebhook(rarity, itemName) {
      if (rarity !== 'limited' && rarity !== 'hidden') return;
      try {
        const threadId = (window.CURRENT_POOL && window.CURRENT_POOL.threadId) || null;
        if (!threadId) return; // 沒設定就不送
        const url = `${B_URL}/functions/v1/gacha-notify`;
        const resp = await fetch(url, {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({
            rarity,
            playerName: PLAYER_NAME || '玩家',
            itemName,
            threadId
          })
        });
        if (!resp.ok) {
          const txt = await resp.text().catch(()=>'(no body)');
          console.error('[gacha-notify] status=', resp.status, 'body=', txt);
        }
      } catch (e) {
        console.warn('[gacha-notify] failed:', e);
      }
    }

    /* ==============================
       抽卡核心（含保底 & 限定依當前卡池）
       - hidden 永遠常駐
       - 若選常駐而觸發金 → 改為銀
    ============================== */
    async function drawOnce(){
      const c = await getCounter();
      if (c.total_draws >= c.max_draws) {
        alert('已達抽卡上限'); await refreshUIFromCounter(); return null;
      }
      if (!isCurrentPoolOpen()) {
        alert('此活動未開放，請切換其他卡池'); return null;
      }

      const totalNext = c.total_draws + 1;
      let nextPity    = c.next_pity;

      let rarity, chosen, event_name = DEFAULT_EVENT;

      const currentKey = (window.CURRENT_POOL?.key || '常駐');
      const isBasePool = (currentKey === '常駐');

      // 保底
      const pityTrigger = (totalNext === nextPity);

      if (pityTrigger) {
        if (isBasePool) {
          rarity = 'hidden';
          chosen = pick(pools.hidden);
          event_name = DEFAULT_EVENT; // hidden 永遠常駐
        } else {
          rarity = 'limited';
          const candidates = pools.limited.filter(x => x.event_name === currentKey);
          if (!candidates.length) { alert('此活動沒有限定角色資料'); return null; }
          chosen = pick(candidates);
          event_name = currentKey;
        }
        nextPity += 50;
      } else {
        // 1=銀、100=金、其他白
        const r = Math.floor(Math.random()*100) + 1;
        if (r === 1) {
          rarity = 'hidden';
          chosen = pick(pools.hidden);
          event_name = DEFAULT_EVENT; // hidden 永遠常駐
        } else if (r === 100) {
          if (isBasePool) {
            rarity = 'hidden';
            chosen = pick(pools.hidden);
            event_name = DEFAULT_EVENT;
          } else {
            rarity = 'limited';
            const candidates = pools.limited.filter(x => x.event_name === currentKey);
            if (!candidates.length) { alert('此活動沒有限定角色資料'); return null; }
            chosen = pick(candidates);
            event_name = currentKey;
          }
        } else {
          rarity = 'normal';
          chosen = pick(pools.normal);
          event_name = DEFAULT_EVENT; // normal 也記在常駐
        }
      }

      if (!chosen) { alert('對應池子沒有資料'); return null; }

      await addOwned(rarity, chosen.id, event_name);
      await setCounter(totalNext, nextPity);

      return { rarity, name: chosen.name, id: chosen.id, event_name, totalAfter: totalNext };
    }

    async function drawTenTimes(){
      const c = await getCounter();
      const remain = Math.max(0, c.max_draws - c.total_draws);
      if (remain < 10) { alert('剩餘抽數不足 10 抽'); return null; }
      if (!isCurrentPoolOpen()) { alert('此活動未開放，請切換其他卡池'); return null; }

      const results = [];
      for (let i=0;i<10;i++){
        const r = await drawOnce();
        if (!r) break;
        results.push({ rarity: r.rarity, name: r.name });
      }
      return results;
    }

    /* ==============================
       UI：建立球 / 翻牌與節流
    ============================== */
    function clearResults(){
      resultsContainer.classList.remove('single');
      // 抽卡顯示結果時，把倫波暫時藏起來避免重疊
      PoolCarousel.hide?.();
      // 只刪除既有球排版（保留輪播層與三塊 slot）
      $$('.gacha-row', resultsContainer).forEach(n => n.remove());
    }

    function createOrb(res, { autoReveal=false, revealDelay=0, big=false } = {}){
      const orb = document.createElement('div');
      orb.className = `gacha-orb orb-${res.rarity}` + (big?' big':'');
      const inner = document.createElement('div');
      inner.className = 'orb-inner auto-resize';
      inner.textContent = '';

      const reveal = () => {
        if (orb.classList.contains('revealed')) return;
        inner.textContent = res.name;
        orb.classList.add('revealed');

        // 銀/金廣播 → 用當前卡池的 DCID
        if (res.rarity === 'limited' || res.rarity === 'hidden') {
          sendGachaWebhook(res.rarity, res.name);
        }

        resizeAllTexts();
        checkAllRevealed();
      };

      if (autoReveal) setTimeout(reveal, revealDelay);
      else orb.addEventListener('click', reveal);

      orb.appendChild(inner);
      return orb;
    }

    function checkAllRevealed(){
      const orbs = $$('.gacha-orb', resultsContainer);
      if (orbs.length === 0) return;
      const all = orbs.every(o => o.classList.contains('revealed'));
      if (all) {
        unlockAt = Date.now() + 500;
        setTimeout(()=>{
          canDraw = true;
          unlockButtons();
          PoolCarousel.show?.(); // 翻完結果再把倫波顯示回來
        }, 500);
      }
    }

    function showResultsTen(results){
      canDraw = false; lockButtons(true);
      resultsContainer.classList.remove('single');

      for (let row=0; row<2; row++){
        const rowDiv = document.createElement('div');
        rowDiv.className = 'gacha-row';
        rowDiv.style.position = 'absolute';
        rowDiv.style.left = '0%';
        rowDiv.style.width = '100%';
        rowDiv.style.height = '45%';
        rowDiv.style.display = 'flex';
        rowDiv.style.justifyContent = 'space-between';
        rowDiv.style.gap = '2%';
        rowDiv.style.top = (row===0 ? '0%' : '50%');

        results.slice(row*5, row*5+5).forEach((res, idx)=>{
          const index = row*5 + idx;
          const orb = createOrb(res, { autoReveal: res.rarity==='normal', revealDelay: index*200 });
          rowDiv.appendChild(orb);
        });
        resultsContainer.appendChild(rowDiv);
      }
      resizeAllTexts();
    }

    function showResultSingle(res){
      canDraw = false; lockButtons(true);
      resultsContainer.classList.add('single');

      const rowDiv = document.createElement('div');
      rowDiv.className = 'gacha-row';
      rowDiv.style.position = 'absolute';
      rowDiv.style.inset = '0% 0% 0% 0%';
      rowDiv.style.display = 'flex';
      rowDiv.style.alignItems = 'center';
      rowDiv.style.justifyContent = 'center';

      const orb = createOrb(res, { autoReveal: res.rarity==='normal', revealDelay:0, big:true });
      rowDiv.appendChild(orb);
      resultsContainer.appendChild(rowDiv);

      resizeAllTexts();
      if (res.rarity==='normal') {
        unlockAt = Date.now() + 500;
        setTimeout(()=>{
          canDraw = true; unlockButtons(); PoolCarousel.show?.();
        }, 500);
      }
    }

    /* ==============================
       背包
    ============================== */
    function nameFromPools(rarity, character_id, event_name){
      if (rarity === 'normal') return pools.normal.find(x=>x.id===character_id)?.name || `#${character_id}`;
      if (rarity === 'hidden') return pools.hidden.find(x=>x.id===character_id)?.name || `#${character_id}`;
      const hit = pools.limited.find(x=>x.id===character_id && x.event_name===event_name) || pools.limited.find(x=>x.id===character_id);
      return hit ? hit.name : `#${character_id}`;
    }

    async function openBackpack(){
      const orbs = $$('.gacha-orb', resultsContainer);
      if (orbs.some(o=>!o.classList.contains('revealed'))) {
        alert('請先翻開所有扭蛋！'); return;
      }

      infoTitle.textContent = `${PLAYER_NAME}的背包`;

      const { data, error } = await G('owned_characters')
        .select('rarity,event_name,character_id,count')
        .eq('player_id', user.id);

      if (error) { console.error('[owned_characters] query error:', error); alert('讀取背包失敗'); return; }
      const rows = Array.isArray(data) ? data : [];

      const byKey = new Map();
      for (const r of rows){
        const key = `${r.rarity}|${r.event_name}|${r.character_id}`;
        const v = byKey.get(key);
        byKey.set(key, v ? { ...r, count: v.count + r.count } : { ...r });
      }
      const merged = [...byKey.values()];

      const limited=[], hidden=[], normal=[];
      const byId = a=>a.sort((x,y)=>(x.id??0)-(y.id??0));
      merged.forEach(r=>{
        const nm = nameFromPools(r.rarity, r.character_id, r.event_name);
        const item = { id:r.character_id, html:`${escapeHtml(nm)} × <span>${r.count}</span>` };
        if (r.rarity==='limited')      limited.push(item);
        else if (r.rarity==='hidden')  hidden.push(item);
        else                           normal.push(item);
      });
      byId(limited); byId(hidden); byId(normal);

      const joinRows = (arr, len=3)=>{
        const lines=[]; for(let i=0;i<arr.length;i+=len){ lines.push(arr.slice(i,i+len).map(x=>x.html).join('、 ')); }
        return lines.join('<br>');
      };

      let html='';
      if (limited.length) html += `<div class="backpack-section"><h3 class="auto-resize" style="position:relative;display:inline-block;">活動限定饅頭：</h3><div class="backpack-items">${joinRows(limited,3)}</div></div>`;
      if (hidden.length)  html += `<div class="backpack-section"><h3 class="auto-resize" style="position:relative;display:inline-block;">隱藏饅頭：</h3><div class="backpack-items">${joinRows(hidden,3)}</div></div>`;
      if (normal.length)  html += `<div class="backpack-section"><h3 class="auto-resize" style="position:relative;display:inline-block;">普通饅頭：</h3><div class="backpack-items">${joinRows(normal,3)}</div></div>`;
      if (!html) html = '<div class="backpack-items auto-resize">目前沒有任何饅頭</div>';

      infoBody.innerHTML = html;
      infoModal.style.display = 'flex';
      resizeAllTexts();
    }
    infoModal?.addEventListener('click', ()=> infoModal.style.display='none');
    infoModal?.querySelector('.modal-content')?.addEventListener('click', e=> e.stopPropagation());

    /* ==============================
       綁定按鈕
    ============================== */
    function bindUI(){
      theBtnBag?.addEventListener('click', openBackpack);

      btnSingle?.addEventListener('click', async ()=>{
        if (!ensureAuthOrRedirect()) return;
        if (!canDraw || Date.now() < unlockAt) return alert('稍等一下…');
        if (!isCurrentPoolOpen()) return alert('此活動未開放，請切換其他卡池');

        gachaBtns?.classList.add('bottom');
        lockButtons(true);

        clearResults();
        Loader.show('Roro爆肝中……');

        const r = await drawOnce();
        if (!r) {
          Loader.hide();
          await refreshUIFromCounter();
          unlockButtons();
          return;
        }

        await Loader.step(1, 1);
        Loader.hide();

        await refreshUIFromCounter();
        showResultSingle({ rarity: r.rarity, name: r.name });
      });

      btnTen?.addEventListener('click', async ()=>{
        if (!ensureAuthOrRedirect()) return;
        if (!canDraw || Date.now() < unlockAt) return alert('稍等一下…');

        const c = await getCounter();
        if (c.max_draws - c.total_draws < 10) {
          return alert('剩餘抽數不足 10 抽');
        }
        if (!isCurrentPoolOpen()) return alert('此活動未開放，請切換其他卡池');

        gachaBtns?.classList.add('bottom');
        lockButtons(true);

        clearResults();
        Loader.show('Roro爆肝中……');

        const results = [];
        for (let i = 0; i < 10; i++) {
          const r = await drawOnce();
          if (!r) break;
          results.push({ rarity: r.rarity, name: r.name });
          await Loader.step(i + 1, 10);
        }

        Loader.hide();

        if (!results.length) {
          unlockButtons();
          return;
        }

        await refreshUIFromCounter();
        showResultsTen(results);
      });

      const obs = new MutationObserver(()=>{ resizeAllTexts(); });
      obs.observe(resultsContainer, { childList:true, subtree:true });
    }
  </script>

  <!-- 外掛：卡池倫波 JS -->
  <script src="pool-carousel.js"></script>

  <!-- 你的登出腳本 -->
  <script src="https://shierusha.github.io/library/assets/js/logout.js"></script>
</body>
</html>
