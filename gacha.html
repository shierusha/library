<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>謝爾夏｜扭蛋系統1.1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
  body {
    background: url('https://shierusha.github.io/create-student/imgs/citybg.png') center/cover fixed no-repeat;
    min-height: 100vh; margin:0; font-family:'Noto Sans TC',sans-serif; color:#fff;
  }
  .hidden { display:none !important; }

  /* ====== 共用容器 ====== */
  .wrap { max-width: 1100px; margin: 2rem auto; padding: 0 1rem; }
  .topbar {
    display:flex; align-items:center; justify-content:space-between; gap:.6rem; margin-bottom:.8rem;
  }
  .left-actions, .right-actions { display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; }
  .btn { border:none; border-radius:.55rem; padding:.5rem .9rem; font-weight:700; cursor:pointer; }
  .btn.blue { background:#1767a0; color:#fff; }
  .btn.gray { background:#98a6b8; color:#fff; }
  a.btn { text-decoration:none; display:inline-block; }

  /* ====== 首頁（選卡池） ====== */
  .home-card {
    background: #0d1b3dcc; border:2px solid #1eb5e5; border-radius:16px;
    padding:1rem; box-shadow:0 0 16px #1eb5e5aa; backdrop-filter: blur(2px);
  }
  .home-title { font-size:1.6rem; font-weight:800; letter-spacing:.04em; margin:0 .2rem .6rem; }
  .grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:1rem; }
  @media (max-width: 960px){ .grid { grid-template-columns: repeat(2, 1fr); } }
  @media (max-width: 640px){ .grid { grid-template-columns: 1fr; } }

  .pool-card {
    background:#0f214dcc; border:2px solid #53e2ff; border-radius:14px; overflow:hidden;
    cursor:pointer; transition:.18s; position:relative;
  }
  .pool-card:hover{ transform: translateY(-2px); box-shadow: 0 8px 22px #0008; }
  .pool-banner { width:100%; height:150px; object-fit:cover; background:#10224d; display:block; }
  .pool-body { padding:.8rem 1rem 1rem; }
  .pool-name { font-weight:800; font-size:1.1rem; }
  .pool-time { color:#b7c5ff; font-size:.95rem; margin-top:.25rem; }
  .pool-badge {
    position:absolute; top:.5rem; left:.5rem; background:#23c55e; color:#022;
    padding:.2rem .5rem; border-radius:.4rem; font-weight:800; font-size:.85rem;
  }
  .pool-badge.closed { background:#f97316; color:#200; }
  .pool-badge.future { background:#94a3b8; color:#112; }

  /* ====== 進池畫面（16:9） ====== */
  .container-16-9 {
    position: relative; aspect-ratio: 16/9; width:100%; max-width:1100px; margin: 0 auto;
    border-radius: 16px; overflow: hidden; box-shadow: 0 0 24px #0004; background:#091331;
  }
  .bg-img { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; opacity:.75; }

  /* 置頂工具列（進池） */
  .ingame-top {
    position:absolute; top:1rem; left:1rem; right:1rem; z-index:40;
    display:flex; align-items:center; justify-content:space-between; gap:.6rem;
  }

  /* 中央卡池圖（用 top% 定位） */
  .center-banner {
    position:absolute; left:50%; transform: translateX(-50%);
    top: 26%; /* ← 想調整上下改這裡（百分比） */
    max-height: 38%; width:auto; max-width:78%;
    border-radius:12px; border:2px solid #1eb5e5; box-shadow:0 0 18px #53e2ffaa;
    object-fit:contain; background:#0e1b46;
    z-index: 5;
  }

  /* 抽卡按鈕（預設更靠下） */
  .gacha-buttons {
    position: absolute; bottom: 22%; left: 50%; transform: translateX(-50%);
    display: flex; gap: 10%; width: 60%; height: 11%; z-index: 10; transition: bottom .4s ease;
  }
  .gacha-buttons.bottom { bottom: 14%; }
  .gacha-btn {
    flex: 1; height: 100%; border-radius: 12px; background: rgb(13 27 77 / 82%);
    border: 2px solid #1eb5e5; color: #fff; font-weight: bold; cursor: pointer; transition: all .25s;
    box-shadow: 0 0 12px #53e2ff88, 0 0 24px #1eb5e577 inset;
  }
  .gacha-btn:hover { background:#1eb5e5cc; box-shadow:0 0 18px #53e2ffdd, 0 0 36px #1eb5e5aa inset; }

  .gacha-results {
    position: absolute; top: 10%; left: 50%; transform: translateX(-50%);
    display:flex; flex-direction:column; gap:16px; width:80%; height:52%; z-index:9;
  }
  .gacha-row { display:flex; justify-content:space-between; gap:12px; }
  .gacha-orb {
    position:relative; flex:1; aspect-ratio:1/1; border-radius:50%; display:flex; align-items:center; justify-content:center;
    overflow:hidden; cursor:pointer; user-select:none; transition: all .3s ease;
  }
  .orb-inner { width:90%; height:35%; display:flex; align-items:center; justify-content:center; text-align:center; line-height:1.2; font-weight:bold; }
  .orb-normal  { background:#fff; border:3px solid #ccc; }
  .orb-hidden  { background:#c0c0c0; border:3px solid #aaa; }
  .orb-limited { background:gold; border:3px solid orange; }
  .gacha-orb.revealed { background: transparent; }
  .orb-normal.revealed  { border:3px solid #fff; color:#fff; }
  .orb-hidden.revealed  { border:3px solid #c0c0c0; color:#c0c0c0; }
  .orb-limited.revealed { border:3px solid gold; color:#ffd700; }
  .gacha-results.single{ display:flex; align-items:center; justify-content:center; }
  .gacha-orb.big{ max-width:25%; }

  /* HUD */
  .gacha-hud { position:absolute; bottom:6%; right:4%; display:flex; align-items:center; gap:.6rem; z-index:30; }
  .counter-box { font-weight:700; padding:.35rem .6rem; border-radius:4px; background:#132657cc; border:1px solid #2a4585; }
  .gacha-counter { position:absolute; bottom:5%; right:17%; z-index:30; }

  /* Loader */
  .gacha-loader{ position:absolute; left:10%; right:10%; top:45%; height:15%; z-index:60; display:none; }
  .gacha-loader.show{ display:block; }
  .gacha-loader .loader-box{ position:relative; height:100%; display:flex; flex-direction:column; gap:8px; justify-content:center; }
  .loader-bar{ position:relative; height:42%; background:#263257; border-radius:999px; overflow:hidden; box-shadow: inset 0 0 10px #000a; }
  .loader-fill{ position:absolute; left:0; top:0; height:100%; width:0%; background: linear-gradient(90deg,#2de0ff88,#6dffae88); box-shadow: 0 0 18px #53e2ff99 inset; transition: width .26s cubic-bezier(.22,.61,.36,1); }
  .loader-cat{ position:absolute; top:-15%; left:0; transform: translate(-50%,-90%); height:100%; aspect-ratio:1/1; filter: drop-shadow(0 3px 8px #000c); transition:left .26s cubic-bezier(.22,.61,.36,1); pointer-events:none; }
  .loader-text{ text-align:center; color:#e9efff; font-weight:900; text-shadow:0 2px 6px #000c; height:100%; display:flex; align-items:center; justify-content:center; }

  /* Modal */
  .modal-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:2000; }
  .modal-content{ background:#0d1b4dcc; border-radius:18px; border:2px solid #1eb5e5; box-shadow:0 0 16px 2px #62f1fe88, 0 8px 32px #1eb5e5aa; width:500px; max-width:93vw; height:340px; max-height:80vh; display:flex; flex-direction:column; overflow:hidden; }
  .modal-header{ padding:15px 20px 0 24px; font-size:1.5em; font-weight:bold; }
  .modal-header::after{ content:""; display:block; height:5px; width:70%; margin:.5rem 0 0; border-radius:2px; background:linear-gradient(to right,#53e2ff99 65%,#53e2ff00 100%); }
  .modal-body{ padding:12px 24px 24px; font-size:1.2em; line-height:1.5; overflow:auto; white-space:pre-line; }

  /* 未開放遮罩 */
  .closed-mask {
    position:absolute; inset:0; background: rgba(0,0,0,.35);
    display:flex; align-items:center; justify-content:center; z-index: 20; pointer-events:none; font-size:2rem; font-weight:900;
  }

  .auto-resize{}
  </style>
</head>
<body>

  <!-- ====== 視圖一：卡池首頁 ====== -->
  <div id="home-view" class="wrap">
    <div class="topbar">
      <div class="left-actions">
        <button id="btn-home-back" class="btn gray" type="button">返回上一頁</button>
      </div>
      <div class="right-actions">
        <a id="btn-leaderboard-home" class="btn blue" target="_blank" rel="noopener">持有榜</a>
        <button id="btn-open-backpack-home" class="btn gray" type="button">背包</button>
      </div>
    </div>
    <div class="home-card">
      <div class="home-title">選擇卡池</div>
      <div id="pool-grid" class="grid"><!-- JS 注入卡池卡片 --></div>
    </div>
  </div>

  <!-- ====== 視圖二：進池抽卡 ====== -->
  <div id="pool-view" class="wrap hidden">
    <div class="container-16-9">
      <img class="bg-img" src="https://shierusha.github.io/school-battle/teachers/img/8.webp" alt="background">

      <div class="ingame-top">
        <div class="left-actions">
          <button id="btn-back-to-home" class="btn gray" type="button">返回卡池選擇</button>
        </div>
        <div class="right-actions">
          <a id="btn-leaderboard-pool" class="btn blue" target="_blank" rel="noopener">持有榜</a>
          <button id="btn-backpack" class="btn gray" type="button">背包</button>
        </div>
      </div>

      <!-- 中央卡池圖 -->
      <img id="center-banner" class="center-banner" alt="pool-banner" />

      <!-- 抽卡結果 -->
      <div class="gacha-results" id="gacha-results"></div>

      <!-- Loader -->
      <div id="gacha-loader" class="gacha-loader">
        <div class="loader-box">
          <img class="loader-cat" id="loader-cat" src="https://shierusha.github.io/library/img/cat.png" alt="cat">
          <div class="loader-bar"><div class="loader-fill" id="loader-fill"></div></div>
          <div class="loader-text auto-resize" id="loader-text">Roro爆肝中……</div>
        </div>
      </div>

      <!-- 抽卡按鈕（預設更靠下） -->
      <div class="gacha-buttons">
        <button id="btn-single" class="gacha-btn auto-resize">單抽</button>
        <button id="btn-ten" class="gacha-btn auto-resize">十連抽</button>
      </div>

      <!-- HUD -->
      <div class="gacha-hud">
        <div class="counter-box">累積抽數：<span id="draw-count">0</span></div>
      </div>

      <!-- 未開放遮罩 -->
      <div id="closed-mask" class="closed-mask hidden">未開放</div>
    </div>
  </div>

  <!-- ====== Modal：旋轉提示（保留） ====== -->
  <div id="orientation-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">請旋轉螢幕</div>
      <div class="modal-body">為了最佳體驗，請將裝置轉成橫向模式</div>
    </div>
  </div>

  <!-- ====== Modal：背包 ====== -->
  <div id="info-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header" id="info-modal-title">背包</div>
      <div class="modal-body" id="info-modal-body"></div>
    </div>
  </div>

<script>
/* ==============================
   常數 & Supabase 初始化
============================== */
const LEADERBOARD_URL = 'https://shierusha.github.io/library/gacha/leaderboard'; // 你已經做好了的持有榜
const DEFAULT_EVENT   = '常駐'; // normal/hidden 的 event_name

// 是否改走 Edge Function 單抽
const USE_EDGE = false; // ← 等你部署好 functions/draw-once 再改 true

const B_URL  = 'https://ogzpfrkwnqqaitytncla.supabase.co';
const B_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9nenBmcmt3bnFxYWl0eXRuY2xhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxODQzNzEsImV4cCI6MjA3MDc2MDM3MX0.Ls83xOXcKIW7FUcavr8_sOs37I18VGFWYNW3sNFRS24';
const B_TOKEN     = localStorage.getItem('gacha_b_jwt') || '';
const B_TOKEN_EXP = Number(localStorage.getItem('gacha_b_jwt_exp') || 0);
const PLAYER_NAME = localStorage.getItem('gacha_player_name') || '我的';
const REDIRECT_PLAYER = 'https://shierusha.github.io/create-student/player';

const sb = window.supabase.createClient(B_URL, B_ANON, {
  global: { headers: B_TOKEN ? { Authorization: `Bearer ${B_TOKEN}` } : {} }
});
if (B_TOKEN) sb.realtime.setAuth(B_TOKEN);
const G = (t) => sb.schema('gacha').from(t);

/* ==============================
   快取 & 狀態
============================== */
const $  = (s, r=document) => r.querySelector(s);
const $$ = (s, r=document) => [...r.querySelectorAll(s)];
const sleep = (ms) => new Promise(res => setTimeout(res, ms));
const escapeHtml = s => (s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
const pick = arr => arr[Math.floor(Math.random()*arr.length)];

let EVENTS = [];   // [{event_name, display_name, starts_at, ends_at, image_url}]
let pools  = { normal: [], hidden: [], limited: [] };

let currentEvent = null; // 進池中的活動（null 表示首頁）

/* ==============================
   入口保護
============================== */
function ensureAuthOrRedirect(){
  const now = Math.floor(Date.now()/1000);
  if (!B_TOKEN || (B_TOKEN_EXP && now >= B_TOKEN_EXP)) {
    alert('登入逾期，將返回玩家中心。');
    location.href = REDIRECT_PLAYER;
    return false;
  }
  return true;
}
setInterval(ensureAuthOrRedirect, 60*1000);

/* ==============================
   首頁：載卡池
============================== */
function isNowOpen(ev){
  if (!ev) return true;
  const now = Date.now();
  const st = ev.starts_at ? new Date(ev.starts_at).getTime() : -Infinity;
  const en = ev.ends_at   ? new Date(ev.ends_at).getTime()   :  Infinity;
  return now >= st && now <= en;
}
function fmtRange(ev){
  if (!ev?.starts_at || !ev?.ends_at) return '—';
  const d = (s)=>{ const x=new Date(s); const pad=n=>String(n).padStart(2,'0'); return `${x.getMonth()+1}/${pad(x.getDate())} ${pad(x.getHours())}:${pad(x.getMinutes())}`; };
  return `${d(ev.starts_at)} → ${d(ev.ends_at)}`;
}
async function loadPools(){
  const [n,h,l,ev] = await Promise.all([
    G('normal_characters').select('*').order('id'),
    G('hidden_characters').select('*').order('id'),
    G('limited_characters').select('id,name,image_url,event_name').order('id'),
    G('events').select('event_name,display_name,starts_at,ends_at,image_url').order('starts_at')
  ]);
  pools.normal  = n.data || [];
  pools.hidden  = h.data || [];
  pools.limited = l.data || [];
  EVENTS = (ev.data || []).map(e=>({ ...e, display_name: e.display_name || e.event_name }));
}
function renderHome(){
  // 設置持有榜連結
  $('#btn-leaderboard-home').href = LEADERBOARD_URL;

  const grid = $('#pool-grid');
  grid.innerHTML = '';

  // 依時間排序，開放中的在前
  const sorted = [...EVENTS].sort((a,b)=>{
    const ao = isNowOpen(a), bo = isNowOpen(b);
    if (ao!==bo) return bo-ao;
    return new Date(a.starts_at) - new Date(b.starts_at);
  });

  if (!sorted.length){
    grid.innerHTML = `<div class="home-card">目前沒有活動。</div>`;
    return;
  }

  for (const ev of sorted){
    const card = document.createElement('div');
    card.className = 'pool-card';
    card.innerHTML = `
      <img class="pool-banner" src="${escapeHtml(ev.image_url||'')}" alt="">
      <div class="pool-body">
        <div class="pool-name">${escapeHtml(ev.display_name)}</div>
        <div class="pool-time">${fmtRange(ev)}</div>
      </div>
    `;
    const badge = document.createElement('div');
    badge.className = 'pool-badge ' + (isNowOpen(ev) ? 'open' : (new Date(ev.starts_at) > new Date() ? 'future' : 'closed'));
    badge.textContent = isNowOpen(ev) ? '開放中' : (new Date(ev.starts_at) > new Date() ? '未開放' : '已結束');
    card.appendChild(badge);

    card.onclick = ()=> enterPool(ev.event_name);
    grid.appendChild(card);
  }
}

/* ==============================
   視圖切換
============================== */
function showHome(){
  currentEvent = null;
  $('#home-view').classList.remove('hidden');
  $('#pool-view').classList.add('hidden');
}
function showPool(){
  $('#home-view').classList.add('hidden');
  $('#pool-view').classList.remove('hidden');
}

/* ==============================
   進池：設定 banner / 狀態 / 禁用
============================== */
function getEventByName(name){ return EVENTS.find(e=>e.event_name===name) || null; }

function applyPoolUI(ev){
  // 置中央 banner
  const img = $('#center-banner');
  if (ev?.image_url){ img.src = ev.image_url; img.classList.remove('hidden'); }
  else { img.removeAttribute('src'); img.classList.add('hidden'); }

  // 未開放 -> 禁用 + 遮罩
  const open = isNowOpen(ev);
  const mask = $('#closed-mask');
  mask.classList.toggle('hidden', open);

  const btnSingle  = $('#btn-single');
  const btnTen     = $('#btn-ten');
  if (open){
    btnSingle.disabled = false; btnTen.disabled = false;
  } else {
    btnSingle.disabled = true;  btnTen.disabled = true;
  }

  // 更新持有榜連結
  $('#btn-leaderboard-pool').href = LEADERBOARD_URL;
}

/* ==============================
   Counter
============================== */
async function ensureCounter(){
  const { data } = await G('counters').select('*').eq('player_id', getUserId()).single();
  if (!data) await G('counters').insert({ player_id: getUserId(), total_draws:0, next_pity:50 });
}
async function getCounter(){
  const { data } = await G('counters').select('total_draws,next_pity,max_draws').eq('player_id', getUserId()).single();
  return data || { total_draws:0, next_pity:50, max_draws:0 };
}
async function setCounter(next_pity){
  await G('counters').upsert({ player_id: getUserId(), next_pity }, { onConflict:'player_id' });
}
function getUserId(){
  try{
    const pad=s=>s+'='.repeat((4-s.length%4)%4);
    const p = JSON.parse(atob(pad(B_TOKEN.split('.')[1]).replace(/-/g,'+').replace(/_/g,'/')));
    return p.sub;
  }catch{return null;}
}

/* ==============================
   抽卡核心（本地 / Edge）
============================== */
async function addOwned(rarity, character_id, event_name){
  const { data: rows } = await G('owned_characters')
    .select('count').eq('player_id', getUserId())
    .eq('rarity', rarity).eq('event_name', event_name).eq('character_id', character_id).limit(1);
  const prev = rows?.[0]?.count || 0;
  await G('owned_characters').upsert({
    player_id: getUserId(), rarity, event_name, character_id, count: prev + 1
  }, { onConflict: 'player_id,rarity,event_name,character_id' });
}

function limitedPoolForCurrent(){
  if (!currentEvent) return [];
  return pools.limited.filter(x=>x.event_name===currentEvent.event_name);
}

async function drawOnceLocal(){
  const c = await getCounter();
  if (c.total_draws >= c.max_draws) { alert('已達抽卡上限'); return null; }

  const poolLimited = limitedPoolForCurrent();
  const mustGold = (c.total_draws + 1) === c.next_pity;

  let rarity, chosen, event_name = DEFAULT_EVENT, nextPity = c.next_pity;

  if (mustGold) {
    rarity = 'limited'; chosen = pick(poolLimited); event_name = currentEvent?.event_name || '活動'; nextPity += 50;
  } else {
    const r = Math.floor(Math.random()*100)+1;
    if (r===1){ rarity='hidden'; chosen=pick(pools.hidden); event_name=DEFAULT_EVENT; }
    else if (r===100){ rarity='limited'; chosen=pick(poolLimited); event_name=currentEvent?.event_name||'活動'; }
    else { rarity='normal'; chosen=pick(pools.normal); event_name=DEFAULT_EVENT; }
  }
  if (!chosen){ alert('此卡池沒有資料'); return null; }

  await addOwned(rarity, chosen.id, event_name);
  await setCounter(nextPity);

  return { rarity, name: chosen.name, id: chosen.id, event_name };
}

// 預留 Edge 版本（部署好後，把 USE_EDGE=true 即可）
async function drawOnceEdge(){
  const url = `${B_URL}/functions/v1/draw-once`;
  const resp = await fetch(url, {
    method:'POST',
    headers:{ 'content-type':'application/json', 'authorization': 'Bearer '+B_TOKEN },
    body: JSON.stringify({ event_name: currentEvent?.event_name || null }) // 從這個活動抽
  });
  if (!resp.ok){ const t=await resp.text().catch(()=>'-'); throw new Error(t||resp.statusText); }
  const j = await resp.json();
  // 回傳格式期望：{ rarity, name, character_id, event_name, next_pity }
  return { rarity:j.rarity, name:j.name, id:j.character_id, event_name:j.event_name };
}

async function drawOnce(){
  return USE_EDGE ? drawOnceEdge() : drawOnceLocal();
}

async function drawTenTimes(){
  const c = await getCounter();
  const remain = Math.max(0, c.max_draws - c.total_draws);
  if (remain < 10) { alert('剩餘抽數不足 10 抽'); return []; }
  const results=[];
  for (let i=0;i<10;i++){
    const r = await drawOnce(); if (!r) break; results.push(r);
    await Loader.step(i+1,10);
  }
  return results;
}

/* ==============================
   Loader
============================== */
const loaderEl  = $('#gacha-loader');
const fillEl    = $('#loader-fill');
const catEl     = $('#loader-cat');
const loaderTxt = $('#loader-text');
const Loader = {
  show(label='Roro爆肝中……'){ loaderTxt.textContent=label; fillEl.style.width='0%'; catEl.style.left='0%'; loaderEl.classList.add('show'); },
  async step(i,total){ const pct=Math.round(i*(100/total)); fillEl.style.width=pct+'%'; catEl.style.left=pct+'%'; await sleep(220); },
  hide(){ loaderEl.classList.remove('show'); }
};

/* ==============================
   抽卡 UI
============================== */
const resultsContainer = $('#gacha-results');
const btnSingle = $('#btn-single');
const btnTen    = $('#btn-ten');
const btnBackToHome = $('#btn-back-to-home');
const btnBackpack   = $('#btn-backpack');

function clearResults(){ resultsContainer.classList.remove('single'); resultsContainer.innerHTML=''; }
function checkAllRevealed(){
  const orbs = $$('.gacha-orb', resultsContainer);
  if (!orbs.length) return;
  const all = orbs.every(o=>o.classList.contains('revealed'));
  if (all) setTimeout(()=> unlockButtons(), 500);
}
function sendGachaWebhook(rarity, itemName){
  if (rarity!=='limited' && rarity!=='hidden') return;
  fetch(`${B_URL}/functions/v1/gacha-notify`, {
    method:'POST', headers:{'content-type':'application/json'},
    body: JSON.stringify({ rarity, playerName: PLAYER_NAME||'玩家', itemName, threadId:"1409888757603106886" })
  }).catch(()=>{});
}
function createOrb(res, { autoReveal=false, revealDelay=0, big=false } = {}){
  const orb = document.createElement('div');
  orb.className = `gacha-orb orb-${res.rarity}` + (big?' big':'');
  const inner = document.createElement('div'); inner.className='orb-inner auto-resize'; inner.textContent='';
  const reveal = ()=>{
    if (orb.classList.contains('revealed')) return;
    inner.textContent = res.name; orb.classList.add('revealed');
    if (res.rarity==='limited' || res.rarity==='hidden') sendGachaWebhook(res.rarity, res.name);
    checkAllRevealed();
  };
  if (autoReveal) setTimeout(reveal, revealDelay); else orb.addEventListener('click', reveal);
  orb.appendChild(inner); return orb;
}
function showResultsTen(results){
  lockButtons();
  resultsContainer.classList.remove('single'); resultsContainer.innerHTML='';
  for (let row=0; row<2; row++){
    const rowDiv = document.createElement('div'); rowDiv.className='gacha-row';
    results.slice(row*5, row*5+5).forEach((res, idx)=>{
      const index=row*5+idx; const orb=createOrb(res, { autoReveal: res.rarity==='normal', revealDelay: index*200 });
      rowDiv.appendChild(orb);
    });
    resultsContainer.appendChild(rowDiv);
  }
}
function showResultSingle(res){
  lockButtons();
  resultsContainer.classList.add('single'); resultsContainer.innerHTML='';
  const isWhite = res.rarity==='normal';
  const orb = createOrb(res, { autoReveal:isWhite, big:true });
  const rowDiv=document.createElement('div'); rowDiv.className='gacha-row'; rowDiv.style.justifyContent='center';
  rowDiv.appendChild(orb); resultsContainer.appendChild(rowDiv);
  if (isWhite) setTimeout(()=> unlockButtons(), 500);
}
function lockButtons(){ btnSingle._forceDisabled = btnTen._forceDisabled = true; btnSingle.disabled = btnTen.disabled = true; }
function unlockButtons(){ btnSingle._forceDisabled = btnTen._forceDisabled = false; btnSingle.disabled = btnTen.disabled = false; }

/* ==============================
   背包（首頁 / 進池 兩種顯示規則）
============================== */
function nameFromPools(rarity, character_id, event_name){
  if (rarity==='normal') return pools.normal.find(x=>x.id===character_id)?.name || `#${character_id}`;
  if (rarity==='hidden') return pools.hidden.find(x=>x.id===character_id)?.name || `#${character_id}`;
  const hit = pools.limited.find(x=>x.id===character_id && x.event_name===event_name) || pools.limited.find(x=>x.id===character_id);
  return hit ? hit.name : `#${character_id}`;
}
async function openBackpack(scope){
  // scope: 'home' | 'pool'
  const { data, error } = await G('owned_characters').select('rarity,event_name,character_id,count').eq('player_id', getUserId());
  if (error){ alert('讀取背包失敗'); return; }
  const rows = data || [];

  // 合併同 key
  const map = new Map();
  for (const r of rows){
    const key = `${r.rarity}|${r.event_name}|${r.character_id}`;
    const v = map.get(key);
    map.set(key, v ? { ...r, count: v.count + r.count } : { ...r });
  }
  const list = [...map.values()];

  // 過濾：進池時限定只顯示該池
  const limited = list.filter(r=>r.rarity==='limited' && (scope==='home' ? true : r.event_name===currentEvent?.event_name));
  const hidden  = list.filter(r=>r.rarity==='hidden');
  const normal  = list.filter(r=>r.rarity==='normal');

  // 排序
  const byId = a=>a.sort((x,y)=>x.character_id - y.character_id);
  byId(limited); byId(hidden); byId(normal);

  // 分行工具
  const makeLines = (arr, perRow, withEventTag=false)=>{
    const lines=[]; let buf=[];
    const rows = arr.map(r=>{
      const nm = nameFromPools(r.rarity, r.character_id, r.event_name);
      const tag = withEventTag ? `<span style="color:#8bd5ff">[${escapeHtml(r.event_name)}]</span> ` : '';
      return `${tag}${escapeHtml(nm)} × <span>${r.count}</span>`;
    });
    for (const it of rows){ buf.push(it); if (buf.length===perRow){ lines.push(buf.join('、 ')); buf=[]; } }
    if (buf.length) lines.push(buf.join('、 '));
    return lines.join('<br>');
  };

  let html = '';

  if (scope==='home'){
    // 限定：依活動分組，每行 2
    const byEvent = new Map();
    for (const r of limited){
      const arr = byEvent.get(r.event_name) || []; arr.push(r); byEvent.set(r.event_name, arr);
    }
    if (byEvent.size){
      html += `<div class="backpack-section"><h3>活動限定饅頭：</h3>`;
      for (const [ev, arr] of byEvent.entries()){
        html += `<div class="backpack-items" style="margin:.2rem 0 .5rem">`;
        html += `<div style="color:#53e2ff; font-weight:800; margin-bottom:.1rem;">${escapeHtml(ev)}</div>`;
        html += makeLines(arr, 2, false);
        html += `</div>`;
      }
      html += `</div>`;
    }
  }else{
    // 進池：限定只顯示該池，每行 2
    if (limited.length){
      html += `<div class="backpack-section"><h3>活動限定饅頭：</h3><div class="backpack-items">${makeLines(limited, 2, false)}</div></div>`;
    }
  }

  // 隱藏：兩個換行
  if (hidden.length){
    html += `<div class="backpack-section"><h3>隱藏饅頭：</h3><div class="backpack-items">${makeLines(hidden, 2, false)}</div></div>`;
  }
  // 普通：三個換行
  if (normal.length){
    html += `<div class="backpack-section"><h3>普通饅頭：</h3><div class="backpack-items">${makeLines(normal, 3, false)}</div></div>`;
  }

  if (!html) html = `<div class="backpack-items">目前沒有任何饅頭</div>`;

  $('#info-modal-title').textContent = `${PLAYER_NAME}的背包`;
  $('#info-modal-body').innerHTML = html;
  $('#info-modal').style.display = 'flex';
}
$('#info-modal').addEventListener('click', e=>{
  if (e.target.id==='info-modal') $('#info-modal').style.display='none';
});

/* ==============================
   進池 / 首頁 事件綁定
============================== */
function bindButtons(){
  // 首頁工具列
  $('#btn-home-back').onclick = ()=> history.length>1 ? history.back() : (location.href = REDIRECT_PLAYER);
  $('#btn-open-backpack-home').onclick = ()=> openBackpack('home');

  // 進池工具列
  btnBackToHome.onclick = ()=> { clearResults(); showHome(); };
  btnBackpack.onclick   = ()=> openBackpack('pool');

  // 抽卡
  btnSingle.onclick = async ()=>{
    if (!ensureAuthOrRedirect()) return;
    if (!isNowOpen(currentEvent)) return alert('此卡池未開放');
    clearResults(); Loader.show('Roro爆肝中……');
    const r = await drawOnce().catch(e=>{ alert('抽卡失敗：'+(e.message||e)); return null; });
    if (!r){ Loader.hide(); return; }
    await Loader.step(1,1); Loader.hide();
    await refreshCounterUI(); showResultSingle(r);
  };
  btnTen.onclick = async ()=>{
    if (!ensureAuthOrRedirect()) return;
    if (!isNowOpen(currentEvent)) return alert('此卡池未開放');
    clearResults(); Loader.show('Roro爆肝中……');
    const rs = await drawTenTimes().catch(e=>{ alert('抽卡失敗：'+(e.message||e)); return []; });
    Loader.hide();
    if (!rs.length) return;
    await refreshCounterUI(); showResultsTen(rs);
  };
}

async function refreshCounterUI(){
  const c = await getCounter();
  $('#draw-count').textContent = c.total_draws ?? 0;
}

/* ==============================
   進池：切換
============================== */
async function enterPool(event_name){
  currentEvent = getEventByName(event_name);
  showPool();
  applyPoolUI(currentEvent);
  await ensureCounter();
  await refreshCounterUI();
}

/* ==============================
   橫向強制（保留）
============================== */
const orientationModal = $('#orientation-modal');
function isPortrait(){ return window.matchMedia('(orientation: portrait)').matches || window.innerHeight > window.innerWidth; }
function applyOrientation(){
  const portrait = isPortrait();
  orientationModal.style.display = portrait ? 'flex' : 'none';
  document.body.style.overflow = portrait ? 'hidden' : '';
}
applyOrientation();
addEventListener('resize', applyOrientation);
addEventListener('orientationchange', applyOrientation);

/* ==============================
   啟動
============================== */
(async function init(){
  if (!ensureAuthOrRedirect()) return;
  $('#btn-leaderboard-home').href = LEADERBOARD_URL;
  $('#btn-leaderboard-pool').href = LEADERBOARD_URL;

  bindButtons();
  await loadPools();
  await ensureCounter();
  await refreshCounterUI();
  renderHome();
  showHome();
})();
</script>
</body>
</html>
