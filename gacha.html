
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>謝爾夏｜扭蛋系統2.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- 新增：選池倫波外掛 CSS -->
  <link rel="stylesheet" href="https://shierusha.github.io/library/assets/css/pool-carousel.css"/>

  <style>
/* ==============================
   全域背景 / 字體（原樣）
============================== */
body {
  background: url('https://shierusha.github.io/create-student/imgs/citybg.png') center center no-repeat;
  background-size: cover;
  min-height: 100vh;
  font-family: 'Noto Sans TC', sans-serif;
  overflow: hidden;
}
body.dark-bg::before {
  content: "";
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.3);
  z-index: 0; pointer-events: none;
}

/* ==============================
   16:9 容器（原樣）
============================== */
.container-16-9 {
  position: relative;
  max-width: 90%;
  max-height: 80vh;
  aspect-ratio: 16/9;
  overflow: hidden;
  border-radius: 16px;
  box-shadow: 0 0 24px #0004;
  margin: 3vh auto;
}
.bg-img {
  position: absolute; inset: 0;
  width: 100%; height: 100%;
  object-fit: cover;
  z-index: 1;
}

/* ==============================
   Modal（旋轉 / 背包）（原樣）
============================== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  z-index: 2000;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: modal-fadein-bg 0.25s;
}
@keyframes modal-fadein-bg {
  from { background: rgba(0,0,0,0); }
  to   { background: rgba(0,0,0,0.45); }
}
.modal-content {
  background: rgb(13 27 77 / 82%);
  border-radius: 18px;
  border: 2px solid #1eb5e5;
  box-shadow: 0 0 16px 2px #62f1fe88, 0 8px 32px #1eb5e5aa;
  width: 500px; max-width: 93vw;
  height: 340px; max-height: 80vh;
  display: flex; flex-direction: column;
  overflow: hidden;
  animation: modal-pop 0.32s cubic-bezier(.42,1.4,.51,1.01);
}
@keyframes modal-pop {
  from { opacity: 0; transform: scale(0.92); }
  to   { opacity: 1; transform: scale(1); }
}
.modal-header {
  background: none;
  padding: 15px 20px 0px 24px;
  color: #fff; font-size: 1.5em; font-weight: bold;
  letter-spacing: 1px; text-shadow: 0 1px 4px #000a;
}
.modal-header::after {
  content: ""; display: block; height: 5px; width: 70%;
  margin:.5rem 0 0; border-radius: 2px;
  background: linear-gradient(to right,#53e2ff99 65%,#53e2ff00 100%);
  pointer-events: none;
}
.modal-body {
  color:#fff; padding: 12px 24px 24px 24px;
  font-size: 1.2em; line-height:1.5; text-shadow:0 1px 4px #0008;
  overflow-y:auto; max-height:240px; white-space: pre-line;
  scrollbar-width:none;
}
.modal-body::-webkit-scrollbar { display:none; }

/* ==============================
   抽卡按鈕（原樣）
============================== */
.gacha-buttons {
  position: absolute;
  bottom: 15%;
  left: 50%; transform: translateX(-50%);
  display: flex; gap: 10%;
  width: 60%; height: 11%;
  z-index: 10;
  transition: bottom 0.4s ease;
}


.gacha-btn.inactive {
    border: none;
    box-shadow: none;
}

.gacha-btn {
  flex: 1; height: 100%;
  border-radius: 12px;
  background: rgb(13 27 77 / 82%);
  border: 2px solid #1eb5e5; color: #fff; font-weight: bold;
  cursor: pointer; transition: all 0.25s;
  box-shadow: 0 0 12px #53e2ff88, 0 0 24px #1eb5e577 inset;
}
.gacha-btn:hover {
  background: #1eb5e5cc;
  box-shadow: 0 0 18px #53e2ffdd, 0 0 36px #1eb5e5aa inset;
}

/* ==============================
   抽卡結果容器（原樣）
============================== */
.gacha-results {
  position: absolute;
  top: 5%; left: 50%; transform: translateX(-50%);
  display: flex; flex-direction: column;
  width: 80%; height: 66%;
  z-index: 9;
}
.gacha-row {
  display: flex; justify-content: space-between;
  width: 100%; gap: 12px;
  margin-top: 4%;
}
.gacha-orb {
  position: relative; flex: 1;
  aspect-ratio: 1/1; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  overflow: hidden; cursor: pointer; user-select: none;
  transition: all 0.3s ease;
}
.orb-inner {
  width: 90%; height: 35%;
  display: flex; align-items: center; justify-content: center;
  text-align: center; line-height: 1.2; font-weight: bold;
}
.orb-normal  { background: #fff;    border: 3px solid #ccc; }
.orb-hidden  { background: #c0c0c0; border: 3px solid #aaa; }
.orb-limited { background: gold;    border: 3px solid orange; }
.gacha-orb.revealed { background: transparent; }
.orb-normal.revealed  { border: 3px solid #fff;    color: #fff; }
.orb-hidden.revealed  { border: 3px solid #c0c0c0; color: #c0c0c0; }
.orb-limited.revealed { border: 3px solid gold;    color: #ffd700; }

.gacha-results.single {
  display: flex;
  align-items: center;
  justify-content: center;
}
.gacha-orb.big {
  aspect-ratio: 1/1;
  max-width: 25%;
}

/* ==============================
   HUD（右下角）（原樣）
============================== */
.gacha-hud {
  position: absolute;
  bottom: 6%;
  right: 4%;
  display: flex;
  align-items: center;
  gap: 1rem;
  z-index: 30;
  color: #fff;
  text-shadow: 0 1px 4px #000a;
  height: 10%;
}
.counter-box {
  height: 100%;
  display: flex; align-items: center;
  font-weight: bold; padding: 0 6px;
  border-radius: 4px;
  background: rgba(255,255,255,0.01);
}
.gacha-counter {
  position: absolute;
  bottom: 5%; right: 17%;
  gap: 1rem; z-index: 30;
  color: #fff; text-shadow: 0 1px 4px #000a;
  height: 10%;
}
.gacha-results { z-index: 10; }

/* 背包按鈕（原樣） */
.gacha-backpack {
  height: 100%; aspect-ratio: 2/1;
  border: 2px solid #1eb5e5; border-radius: 8px;
  background: rgb(13 27 77 / 82%); color: #fff;
  cursor: pointer; transition: all 0.25s;
  box-shadow: 0 0 8px #53e2ff88, 0 0 16px #1eb5e577 inset;
  display: flex; align-items: center; justify-content: center;
}
.backpack-box {
  height: 100%;
  display: flex; align-items: center; justify-content: center;
}
.backpack-section { margin: 0.5rem 0; }
.backpack-section h3 { color: #53e2ff; margin-bottom: 0.3rem; }
.backpack-items { color: #fff; }
.backpack-items span { color: #ffe082; font-weight: bold; }

/* ==============================
   Loader（原樣）
============================== */
.gacha-loader{
  position:absolute; 
  left:10%; 
  right:10%;
  top: 45%;
  height: 15%;
  z-index:60; 
  display:none;
}
.gacha-loader.show{ display:block; }
.gacha-loader .loader-box{
  position:relative; 
  height:100%;
  display:flex; 
  flex-direction:column; 
  gap:8px; justify-content:center;
}
.loader-bar{
  position:relative; height:42%;
  background:#263257; border-radius:999px; overflow:hidden;
  box-shadow: inset 0 0 10px #000a;
}
.loader-fill{
  position:absolute; left:0; top:0; height:100%; width:0%;
  background: linear-gradient(90deg,#2de0ff88,#6dffae88);
  box-shadow: 0 0 18px #53e2ff99 inset;
  transition: width .26s cubic-bezier(.22,.61,.36,1);
}
.loader-cat{
  position:absolute; 
  top:-15%; left:0;
  transform: translate(-50%, -90%);
  height: 100%;
  aspect-ratio: 1 / 1;
  filter: drop-shadow(0 3px 8px #000c);
  transition: left .26s cubic-bezier(.22,.61,.36,1);
  pointer-events:none;
}
.loader-text{
  text-align:center; color:#e9efff; font-weight:900;
  text-shadow:0 2px 6px #000c;
  height: 100%;
  display:flex; align-items:center; justify-content:center;
}

/* 自動字級（原樣；新增區塊會加 class 使用） */
.auto-resize {}

/* ==============================
   ★ 新增：修正游標與箭頭層級（不改舊規則）
============================== */
.gacha-btn:disabled { cursor: pointer; } /* 不要顯示禁止符號 */
.back { z-index: 60; cursor: pointer; }  /* 確保可點到 */






.orb-inner {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px; /* 圖片與文字間距 */
}

.orb-inner .orb-icon {
  max-height: 100%;
  max-width: 100%;
  object-fit: contain;
}

/* === Orb 內圖覆蓋名字：請貼在最下面，覆蓋原本的 .orb-inner 版型 === */

/* 內層容器改成定位用的盒子，不再用 flex 排版 */
.gacha-orb .orb-inner{
  position: relative;
  display: block;
  width: 90%;
  height: 90%;
  margin: auto;
}

/* 單抽大球稍微放大填滿 */
.gacha-orb.big .orb-inner{
  width: 95%;
  height: 95%;
}

/* 圖片鋪在正中央，層級比名字高 → 可以擋住名字 */
.gacha-orb .orb-inner .orb-icon{
  position: absolute;
  inset: 0%;
  max-width: 100%;
  max-height: 100%;
  width: auto;
  height: auto;
  object-fit: contain;
  /* z-index: 2;          圖 > 名字 */
  pointer-events: none;/* 不擋點擊翻牌 */
  filter: drop-shadow(0 2px 6px rgba(0,0,0,.35));
}

/* 名字固定在下緣中央，層級較低 → 會被圖片遮住 */
.gacha-orb .orb-inner .orb-name{
    position: absolute;
    left: 50%;
    bottom: 0%;
    transform: translateX(-50%);
    width: 70%;
    text-align: center;
    line-height: 1.1;
    font-weight: 900;
    z-index: 1;
    white-space: normal;
    word-break: keep-all;
    height: 20%;
}

/* 不同稀有度的名字顏色（被遮住也無妨，當作可讀性備援） */
.orb-normal.revealed  .orb-name { color:#ffffff; text-shadow:0 2px 6px #000c, 0 0 3px #000; }
.orb-hidden.revealed  .orb-name { color:#e0e0e0; text-shadow:0 2px 6px #000c, 0 0 3px #000; }
.orb-limited.revealed .orb-name { color:#ffd54f; text-shadow:0 2px 6px #000c, 0 0 6px #000; }



    
  </style>
</head>
<body class="dark-bg">
  <!-- 16:9 主要容器 -->
  <div class="container-16-9">
    <!-- 左上：返回箭頭專用框（滿版黃色箭頭由外掛CSS畫） -->
    <div class="back" id="btnBack" style="
      position: absolute;
      left: 2%;
      width: 7%;
      height: 16%;"></div>

    <!-- 抽卡結果容器 & 選池資訊（標題/簡介/持有榜按鈕） -->
    <div class="gacha-results" id="gacha-results">

      <!-- 卡池名（百分比絕對定位、會被外掛 JS 填字、auto-resize） -->
      <div id="poolName" class="auto-resize" style="
        position: absolute;
        top: 2%;
        left: 4%;
        width: 50%;
        height: 17%;
        color:#FFF;
        display:flex; align-items:center;
      "></div>

      <!-- 卡池簡介（百分比絕對定位、auto-resize） -->
      <div id="poolDesc" class="auto-resize" style="
        position: absolute;
        bottom: -2%;
        width: 100%;
        height: 13%;
        color:#FFF;
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
      "></div>

      <!-- 持有榜：漂亮外框按鈕（另開分頁），連結由外掛 JS 設定 -->
      <div id="poolLink" class="auto-resize" style="
    position: absolute;
    top: 16%;
    right: 8%;
    width: 13%;
    height: 11%;
        color:#FFF;
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
      ">持有榜</div>
    </div>
    
    <!-- 轉蛋讀條 Loader -->
    <div id="gacha-loader" class="gacha-loader">
      <div class="loader-box">
        <img class="loader-cat" id="loader-cat" src="https://shierusha.github.io/library/img/cat.png" alt="cat">
        <div class="loader-bar"><div class="loader-fill" id="loader-fill"></div></div>
        <div class="loader-text auto-resize" id="loader-text">Roro爆肝中……</div>
      </div>
    </div>

    <!-- 抽卡按鈕 -->
    <div class="gacha-buttons">
      <button id="btn-single" class="gacha-btn auto-resize">單抽</button>
      <button id="btn-ten" class="gacha-btn auto-resize">十連抽</button>
    </div>

    <!-- HUD -->
    <div class="gacha-hud">
      <button id="btn-backpack" class="gacha-backpack">
        <div class="backpack-box auto-resize">背包</div>
      </button>
    </div>

    <!-- ★ 改字：「剩餘抽數」 -->
    <div class="gacha-counter auto-resize">
      <div class="counter-box">剩餘抽數：
        <span id="draw-count">0</span>
      </div>
    </div>

    <!-- 背景圖 -->
    <img class="bg-img" src="https://shierusha.github.io/school-battle/teachers/img/8.webp" alt="background">
  </div>

  <!-- 旋轉提示（不可關閉） -->
  <div id="orientation-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <div class="modal-header">請旋轉螢幕</div>
      <div class="modal-body">為了最佳體驗，請將裝置轉成橫向模式</div>
    </div>
  </div>

  <!-- 背包 Modal（可點背景關閉） -->
  <div id="info-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <div class="modal-header" id="info-modal-title">標題</div>
      <div class="modal-body" id="info-modal-body"></div>
    </div>
  </div>


<script>
/* ==============================
   小工具
============================== */
const $  = (s, r=document) => r.querySelector(s);
const $$ = (s, r=document) => [...r.querySelectorAll(s)];
const sleep = (ms) => new Promise(res => setTimeout(res, ms));
const escapeHtml = s => (s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
const pick = arr => arr[Math.floor(Math.random()*arr.length)];

/* ==============================
   DC Webhook（銀/金被翻開時送）
============================== */
async function sendGachaWebhook(rarity, itemName) {
  if (rarity !== 'limited' && rarity !== 'hidden') return;
  try {
    const threadId = (window.CURRENT_POOL && window.CURRENT_POOL.threadId) ? window.CURRENT_POOL.threadId : null;
    if (!threadId) return;
    const url = `${B_URL}/functions/v1/gacha-notify`;
    const resp = await fetch(url, {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({
        rarity,
        playerName: PLAYER_NAME || '玩家',
        itemName,
        threadId
      })
    });
    if (!resp.ok) {
      const txt = await resp.text().catch(()=>'(no body)');
      console.error('[gacha-notify] status=', resp.status, 'body=', txt);
    }
  } catch (e) {
    console.warn('[gacha-notify] failed:', e);
  }
}

/* ==============================
   Supabase
============================== */
const B_URL  = 'https://ogzpfrkwnqqaitytncla.supabase.co';
const B_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9nenBmcmt3bnFxYWl0eXRuY2xhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxODQzNzEsImV4cCI6MjA3MDc2MDM3MX0.Ls83xOXcKIW7FUcavr8_sOs37I18VGFWYNW3sNFRS24';

const B_TOKEN     = localStorage.getItem('gacha_b_jwt') || '';
const B_TOKEN_EXP = Number(localStorage.getItem('gacha_b_jwt_exp') || 0);
const PLAYER_NAME = localStorage.getItem('gacha_player_name') || '我的';
const REDIRECT_PLAYER = 'https://shierusha.github.io/create-student/player';
const DEFAULT_EVENT   = '常駐';

function decodeJWT(t){
  if (!t) return null;
  const pad = s => s + '='.repeat((4 - s.length % 4) % 4);
  try { return JSON.parse(atob(pad(t.split('.')[1]).replace(/-/g,'+').replace(/_/g,'/'))); }
  catch { return null; }
}
const payload = decodeJWT(B_TOKEN);
const user = B_TOKEN && payload ? { id: payload.sub } : null;

let sb = window.supabase.createClient(B_URL, B_ANON, {
  global: { headers: B_TOKEN ? { Authorization: `Bearer ${B_TOKEN}` } : {} }
});
if (B_TOKEN) sb.realtime.setAuth(B_TOKEN);
const G = (t) => sb.schema('gacha').from(t);

/* ==============================
   DOM 快取
============================== */
const resultsContainer   = $('#gacha-results');
const btnSingle          = $('#btn-single');
const btnTen             = $('#btn-ten');
const btnBag             = $('#btn-backpack');
const btnBack            = $('#btnBack');
const gachaBtns          = $('.gacha-buttons');
const infoModal          = $('#info-modal');
const infoTitle          = $('#info-modal-title');
const infoBody           = $('#info-modal-body');
const drawCounterEl      = $('#draw-count');
const orientationModal   = $('#orientation-modal');

/* ==============================
   自動字級（套 auto-resize）
============================== */
function resizeAllTexts() {
  $$('.auto-resize').forEach(el => {
    const h = el.offsetHeight || el.getBoundingClientRect().height || 20;
    el.style.fontSize = (h * 0.50) + 'px';
  });
}
window.addEventListener('load', resizeAllTexts);
window.addEventListener('resize', resizeAllTexts);

/* ==============================
   強制橫向
============================== */
function isPortrait(){
  return window.matchMedia('(orientation: portrait)').matches || window.innerHeight > window.innerWidth;
}
function enforceLandscape(){
  const portrait = isPortrait();
  if (orientationModal) orientationModal.style.display = portrait ? 'flex' : 'none';
  document.body.style.overflow = portrait ? 'hidden' : '';
}
enforceLandscape();
window.addEventListener('resize', enforceLandscape);
window.addEventListener('orientationchange', enforceLandscape);
if (orientationModal) orientationModal.addEventListener('click', e => e.stopPropagation());

/* ==============================
   會話 / 逾期保護
============================== */
function ensureAuthOrRedirect(){
  const now = Math.floor(Date.now()/1000);
  if (!user || !B_TOKEN || (B_TOKEN_EXP && now >= B_TOKEN_EXP)) {
    alert('登入逾期，將返回玩家中心。');
    location.href = REDIRECT_PLAYER;
    return false;
  }
  return true;
}
setInterval(ensureAuthOrRedirect, 60*1000);
ensureAuthOrRedirect();

/* ==============================
   狀態
============================== */
let pools = { normal: [], hidden: [], limited: [] };
let canDraw = true;
let unlockAt = 0;
let backLocked = false; // 抽卡&未翻完 → 鎖返回

function lockButtons()  { [btnSingle, btnTen, btnBag].forEach(b => b && (b.disabled = true,  b._forceDisabled = true)); }
function unlockButtons(){ [btnSingle, btnTen, btnBag].forEach(b => b && (b.disabled = false, b._forceDisabled = false)); }

/* ==============================
   初始化
============================== */
(async function boot(){
  if (!ensureAuthOrRedirect()) return;

  const [n, h, l] = await Promise.all([
    G('normal_characters').select('*').order('id',{ascending:true}),
    G('hidden_characters').select('*').order('id',{ascending:true}),
    G('limited_characters').select('*').order('id',{ascending:true}),
  ]);
  pools.normal  = Array.isArray(n.data) ? n.data : [];
  pools.hidden  = Array.isArray(h.data) ? h.data : [];
  pools.limited = Array.isArray(l.data) ? l.data : [];

  await ensureCounter();
  await refreshUIFromCounter();

  bindUI();

  new MutationObserver(()=>{
    const hasResults = document.querySelectorAll('.gacha-row').length > 0;
    const car = document.querySelector('.pool-carousel');
    if (car) car.style.display = hasResults ? 'none' : 'block';
  }).observe(resultsContainer, { childList:true, subtree:true });

  setInterval(refreshUIFromCounter, 15000);
})();

/* ==============================
   Counter（剩餘抽數 = max_draws - total_draws）
============================== */
async function ensureCounter(){
  const { data } = await G('counters').select('*').eq('player_id', user.id).single();
  if (!data){
    await G('counters').insert({ player_id: user.id, total_draws: 0, next_pity: 50 }); // max_draws 走 DB 預設
  }
}
async function getCounter(){
  const { data } = await G('counters')
    .select('total_draws,next_pity,max_draws')
    .eq('player_id', user.id).single();
  return data || { total_draws: 0, next_pity: 50, max_draws: 0 };
}
async function setCounter(_total_draws, next_pity) {
  await G('counters').upsert({ player_id: user.id, next_pity }, { onConflict: 'player_id' });
}
async function refreshUIFromCounter(){
  const c = await getCounter();
  const remain = Math.max(0, c.max_draws - c.total_draws);
  if (drawCounterEl) drawCounterEl.textContent = remain;
  if (btnTen)    btnTen.disabled    = remain < 10 || btnTen._forceDisabled === true || isPortrait();
  if (btnSingle) btnSingle.disabled = remain <  1 || btnSingle._forceDisabled === true || isPortrait();
}

/* ==============================
   Owned upsert
============================== */
async function addOwned(rarity, character_id, event_name){
  const { data: rows } = await G('owned_characters')
    .select('count')
    .eq('player_id', user.id)
    .eq('rarity', rarity)
    .eq('character_id', character_id)
    .eq('event_name', event_name)
    .limit(1);
  const prev = rows?.[0]?.count || 0;

  await G('owned_characters').upsert({
    player_id: user.id,
    rarity, event_name,
    character_id,
    count: prev + 1
  }, { onConflict: 'player_id,rarity,event_name,character_id' });
}

/* ==============================
   抽卡核心（常駐金→銀；保底在常駐也消耗）
============================== */
async function drawOnce(){
  const c = await getCounter();
  if (c.total_draws >= c.max_draws) {
    alert('已達抽卡上限'); await refreshUIFromCounter(); return null;
  }

  const currentPoolKey = (window.CURRENT_POOL && window.CURRENT_POOL.key) ? window.CURRENT_POOL.key : DEFAULT_EVENT;

  let totalNext = c.total_draws + 1;
  let nextPity  = c.next_pity;

  let rarity, chosen, event_name = DEFAULT_EVENT;

  // 保底
  if (totalNext === nextPity) {
    if (currentPoolKey === DEFAULT_EVENT) {
      rarity = 'hidden';
      chosen = pick(pools.hidden);
      event_name = DEFAULT_EVENT;
      nextPity += 50;
    } else {
      rarity = 'limited';
      const poolLimited = pools.limited.filter(x => x.event_name === currentPoolKey);
      chosen = pick(poolLimited.length ? poolLimited : pools.limited);
      event_name = chosen?.event_name || currentPoolKey;
      nextPity += 50;
    }
  } else {
    const r = Math.floor(Math.random()*100) + 1; // 1..100
    if (r === 1) {
      rarity = 'hidden';  chosen = pick(pools.hidden);  event_name = DEFAULT_EVENT;
    } else if (r === 100) {
      if (currentPoolKey === DEFAULT_EVENT) {
        rarity = 'hidden';  chosen = pick(pools.hidden);  event_name = DEFAULT_EVENT;
      } else {
        rarity = 'limited';
        const poolLimited = pools.limited.filter(x => x.event_name === currentPoolKey);
        chosen = pick(poolLimited.length ? poolLimited : pools.limited);
        event_name = chosen?.event_name || currentPoolKey;
      }
    } else {
      rarity = 'normal';  chosen = pick(pools.normal);  event_name = DEFAULT_EVENT;
    }
  }

  if (!chosen) { alert('對應池子沒有資料'); return null; }

  await addOwned(rarity, chosen.id, event_name);
  await setCounter(totalNext, nextPity);

  return {
    rarity,
    name: chosen.name,
    id: chosen.id,
    event_name,
    image_url: chosen.image_url || null, // ← 圖片路徑（若資料庫有就顯示）
    totalAfter: totalNext
  };
}

async function drawTenTimes(){
  const c = await getCounter();
  const remain = Math.max(0, c.max_draws - c.total_draws);
  if (remain < 10) { alert('剩餘抽數不足 10 抽'); return null; }

  const results = [];
  for (let i=0;i<10;i++){
    const r = await drawOnce();
    if (!r) break;
    results.push(r); // 帶著 image_url
  }
  return results;
}

/* ==============================
   Loader
============================== */
const loaderEl  = $('#gacha-loader');
const fillEl    = $('#loader-fill');
const catEl     = $('#loader-cat');
const loaderTxt = $('#loader-text');

const Loader = {
  show(label='Roro爆肝中……'){
    if (loaderTxt) loaderTxt.textContent = label;
    if (fillEl) fillEl.style.width = '0%';
    if (catEl)  catEl.style.left  = '0%';
    loaderEl?.classList.add('show');
    resizeAllTexts();
  },
  async step(stepIndex, total){
    const pct = Math.max(0, Math.min(100, Math.round(stepIndex * (100/total))));
    fillEl && (fillEl.style.width = pct + '%');
    catEl  && (catEl.style.left  = pct + '%');
    await sleep(240);
  },
  hide(){ loaderEl?.classList.remove('show'); }
};

function clearResults(){
  resultsContainer.classList.remove('single');
  resultsContainer.innerHTML = '';
}

/* ==============================
   UI：建立球 / 翻牌與節流（球內放圖、可遮名）
============================== */
function createOrb(res, { autoReveal=false, revealDelay=0, big=false } = {}){
  const orb = document.createElement('div');
  orb.className = `gacha-orb orb-${res.rarity}` + (big?' big':'');
  const inner = document.createElement('div');
  inner.className = 'orb-inner';
  inner.textContent = '';

  const reveal = () => {
    if (orb.classList.contains('revealed')) return;

    inner.innerHTML = '';

    // 先放圖片（z-index:2），可遮住名字
    if (res.image_url) {
      const img = document.createElement('img');
      img.src = res.image_url;
      img.alt = res.name;
      img.className = 'orb-icon';
      inner.appendChild(img);
    }

    // 再放名字（z-index:1）
    const nameEl = document.createElement('span');
    nameEl.className = 'orb-name auto-resize';
    nameEl.textContent = res.name;
    inner.appendChild(nameEl);

    orb.classList.add('revealed');

    if (res.rarity === 'limited' || res.rarity === 'hidden') {
      sendGachaWebhook(res.rarity, res.name);
    }

    resizeAllTexts();
    checkAllRevealed();
  };

  if (autoReveal) setTimeout(reveal, revealDelay);
  else orb.addEventListener('click', reveal);

  orb.appendChild(inner);
  return orb;
}

function checkAllRevealed(){
  const orbs = $$('.gacha-orb', resultsContainer);
  if (orbs.length === 0) return;
  const all = orbs.every(o => o.classList.contains('revealed'));
  if (all) {
    unlockAt = Date.now() + 500;
    setTimeout(()=>{
      canDraw = true;
      unlockButtons();
      backLocked = false;  // 翻完 → 可按返回
    }, 500);
  }
}

function showResultsTen(results){
  canDraw = false;
  backLocked = true;          // 抽卡期間不可按返回
  lockButtons();
  resultsContainer.classList.remove('single');
  resultsContainer.innerHTML = '';
  for (let row=0; row<2; row++){
    const rowDiv = document.createElement('div');
    rowDiv.className = 'gacha-row';
    results.slice(row*5, row*5+5).forEach((res, idx)=>{
      const index = row*5 + idx;
      const orb = createOrb(res, { autoReveal: res.rarity==='normal', revealDelay: index*200 });
      rowDiv.appendChild(orb);
    });
    resultsContainer.appendChild(rowDiv);
  }
  resizeAllTexts();
}

function showResultSingle(res){
  canDraw = false;
  backLocked = true;          // 抽卡期間不可按返回
  lockButtons();
  resultsContainer.classList.add('single');
  resultsContainer.innerHTML = '';
  const isWhite = res.rarity === 'normal';
  const orb = createOrb(res, { autoReveal:isWhite, revealDelay:0, big:true });
  const rowDiv = document.createElement('div');
  rowDiv.className = 'gacha-row';
  rowDiv.style.justifyContent = 'center';
  rowDiv.appendChild(orb);
  resultsContainer.appendChild(rowDiv);
  resizeAllTexts();
  if (isWhite) { // 白球自動翻 → 立刻可返回/再抽
    unlockAt = Date.now() + 500;
    setTimeout(()=>{ canDraw = true; unlockButtons(); backLocked = false; }, 500);
  }
}

/* ==============================
   背包
============================== */
function nameFromPools(rarity, character_id, event_name){
  if (rarity === 'normal') return pools.normal.find(x=>x.id===character_id)?.name || `#${character_id}`;
  if (rarity === 'hidden') return pools.hidden.find(x=>x.id===character_id)?.name || `#${character_id}`;
  const hit = pools.limited.find(x=>x.id===character_id && x.event_name===event_name) || pools.limited.find(x=>x.id===character_id);
  return hit ? hit.name : `#${character_id}`;
}

async function openBackpack(){
  const orbs = $$('.gacha-orb', resultsContainer);
  if (orbs.some(o=>!o.classList.contains('revealed'))) {
    alert('請先翻開所有扭蛋！'); return;
  }

  infoTitle.textContent = `${PLAYER_NAME}的背包`;

  const { data, error } = await G('owned_characters')
    .select('rarity,event_name,character_id,count')
    .eq('player_id', user.id);

  if (error) { console.error('[owned_characters] query error:', error); alert('讀取背包失敗'); return; }
  const rows = Array.isArray(data) ? data : [];

  const byKey = new Map();
  for (const r of rows){
    const key = `${r.rarity}|${r.event_name}|${r.character_id}`;
    const v = byKey.get(key);
    byKey.set(key, v ? { ...r, count: v.count + r.count } : { ...r });
  }
  const merged = [...byKey.values()];

  const car = document.querySelector('.pool-carousel');
  const inPool = car && getComputedStyle(car).display === 'none';
  const currentPool = (window.CURRENT_POOL && window.CURRENT_POOL.key) ? window.CURRENT_POOL.key : '常駐';

  const limitedGroups = new Map(); // event_name -> [{id, html}]
  const hiddenList = [];
  const normalList = [];

  merged.forEach(r=>{
    const nm = nameFromPools(r.rarity, r.character_id, r.event_name);
    const item = { id:r.character_id, html:`${escapeHtml(nm)} × <span>${r.count}</span>` };

    if (r.rarity === 'limited') {
      if (!inPool || r.event_name === currentPool) {
        const arr = limitedGroups.get(r.event_name) || [];
        arr.push(item);
        limitedGroups.set(r.event_name, arr);
      }
    } else if (r.rarity === 'hidden') {
      hiddenList.push(item);
    } else {
      normalList.push(item);
    }
  });

  const byId = a => a.sort((x,y)=>(x.id??0)-(y.id??0));
  for (const [k, arr] of limitedGroups) limitedGroups.set(k, byId(arr));
  byId(hiddenList); byId(normalList);

  const joinRows = (arr, perLine=3)=>{
    const lines=[]; for(let i=0;i<arr.length;i+=perLine){ lines.push(arr.slice(i,i+perLine).map(x=>x.html).join('、 ')); }
    return lines.join('<br>');
  };

  let html='';
  const limitedKeys = [...limitedGroups.keys()].sort();
  if (limitedKeys.length){
    html += `<div class="backpack-section"><h3>活動限定饅頭：</h3><div class="backpack-items">`;
    limitedKeys.forEach((evName, idx)=>{
      const rowsHtml = joinRows(limitedGroups.get(evName)||[], 2) || '（無）';
      html += `<div class="backpack-event-block" style="margin:.25rem 0;">${escapeHtml(evName)}</div>`;
      html += `<div class="backpack-event-items" style="margin:0 0 .5rem 0;">${rowsHtml}</div>`;
      if (idx !== limitedKeys.length-1) html += `<div style="height:.4rem;"></div>`;
    });
    html += `</div></div>`;
  }
  if (hiddenList.length){
    html += `<div class="backpack-section"><h3>隱藏饅頭：</h3><div class="backpack-items">${joinRows(hiddenList,2)}</div></div>`;
  }
  if (normalList.length){
    html += `<div class="backpack-section"><h3>普通饅頭：</h3><div class="backpack-items">${joinRows(normalList,3)}</div></div>`;
  }
  if (!html) html = '<div class="backpack-items">目前沒有任何饅頭</div>';

  infoBody.innerHTML = html;
  infoModal.style.display = 'flex';
}
infoModal?.addEventListener('click', ()=> infoModal.style.display='none');
infoModal?.querySelector('.modal-content')?.addEventListener('click', e=> e.stopPropagation());

/* ==============================
   綁定按鈕（返回鍵：抽卡時不可按；翻完結果→F5；沒結果→回玩家中心）
============================== */
function bindUI(){
  btnBag?.addEventListener('click', openBackpack);

  btnBack?.addEventListener('click', ()=>{
    if (isPortrait()) return;

    const orbs = $$('.gacha-orb', resultsContainer);
    const hasResults = orbs.length > 0;

    // 抽卡中 or 還沒翻完 → 禁用（跟背包規則一致）
    if (hasResults && (backLocked || orbs.some(o=>!o.classList.contains('revealed')))) {
      alert('請先翻開所有扭蛋！');
      return;
    }

    if (hasResults) {
      // 10 抽頁/單抽頁有結果 → F5
      location.reload();
    } else {
      // 沒結果（初始畫面）→ 回玩家中心
      location.href = REDIRECT_PLAYER;
    }
  });

  btnSingle?.addEventListener('click', async ()=>{
    if (!ensureAuthOrRedirect()) return;
    if (isPortrait()) return;
    if (!canDraw || Date.now() < unlockAt) return alert('稍等一下…');

    backLocked = true;          // 抽卡開始 → 鎖返回
    gachaBtns?.classList.add('bottom');
    lockButtons();

    clearResults();
    Loader.show('Roro爆肝中……');

    const r = await drawOnce();
    if (!r) {
      Loader.hide();
      await refreshUIFromCounter();
      unlockButtons();
      backLocked = false;
      return;
    }

    await Loader.step(1, 1);
    Loader.hide();

    await refreshUIFromCounter();
    showResultSingle(r); // r 內含 image_url
  });

  btnTen?.addEventListener('click', async ()=>{
    if (!ensureAuthOrRedirect()) return;
    if (isPortrait()) return;
    if (!canDraw || Date.now() < unlockAt) return alert('稍等一下…');

    const c = await getCounter();
    if (c.max_draws - c.total_draws < 10) {
      return alert('剩餘抽數不足 10 抽');
    }

    backLocked = true;          // 抽卡開始 → 鎖返回
    gachaBtns?.classList.add('bottom');
    lockButtons();

    clearResults();
    Loader.show('Roro爆肝中……');

    const results = [];
    for (let i = 0; i < 10; i++) {
      const r = await drawOnce();
      if (!r) break;
      results.push(r);          // r 內含 image_url
      await Loader.step(i + 1, 10);
    }

    Loader.hide();

    if (!results.length) { unlockButtons(); backLocked = false; return; }

    await refreshUIFromCounter();
    showResultsTen(results);
  });

  const obs = new MutationObserver(()=>{ resizeAllTexts(); checkAllRevealed(); });
  obs.observe(resultsContainer, { childList:true, subtree:true });
}
</script>



  <!-- 登出腳本（原樣） -->
  <script src="https://shierusha.github.io/library/assets/js/logout.js"></script>

  <!-- 新增：選池倫波外掛 JS -->
  <script src="https://shierusha.github.io/library/assets/js/pool-carousel.js"></script>
</body>
</html>

