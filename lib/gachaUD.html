<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>謝爾夏|扭蛋管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css?family=Noto+Sans+TC:400,700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: 'Noto Sans TC', sans-serif;
      background: url(https://shierusha.github.io/create-student/imgs/citybg.png) center/cover fixed no-repeat;
      margin: 0;
      padding: 2rem;
    }
    .container {
      max-width: 1100px;
      margin: auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 16px #0001;
      padding: 1.6rem 1.4rem 2rem;
      backdrop-filter: saturate(140%) blur(2px);
    }
    h1 { margin: .2rem 0 0; color: #143158; text-align: center; letter-spacing: .04em; }
    .hr { height: 4px; width: 78%; background: #1767a0; margin: .6rem auto 1.6rem; border-radius: 2px; opacity: .9; }
    .right { color: #0f2d52; }
    .toolbar { display:flex; gap:8px; justify-content:center; margin-bottom:12px; }
    button { border: none; background:#1767a0; color:#fff; padding:8px 14px; border-radius:8px; cursor:pointer; font-weight:700 }
    button.ghost{ background:#e9f1f9; color:#143158 }
    input, select { width:100%; padding:8px 10px; border:1px solid #c8d6e6; border-radius:8px; background:#f7fbff }
    table { width:100%; border-collapse:collapse; background:#f7fbff; border-radius:10px; overflow:hidden }
    th,td { padding:10px; border-bottom:1px solid #e6eef6; text-align:left; vertical-align:middle }
    th { background:#ddebf7; color:#143158 }
    tr:last-child td{ border-bottom:none }
    .row{ display:flex; gap:10px; flex-wrap:wrap }
    .row > *{ flex:1 }
    .img64{ width:64px;height:64px;object-fit:cover;border:1px solid #e6eef6;border-radius:8px; background:#fff }
    .muted{ color:#3a4b5f }
    .mt8{ margin-top:8px } .mt12{ margin-top:12px }
    .hide{ display:none }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="pageTitle">謝爾夏|扭蛋管理</h1>
    <div class="hr"></div>

    <div class="toolbar">
      <button id="tabEvents" class="ghost">活動管理</button>
      <button id="tabLimited">限定饅頭</button>
      <button class="ghost" id="backBtn">返回管理者後台</button>
    </div>

    <!-- 活動管理 -->
    <div id="panel-events">
      <div class="row">
        <button id="addEventBtn">＋ 新增活動</button>
      </div>
      <div class="mt12">
        <table>
          <thead>
            <tr>
              <th>預覽</th>
              <th>活動名稱（key）</th>
              <th>顯示名稱</th>
              <th>Discord Thread ID</th>
              <th>開始</th>
              <th>結束</th>
              <th>圖片 URL</th>
              <th style="width:160px">操作</th>
            </tr>
          </thead>
          <tbody id="eventsTbody"></tbody>
        </table>
      </div>
    </div>

    <!-- 限定饅頭 -->
    <div id="panel-limited" class="hide">
      <div class="row">
        <div><label>選擇活動</label><select id="eventSelect"></select></div>
        <div class="right center"><button id="addCharBtn" disabled>＋ 新增限定饅頭</button></div>
      </div>
      <div class="mt12">
        <table>
          <thead>
            <tr>
              <th>預覽</th>
              <th>ID</th>
              <th>名稱</th>
              <th>圖片 URL</th>
              <th style="width:160px">操作</th>
            </tr>
          </thead>
          <tbody id="charsTbody"></tbody>
        </table>
      </div>
    </div>

  </div>

<script>
/** ===== 基本設定（B 專案） ===== */
const B_URL  = 'https://ogzpfrkwnqqaitytncla.supabase.co';
const B_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9nenBmcmt3bnFxYWl0eXRuY2xhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxODQzNzEsImV4cCI6MjA3MDc2MDM3MX0.Ls83xOXcKIW7FUcavr8_sOs37I18VGFWYNW3sNFRS24';
const LOGOUT_URL = 'https://shierusha.github.io/login/login';
const ADMIN_HOME = 'https://shierusha.github.io/create-student/player_manage'; // 你要回到的後台首頁

const token = localStorage.getItem('gacha_b_jwt') || '';
const appRole = (localStorage.getItem('gacha_app_role') || '').toUpperCase();

/** 非 ADMIN：清掉登入態並導登出頁 */
function kickNonAdmin() {
  localStorage.removeItem('gacha_b_jwt');
  localStorage.removeItem('gacha_b_jwt_exp');
  localStorage.removeItem('gacha_b_user');
  localStorage.removeItem('gacha_player_name');
  localStorage.removeItem('gacha_app_role');
  location.replace(LOGOUT_URL);
}
if (!token || appRole !== 'ADMIN') kickNonAdmin();

const sb = window.supabase.createClient(B_URL, B_ANON, {
  global: { headers: { Authorization: `Bearer ${token}` } }
});
const G = (t) => sb.schema('gacha').from(t);

/** ===== 小工具：時區轉換 ===== */
function toLocalInputValue(iso){
  if(!iso) return '';
  const d = new Date(iso); const off = d.getTimezoneOffset();
  return new Date(d.getTime()-off*60000).toISOString().slice(0,16);
}
function fromLocalInputToISO(v){
  if(!v) return null;
  return new Date(v).toISOString();
}

/** ===== Tabs ===== */
const tabEvents = document.getElementById('tabEvents');
const tabLimited= document.getElementById('tabLimited');
const pEvents   = document.getElementById('panel-events');
const pLimited  = document.getElementById('panel-limited');
function showPanel(which){
  if(which==='events'){ pEvents.classList.remove('hide'); pLimited.classList.add('hide'); }
  else { pLimited.classList.remove('hide'); pEvents.classList.add('hide'); }
}
tabEvents.onclick = ()=> showPanel('events');
tabLimited.onclick= ()=> showPanel('limited');
document.getElementById('backBtn').onclick = ()=> location.href = ADMIN_HOME;

/** ===== 活動管理 ===== */
const eventsTbody = document.getElementById('eventsTbody');
const addEventBtn = document.getElementById('addEventBtn');

function rowEventView(ev){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><img class="img64" src="${ev.image_url||''}" onerror="this.src='';"></td>
    <td>${ev.event_name}</td>
    <td>${ev.display_name||''}</td>
    <td class="muted">${ev.discord_thread_id||''}</td>
    <td>${toLocalInputValue(ev.starts_at).replace('T',' ')}</td>
    <td>${toLocalInputValue(ev.ends_at).replace('T',' ')}</td>
    <td class="muted">${ev.image_url||''}</td>
    <td>
      <button class="ghost" data-act="edit">編輯</button>
      <button data-act="del">刪除</button>
    </td>`;
  tr.querySelector('[data-act="edit"]').onclick = ()=> renderEventEditor(ev);
  tr.querySelector('[data-act="del"]').onclick  = ()=> deleteEvent(ev.event_name);
  return tr;
}

function renderEventEditor(ev){
  const isNew = !ev;
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><img class="img64" id="ev_img_prev" src="${ev?.image_url||''}" onerror="this.src='';"></td>
    <td>${isNew?'<input id="ev_event_name" placeholder="活動 key（必填）">':`<b>${ev.event_name}</b>`}</td>
    <td><input id="ev_display" placeholder="顯示名稱" value="${ev?.display_name||''}"></td>
    <td><input id="ev_thread" placeholder="Discord Thread ID" value="${ev?.discord_thread_id||''}"></td>
    <td><input id="ev_start" type="datetime-local" value="${toLocalInputValue(ev?.starts_at)}"></td>
    <td><input id="ev_end" type="datetime-local" value="${toLocalInputValue(ev?.ends_at)}"></td>
    <td><input id="ev_img" placeholder="https://..." value="${ev?.image_url||''}"></td>
    <td>
      <button id="ev_save">儲存</button>
      <button class="ghost" id="ev_cancel">取消</button>
    </td>`;
  const imgI = tr.querySelector('#ev_img');
  imgI.addEventListener('input',()=> tr.querySelector('#ev_img_prev').src = imgI.value || '');

  tr.querySelector('#ev_cancel').onclick = refreshEvents;
  tr.querySelector('#ev_save').onclick = async ()=>{
    const payload = {
      event_name: isNew ? (tr.querySelector('#ev_event_name').value||'').trim() : ev.event_name,
      display_name: (tr.querySelector('#ev_display').value||'').trim() || null,
      discord_thread_id: (tr.querySelector('#ev_thread').value||'').trim() || null,
      starts_at: fromLocalInputToISO(tr.querySelector('#ev_start').value),
      ends_at:   fromLocalInputToISO(tr.querySelector('#ev_end').value),
      image_url: (tr.querySelector('#ev_img').value||'').trim() || null,
    };
    if (!payload.event_name) return alert('活動 key 必填');
    if (!payload.starts_at || !payload.ends_at) return alert('請填起迄時間');
    const { error } = await G('events').upsert(payload, { onConflict:'event_name' });
    if (error) return alert('儲存失敗：'+error.message);
    await refreshEvents();
    alert('已儲存');
  };

  eventsTbody.innerHTML='';
  eventsTbody.appendChild(tr);
}

async function deleteEvent(event_name){
  if (!confirm(`確定刪除活動「${event_name}」？`)) return;
  const { error } = await G('events').delete().eq('event_name', event_name);
  if (error) return alert('刪除失敗：'+error.message);
  refreshEvents();
}

async function refreshEvents(){
  const { data, error } = await G('events').select('*').order('starts_at');
  eventsTbody.innerHTML = '';
  if (error) { eventsTbody.innerHTML = `<tr><td colspan="8" class="muted">讀取失敗：${error.message}</td></tr>`; return; }
  (data||[]).forEach(ev => eventsTbody.appendChild(rowEventView(ev)));
}
addEventBtn.onclick = ()=> renderEventEditor(null);

/** ===== 限定饅頭 ===== */
const evSelect = document.getElementById('eventSelect');
const addCharBtn= document.getElementById('addCharBtn');
const charsTbody= document.getElementById('charsTbody');

async function loadEventOptions(){
  const { data, error } = await G('events').select('event_name,display_name').order('starts_at');
  evSelect.innerHTML = '';
  if (error) { evSelect.innerHTML = '<option>讀取失敗</option>'; return; }
  const ph = document.createElement('option');
  ph.value=''; ph.textContent='— 請選擇活動 —';
  evSelect.appendChild(ph);
  (data||[]).forEach(ev=>{
    const o = document.createElement('option');
    o.value = ev.event_name; o.textContent = ev.display_name || ev.event_name;
    evSelect.appendChild(o);
  });
}
evSelect.onchange = ()=>{ addCharBtn.disabled = !evSelect.value; if (evSelect.value) refreshChars(); else charsTbody.innerHTML=''; };
addCharBtn.onclick = ()=> renderCharEditor(null);

function rowCharView(r){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><img class="img64" src="${r.image_url||''}" onerror="this.src='';"></td>
    <td>${r.id}</td>
    <td>${r.name}</td>
    <td class="muted">${r.image_url||''}</td>
    <td>
      <button class="ghost" data-act="edit">編輯</button>
      <button data-act="del">刪除</button>
    </td>`;
  tr.querySelector('[data-act="edit"]').onclick = ()=> renderCharEditor(r);
  tr.querySelector('[data-act="del"]').onclick  = ()=> deleteChar(r);
  return tr;
}
function renderCharEditor(r){
  if (!evSelect.value) return alert('請先選活動');
  const isNew = !r;
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><img class="img64" id="ch_img_prev" src="${r?.image_url||''}" onerror="this.src='';"></td>
    <td>${isNew?'<input id="ch_id" type="number" min="1" step="1" placeholder="ID（必填）">':`<b>${r.id}</b>`}</td>
    <td><input id="ch_name" placeholder="名稱" value="${r?.name||''}"></td>
    <td><input id="ch_img" placeholder="https://..." value="${r?.image_url||''}"></td>
    <td>
      <button id="ch_save">儲存</button>
      <button class="ghost" id="ch_cancel">取消</button>
    </td>`;
  const imgI = tr.querySelector('#ch_img');
  imgI.addEventListener('input',()=> tr.querySelector('#ch_img_prev').src = imgI.value || '');

  tr.querySelector('#ch_cancel').onclick = refreshChars;
  tr.querySelector('#ch_save').onclick = async ()=>{
    const payload = {
      id: isNew ? Number(tr.querySelector('#ch_id').value) : r.id,
      event_name: evSelect.value,
      name: (tr.querySelector('#ch_name').value||'').trim(),
      image_url: (tr.querySelector('#ch_img').value||'').trim() || null,
    };
    if (!payload.id || !payload.name) return alert('ID / 名稱必填');
    const { error } = await G('limited_characters').upsert(payload, { onConflict:'id' });
    if (error) return alert('儲存失敗：'+error.message);
    await refreshChars();
    alert('已儲存');
  };

  charsTbody.innerHTML='';
  charsTbody.appendChild(tr);
}
async function deleteChar(r){
  if (!confirm(`確定刪除 #${r.id} ${r.name}？`)) return;
  const { error } = await G('limited_characters').delete().eq('id', r.id);
  if (error) return alert('刪除失敗：'+error.message);
  refreshChars();
}
async function refreshChars(){
  const ev = evSelect.value; if(!ev) return;
  const { data, error } = await G('limited_characters').select('id,name,image_url').eq('event_name', ev).order('id');
  charsTbody.innerHTML = '';
  if (error) { charsTbody.innerHTML = `<tr><td colspan="5" class="muted">讀取失敗：${error.message}</td></tr>`; return; }
  (data||[]).forEach(r => charsTbody.appendChild(rowCharView(r)));
}

/** ===== Boot ===== */
(async function init(){
  await refreshEvents();
  await loadEventOptions();
})();
</script>
</body>
</html>
