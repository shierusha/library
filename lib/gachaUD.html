<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>謝爾夏｜扭蛋管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css?family=Noto+SansTC:400,700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body{
      font-family:'Noto Sans TC',sans-serif;
      background:url(https://shierusha.github.io/create-student/imgs/citybg.png) center/cover fixed no-repeat;
      margin:0;padding:2rem;color:#0f2d52;
    }
    .container{max-width:1100px;margin:auto;background:#fff;border-radius:16px;box-shadow:0 2px 16px #0001;padding:1.6rem 1.4rem 2rem;position:relative}
    h1{margin:.2rem 0 0;color:#143158;text-align:center;letter-spacing:.04em}
    .hr{height:4px;width:78%;background:#1767a0;margin:.6rem auto 1rem;border-radius:2px;opacity:.9}

    .tabs{display:flex;gap:.6rem;flex-wrap:wrap;justify-content:center;margin:.2rem 0 1rem}
    .tab-btn{border:none;border-radius:999px;padding:.5rem 1rem;background:#e9f1f9;color:#143158;font-weight:700;cursor:pointer}
    .tab-btn.active{background:#1767a0;color:#fff}

    .toolbar{display:flex;justify-content:flex-end;gap:.5rem;margin:.2rem 0 1rem}
    .delete-toggle-btn{background:#eef2fa;color:#1d4076;border:none;border-radius:2em;padding:.55em 1.2em;font-weight:700;cursor:pointer;transition:.18s}
    .delete-toggle-btn:hover,.delete-toggle-btn:focus{background:#1767a0;color:#fff}
    .delete-toggle-btn.active{background:#f66464;color:#fff}

    .row,.row-1,.row-3{display:grid;gap:.8rem;margin:.7rem 0}
    .row{grid-template-columns:1fr 1fr}
    .row-1{grid-template-columns:1fr}
    .row-3{grid-template-columns:1fr 1fr 1fr}
    @media(max-width:800px){.row,.row-3{grid-template-columns:1fr}}
    label{display:flex;flex-direction:column;font-size:.92rem;color:#3a4b5f}
    input,select{padding:.55rem .6rem;border:1px solid #c8d6ea;border-radius:.5rem;font-size:1rem}
    input[type="number"]{width:100%}
    .muted{color:#6b7c90;font-size:.95rem}

    table{width:100%;border-collapse:collapse;margin-top:.6rem}
    th,td{padding:.5rem .6rem;border-bottom:1px solid #eef2fa;text-align:left;vertical-align:top}
    thead th{background:#f2f6fb;color:#143158}
    tbody tr:hover{background:#f7fbff}
    .btn{border:none;border-radius:.45rem;padding:.35rem .7rem;cursor:pointer;font-weight:700;background:#1767a0;color:#fff;margin-right:.25rem}
    .btn.gray{background:#98a6b8}
    .btn.green{background:#4e892a}
    .btn.red{background:#f66464}
    .btn-del{background:#f66464;display:none}
    .btn-del.show{display:inline-block}

    .back-wrap{display:flex;justify-content:flex-end;margin-top:1.2rem}
    .back-btn{border:none;border-radius:999px;padding:.6rem 1.1rem;font-weight:700;background:#e9f1f9;color:#143158;cursor:pointer}
    .back-btn:hover{background:#1767a0;color:#fff}
    .section{margin-top:1.2rem}

    /* 活動管理：右側 2x3 佈局 */
    .ev-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.7rem}
    .ev-actions{display:flex;align-items:center;gap:.4rem}
    @media(max-width:900px){.ev-grid{grid-template-columns:1fr}}

    /* 活動圖預覽 */
    .thumb-wrap{display:flex;flex-direction:column;align-items:center;gap:.5rem}
    .thumb{
      width:120px;height:120px;border:1px solid #e6eef6;border-radius:.6rem;
      background:#f3f6fb center/cover no-repeat;overflow:hidden
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .thumb.empty{background:#eef3f9}
    .thumb-tip{font-size:.85rem;color:#6b7c90}

    /* URL小視窗（統一用） */
    .modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:999;justify-content:center;align-items:center}
    .modal{background:#fff;border-radius:.8rem;box-shadow:0 6px 24px #0006;min-width:280px;max-width:92vw;padding:1rem 1rem 1.1rem}
    .modal h3{margin:.2rem 0 0.8rem;color:#143158}
    .modal .row-1{margin:.4rem 0}
    .modal .btn{margin-top:.4rem}
  </style>
</head>
<body>
  <div class="container">
    <h1>扭蛋管理</h1>
    <div class="hr"></div>

    <div class="toolbar">
      <button id="delete-toggle-btn" class="delete-toggle-btn" type="button">啟用刪除</button>
    </div>

    <div class="tabs">
      <button class="tab-btn" data-tab="events">活動管理</button>
      <button class="tab-btn" data-tab="limited">限定饅頭</button>
      <button class="tab-btn" data-tab="normal">普通饅頭</button>
      <button class="tab-btn" data-tab="hidden">隱藏饅頭</button>
    </div>

    <!-- 活動管理 -->
    <div class="section" id="sec-events" hidden>
      <!-- 新增區 -->
      <div class="row-3">
        <label>活動名稱（唯一，不可重複）
          <input id="ev-new-name" placeholder="例：四月一日貓尋 全員貓貓池">
        </label>
        <label>活動簡介（可空）
          <input id="ev-new-display" placeholder="例：咪咪喵喵咪喵">
        </label>
        <label>Discord 討論串 ID（文字）
          <input id="ev-new-dcid" placeholder="例：1409888757603106886">
        </label>
      </div>
      <div class="row">
        <label>開始時間
          <input id="ev-new-start" type="datetime-local">
        </label>
        <label>結束時間
          <input id="ev-new-end" type="datetime-local">
        </label>
      </div>
      <div class="row-1">
        <button class="btn green" id="btn-ev-add">新增活動</button>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:160px">活動圖</th>
            <th>內容</th>
          </tr>
        </thead>
        <tbody id="events-tbody">
          <tr><td colspan="2" class="muted">載入中…</td></tr>
        </tbody>
      </table>
    </div>

    <!-- 限定饅頭 -->
    <div class="section" id="sec-limited" hidden>
      <div class="row">
        <label>選擇活動
          <select id="lim-evsel"></select>
        </label>
      </div>

      <div class="row-3">
        <label>新增 / 修改：ID（小整數，全域唯一）
          <input id="lim-new-id" type="number" min="1" placeholder="例：5">
        </label>
        <label>名稱
          <input id="lim-new-name" placeholder="例：貓貓本貓饅頭">
        </label>
        <label>圖片 URL（可空）
          <input id="lim-new-img" placeholder="https://...">
        </label>
      </div>
      <div><button class="btn green" id="btn-lim-upsert">新增 / 覆蓋</button></div>

      <table>
        <thead><tr><th>ID</th><th>名稱</th><th>圖片</th><th>操作</th></tr></thead>
        <tbody id="limited-tbody"><tr><td colspan="4" class="muted">請先選活動</td></tr></tbody>
      </table>
    </div>

    <!-- 普通饅頭 -->
    <div class="section" id="sec-normal" hidden>
      <div class="row-3">
        <label>新增 / 修改：ID（小整數）
          <input id="nor-new-id" type="number" min="1" placeholder="例：1">
        </label>
        <label>名稱
          <input id="nor-new-name" placeholder="例：原味饅頭">
        </label>
        <label>圖片 URL（可空）
          <input id="nor-new-img" placeholder="https://...">
        </label>
      </div>
      <div><button class="btn green" id="btn-nor-upsert">新增 / 覆蓋</button></div>

      <table>
        <thead><tr><th>ID</th><th>名稱</th><th>圖片</th><th>操作</th></tr></thead>
        <tbody id="normal-tbody"><tr><td colspan="4" class="muted">載入中…</td></tr></tbody>
      </table>
    </div>

    <!-- 隱藏饅頭 -->
    <div class="section" id="sec-hidden" hidden>
      <div class="row-3">
        <label>新增 / 修改：ID（小整數）
          <input id="hid-new-id" type="number" min="1" placeholder="例：901">
        </label>
        <label>名稱
          <input id="hid-new-name" placeholder="例：神秘隱藏饅頭">
        </label>
        <label>圖片 URL（可空）
          <input id="hid-new-img" placeholder="https://...">
        </label>
      </div>
      <div><button class="btn green" id="btn-hid-upsert">新增 / 覆蓋</button></div>

      <table>
        <thead><tr><th>ID</th><th>名稱</th><th>圖片</th><th>操作</th></tr></thead>
        <tbody id="hidden-tbody"><tr><td colspan="4" class="muted">載入中…</td></tr></tbody>
      </table>
    </div>

    <div class="back-wrap">
      <button class="back-btn" onclick="location.href='https://shierusha.github.io/create-student/player'">返回管理者首頁</button>
    </div>
  </div>

  <!-- URL 輸入小視窗（通用） -->
  <div id="url-modal" class="modal-bg">
    <div class="modal">
      <h3>設定圖片網址</h3>
      <div class="row-1">
        <input id="url-input" placeholder="https://..." />
      </div>
      <div class="row-1">
        <button class="btn" id="url-save">儲存</button>
        <button class="btn gray" id="url-cancel">取消</button>
      </div>
    </div>
  </div>

<script>
/* =========================
   基本設定 & 權限檢查 (B 專案)
========================= */
const B_URL  = 'https://ogzpfrkwnqqaitytncla.supabase.co';
const B_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9nenBmcmt3bnFxYWl0eXRuY2xhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxODQzNzEsImV4cCI6MjA3MDc2MDM3MX0.Ls83xOXcKIW7FUcavr8_sOs37I18VGFWYNW3sNFRS24';

const B_TOKEN     = localStorage.getItem('gacha_b_jwt') || '';
const B_TOKEN_EXP = Number(localStorage.getItem('gacha_b_jwt_exp') || 0);
const APP_ROLE    = localStorage.getItem('gacha_app_role') || 'PLAYER';

function decodeJWT(t){ if(!t) return null;
  const pad=s=>s+'='.repeat((4 - s.length % 4) % 4);
  try{ return JSON.parse(atob(pad(t.split('.')[1]).replace(/-/g,'+').replace(/_/g,'/')));}catch{ return null;}
}
const payload = decodeJWT(B_TOKEN);
const user = B_TOKEN && payload ? { id: payload.sub } : null;

let sb = window.supabase.createClient(B_URL, B_ANON, {
  global: { headers: B_TOKEN ? { Authorization: `Bearer ${B_TOKEN}` } : {} }
});
if (B_TOKEN) sb.realtime.setAuth(B_TOKEN);
const G = (t) => sb.schema('gacha').from(t);

(function guard(){
  const now = Math.floor(Date.now()/1000);
  if (!user || !B_TOKEN || (B_TOKEN_EXP && now >= B_TOKEN_EXP) || APP_ROLE !== 'ADMIN') {
    alert('請用管理者身分從後台入口進入（或登入逾期）。');
    location.href = 'https://shierusha.github.io/create-student/player';
  }
})();

/* =========================
   小工具
========================= */
const $  = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>[...r.querySelectorAll(s)];
const fmtDTLocal = (iso)=>{
  if(!iso) return '';
  const d = new Date(iso);
  const pad = n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
};
const toISOFromLocalInput = (val)=>{ if(!val) return null; const d=new Date(val); return d.toISOString(); };
function escapeHTML(s){ return String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

/* =========================
   刪除安全模式
========================= */
let deleteMode = false;
function applyDeleteModeUI(){
  $$('.btn-del').forEach(btn=>btn.classList.toggle('show', deleteMode));
  const tgl = $('#delete-toggle-btn');
  if (tgl){ tgl.classList.toggle('active', deleteMode); tgl.textContent = deleteMode ? '停用刪除' : '啟用刪除'; }
}
$('#delete-toggle-btn')?.addEventListener('click', ()=>{ deleteMode=!deleteMode; applyDeleteModeUI(); });

/* =========================
   Tabs（hash）
========================= */
const sections = {
  events:  $('#sec-events'),
  limited: $('#sec-limited'),
  normal:  $('#sec-normal'),
  hidden:  $('#sec-hidden')
};
function setActiveTab(tab){
  Object.keys(sections).forEach(k=>{
    sections[k].hidden = (k !== tab);
    const btn = $(`.tab-btn[data-tab="${k}"]`);
    btn?.classList.toggle('active', k===tab);
  });
  if (location.hash !== '#tab='+tab) history.replaceState(null,'','#tab='+tab);
}
function currentTabFromHash(){ const m = location.hash.match(/#tab=(\w+)/); const t = m?.[1] || 'events'; return sections[t] ? t : 'events'; }
window.addEventListener('hashchange', ()=> setActiveTab(currentTabFromHash()));
$$('.tab-btn').forEach(btn=>btn.addEventListener('click', ()=> setActiveTab(btn.dataset.tab)));

/* =========================
   URL Modal（通用）
========================= */
let urlModalCb = null;
function openUrlModal(initial='', cb){
  $('#url-input').value = initial || '';
  urlModalCb = cb || null;
  $('#url-modal').style.display = 'flex';
  $('#url-input').focus();
}
function closeUrlModal(){
  $('#url-modal').style.display = 'none';
  urlModalCb = null;
}
$('#url-save').addEventListener('click', ()=>{ const v=$('#url-input').value.trim(); if(urlModalCb) urlModalCb(v); closeUrlModal(); });
$('#url-cancel').addEventListener('click', closeUrlModal);
$('#url-modal').addEventListener('click', (e)=>{ if(e.target.id==='url-modal') closeUrlModal(); });

/* =========================
   活動管理（兩列三欄 + 圖片預覽+按鈕）
========================= */
const eventsTbody = $('#events-tbody');

function renderEventRow(ev){
  const tr = document.createElement('tr');

  // 左：方形預覽 + 設定圖片
  const leftTd = document.createElement('td');
  leftTd.innerHTML = `
    <div class="thumb-wrap">
      <div class="thumb ${ev.image_url ? '' : 'empty'}" data-thumb></div>
      <button class="btn gray" data-setimg>設定圖片</button>
      <div class="thumb-tip">預覽 120×120（裁切顯示）</div>
    </div>
  `;
  tr.appendChild(leftTd);

  // 設定背景圖
  const thumb = leftTd.querySelector('[data-thumb]');
  if (ev.image_url){
    const img = document.createElement('img');
    img.src = ev.image_url; img.alt='活動圖';
    thumb.appendChild(img);
  }

  leftTd.querySelector('[data-setimg]').addEventListener('click', ()=>{
    openUrlModal(ev.image_url || '', async (url)=>{
      const { error } = await G('events').update({ image_url: url || null }).eq('event_name', ev.event_name);
      if (error){ alert('設定失敗：'+error.message); return; }
      await refreshEvents(); // 重新渲染預覽
    });
  });

  // 右：2x3 格
  const rightTd = document.createElement('td');
  rightTd.innerHTML = `
    <div class="ev-grid">
      <label>活動名稱
        <input data-k="event_name" value="${escapeHTML(ev.event_name)}">
      </label>
      <label>開始時間
        <input data-k="starts_at" type="datetime-local" value="${fmtDTLocal(ev.starts_at)}">
      </label>
      <label>DC Thread ID
        <input data-k="discord_thread_id" value="${escapeHTML(ev.discord_thread_id||'')}">
      </label>

      <label>活動簡介
        <input data-k="display_name" value="${escapeHTML(ev.display_name||'')}" placeholder="可空">
      </label>
      <label>結束時間
        <input data-k="ends_at" type="datetime-local" value="${fmtDTLocal(ev.ends_at)}">
      </label>
      <div class="ev-actions">
        <button class="btn green" data-act="save">儲存</button>
        <button class="btn-del" data-act="del">刪除</button>
      </div>
    </div>
  `;
  tr.appendChild(rightTd);

  // 綁定儲存/刪除
  rightTd.querySelector('[data-act="save"]').addEventListener('click', async ()=>{
    const vals = {};
    rightTd.querySelectorAll('input[data-k]').forEach(inp=>{
      const k=inp.dataset.k; let v=inp.value;
      if (k==='starts_at' || k==='ends_at') v = toISOFromLocalInput(v);
      vals[k] = v===''?null:v;
    });
    if (!vals.starts_at || !vals.ends_at){ alert('開始/結束時間不可為空'); return; }
    const oldName = ev.event_name;
    const payload = {
      event_name: vals.event_name || oldName,
      display_name: vals.display_name,
      discord_thread_id: vals.discord_thread_id,
      starts_at: vals.starts_at,
      ends_at: vals.ends_at
    };
    const { error } = await G('events').update(payload).eq('event_name', oldName);
    if (error){ alert('更新失敗：'+error.message); return; }
    await refreshEvents();
    alert('已更新');
  });

  rightTd.querySelector('[data-act="del"]').addEventListener('click', async ()=>{
    if (!deleteMode) return;
    if (!confirm(`刪除活動「${ev.event_name}」？（不會連動刪限定與持有）`)) return;
    const { error } = await G('events').delete().eq('event_name', ev.event_name);
    if (error){ alert('刪除失敗：'+error.message); return; }
    await refreshEvents();
  });

  return tr;
}

async function refreshEvents(){
  const { data, error } = await G('events').select('*').order('starts_at');
  eventsTbody.innerHTML = '';
  if (error){ eventsTbody.innerHTML = `<tr><td colspan="2" class="muted">讀取失敗：${escapeHTML(error.message)}</td></tr>`; applyDeleteModeUI(); return; }
  (data||[]).forEach(ev=> eventsTbody.appendChild(renderEventRow(ev)));
  if (!data || data.length===0) eventsTbody.innerHTML = `<tr><td colspan="2" class="muted">尚無活動，請先新增。</td></tr>`;
  applyDeleteModeUI();
}

$('#btn-ev-add')?.addEventListener('click', async ()=>{
  const name = $('#ev-new-name').value.trim();
  if (!name){ alert('請填活動名稱'); return; }
  const starts = toISOFromLocalInput($('#ev-new-start').value);
  const ends   = toISOFromLocalInput($('#ev-new-end').value);
  if (!starts || !ends){ alert('開始/結束時間不可為空'); return; }
  const payload = {
    event_name: name,
    display_name: $('#ev-new-display').value.trim() || null,
    discord_thread_id: ($('#ev-new-dcid').value || '').trim() || null,
    starts_at: starts,
    ends_at: ends
  };
  const { error } = await G('events').insert(payload);
  if (error){ alert('新增失敗：'+error.message); return; }
  $('#ev-new-name').value=''; $('#ev-new-display').value=''; $('#ev-new-dcid').value='';
  $('#ev-new-start').value=''; $('#ev-new-end').value='';
  await refreshEvents(); await loadEventOptions();
  alert('新增成功');
});

/* =========================
   限定饅頭
========================= */
const limSel   = $('#lim-evsel');
const limTbody = $('#limited-tbody');

async function loadEventOptions(selected){
  const { data } = await G('events').select('event_name').order('starts_at');
  limSel.innerHTML = '<option value="">（請選擇活動）</option>';
  (data||[]).forEach(r=>{
    const opt=document.createElement('option');
    opt.value=r.event_name; opt.textContent=r.event_name;
    if (selected && selected===r.event_name) opt.selected=true;
    limSel.appendChild(opt);
  });
}
function renderLimitedRow(r){
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td>${r.id}</td>
    <td><input data-k="name" value="${escapeHTML(r.name||'')}" placeholder="名稱"></td>
    <td>
      ${r.image_url ? `<img src="${escapeHTML(r.image_url)}" alt="" style="max-width:90px;max-height:60px;object-fit:cover;border:1px solid #eef2fa;border-radius:6px;display:block;margin-bottom:.3rem;">` : ''}
      <input data-k="image_url" value="${escapeHTML(r.image_url||'')}" placeholder="https://...">
    </td>
    <td>
      <button class="btn" data-act="save">儲存</button>
      <button class="btn-del" data-act="del">刪除</button>
    </td>`;
  tr.querySelector('[data-act="save"]').addEventListener('click',async ()=>{
    const name = tr.querySelector('input[data-k="name"]').value.trim();
    const img  = tr.querySelector('input[data-k="image_url"]').value.trim() || null;
    const { error } = await G('limited_characters').update({ name, image_url: img }).eq('id', r.id).eq('event_name', r.event_name);
    if (error){ alert('更新失敗：'+error.message); return; }
    await refreshLimited(); alert('已更新');
  });
  tr.querySelector('[data-act="del"]').addEventListener('click',async ()=>{
    if(!deleteMode) return;
    if(!confirm(`刪除限定饅頭 #${r.id}「${r.name}」？`)) return;
    const { error } = await G('limited_characters').delete().eq('id', r.id).eq('event_name', r.event_name);
    if (error){ alert('刪除失敗：'+error.message); return; }
    await refreshLimited();
  });
  return tr;
}
async function refreshLimited(){
  const ev=limSel.value;
  if(!ev){ limTbody.innerHTML=`<tr><td colspan="4" class="muted">請先選活動</td></tr>`; applyDeleteModeUI(); return; }
  const { data, error } = await G('limited_characters').select('*').eq('event_name', ev).order('id');
  limTbody.innerHTML='';
  if(error){ limTbody.innerHTML=`<tr><td colspan="4" class="muted">讀取失敗：${escapeHTML(error.message)}</td></tr>`; applyDeleteModeUI(); return; }
  (data||[]).forEach(r=>limTbody.appendChild(renderLimitedRow(r)));
  if(!data || data.length===0) limTbody.innerHTML=`<tr><td colspan="4" class="muted">此活動尚無限定饅頭。</td></tr>`;
  applyDeleteModeUI();
}
$('#lim-evsel')?.addEventListener('change', refreshLimited);
$('#btn-lim-upsert')?.addEventListener('click',async ()=>{
  const ev=limSel.value; if(!ev){ alert('請先選活動'); return; }
  const id=Number($('#lim-new-id').value);
  const name=$('#lim-new-name').value.trim();
  const img=$('#lim-new-img').value.trim()||null;
  if(!id||!name){ alert('請填 ID 與 名稱'); return; }
  const { error } = await G('limited_characters').upsert({ id, event_name: ev, name, image_url: img }, { onConflict:'id' });
  if(error){ alert('新增/覆蓋失敗：'+error.message); return; }
  $('#lim-new-id').value=''; $('#lim-new-name').value=''; $('#lim-new-img').value='';
  await refreshLimited();
});

/* =========================
   普通 / 隱藏饅頭
========================= */
const norTbody=$('#normal-tbody');
const hidTbody=$('#hidden-tbody');

function renderSimpleRow(r, tableKey){
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td>${r.id}</td>
    <td><input data-k="name" value="${escapeHTML(r.name||'')}" placeholder="名稱"></td>
    <td>
      ${r.image_url ? `<img src="${escapeHTML(r.image_url)}" alt="" style="max-width:90px;max-height:60px;object-fit:cover;border:1px solid #eef2fa;border-radius:6px;display:block;margin-bottom:.3rem;">` : ''}
      <input data-k="image_url" value="${escapeHTML(r.image_url||'')}" placeholder="https://...">
    </td>
    <td>
      <button class="btn" data-act="save">儲存</button>
      <button class="btn-del" data-act="del">刪除</button>
    </td>`;
  const table = tableKey==='normal'?'normal_characters':'hidden_characters';
  tr.querySelector('[data-act="save"]').addEventListener('click',async ()=>{
    const name=tr.querySelector('input[data-k="name"]').value.trim();
    const img =tr.querySelector('input[data-k="image_url"]').value.trim()||null;
    const { error } = await G(table).update({ name, image_url: img }).eq('id', r.id);
    if(error){ alert('更新失敗：'+error.message); return; }
    if(tableKey==='normal') await refreshNormal(); else await refreshHidden();
    alert('已更新');
  });
  tr.querySelector('[data-act="del"]').addEventListener('click',async ()=>{
    if(!deleteMode) return;
    if(!confirm(`刪除 ${tableKey==='normal'?'普通':'隱藏'}饅頭 #${r.id}「${r.name}」？`)) return;
    const { error } = await G(table).delete().eq('id', r.id);
    if(error){ alert('刪除失敗：'+error.message); return; }
    if(tableKey==='normal') await refreshNormal(); else await refreshHidden();
  });
  return tr;
}
async function refreshNormal(){
  const { data, error } = await G('normal_characters').select('*').order('id');
  norTbody.innerHTML='';
  if(error){ norTbody.innerHTML=`<tr><td colspan="4" class="muted">讀取失敗：${escapeHTML(error.message)}</td></tr>`; applyDeleteModeUI(); return; }
  (data||[]).forEach(r=>norTbody.appendChild(renderSimpleRow(r,'normal')));
  if(!data || data.length===0) norTbody.innerHTML=`<tr><td colspan="4" class="muted">尚無資料，請新增。</td></tr>`;
  applyDeleteModeUI();
}
async function refreshHidden(){
  const { data, error } = await G('hidden_characters').select('*').order('id');
  hidTbody.innerHTML='';
  if(error){ hidTbody.innerHTML=`<tr><td colspan="4" class="muted">讀取失敗：${escapeHTML(error.message)}</td></tr>`; applyDeleteModeUI(); return; }
  (data||[]).forEach(r=>hidTbody.appendChild(renderSimpleRow(r,'hidden')));
  if(!data || data.length===0) hidTbody.innerHTML=`<tr><td colspan="4" class="muted">尚無資料，請新增。</td></tr>`;
  applyDeleteModeUI();
}

/* =========================
   啟動
========================= */
(async function init(){
  setActiveTab(currentTabFromHash());
  applyDeleteModeUI();

  await refreshEvents();
  await loadEventOptions();
  await refreshNormal();
  await refreshHidden();

  const usp=new URLSearchParams(location.search);
  const evq=usp.get('ev');
  if (evq){ await loadEventOptions(evq); await refreshLimited(); }
  if (currentTabFromHash()==='limited') await refreshLimited();
})();
</script>
</body>
</html>
