<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>休息室</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{ --w:1080px; --h:725px; --ink:#e9efff; --muted:#98a3c7; --brand:#1767a0; }
    html,body{margin:0;background:#1e2126;font-family:'Noto Sans TC',system-ui,-apple-system,Segoe UI,sans-serif;color:var(--ink)}
    .room{position:relative;width:var(--w);height:var(--h);margin:28px auto;border-radius:16px;overflow:hidden;box-shadow:0 18px 60px #000a;background:#000}
    .room img{width:100%;height:100%;object-fit:cover;display:block}
    .owner-badge{
      position:absolute;left:16px;top:16px;z-index:5;
      background:rgba(15,20,32,.85);border:1px solid #2b3550;color:#e9efff;
      padding:.45rem .75rem;border-radius:12px;box-shadow:0 6px 24px #0008;font-weight:700
    }
    .hot{position:absolute;left:54px;top:86px;width:268px;height:540px;background:transparent;border:none;cursor:pointer}
    .hot:hover{outline:3px solid rgba(255,207,102,.9);border-radius:18px}
    .shelf-books{position:absolute;left:76px;top:112px;pointer-events:none}
    .book-on-shelf{position:absolute;width:48px;height:68px;border-radius:5px;background:#f6d3a3;border:2px solid #b7894e;box-shadow:0 2px 8px #0006}
    .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{background:#0f1420;border:1px solid #2b3550;color:#e9efff;border-radius:14px;box-shadow:0 16px 60px #000b;width:min(720px,94vw);max-height:88vh;overflow:auto;padding:18px}
    .row{display:flex;gap:10px;align-items:center;margin-bottom:10px}
    select{background:#0b1120;color:#e9efff;border:1px solid #35446f;border-radius:10px;padding:.5rem .7rem}
    .btn{background:#1767a0;border:1px solid #1767a0;color:#fff;border-radius:10px;padding:.55rem .9rem;cursor:pointer}
    .book-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .book-item{display:flex;align-items:center;gap:10px;background:#0b1327;border:1px solid #263257;border-radius:10px;padding:10px;cursor:pointer}
    .book-item .date{color:#98a3c7;font-size:.9rem;margin-left:auto}
    .icon{width:28px;height:28px;flex:0 0 28px;filter:drop-shadow(0 1px 2px #0006)}
    .foot{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
    .note{max-width:960px;margin:14px auto;padding:12px 14px;background:#0f1420;border:1px solid #2b3550;border-radius:12px}
  </style>
</head>
<body>
  <div class="room" id="room">
    <img src="https://shierusha.github.io/library/img/ROOM.webp" alt="room" />
    <div id="ownerBadge" class="owner-badge" style="display:none;">房主：—</div>
    <button class="hot" title="打開書櫃" onclick="openShelf()"></button>
    <div id="shelfBooks" class="shelf-books"></div>
  </div>

  <div class="modal-bg" id="modalBg">
    <div class="modal">
      <h2 id="modalTitle">書櫃清單</h2>
      <div class="row">
        <div>切換：</div>
        <select id="selChar" onchange="onCharChange()"></select>
        <div style="margin-left:auto" id="ownerInfo"></div>
      </div>
      <div id="bookList" class="book-list"></div>
      <div class="foot">
        <button id="btnWrite" class="btn" onclick="goWrite()" style="display:none">＋ 撰寫故事</button>
        <button class="btn" onclick="closeShelf()">關閉</button>
      </div>
    </div>
  </div>

<script>
/* ====== Supabase 連線 ====== */
// A：登入/角色庫
const A = window.supabase.createClient(
  'https://wfhwhvodgikpducrhgda.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmaHdodm9kZ2lrcGR1Y3JoZ2RhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwMTAwNjEsImV4cCI6MjA2MzU4NjA2MX0.P6P-x4SxjiR4VdWH6VFgY_ktgMac_OzuI4Bl7HWskz8'
);
// B：圖書館
const B = window.supabase.createClient(
  'https://ogzpfrkwnqqaitytncla.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9nenBmcmt3bnFxYWl0eXRuY2xhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxODQzNzEsImV4cCI6MjA3MDc2MDM3MX0.Ls83xOXcKIW7FUcavr8_sOs37I18VGFWYNW3sNFRS24'
);

/* ====== 白名單（玩家ID）====== */
const WHITELIST = [
  '32d2c681-43f4-4f24-8014-44cdbe80411d',
  '9eee80cf-baf2-4297-b163-59699bad4ed4',
];

/* ====== 狀態 ====== */
const BOOK_ICON = 'https://shierusha.github.io/school-battle/images/book.png';
let viewer = null;             // 目前登入者（可為 null）
let ownerId = null;            // 房主 player_id
let ownerName = '—';           // players.username
let isOwnerWhitelisted = false;
let students = [];             // 房主名下「審核通過」的學生
let selected = null;           // {type:'student'|'teacher', id?, name?}
let defaultStudentName = null; // URL 的 student_name

/* ====== 初始化：用 student_name 反查 owner，顯示 username、白名單、過濾通過 ====== */
(async function init(){
  const { data:{ user } } = await A.auth.getUser().catch(()=>({data:{user:null}}));
  viewer = user || null;

  const p = new URLSearchParams(location.search);
  defaultStudentName = p.get('student_name');

  if (!defaultStudentName) {
    document.body.insertAdjacentHTML('beforeend',
      `<div class="note">請在網址加上 <b>?student_name=角色名</b>。</div>`);
    return;
  }

  // 1) 角色名 -> ownerId + student_id
  const { data: stu, error: e1 } = await A
    .from('students')
    .select('student_id, player_id, name')
    .eq('name', defaultStudentName)
    .single();
  if (e1 || !stu) {
    document.body.insertAdjacentHTML('beforeend',
      `<div class="note">查無角色：${escapeHtml(defaultStudentName)}</div>`);
    return;
  }
  ownerId = stu.player_id;
  selected = { type:'student', id: stu.student_id, name: stu.name };

  // 2) 房主 username + 白名單
  const { data: ownerRow } = await A
    .eq('player_id', ownerId).single();
  ownerName = ownerRow?.username || '—';
  isOwnerWhitelisted = WHITELIST.includes(ownerId);
  // 依 ownerId 取 username（只回傳文字）
const { data: uname, error: uerr } = await A.rpc('get_player_username', { p_id: ownerId });
const ownerName = (uname && String(uname).trim()) ? uname : '玩家';
if (uerr) console.warn('get_player_username error:', uerr);

// 顯示在左上角
document.title = `${ownerName} 的休息室`;
const badge = document.getElementById('ownerBadge');
badge.textContent = `${ownerName} 的休息室`;
badge.style.display = '';

  // 3) 取房主名下所有學生，過濾「審核通過」
  const { data: allStu } = await A
    .from('students')
    .select('student_id, name')
    .eq('player_id', ownerId);
  const ids = (allStu||[]).map(s=>s.student_id);

  let passSet = new Set();
  if (ids.length){
    const { data: reviews } = await A
      .from('student_reviews')
      .select('student_id,status')
      .in('student_id', ids)
      .eq('status', 'PASS');
    (reviews||[]).forEach(r=> passSet.add(r.student_id));
  }
  students = (allStu||[]).filter(s=> passSet.has(s.student_id))
                         .sort((a,b)=> a.name.localeCompare(b.name,'zh-Hant'));

  // 若預設學生不在通過名單：改選第一位；如果白名單且沒有通過學生，預設選「老師」
  if (!students.find(s => s.student_id === selected.id)) {
    if (students.length) selected = { type:'student', id:students[0].student_id, name:students[0].name };
    else if (isOwnerWhitelisted) selected = { type:'teacher', name:'老師' };
    else selected = null;
  }

  await renderShelfOverlay(); // 書櫃疊書（顯示數量）
})();

/* ====== 彈窗 ====== */
function openShelf(){
  if (!ownerId) return;
  document.getElementById('modalBg').style.display = 'flex';
  fillSelect();
  refreshModal();
}
function closeShelf(){ document.getElementById('modalBg').style.display = 'none'; }

function fillSelect(){
  const sel = document.getElementById('selChar');
  const opts = [];
  if (isOwnerWhitelisted) {
    opts.push(`<option value="teacher" ${selected?.type==='teacher'?'selected':''}>老師</option>`);
  }
  for (const s of students) {
    const isSel = selected?.type==='student' && selected?.id===s.student_id;
    opts.push(`<option value="${s.student_id}" ${isSel?'selected':''}>${escapeHtml(s.name)}</option>`);
  }
  sel.innerHTML = opts.join('') || '<option>（無可顯示角色）</option>';

  const isOwnerViewing = viewer && viewer.id === ownerId;
  document.getElementById('btnWrite').style.display = isOwnerViewing ? '' : 'none';
  document.getElementById('ownerInfo').textContent = `房主：${ownerName}`;
  document.getElementById('modalTitle').textContent =
    `書櫃清單（${selected ? (selected.type==='teacher'?'老師':selected.name) : '—'}）`;
}
function onCharChange(){
  const sel = document.getElementById('selChar');
  if (sel.value === 'teacher') {
    selected = { type:'teacher', name:'老師' };
  } else {
    const s = students.find(x=>x.student_id===sel.value);
    selected = s ? { type:'student', id:s.student_id, name:s.name } : null;
  }
  refreshModal(); renderShelfOverlay();
}

/* ====== 撰寫故事（只有房主本人可見） ====== */
function goWrite(){
  if (!selected) return;
  if (selected.type === 'teacher') {
    // 老師的故事：student_id = null
    location.href = `https://shierusha.github.io/library/library?owner_id=${encodeURIComponent(ownerId)}&teacher=1`;
  } else {
    location.href = `https://shierusha.github.io/library/library?student_name=${encodeURIComponent(selected.name)}`;
  }
}

/* ====== 抓書並渲染 ====== */
async function refreshModal(){
  const listEl = document.getElementById('bookList');
  if (!selected){
    listEl.innerHTML = '<div class="muted">沒有可顯示的目標</div>';
    return;
  }
  let q = B.from('books').select('id, title, updated_at').eq('owner_id', ownerId);
  if (selected.type === 'teacher') q = q.is('student_id', null);
  else q = q.eq('student_id', selected.id);
  const { data: books } = await q.order('updated_at', {ascending:false});

  const icon = 'https://shierusha.github.io/school-battle/images/book.png';
  listEl.innerHTML = (books||[]).length
    ? books.map(b=>`
      <div class="book-item" onclick="window.open('https://shierusha.github.io/library/reader.html?book_id=${encodeURIComponent(b.id)}','_blank')">
        <img class="icon" src="${icon}" alt="book">
        <div>${escapeHtml(b.title||'未命名書籍')}</div>
        <div class="date">${(b.updated_at||'').slice(0,10)}</div>
      </div>`).join('')
    : '<div class="muted">目前沒有書籍</div>';

  fillSelect();
}

/* ====== 書櫃上的書數量展示（裝飾） ====== */
async function renderShelfOverlay(){
  const box = document.getElementById('shelfBooks');
  box.innerHTML = '';
  if (!selected) return;

  let q = B.from('books').select('id').eq('owner_id', ownerId);
  if (selected.type === 'teacher') q = q.is('student_id', null);
  else q = q.eq('student_id', selected.id);
  const { data: books } = await q;
  const count = (books||[]).length;

  const perRow = 4, gapX = 60, baseX = 90, baseY = 115, gapY = 110;
  for (let i=0; i<Math.min(count,16); i++){
    const row = Math.floor(i/perRow), col = i%perRow;
    const div = document.createElement('div');
    div.className = 'book-on-shelf';
    div.style.left = (baseX + col*gapX) + 'px';
    div.style.top  = (baseY + row*gapY) + 'px';
    box.appendChild(div);
  }
}

/* ====== 小工具 ====== */
function escapeHtml(s){return (s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]))}
</script>
</body>
</html>
