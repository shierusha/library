<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>謝爾夏|休息室</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
  :root{
    --room-bg: url("https://shierusha.github.io/library/img/ROOM.webp");
    --panel-bg: #ffffffec;
    --panel-stroke: rgba(0,0,0,.08);
    --text: #1f2937;
    --radius-2xl: 24px;
    --control-h: 38px;
  }
  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body{
    margin: 0;
    font-family: "Noto Sans TC",ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue","PingFang TC","Microsoft JhengHei",sans-serif;
    color: var(--text);
    background: #393c47;
  }

  .room-wrap{
    width: 90vw;
    max-width: 1600px;
    aspect-ratio: 3/2;
    margin: 4vh auto;
    position: relative;
    background-image: var(--room-bg);
    background-size: cover;
    background-position: center;
    border-radius: var(--radius-2xl);
    box-shadow: 0 10px 40px rgba(0,0,0,.35);
    overflow: hidden;
  }

  .book{
    position: absolute;
    left: 5.5%;
    width: 23%;
    height: 12%;
  }
  .book img{
    position: absolute;
    bottom: 0%;
    width: 20%;
  }

  .book-btn{
    position: absolute;
    bottom: 65%;
    width: 24%;
    left: 5%;
    height: 27%;
    background: transparent;
    border: 0;
    padding: 0;
    cursor: pointer;
  }

  .modal-overlay {
    position: fixed;
    inset: 0;
    z-index: 2000;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: modal-fadein-bg 0.25s;
  }
  @keyframes modal-fadein-bg { from{background:rgba(0,0,0,0)} to{background:rgba(0,0,0,0.45)} }
  .modal-content2 {
    background: rgb(255 255 255 / 69%);
    border-radius: 18px;
    border: 2px solid #1eb5e5;
    box-shadow: 0 0 16px 2px #62f1fe88, 0 8px 32px #1eb5e5aa;
    width: 75vw; max-width: 1200px; min-height: 75vh;
    display: flex; flex-direction: column; overflow: hidden;
    animation: modal-pop 0.32s cubic-bezier(.42, 1.4, .51, 1.01);
  }
  @keyframes modal-pop { from{opacity:0;transform:scale(0.92)} to{opacity:1;transform:scale(1)} }

  .modal-header {
    background: none;
    padding: 15px 20px 0px 24px;
    font-size: 1.5em; font-weight: bold;
    letter-spacing: 1px;
    display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
  }
  .modal-header::after {
    content: ""; display: block; height: 5px; width: 100%; margin:.5rem 0 0;
    border-radius: 2px; background: linear-gradient(to right,#53e2ff99 65%,#53e2ff00 100%);
    pointer-events: none; flex-basis: 100%;
  }
  .header-title{
    flex: 1; min-width: 0; white-space: normal;
    display: -webkit-box; -webkit-line-clamp: 3; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
  }
  .header-actions{ display:flex; align-items:center; gap:10px; margin-left:auto; }
  .modal-content2 .modal-header{ font-size:clamp(14px, 2.2vw, 22px); --control-h: clamp(30px, 5.5vw, 42px); }
  #student-filter{
    font-size:1em; height:var(--control-h); padding:0 .8em; border-radius:.5rem; border:1px solid var(--panel-stroke); background:#fff;
  }
  .manage-btn{
    display:inline-flex; align-items:center; height:var(--control-h); padding:0 1em;
    border-radius:.55rem; border:1px solid #d1d5db; background:#f9fafb;
    cursor:pointer; text-decoration:none; color:#111827; line-height:1;
  }
  .manage-btn:hover{ background:#eef2f7; }

  .modal-body { color:#fff; padding:12px 24px 24px 24px; font-size:1em; overflow-y:auto; max-height:60vh; }
  .modal-body::-webkit-scrollbar { display:none; }

  .book-list{ display:grid; }
  .book-card{ display:grid; grid-template-columns:15% 1fr 65px; gap:10px; align-items:center; color:#111827; }
  .book-icon{ width:100%; border-radius:6px; display:grid; place-items:center; }
  .book-icon img{ max-width:100%; max-height:100%; display:block; }
  .book-meta{ min-width:0; display:flex; flex-direction:column; gap:4px; }
  .book-title{ font-weight:700; line-height:1.2; white-space:nowrap; text-overflow:ellipsis; overflow:hidden; }
  .book-sub{ font-size:.88rem; color:#6b7280; }
  .book-actions{ margin-left:auto; }
  .go-btn{
    display:inline-flex; align-items:center; justify-content:center; padding:.55rem .9rem;
    border-radius:.55rem; border:1px solid #d1d5db; background:#214568; cursor:pointer; text-decoration:none;
    color:#ffffff; line-height:1.2; text-align:center; white-space:normal; font-weight:600;
  }
  .go-btn:hover{ background:#cc3f3f; }

  @media (max-width: 640px){ .book-list{ grid-template-columns:1fr; } }

  img { -webkit-user-drag:none; user-select:none; -webkit-touch-callout:none; }
  </style>
</head>
<body>

  <!-- 書櫃彈窗 -->
  <div id="library-modal" class="modal-overlay" style="display: flex;">
    <div class="modal-content2">
      <div class="modal-header">
        <div class="header-title">歡迎來到 <span id="owner-name">玩家</span> 的書櫃</div>
        <div class="header-actions">
          <select id="student-filter"></select>
          <!-- href 改為 #，由 JS 控制導向 -->
          <a id="manage-btn" class="manage-btn" href="#" style="display:none;">管理</a>
        </div>
      </div>
      <div class="modal-body">
        <div id="book-list" class="book-list"></div>
      </div>
    </div>
  </div>

  <!-- 房間背景 & 書籍清單 -->
  <div class="room-wrap">
    <div class="book book1-12" style="bottom: 78.2%;"></div>
    <div class="book book13-24" style="bottom: 64.2%;"></div>

    <img draggable="false" style="position: absolute; height: 100%; width: 100%;" src="https://shierusha.github.io/library/img/ROOM-TOP.png" alt="bookshelf overlay">
    <button class="book-btn" aria-label="打開書櫃"></button>
  </div>

<script>
/* ============ 快捷選擇器 ============ */
const $  = (s, r=document) => r.querySelector(s);
const $$ = (s, r=document) => [...r.querySelectorAll(s)];

/* ============ Supabase：兩個專案 ============ */
/* B（書櫃 / books） */
const BOOKS_URL  = 'https://ogzpfrkwnqqaitytncla.supabase.co';
const BOOKS_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9nenBmcmt3bnFxYWl0eXRuY2xhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxODQzNzEsImV4cCI6MjA3MDc2MDM3MX0.Ls83xOXcKIW7FUcavr8_sOs37I18VGFWYNW3sNFRS24';
const booksClient = window.supabase.createClient(BOOKS_URL, BOOKS_ANON);

/* A（登入/角色 players/students） */
const client = window.supabase.createClient(
  'https://wfhwhvodgikpducrhgda.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmaHdodm9kZ2lrcGR1Y3JoZ2RhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwMTAwNjEsImV4cCI6MjA2MzU4NjA2MX0.P6P-x4SxjiR4VdWH6VFgY_ktgMac_OzuI4Bl7HWskz8'
);

/* Edge Function（B 專案）的完整 URL —— 用 fetch() 直打 */
const EXCHANGE_URL = 'https://ogzpfrkwnqqaitytncla.supabase.co/functions/v1/exchange-token';

/* 電子書櫃頁路徑 */
const BOOK_CHEST_URL = 'book-chest';

/* 其他常數 */
const BOOK_ICON = 'https://shierusha.github.io/school-battle/images/book.png';
const BOOK_SHELF_1_12  = 'https://shierusha.github.io/library/img/book1.png';
const BOOK_SHELF_13_24 = 'https://shierusha.github.io/library/img/book2.png';
const DEBUG = new URLSearchParams(location.search).get('debug') === '1';

/* ============ 小工具 ============ */
function fDate(x){
  if(!x) return '';
  const d = new Date(x);
  if (Number.isNaN(d.getTime())) return '';
  return d.toLocaleDateString('zh-TW', { year:'numeric', month:'2-digit', day:'2-digit' });
}
function bookImg(_b, fallback){ return fallback; }

/* ============ 主要狀態 ============ */
let CURRENT_PLAYER = null;
let OWNER_PLAYER   = null;
let PLAYER_STUDENTS = [];
let DEFAULT_STUDENT = null;
let ALL_BOOKS = [];

/* ============ A 專案：登入玩家 & 角色 ============ */
async function getCurrentPlayer(){
  const res = await client.auth.getUser();
  if (res.error) {
    if (res.error.name === 'AuthSessionMissingError' || /Auth session missing/i.test(res.error.message||'')) return null;
    console.warn('[auth.getUser] unexpected error:', res.error);
    return null;
  }
  const user = res.data?.user;
  if (!user) return null;

  const { data: p, error: pErr } = await client
    .from('players')
    .select('player_id, username')
    .eq('player_id', user.id)
    .maybeSingle();

  if (pErr) {
    console.warn('[getCurrentPlayer] players query error:', pErr);
    return { id: user.id, username: user.user_metadata?.name || '玩家' };
  }
  return { id: user.id, username: p?.username || user.user_metadata?.name || '玩家' };
}

async function getStudentByCode(code){
  if (!code) return null;
  const { data, error } = await client
    .from('students')
    .select('student_id, name, student_code, player_id')
    .eq('student_code', code)
    .maybeSingle();
  if (error) throw error;
  return data || null;
}

async function getPlayerUsernameByRPC(playerId){
  if (!playerId) return '玩家';
  try{
    const { data, error } = await client.rpc('get_player_username', { p_id: playerId });
    if (error) { console.warn('[getPlayerUsernameByRPC] error:', error); return '玩家'; }
    const name = (data && String(data).trim()) || '玩家';
    return name;
  }catch(e){ console.warn('[getPlayerUsernameByRPC] exception:', e); return '玩家'; }
}
async function getPlayerProfile(playerId){
  const username = await getPlayerUsernameByRPC(playerId);
  return { id: playerId, username };
}

async function getOwnerStudents(playerId){
  const { data, error } = await client
    .from('students')
    .select('student_id, name, student_code')
    .eq('player_id', playerId)
    .not('student_code', 'is', null)
    .order('name', { ascending: true });
  if (error) throw error;
  return data || [];
}

/* ============ B 專案：讀書（公開 read） ============ */
async function fetchBooksByFilter(ownerId, filterStudentId){
  if (!ownerId) { if (DEBUG) console.warn('[books] missing ownerId'); return []; }

  let q = booksClient
    .from('books')
    .select('id, title, cover_image, cover_color, updated_at, sort_order, student_id, owner_id')
    .eq('owner_id', ownerId)
    .order('sort_order', { ascending: true })
    .order('updated_at', { ascending: false });

  if (filterStudentId === 'OTHER'){
    q = q.is('student_id', null);
  } else if (filterStudentId){
    q = q.eq('student_id', filterStudentId);
  }

  const { data, error } = await q;
  if (error) throw error;
  return data || [];
}

/* ============ UI：下拉 & 書單 & 書架 ============ */
function renderFilterOptions(){
  const sel = $('#student-filter');
  if (!sel) return;
  sel.innerHTML = '';

  PLAYER_STUDENTS.forEach(s => sel.appendChild(new Option(s.name, s.student_id, false, false)));
  sel.appendChild(new Option('其他', 'OTHER', false, false));

  if (DEFAULT_STUDENT) sel.value = DEFAULT_STUDENT.student_id;
  else sel.value = PLAYER_STUDENTS[0]?.student_id || 'OTHER';
}

function renderBookList(books){
  const box = $('#book-list');
  if (!box) return;
  box.innerHTML = '';
  if (!books.length){
    box.innerHTML = `<div style="padding:12px;color:#6b7280;">沒有找到符合的書籍。</div>`;
    return;
  }
  const frag = document.createDocumentFragment();
  books.forEach(b => {
    const card = document.createElement('div');
    card.className = 'book-card';

    const icon = document.createElement('div');
    icon.className = 'book-icon';
    const filterStr = (b?.cover_color || '').trim();
    icon.innerHTML = `<img draggable="false" alt="book" src="${BOOK_ICON}" style="${/^filter:/.test(filterStr) ? filterStr : ''}">`;

    const meta = document.createElement('div');
    meta.className = 'book-meta';
    meta.innerHTML = `
      <div class="book-title" title="${b.title}">${b.title}</div>
      <div class="book-sub">最後更新日：${fDate(b.updated_at) || '—'}</div>
    `;

    const actions = document.createElement('div');
    actions.className = 'book-actions';
    const link = document.createElement('a');
    link.className = 'go-btn';
    link.innerHTML = '前往<br>閱讀';
    link.href = `./book?book=${encodeURIComponent(b.title)}`;
    actions.appendChild(link);

    card.append(icon, meta, actions);
    frag.appendChild(card);
  });
  box.appendChild(frag);
}

function renderShelves(books){
  const shelf1 = document.querySelector('.book1-12');
  const shelf2 = document.querySelector('.book13-24');
  if (!shelf1 || !shelf2) return;

  const leftStart = 3;
  const delta = 6;
  const heights = [75,80,85,90,95,100];

  function renderShelf(el, slice, fallbackUrl){
    el.innerHTML = '';
    slice.forEach((b, i) => {
      const img = document.createElement('img');
      img.draggable = false;
      const left = leftStart + i*delta;
      const h = heights[Math.floor(Math.random()*heights.length)];
      img.src = bookImg(b, fallbackUrl);
      img.style.left = left + '%';
      img.style.height = h + '%';
      img.title = b.title;
      img.style.cursor = 'pointer';

      const filterStr = (b?.cover_color || '').trim();
      if (/^filter:/.test(filterStr)) img.style.cssText += ';' + filterStr;

      img.addEventListener('click', () => {
        window.location.href = `./reader.html?book_id=${encodeURIComponent(b.id)}`;
      });
      el.appendChild(img);
    });
  }

  renderShelf(shelf1, books.slice(0, 12),  BOOK_SHELF_1_12);
  renderShelf(shelf2, books.slice(12, 24), BOOK_SHELF_13_24);
}

async function refreshBooks(){
  if (!OWNER_PLAYER?.id) {
    if (DEBUG) console.warn('[books] refresh skipped: missing OWNER_PLAYER.id');
    renderBookList([]);
    return;
  }
  const sel = $('#student-filter');
  const filter = sel?.value || 'OTHER';
  const books = await fetchBooksByFilter(OWNER_PLAYER.id, filter);
  ALL_BOOKS = books;
  renderBookList(books);
  renderShelves(books);

  if (DEBUG) await runDiagnostics();
}

/* ============ Realtime ============ */
let booksChannel = null;
function setupRealtime(ownerId){
  if (booksChannel) { booksClient.removeChannel(booksChannel); booksChannel = null; }
  booksChannel = booksClient
    .channel('books-room-' + ownerId)
    .on('postgres_changes', { event: '*', schema: 'public', table: 'books', filter: `owner_id=eq.${ownerId}` },
      payload => { refreshBooks(); })
    .subscribe();
}

/* ============ 診斷工具（?debug=1） ============ */
async function runDiagnostics(){
  const ownerId = OWNER_PLAYER?.id;
  const stuId = $('#student-filter')?.value;

  console.log('%c[diag] ownerId / studentId', 'color:#0aa', ownerId, stuId);

  const q1 = await booksClient.from('books').select('id,owner_id,student_id,title', { count: 'exact' }).eq('owner_id', ownerId).eq('student_id', stuId).limit(5);
  console.log('[diag] owner+student → count=', q1.count, 'error=', q1.error);
  if (q1.data?.length) console.table(q1.data);

  const q2 = await booksClient.from('books').select('id,owner_id,student_id,title', { count: 'exact' }).eq('student_id', stuId).limit(5);
  console.log('[diag] only student → count=', q2.count, 'error=', q2.error);
  if (q2.data?.length) console.table(q2.data);

  const q3 = await booksClient.from('books').select('id,owner_id,student_id,title', { count: 'exact' }).eq('owner_id', ownerId).limit(5);
  console.log('[diag] only owner → count=', q3.count, 'error=', q3.error);
  if (q3.data?.length) console.table(q3.data);

  const q4 = await booksClient.from('books').select('id,owner_id,student_id,title', { count: 'exact' }).limit(5);
  console.log('[diag] sample(any) → count=', q4.count, 'error=', q4.error);
  if (q4.data?.length) console.table(q4.data);

  const auth = await booksClient.auth.getUser();
  console.log('[diag] books auth user =', auth?.data?.user ?? null);
}

/* ============ ★ 改成 fetch()：跳轉到「電子書櫃」（交換長簽） ============ */
async function goToBookChest(e){
  if (e) e.preventDefault();

  // 先預開分頁（同步、可通過 popup blocker）
  const popup = window.open('about:blank', '_blank', 'noopener');

  // 取 A 的 access_token（這段是非同步，不會影響已開好的分頁）
  const { data: sess } = await client.auth.getSession();
  const tokenA = sess?.session?.access_token;
  if (!tokenA) {
    if (popup && !popup.closed) popup.close();
    alert('請先登入才能管理書櫃');
    return;
  }

  try {
    const resp = await fetch(`${BOOKS_URL}/functions/v1/exchange-token`, {
      method: 'POST',
      headers: { 'content-type':'application/json' },
      body: JSON.stringify({ token: tokenA })
    });
    const out = await resp.json();
    if (!resp.ok || !out?.token) throw new Error(out?.message || '交換 token 失敗');

    const url = new URL(BOOK_CHEST_URL, location.href);
    url.searchParams.set('token', out.token);

    const ownerId = OWNER_PLAYER?.id || sess.session.user.id;
    if (ownerId) url.searchParams.set('id', ownerId);

    const sel = document.getElementById('student-filter');
    if (sel && sel.value && sel.value !== 'OTHER') {
      const stu = (window.PLAYER_STUDENTS||[]).find(s => String(s.student_id)===String(sel.value));
      if (stu?.student_code) url.searchParams.set('stu', stu.student_code);
    }

    const target = url.toString();
    if (popup && !popup.closed) popup.location.href = target;   // ✅ 走新分頁
    else location.href = target;                                // ✅ 備援：同分頁
  } catch (err) {
    if (popup && !popup.closed) popup.close();
    alert('登入書櫃失敗：' + (err?.message || '未知錯誤'));
  }
}

/* ============ 初始化流程 ============ */
async function init(){
  try{
    const params = new URLSearchParams(location.search);
    const stuCode = params.get('stu'); // ?stu=student_code

    CURRENT_PLAYER = await getCurrentPlayer();

    if (stuCode){
      const stu = await getStudentByCode(stuCode);
      if (stu){
        DEFAULT_STUDENT = stu;
        OWNER_PLAYER = await getPlayerProfile(stu.player_id);
      }
    }
    if (!OWNER_PLAYER && CURRENT_PLAYER){
      OWNER_PLAYER = { id: CURRENT_PLAYER.id, username: CURRENT_PLAYER.username };
    }
    window.OWNER_PLAYER = OWNER_PLAYER;
    if (DEBUG) console.log('[INIT] OWNER_PLAYER =', OWNER_PLAYER);

    $('#owner-name').textContent = OWNER_PLAYER?.username || '玩家';

    if (OWNER_PLAYER?.id){
      PLAYER_STUDENTS = await getOwnerStudents(OWNER_PLAYER.id);
    }else{
      PLAYER_STUDENTS = [];
    }

    renderFilterOptions();
    if (DEBUG) {
      console.log('[DEBUG] selected student filter =', $('#student-filter')?.value);
      console.log('[DEBUG] ownerId =', OWNER_PLAYER?.id);
    }

    // 【管理】按鈕：持有者 = 登入者 才顯示；改由 fetch 版本的 goToBookChest()
    const manageBtn = $('#manage-btn');
    if (manageBtn){
      const isOwner = (CURRENT_PLAYER && OWNER_PLAYER && CURRENT_PLAYER.id === OWNER_PLAYER.id);
      manageBtn.style.display = isOwner ? 'inline-flex' : 'none';
      manageBtn.href = '#';
      manageBtn.addEventListener('click', goToBookChest);
    }

    await refreshBooks();

    const selEl = document.getElementById('student-filter');
    if (selEl) selEl.addEventListener('change', refreshBooks);

    const openBtn = document.querySelector('.book-btn');
    if (openBtn){
      openBtn.addEventListener('click', () => {
        const modal = document.getElementById('library-modal');
        if (modal) modal.style.display = 'flex';
      });
    }

    const libModal = document.getElementById('library-modal');
    if (libModal){
      libModal.addEventListener('click', (e) => {
        if (e.target === libModal) libModal.style.display = 'none';
      });
    }

    if (OWNER_PLAYER?.id) setupRealtime(OWNER_PLAYER.id);

  }catch(err){
    console.error('[Init Error]', err);
    renderBookList([]);
  }
}

window.addEventListener('load', init);

/* 禁止拖曳 <img>（不影響點擊） */
document.addEventListener('dragstart', e => {
  if (e.target && e.target.tagName === 'IMG') e.preventDefault();
});
</script>

</body>
</html>
