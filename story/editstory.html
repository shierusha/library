<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>è¬çˆ¾å¤ï½œé›»å­æ›¸ç·¨è¼¯å™¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- å­—é«” -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- Supabase JSï¼ˆå¯é¸ï¼›æœªè¨­å®šä¹Ÿä¸æœƒå£ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* ===== ä½ˆæ™¯èˆ‡æŒ‰éˆ• ===== */
    :root{
      --panel:#0f1830; --line:#2a3555; --ink:#e6ebff; --muted:#98a3c7;
      --primary:#6f82ff; --radius:16px; --shadow:0 10px 30px rgba(16,24,40,.25);
      /* ğŸ‘‡ mmâ†’px æ›ç®—åŠ ä¸Š px å–®ä½ï¼Œç™½ç´™æ‰æœƒå‡ºç¾ï¼ */
      --mm: 3.7795275591px;
      --paper-w-mm:148; --paper-h-mm:210; /* A5ç›´å¼ */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink);
      font-family:'Noto Sans TC',system-ui,-apple-system,Segoe UI,sans-serif;
      background:
        linear-gradient(180deg, rgba(11,18,36,.25), rgba(16,25,54,.55)),
        url('https://shierusha.github.io/school-battle/teachers/img/8.webp') center top / cover no-repeat fixed;
    }
    .appbar{
      position:sticky; top:0; z-index:10;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:10px 14px; background:rgba(15,27,51,.7);
      backdrop-filter:saturate(1.1) blur(6px);
      border-bottom:1px solid rgba(34,48,87,.7);
    }
    .brand{display:flex;gap:.6rem;align-items:center;font-weight:700}
    .brand .dot{width:10px;height:10px;border-radius:999px;background:linear-gradient(135deg,#5aa7ff,#6ee7b7)}
    .tools{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .tools .sp{width:12px}
    .muted{color:var(--muted)}
    .btn{border:1px solid #3a4a78;background:#16244a;color:#fff;padding:.5rem .9rem;border-radius:12px;cursor:pointer}
    .btn.primary{background:var(--primary);border-color:var(--primary)}
    .btn.ghost{background:#ffffff18;border-color:#ffffff33}
    .btn.danger{background:#2a0f18;border-color:#6b1b2e;color:#ffb3c2}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    /* å´æ¬„å·¥å…·åˆ— */
    .side{position:fixed;top:90px;display:flex;flex-direction:column;gap:8px;z-index:5}
    .side.left{left:10px}
    .side.right{right:10px}

    /* èˆå°èˆ‡ç´™å¼µ */
    .stage{
      display:grid;place-items:center;padding:14px;min-height:calc(100vh - 180px);
      perspective: 1400px; /* ç¿»é é€è¦– */
    }
    .scaler{transform-origin:top center}
    .paper{
      position:relative;background:#fff;box-shadow:0 8px 30px rgba(0,0,0,.25);
      overflow:hidden;border-radius:10px;
      width:calc(var(--paper-w-mm)*var(--mm)); height:calc(var(--paper-h-mm)*var(--mm));
      transform-style: preserve-3d; /* ç¿»é éœ€è¦ */
    }
    .papers{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .page{position:absolute;inset:0;padding:22mm 18mm 20mm;display:flex;flex-direction:column; backface-visibility:hidden}
    .tpl-paper{color:#111827}
    .tpl-paper .page-body{white-space:pre-wrap;line-height:1.8;font-size:1.02rem;margin-top:6mm;flex:1}
    .tpl-paper .page-foot{position:absolute;bottom:10mm;left:18mm;right:18mm;text-align:center;color:#9aa3b2}
    .vertical .page-body{writing-mode:vertical-rl;text-orientation:upright;line-height:1.9}

    /* åˆ†éš”é èˆ‡åœ–ç‰‡é  */
    .tpl-divider-dark{background:#222;color:#fff}
    .tpl-divider-light{background:#fff;color:#111827}
    .tpl-illustration{padding:0}
    .tpl-illustration .fill{position:absolute;inset:0;display:grid;place-items:center}
    .tpl-illustration img{width:100%;height:100%;object-fit:cover;display:block}

    /* æ©«å‘ç´™ï¼ˆé•·é‚Šç¿»ï¼‰ */
    .landscape .paper{ width:calc(var(--paper-h-mm)*var(--mm)); height:calc(var(--paper-w-mm)*var(--mm)); }
    .landscape .tpl-illustration img{ transform:rotate(90deg); object-fit:contain; width:auto; height:100%; }

    /* ç« ç¯€è§’æ¨™ */
    .chapter-chip{position:absolute;top:10mm;right:18mm;font-size:.85rem;color:#6b7280}

    /* ä¸‹æ–¹ Dock */
    .dock{display:flex;gap:10px;justify-content:center;align-items:center;padding:10px}

    /* contenteditable placeholder */
    .ph:empty::before{content:attr(data-ph); color:#95a0c2}

    /* ===== ç¿»é å‹•ç•«ï¼ˆå–®é æ¨¡å¼ï¼‰ ===== */
    .turn-sheet{
      position:absolute; inset:0; border-radius:10px; overflow:hidden; pointer-events:none;
      box-shadow:0 8px 30px rgba(0,0,0,.25); background:#fff;
      transform-origin: right center; /* é è¨­å³ç¿» */
      backface-visibility:hidden;
    }
    .turn-from-left{ transform-origin: left center; }
    @keyframes turnLeft { 0%{ transform:rotateY(0deg)} 100%{ transform:rotateY(-100deg)} }
    @keyframes turnRight{ 0%{ transform:rotateY(0deg)} 100%{ transform:rotateY(100deg)} }

    /* é›™é éå ´ï¼ˆè¼•é‡æ»‘å‹•ï¼‰ */
    .double-slide-next{ animation: slideNext .28s ease both }
    .double-slide-prev{ animation: slidePrev .28s ease both }
    @keyframes slideNext{ from{opacity:.7; transform:translateX(20px)} to{opacity:1; transform:none} }
    @keyframes slidePrev{ from{opacity:.7; transform:translateX(-20px)} to{opacity:1; transform:none} }

    /* è‡¨æ™‚å¯è¦‹åº¦ä¿éšªï¼šç¢ºèªç™½ç´™å‡ºç¾å¾Œå¯åˆª */
    /* .paper{ outline:1px solid #dde3f0 } */
  </style>
</head>
<body>
  <!-- é ‚ç«¯å°è¦½ -->
  <div class="appbar">
    <div class="brand"><span class="dot"></span><span id="bookTitle">æœªå‘½åæ›¸ç±</span></div>
    <div class="tools">
      <span class="muted">é é¢æ•¸ï¼š</span><b id="lblCount">1</b>
      <button class="btn" id="btnInsertPage">æ’å…¥é é¢</button>
      <button class="btn danger" id="btnDeleteBlank">åˆªé™¤ç©ºç™½é </button>
      <span class="sp"></span>
      <button class="btn ghost" id="btnPrev">ä¸Šä¸€é </button>
      <button class="btn ghost" id="btnNext">ä¸‹ä¸€é </button>
      <button class="btn primary" id="btnSave">å„²å­˜</button>
      <button class="btn" id="btnBack">å›æ›¸å–®</button>
    </div>
  </div>

  <!-- å·¦å´å·¥å…·åˆ— -->
  <div class="side left">
    <button class="btn ghost" id="btnTOC">ç›®éŒ„</button>
    <button class="btn ghost" id="btnFontUp">å­—ç´šï¼‹</button>
    <button class="btn ghost" id="btnFontDown">å­—ç´šï¼</button>
    <button class="btn ghost" id="btnBold">ç²—é«”</button>
    <button class="btn ghost" id="btnItalic">æ–œé«”</button>
    <button class="btn ghost" id="btnUnderline">åº•ç·š</button>
  </div>

  <!-- å³å´å·¥å…·åˆ— -->
  <div class="side right">
    <button class="btn ghost" id="btnToggleDir">åˆ‡æ›æ©«/ç›´å¼</button>
    <button class="btn ghost" id="btnToggleBind">åˆ‡æ›é•·çŸ­é‚Š</button>
    <button class="btn ghost" id="btnToggleView" title="æ‰‹æ©Ÿåƒ…å–®é ">åˆ‡æ›å–®é /é›™é </button>
  </div>

  <!-- ä¸­å¤®èˆå° -->
  <div class="stage">
    <div class="scaler" id="edScaler">
      <div class="paper" id="edSingle"></div>
      <div class="papers" id="edDouble" style="display:none">
        <div class="paper" id="edLeft"></div>
        <div class="paper" id="edRight"></div>
      </div>
    </div>
  </div>

  <!-- ä¸‹æ–¹ Dock -->
  <div class="dock">
    <button class="btn" id="btnInsertChapter" style="margin:0 auto;min-width:128px">æ’å…¥ç« ç¯€</button>
  </div>
  <div class="dock">
    <button class="btn" data-style="novel">æ–‡æœ¬é é¢</button>
    <button class="btn" data-style="divider-light">ç™½è‰²ä¸­é–“é </button>
    <button class="btn" data-style="divider-dark">é»‘è‰²ä¸­é–“é </button>
    <button class="btn" data-style="illustration">åœ–ç‰‡é </button>
  </div>

  <!-- ç›®éŒ„å°è¦½ -->
  <dialog id="tocDialog">
    <form method="dialog" style="padding:14px 16px">
      <h3 style="margin:.2rem 0 1rem">ç›®éŒ„</h3>
      <div id="tocList" style="max-height:60vh;overflow:auto;border:1px solid #2a3555;border-radius:12px"></div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button>é—œé–‰</button>
      </div>
    </form>
  </dialog>

  <script>
    /* ============ Editorï¼ˆå–®æª”ï¼šLocalStorageï¼›å¯é¸é€£ Supabaseï¼‰============ */
    (() => {
      // ======ï¼ˆå¯é¸ï¼‰ä½ çš„ Supabase å°ˆæ¡ˆï¼›æ²’è¨­ä¹Ÿèƒ½ç”¨ ======
      const SUPABASE_URL = window.SUPABASE_URL || '';
      const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || '';
      const supabase = (window.supabase && SUPABASE_URL && SUPABASE_ANON_KEY)
        ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        : null;

      // --------- LocalStorage ç‹€æ…‹ ---------
      const LocalStore = {
        KEY_PREFIX: 'xer_book_',
        get(id){ try{ return JSON.parse(localStorage.getItem(this.KEY_PREFIX+id))||null }catch{ return null } },
        set(book){ localStorage.setItem(this.KEY_PREFIX+book.id, JSON.stringify(book)); }
      };
      const Store = LocalStore;

      // è®€ URLï¼š?book_id=xxx&title=...
      const qp = new URLSearchParams(location.search);
      const bookId = qp.get('book_id') || ('local_'+Math.random().toString(36).slice(2,9));
      const titleFromUrl = qp.get('title');

      // --------- åˆå§‹åŒ–æ›¸æœ¬ ---------
      let book = Store.get(bookId) || {
        id: bookId, title: titleFromUrl || 'æœªå‘½åæ›¸ç±',
        direction: 'ltr', binding: 'short', viewMode: 'single',
        pages: [], fontScale: 1, db_id: null
      };
      if (!Array.isArray(book.pages)) book.pages = [];
      if (book.pages.length === 0) book.pages.push(newPage(1));

      // --------- ç‹€æ…‹èˆ‡ DOM ---------
      let cur = 0;
      const forceSingle = isMobile();
      let viewMode = forceSingle ? 'single' : (book.viewMode || 'single');
      const TOC_PER_PAGE = 20;

      const $ = (s,r=document)=>r.querySelector(s);
      const esc = s=>(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

      // é¡¯ç¤ºæ›¸å
      $('#bookTitle').textContent = book.title;
      if (forceSingle) $('#btnToggleView').disabled = true;

      // ç¶å®šæŒ‰éˆ•
      $('#btnInsertPage').onclick = insertPageAfter;
      $('#btnDeleteBlank').onclick = deleteBlank;
      $('#btnPrev').onclick = ()=>goto(cur-1,true);
      $('#btnNext').onclick = ()=>goto(cur+1,true);
      $('#btnSave').onclick = saveToDatabase;
      $('#btnBack').onclick = saveAndBack;
      $('#btnInsertChapter').onclick = insertChapter;

      $('#btnBold').onclick = ()=>document.execCommand('bold',false,null);
      $('#btnItalic').onclick = ()=>document.execCommand('italic',false,null);
      $('#btnUnderline').onclick = ()=>document.execCommand('underline',false,null);
      $('#btnFontUp').onclick = ()=>wrapFont(1.15);
      $('#btnFontDown').onclick = ()=>wrapFont(0.87);

      $('#btnToggleDir').onclick = ()=>{ book.direction = (book.direction==='rtl'?'ltr':'rtl'); render(); };
      $('#btnToggleBind').onclick = ()=>{ book.binding = (book.binding==='long'?'short':'long'); render(); };
      $('#btnToggleView').onclick = ()=>{ if(forceSingle) return; viewMode = (viewMode==='single'?'double':'single'); book.viewMode=viewMode; render(); };

      document.querySelectorAll('[data-style]').forEach(b=>{
        b.addEventListener('click',()=>{ setType(book.pages[cur], b.dataset.style); render(); });
      });

      document.addEventListener('keydown',(e)=>{
        if(e.key==='ArrowLeft') $('#btnPrev').click();
        if(e.key==='ArrowRight') $('#btnNext').click();
      });

      $('#btnTOC').onclick = ()=>{ buildTOC(); $('#tocDialog').showModal(); };

      render(); fit(); window.addEventListener('resize', fit);

      /* ---------- æ¸²æŸ“ ---------- */
      function render(){
        $('#lblCount').textContent = book.pages.length;

        const scaler = $('#edScaler');
        scaler.classList.toggle('vertical', book.direction==='rtl');
        scaler.classList.toggle('landscape', book.binding==='long');

        const single = $('#edSingle'), dbl = $('#edDouble');
        const mode = forceSingle ? 'single' : viewMode;
        single.style.display = (mode==='single')?'block':'none';
        dbl.style.display = (mode==='double')?'grid':'none';

        single.innerHTML=''; $('#edLeft').innerHTML=''; $('#edRight').innerHTML='';
        cur = clamp(cur, 0, book.pages.length-1);

        if(mode==='single'){
          single.appendChild(renderPage(book.pages[cur], cur));
        }else{
          let L,R, total=book.pages.length, one=cur+1;
          if(book.direction==='rtl'){
            if(one%2===1){ L=cur; R=Math.min(total-1,cur+1); }
            else { R=cur; L=Math.max(0,cur-1); }
          }else{
            if(one%2===1){ R=cur; L=Math.max(0,cur-1); }
            else { L=cur; R=Math.min(total-1,cur+1); }
          }
          $('#edLeft').appendChild(renderPage(book.pages[L],L));
          $('#edRight').appendChild(renderPage(book.pages[R],R));
        }
        buildTOC();
        fit();
      }

      function renderPage(p, idx){
        const el = document.createElement('div');
        el.className = 'page tpl-paper';

        // ç« ç¯€è§’æ¨™ï¼ˆå°±è¿‘å‘ä¸Šæ‰¾ï¼‰
        const ch = nearChapter(idx);
        if (ch){
          const chip = document.createElement('div');
          chip.className='chapter-chip';
          chip.textContent = ch;
          if (isLeft(idx)) chip.style.left='18mm', chip.style.right='auto';
          el.appendChild(chip);
        }

        const pageNo = displayPage(idx);

        if (p.type==='illustration'){
          el.classList.add('tpl-illustration');
          el.innerHTML = `
            <div class="fill">${ p.image_url ? `<img src="${esc(p.image_url)}" alt="illustration">`
                                              : `<div class="muted">ï¼ˆé›™æ“Šè²¼ä¸Šåœ–ç‰‡ç¶²å€ï¼‰</div>`}</div>
            <div class="page-foot">${pageNo}</div>`;
          el.ondblclick = ()=>{
            const url = prompt('åœ–ç‰‡ç¶²å€ï¼š', p.image_url||'')?.trim()||'';
            p.image_url = url || null;
            saveShadow(); render();
          };
          return el;
        }

        if (p.type==='divider-light' || p.type==='divider-dark'){
          el.classList.add(p.type==='divider-dark' ? 'tpl-divider-dark' : 'tpl-divider-light');
          el.innerHTML = `
            <div class="page-body" style="display:grid;place-items:center;text-align:center;min-height:100%">
              <div class="chapter-block" ${ensureChapterField(p)?'contenteditable':''} data-ph="ç« ç¯€åç¨±â€¦"></div>
              <div class="body-text ph" contenteditable data-ph="ç½®ä¸­æ–‡å­—â€¦"></div>
            </div>
            <div class="page-foot">${pageNo}</div>`;
          el.querySelector('.page-body').style.fontSize = `calc(1.02rem * ${book.fontScale || 1})`;
          bindEditable(el,p,idx,true);
          return el;
        }

        // æ–‡æœ¬é 
        el.innerHTML = `
          <div class="page-body">
            ${ hasOwnChapter(p) ? `<div class="chapter-block ph" contenteditable data-ph="ç« ç¯€åç¨±â€¦"></div>` : ``}
            <div class="body-text ph" contenteditable data-ph="æ­£æ–‡â€¦"></div>
          </div>
          <div class="page-foot">${pageNo}</div>`;
        el.querySelector('.page-body').style.fontSize = `calc(1.02rem * ${book.fontScale || 1})`;
        bindEditable(el,p,idx,false);
        return el;
      }

      function bindEditable(host,p,idx,center){
        const body = host.querySelector('.body-text');
        const chEl = host.querySelector('.chapter-block');
        body.textContent = (p.content_json?.text||'');
        if(chEl) chEl.textContent = (p.content_json?.chapter||'');

        if (chEl){
          chEl.addEventListener('input', ()=>{
            p.content_json.chapter = chEl.textContent.trim();
            saveShadow(); render(); // ç« ç¯€è®Šæ›´è¦ç«‹åˆ»åˆ·æ–° chip/ç›®éŒ„
          });
        }

        let tmr=null;
        body.addEventListener('input', ()=>{
          p.content_json.text = body.textContent||'';
          saveShadow();
          if(center) return;
          clearTimeout(tmr); tmr=setTimeout(()=>flowFrom(idx), 40);
        });

        // ç›´æ’
        const pb = host.querySelector('.page-body');
        pb.style.writingMode = (book.direction==='rtl'?'vertical-rl':'initial');
        pb.style.textOrientation = (book.direction==='rtl'?'upright':'initial');
      }

      /* ---------- æ–‡å­—æº¢ä½è‡ªå‹•çºŒé  ---------- */
      function flowFrom(start){
        let i=start;
        while(i<book.pages.length){
          const body = currentBody(i);
          if(!body) break;
          if(body.scrollHeight <= body.clientHeight) break;

          // skip åœ–ç‰‡é 
          let j=i+1;
          while(j<book.pages.length && book.pages[j].type==='illustration') j++;
          if(j>=book.pages.length){ book.pages.push(newPage(book.pages.length+1)); j=book.pages.length-1; }

          // äºŒåˆ†æ‰¾ fit
          const full = book.pages[i].content_json.text || '';
          let lo=0, hi=full.length, fit=full.length;
          while(lo<=hi){
            const mid=(lo+hi>>1);
            body.textContent = full.slice(0,mid);
            if(body.scrollHeight<=body.clientHeight){ fit=mid; lo=mid+1; } else hi=mid-1;
          }
          const remain = full.slice(fit).trimStart();
          book.pages[i].content_json.text = full.slice(0,fit);
          const before = book.pages[j].content_json.text||'';
          book.pages[j].content_json.text = remain + (before?('\n'+before):'');
          saveShadow();

          i=j; render(); // é‡æ–°é‡æ¸¬
        }
      }
      function currentBody(idx){
        const mode = forceSingle ? 'single' : viewMode;
        const root = (mode==='single') ? $('#edSingle') : (isLeft(idx)?$('#edLeft'):$('#edRight'));
        return root.querySelector('.body-text');
      }

      /* ---------- ç›®éŒ„ / é ç¢¼ ---------- */
      function hasOwnChapter(p){ return p.content_json && typeof p.content_json.chapter==='string'; }
      function ensureChapterField(p){ if(!p.content_json) p.content_json={}; if(p.content_json.chapter==null) p.content_json.chapter=''; return true; }
      function nearChapter(idx){
        for(let i=idx;i>=0;i--){ const t=(book.pages[i].content_json?.chapter||'').trim(); if(t) return t; }
        return '';
      }
      function tocOffset(nChapters){
        let n = Math.ceil(nChapters / TOC_PER_PAGE);
        if(n%2===1) n+=1; // ä¸€å¾‹å¶æ•¸
        return n;
      }
      function displayPage(idx){
        const count = book.pages.filter(p=>(p.content_json?.chapter||'').trim()).length;
        return tocOffset(count) + (idx+1);
      }
      function buildTOC(){
        const list = book.pages.map((p,i)=>({i, ch:(p.content_json?.chapter||'').trim()})).filter(x=>x.ch);
        const box = $('#tocList');
        if(!list.length){ box.innerHTML='<div class="muted" style="padding:12px">å°šç„¡ç« ç¯€</div>'; return; }
        const off = tocOffset(list.length);
        box.innerHTML = list.map(x=>`
          <div style="display:flex;justify-content:space-between;padding:10px 12px;border-bottom:1px dashed #2a3555;cursor:pointer">
            <div>P${off + (x.i+1)}</div><div>${esc(x.ch)}</div>
          </div>`).join('');
        box.querySelectorAll('div[style*="cursor"]').forEach((row,k)=>{
          row.onclick = ()=>{ cur = list[k].i; $('#tocDialog').close(); render(); };
        });
      }

      /* ---------- æ“ä½œ & ç¿»é  ---------- */
      function goto(n, animate=true){
        n = clamp(n, 0, Math.max(0, book.pages.length-1));
        if(n===cur) return;

        const dir = (n>cur) ? 'next' : 'prev';
        const wasCur = cur;
        const singleMode = forceSingle || viewMode==='single';

        if (singleMode && animate){
          // æŠ“èˆŠé  HTMLï¼ˆç¿»æ‰å®ƒï¼‰ï¼Œå…ˆ render æ–°é ï¼Œå†æŠŠèˆŠé è“‹ä¸Šåšç¿»é å‹•ç•«
          const host = $('#edSingle');
          const oldHTML = host.innerHTML; // ç¾åœ¨ç•«é¢
          cur = n; render();              // å…ˆæŠŠæ–°é æ”¾åº•å±¤
          makeTurnAnimation(host, oldHTML, dir);
        }else if (!singleMode && animate){
          cur = n; render();
          const dbl = $('#edDouble');
          dbl.classList.remove('double-slide-next','double-slide-prev');
          void dbl.offsetWidth; // reflow
          dbl.classList.add(dir==='next'?'double-slide-next':'double-slide-prev');
        }else{
          cur = n; render();
        }
      }

      function makeTurnAnimation(host, oldHTML, dir){
        const sheet = document.createElement('div');
        sheet.className = 'turn-sheet';
        if(dir==='prev') sheet.classList.add('turn-from-left');

        // ç”¨èˆŠé å…§å®¹è“‹ä¸Šå»ç¿»æ‰
        const wrap = document.createElement('div');
        wrap.className='page tpl-paper';
        wrap.innerHTML = oldHTML;
        // ç§»é™¤ wrap è£¡å¤šé¤˜å¤–å±¤ï¼ˆoldHTML æ˜¯ .pageï¼‰çš„å°å·®ç•°å®‰å…¨è™•ç†
        sheet.appendChild(wrap);

        host.appendChild(sheet);
        // è®“å‹•ç•«åƒåˆ°åˆå§‹ç‹€æ…‹
        void sheet.offsetWidth;

        sheet.style.animation = (dir==='next') ? 'turnLeft .35s ease both' : 'turnRight .35s ease both';
        sheet.addEventListener('animationend', ()=> sheet.remove(), {once:true});
      }

      function insertPageAfter(){
        const at = cur+1;
        book.pages.splice(at,0,newPage(at+1));
        renumber(); cur = at; render();
      }
      function deleteBlank(){
        const p = book.pages[cur];
        const hasText=(p.content_json?.text||'').trim().length>0;
        const hasCh=(p.content_json?.chapter||'').trim().length>0;
        const hasImg=!!p.image_url;
        if(hasText||hasCh||hasImg) return alert(`ç¬¬ ${displayPage(cur)} é æœ‰å…§å®¹ï¼Œç„¡æ³•åˆªé™¤`);
        if(book.pages.length<=1)   return alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€é ');
        book.pages.splice(cur,1); renumber(); cur=Math.max(0,cur-1); render();
      }
      function insertChapter(){
        const p = book.pages[cur];
        ensureChapterField(p);
        render();
        const root = (forceSingle||viewMode==='single') ? $('#edSingle') : (isLeft(cur)?$('#edLeft'):$('#edRight'));
        root.querySelector('.chapter-block')?.focus();
      }
      function setType(p,type){ p.type=type; saveShadow(); render(); }

      function renumber(){ for(let i=0;i<book.pages.length;i++) book.pages[i].page_index=i+1; }
      function newPage(idx){ return { id:'local_'+Math.random().toString(36).slice(2,9), page_index:idx, type:'novel', content_json:{text:'',chapter:''}, image_url:null }; }
      function isLeft(idx){
        if(forceSingle || viewMode==='single') return false;
        const one=idx+1;
        if(book.direction==='rtl') return (one%2===1);
        return (one%2===0);
      }

      /* ---------- å­—ç´šèª¿æ•´ ---------- */
      function wrapFont(mult){
        const MIN = 0.7, MAX = 1.8;
        const curS = book.fontScale || 1;
        let next = curS * mult;
        if (!isFinite(next) || next <= 0) next = 1;
        next = Math.max(MIN, Math.min(MAX, next));
        book.fontScale = next;
        saveShadow();
        render();
      }

      /* ---------- å„²å­˜ï¼ˆLocalStorage + å¯é¸ DBï¼‰ ---------- */
      function saveAll(){
        const filtered = book.pages.filter(p=> !(p.type==='illustration' && !p.image_url));
        if(filtered.length!==book.pages.length){ book.pages=filtered; renumber(); cur=clamp(cur,0,book.pages.length-1); }
        Store.set(book);
      }
      function saveShadow(){ Store.set(book); }

      async function saveToDatabase(){
        saveAll();
        if (!supabase){
          alert('æœªè¨­å®š Supabase æˆ– SDK æœªè¼‰å…¥ï¼Œå·²å…ˆå­˜åˆ° LocalStorageã€‚');
          return;
        }

        const { data:auth } = await supabase.auth.getUser();
        const user = auth?.user;
        if (!user){
          alert('è«‹å…ˆç™»å…¥ Supabase æ‰èƒ½å„²å­˜åˆ°è³‡æ–™åº«ï¼ˆå·²å­˜ LocalStorageï¼‰ã€‚');
          return;
        }

        const bookPayload = {
          title: book.title || 'æœªå‘½åæ›¸ç±',
          binding: book.binding || 'short',
          direction: book.direction || 'ltr',
          page_count: book.pages.length,
          owner_id: user.id
        };

        try{
          lockUI(true, 'å„²å­˜ä¸­â€¦');

          if (!book.db_id){
            const { data: created, error: errCreate } = await supabase
              .from('books').insert(bookPayload).select().single();
            if (errCreate) throw errCreate;
            book.db_id = created.id;
          }else{
            const { error: errUpd } = await supabase
              .from('books').update(bookPayload).eq('id', book.db_id);
            if (errUpd) throw errUpd;
          }

          const bid = book.db_id;

          await supabase.from('chapters').delete().eq('book_id', bid);
          await supabase.from('pages').delete().eq('book_id', bid);

          const pageRows = book.pages.map((p,i)=>({
            book_id: bid,
            page_index: i+1,
            type: p.type || 'novel',
            content_json: p.content_json || {},
            image_url: p.image_url || null
          }));
          const { data: insertedPages, error: errPages } = await supabase
            .from('pages').insert(pageRows).select();
          if (errPages) throw errPages;

          const chapters = [];
          insertedPages.forEach((row, i)=>{
            const title = (book.pages[i].content_json?.chapter || '').trim();
            if (title) chapters.push({ book_id: bid, page_id: row.id, title });
          });
          if (chapters.length){
            const { error: errCh } = await supabase.from('chapters').insert(chapters);
            if (errCh) throw errCh;
          }

          Store.set(book);
          alert('å·²å„²å­˜åˆ°è³‡æ–™åº« âœ…');
        }catch(e){
          console.error(e);
          alert('å„²å­˜åˆ°è³‡æ–™åº«å¤±æ•—ï¼š' + (e?.message || e));
        }finally{
          lockUI(false);
        }
      }

      async function saveAndBack(){
        try{ await saveToDatabase(); }catch(_){}
        if(history.length>1) history.back();
        else location.href = '/books'; // TODO: æ›¿æ›æˆä½ çš„æ›¸å–®é  URL
      }

      /* ---------- ç‰ˆé¢ç¸®æ”¾ ---------- */
      function fit(){
        const scaler = $('#edScaler'); const stage = $('.stage');
        const paperWpx = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--paper-w-mm')) * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--mm'));
        const pad=40, maxW = stage.clientWidth - pad;
        let s = Math.min(1, maxW / paperWpx);
        if(!isFinite(s) || s<=0) s=1;
        scaler.style.transform = `scale(${s})`;
      }

      /* ---------- å°å·¥å…· ---------- */
      function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
      function isMobile(){ return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || Math.min(window.innerWidth, window.innerHeight) < 768; }

      function lockUI(on, msg){
        const dis = !!on;
        ['btnInsertPage','btnDeleteBlank','btnPrev','btnNext','btnSave','btnBack',
         'btnInsertChapter','btnTOC','btnFontUp','btnFontDown','btnBold','btnItalic','btnUnderline',
         'btnToggleDir','btnToggleBind','btnToggleView'
        ].forEach(id=>{
          const el = document.getElementById(id);
          if (el) el.disabled = dis;
        });
        const saveBtn = document.getElementById('btnSave');
        if (saveBtn){
          if (dis){ saveBtn.dataset._txt = saveBtn.textContent; saveBtn.textContent = msg || 'å„²å­˜ä¸­â€¦'; }
          else if (saveBtn.dataset._txt){ saveBtn.textContent = saveBtn.dataset._txt; delete saveBtn.dataset._txt; }
        }
      }
    })();
  </script>
</body>
</html>
