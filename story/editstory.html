<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>謝爾夏｜電子書編輯器（雙頁翻頁版）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --panel:#0f1830; --line:#2a3555; --ink:#e6ebff; --muted:#98a3c7;
      --primary:#6f82ff; --radius:16px; --shadow:0 10px 30px rgba(16,24,40,.25);
      --mm: 3.7795275591px;                 /* mm→px 必須有單位 */
      --paper-w-mm:148; --paper-h-mm:210;   /* A5 直式 */
      --pad: 6%;                            /* 白紙內縮 6% */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink);
      font-family:'Noto Sans TC',system-ui,-apple-system,Segoe UI,sans-serif;
      background:
        linear-gradient(180deg, rgba(11,18,36,.25), rgba(16,25,54,.55)),
        url('https://shierusha.github.io/school-battle/teachers/img/8.webp') center top / cover no-repeat fixed;
    }
    .appbar{
      position:sticky; top:0; z-index:10;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:10px 14px; background:rgba(15,27,51,.7);
      backdrop-filter:saturate(1.1) blur(6px);
      border-bottom:1px solid rgba(34,48,87,.7);
    }
    .brand{display:flex;gap:.6rem;align-items:center;font-weight:700}
    .brand .dot{width:10px;height:10px;border-radius:999px;background:linear-gradient(135deg,#5aa7ff,#6ee7b7)}
    .tools{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .tools .sp{width:12px}
    .muted{color:var(--muted)}
    .btn{border:1px solid #3a4a78;background:#16244a;color:#fff;padding:.5rem .9rem;border-radius:12px;cursor:pointer}
    .btn.primary{background:var(--primary);border-color:var(--primary)}
    .btn.ghost{background:#ffffff18;border-color:#ffffff33}
    .btn.danger{background:#2a0f18;border-color:#6b1b2e;color:#ffb3c2}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    .side{position:fixed;top:90px;display:flex;flex-direction:column;gap:8px;z-index:5}
    .side.left{left:10px}
    .side.right{right:10px}

    .stage{display:grid;place-items:center;padding:14px;min-height:calc(100vh - 180px);perspective:1400px}
    .scaler{transform-origin:top center}
    .paper{
      position:relative;background:#fff;box-shadow:0 8px 30px rgba(0,0,0,.25);
      overflow:hidden;border-radius:10px;
      width:calc(var(--paper-w-mm)*var(--mm)); height:calc(var(--paper-h-mm)*var(--mm));
      transform-style:preserve-3d;
    }
    /* 兩張紙「無縫」：gap=0，內側圓角取消 */
    .papers{display:grid;grid-template-columns:1fr 1fr;gap:0;position:relative}
    .papers .paper:first-child{border-top-right-radius:0;border-bottom-right-radius:0}
    .papers .paper:last-child{border-top-left-radius:0;border-bottom-left-radius:0}

    .page{
      position:absolute;inset:0;
      padding: var(--pad);
      display:flex;flex-direction:column;backface-visibility:hidden;color:#111827;
    }
    .page-body{white-space:pre-wrap;line-height:1.8;font-size:1.02rem;margin-top:.2rem;flex:1}

    /* 章節角標：單頁固定右上；雙頁左/右頁 → 左上/右上 */
    .chapter-chip{position:absolute;top:var(--pad);right:var(--pad);font-size:.85rem;color:#6b7280}
    .chip-left{ right:auto; left:var(--pad); }

    /* 頁碼左右角 */
    .page-foot{position:absolute;bottom:var(--pad);font-variant-numeric:tabular-nums;color:#9aa3b2}
    .foot-right{ right:var(--pad); text-align:right }
    .foot-left{  left:var(--pad);  text-align:left  }

    .vertical .page-body{writing-mode:vertical-rl;text-orientation:upright;line-height:1.9}

    /* 分隔頁與圖片頁 */
    .tpl-divider-dark{background:#555;color:#fff}
    .tpl-divider-light{background:#fff;color:#111827}
    .tpl-illustration{padding:0}
    .tpl-illustration .fill{position:absolute;inset:0;display:grid;place-items:center}
    .tpl-illustration img{width:100%;height:100%;object-fit:cover;display:block}

    /* 橫向紙（長邊裝訂） */
    .landscape .paper{ width:calc(var(--paper-h-mm)*var(--mm)); height:calc(var(--paper-w-mm)*var(--mm)); }
    .landscape .tpl-illustration img{ transform:rotate(90deg); width:100%; height:100%; object-fit:cover; }

    .dock{display:flex;gap:10px;justify-content:center;align-items:center;padding:10px}
    .ph:empty::before{content:attr(data-ph); color:#95a0c2}

    /* ====== 單頁翻頁（較輕） ====== */
    .turn-sheet{position:absolute; inset:0; border-radius:10px; overflow:hidden; pointer-events:none;
      box-shadow:0 8px 30px rgba(0,0,0,.25); background:#fff; transform-origin:right center; backface-visibility:hidden;}
    .turn-from-left{ transform-origin:left center }
    @keyframes turnLeft { 0%{ transform:rotateY(0deg)} 100%{ transform:rotateY(-100deg)} }
    @keyframes turnRight{ 0%{ transform:rotateY(0deg)} 100%{ transform:rotateY(100deg)} }

    /* ====== 雙頁「完美半張紙翻頁」 ====== */
    #edDouble{position:relative} /* 讓覆蓋層絕對定位 */
    .turn-page{
      position:absolute; top:0; transform-style:preserve-3d; pointer-events:none; /* 不擋編輯 */
      width:0; height:0; /* 以 JS 設定真實尺寸 */
    }
    .turn-right{ transform-origin:left center; }   /* 右頁往左翻 */
    .turn-left{  transform-origin:right center; }  /* 左頁往右翻 */
    .turn-page .face{ position:absolute; inset:0; backface-visibility:hidden; overflow:hidden; background:#fff }
    .turn-page .back{ transform: rotateY(180deg); }
    .fold-shadow{ position:absolute; inset:0; pointer-events:none; opacity:.0 }
    /* 翻頁動畫本體 */
    @keyframes flipRightNext { from{ transform:rotateY(0deg) } to{ transform:rotateY(-180deg) } }
    @keyframes flipLeftPrev  { from{ transform:rotateY(0deg) } to{ transform:rotateY(180deg) } }
    /* 摺線陰影（翻的那半張紙上） */
    @keyframes foldShade { 0%{opacity:.35} 50%{opacity:.12} 100%{opacity:.25} }
    /* 對頁受影響陰影（靜止那半邊） */
    .static-shadow-right::after,
    .static-shadow-left::after{
      content:""; position:absolute; top:0; bottom:0; width:16%;
      pointer-events:none; opacity:.0; transition:opacity .12s ease;
    }
    .static-shadow-right::after{ right:0; background:linear-gradient(90deg, rgba(0,0,0,.18), transparent 70%) }
    .static-shadow-left::after{ left:0;  background:linear-gradient(270deg, rgba(0,0,0,.18), transparent 70%) }
    .shadow-on::after{ opacity:1 }

  </style>
</head>
<body>
  <!-- 頂端導覽 -->
  <div class="appbar">
    <div class="brand"><span class="dot"></span><span id="bookTitle">未命名書籍</span></div>
    <div class="tools">
      <span class="muted">頁面數：</span><b id="lblCount">2</b>
      <button class="btn" id="btnInsertPage">插入頁面</button>
      <button class="btn danger" id="btnDeleteBlank">刪除空白頁</button>
      <span class="sp"></span>
      <button class="btn ghost" id="btnPrev">上一頁</button>
      <button class="btn ghost" id="btnNext">下一頁</button>
      <button class="btn primary" id="btnSave">儲存</button>
      <button class="btn" id="btnBack">回書單</button>
    </div>
  </div>

  <!-- 左側工具列 -->
  <div class="side left">
    <button class="btn ghost" id="btnTOC">目錄</button>
    <button class="btn ghost" id="btnFontUp">字級＋</button>
    <button class="btn ghost" id="btnFontDown">字級－</button>
    <button class="btn ghost" id="btnBold">粗體</button>
    <button class="btn ghost" id="btnItalic">斜體</button>
    <button class="btn ghost" id="btnUnderline">底線</button>
  </div>

  <!-- 右側工具列 -->
  <div class="side right">
    <button class="btn ghost" id="btnToggleDir">切換橫/直式</button>
    <button class="btn ghost" id="btnToggleBind">切換長短邊</button>
    <button class="btn ghost" id="btnToggleView" title="手機僅單頁">切換單頁/雙頁</button>
  </div>

  <!-- 中央舞台 -->
  <div class="stage">
    <div class="scaler" id="edScaler">
      <div class="paper" id="edSingle"></div>
      <div class="papers" id="edDouble" style="display:none">
        <div class="paper" id="edLeft"></div>
        <div class="paper" id="edRight"></div>
      </div>
    </div>
  </div>

  <!-- 下方 Dock -->
  <div class="dock">
    <button class="btn" id="btnInsertChapter" style="margin:0 auto;min-width:128px">插入章節</button>
  </div>
  <div class="dock">
    <button class="btn" data-style="novel">文本頁面</button>
    <button class="btn" data-style="divider-light">白色中間頁</button>
    <button class="btn" data-style="divider-dark">黑色中間頁</button>
    <button class="btn" data-style="illustration">圖片頁</button>
  </div>

  <!-- 目錄導覽 -->
  <dialog id="tocDialog">
    <form method="dialog" style="padding:14px 16px">
      <h3 style="margin:.2rem 0 1rem">目錄</h3>
      <div id="tocList" style="max-height:60vh;overflow:auto;border:1px solid #2a3555;border-radius:12px"></div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button>關閉</button></div>
    </form>
  </dialog>

  <script>
    (() => {
      /* 可選 Supabase；未設定也能用 */
      const SUPABASE_URL = window.SUPABASE_URL || '';
      const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || '';
      const supabase = (window.supabase && SUPABASE_URL && SUPABASE_ANON_KEY)
        ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        : null;

      /* LocalStorage 狀態 */
      const LocalStore = {
        KEY_PREFIX: 'xer_book_',
        get(id){ try{ return JSON.parse(localStorage.getItem(this.KEY_PREFIX+id))||null }catch{ return null } },
        set(book){ localStorage.setItem(this.KEY_PREFIX+book.id, JSON.stringify(book)); }
      };
      const Store = LocalStore;

      const qp = new URLSearchParams(location.search);
      const bookId = qp.get('book_id') || ('local_'+Math.random().toString(36).slice(2,9));
      const titleFromUrl = qp.get('title');

      let book = Store.get(bookId) || {
        id: bookId, title: titleFromUrl || '未命名書籍',
        direction: 'ltr', binding: 'short', viewMode: 'double', /* 預設顯示雙頁 */
        pages: [], fontScale: 1, db_id: null
      };
      if (!Array.isArray(book.pages)) book.pages = [];
      if (book.pages.length < 2) { /* 最少 2 頁 */
        while(book.pages.length<2) book.pages.push(newPage(book.pages.length+1));
      }

      let cur = 0; // 以 page index 為基準
      const forceSingle = isMobile();
      let viewMode = forceSingle ? 'single' : (book.viewMode || 'double');
      const TOC_PER_PAGE = 20;

      const $ = (s,r=document)=>r.querySelector(s);
      const esc = s=>(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

      $('#bookTitle').textContent = book.title;
      if (forceSingle) $('#btnToggleView').disabled = true;

      /* 綁定 UI */
      $('#btnInsertPage').onclick = insertPageAfter;
      $('#btnDeleteBlank').onclick = deleteBlank;
      $('#btnPrev').onclick  = ()=>goto(cur + stepDelta(-1), true);
      $('#btnNext').onclick  = ()=>goto(cur + stepDelta(+1), true);
      $('#btnSave').onclick  = saveToDatabase;
      $('#btnBack').onclick  = saveAndBack;
      $('#btnInsertChapter').onclick = insertChapter;

      $('#btnBold').onclick = ()=>document.execCommand('bold',false,null);
      $('#btnItalic').onclick = ()=>document.execCommand('italic',false,null);
      $('#btnUnderline').onclick = ()=>document.execCommand('underline',false,null);
      $('#btnFontUp').onclick = ()=>wrapFont(1.15);
      $('#btnFontDown').onclick = ()=>wrapFont(0.87);

      $('#btnToggleDir').onclick = ()=>{ book.direction = (book.direction==='rtl'?'ltr':'rtl'); render(); };
      $('#btnToggleBind').onclick = ()=>{ book.binding = (book.binding==='long'?'short':'long'); render(); };
      $('#btnToggleView').onclick = ()=>{ if(forceSingle) return; viewMode = (viewMode==='single'?'double':'single'); book.viewMode=viewMode; render(); };

      document.querySelectorAll('[data-style]').forEach(b=>{
        b.addEventListener('click',()=>{ setType(book.pages[cur], b.dataset.style); render(); });
      });

      document.addEventListener('keydown',(e)=>{
        if(e.key==='ArrowLeft') $('#btnPrev').click();
        if(e.key==='ArrowRight') $('#btnNext').click();
      });

      $('#btnTOC').onclick = ()=>{ buildTOC(); $('#tocDialog').showModal(); };

      render(); fit(); window.addEventListener('resize', fit);

      /* ======= 渲染 ======= */
      function render(){
        /* 最少 2 頁保障 */
        if (book.pages.length < 2) while(book.pages.length<2) book.pages.push(newPage(book.pages.length+1));

        $('#lblCount').textContent = book.pages.length;

        const scaler = $('#edScaler');
        scaler.classList.toggle('vertical', book.direction==='rtl');
        scaler.classList.toggle('landscape', book.binding==='long');

        const single = $('#edSingle'), dbl = $('#edDouble');
        const mode = forceSingle ? 'single' : viewMode;
        single.style.display = (mode==='single')?'block':'none';
        dbl.style.display    = (mode==='double')?'grid':'none';

        single.innerHTML=''; $('#edLeft').innerHTML=''; $('#edRight').innerHTML='';
        cur = clamp(cur, 0, book.pages.length-1);

        if(mode==='single'){
          single.appendChild(renderPage(book.pages[cur], cur, 'single'));
        }else{
          const [L,R] = getSpread(cur);
          $('#edLeft').appendChild(renderPage(book.pages[L],L,'left'));
          $('#edRight').appendChild(renderPage(book.pages[R],R,'right'));
        }
        buildTOC();
        fit();
      }

      function renderPage(p, idx, pos){
        const el = document.createElement('div');
        el.className = 'page';

        /* 章節角標（只有「插入章節」後才會出現） */
        const chName = nearChapter(idx);
        if (chName){
          const chip = document.createElement('div');
          chip.className='chapter-chip' + (pos==='left' ? ' chip-left' : '');
          chip.textContent = chName;
          el.appendChild(chip);
        }

        const pageNo = displayPage(idx);
        const foot = document.createElement('div');
        foot.className = 'page-foot ' + ((pos==='left') ? 'foot-left' : 'foot-right');
        foot.textContent = pageNo;
        el.appendChild(foot);

        if (p.type==='illustration'){
          el.classList.add('tpl-illustration');
          el.innerHTML += `
            <div class="fill">${ p.image_url ? `<img src="${esc(p.image_url)}" alt="illustration">`
                                              : `<div class="muted">（雙擊貼上圖片網址）</div>`}</div>`;
          el.ondblclick = ()=>{
            const url = prompt('圖片網址：', p.image_url||'')?.trim()||'';
            p.image_url = url || null; saveShadow(); render();
          };
          return el;
        }

        if (p.type==='divider-light' || p.type==='divider-dark'){
          el.classList.add(p.type==='divider-dark' ? 'tpl-divider-dark' : 'tpl-divider-light');
          el.innerHTML += `
            <div class="page-body" style="display:grid;place-items:center;text-align:center;min-height:100%">
              ${ hasOwnChapter(p) ? `<div class="chapter-block ph" contenteditable data-ph="章節名稱…"></div>` : ``}
              <div class="body-text ph" contenteditable data-ph="置中文字…"></div>
            </div>`;
          el.querySelector('.page-body').style.fontSize = `calc(1.02rem * ${book.fontScale || 1})`;
          bindEditable(el,p,idx,true);
          return el;
        }

        // 文本頁
        el.innerHTML += `
          <div class="page-body">
            ${ hasOwnChapter(p) ? `<div class="chapter-block ph" contenteditable data-ph="章節名稱…"></div>` : ``}
            <div class="body-text ph" contenteditable data-ph="正文…"></div>
          </div>`;
        el.querySelector('.page-body').style.fontSize = `calc(1.02rem * ${book.fontScale || 1})`;
        bindEditable(el,p,idx,false);
        return el;
      }

      function hasOwnChapter(p){
        return p.content_json && Object.prototype.hasOwnProperty.call(p.content_json,'chapter');
      }

      function bindEditable(host,p,idx,center){
        const body = host.querySelector('.body-text');
        const chEl = host.querySelector('.chapter-block');
        body && (body.textContent = (p.content_json?.text||''));
        if(chEl) chEl.textContent = (p.content_json?.chapter||'');

        if (chEl){
          chEl.addEventListener('input', ()=>{
            p.content_json.chapter = chEl.textContent.trim();
            saveShadow(); render();
          });
        }

        let tmr=null;
        body && body.addEventListener('input', ()=>{
          p.content_json.text = body.textContent||'';
          saveShadow();
          if(center) return;
          clearTimeout(tmr); tmr=setTimeout(()=>flowFrom(idx), 40);
        });

        const pb = host.querySelector('.page-body');
        if (pb){
          pb.style.writingMode = (book.direction==='rtl'?'vertical-rl':'initial');
          pb.style.textOrientation = (book.direction==='rtl'?'upright':'initial');
        }
      }

      /* ======= 文字溢位自動續頁 ======= */
      function flowFrom(start){
        let i=start;
        while(i<book.pages.length){
          const body = currentBody(i);
          if(!body) break;
          if(body.scrollHeight <= body.clientHeight) break;

          // 找下一個可寫頁（跳過圖片）
          let j=i+1;
          while(j<book.pages.length && book.pages[j].type==='illustration') j++;
          if(j>=book.pages.length){ book.pages.push(newPage(book.pages.length+1)); j=book.pages.length-1; }

          const full = book.pages[i].content_json.text || '';
          let lo=0, hi=full.length, fit=full.length;
          while(lo<=hi){
            const mid=(lo+hi>>1);
            body.textContent = full.slice(0,mid);
            if(body.scrollHeight<=body.clientHeight){ fit=mid; lo=mid+1; } else hi=mid-1;
          }
          const remain = full.slice(fit).trimStart();
          book.pages[i].content_json.text = full.slice(0,fit);
          const before = book.pages[j].content_json.text||'';
          book.pages[j].content_json.text = remain + (before?('\n'+before):'');
          saveShadow();

          i=j; render();
        }
      }
      function currentBody(idx){
        const mode = forceSingle ? 'single' : viewMode;
        const root = (mode==='single') ? $('#edSingle') : (isLeft(idx)?$('#edLeft'):$('#edRight'));
        return root.querySelector('.body-text');
      }

      /* ======= 目錄 / 頁碼 ======= */
      function nearChapter(idx){
        for(let i=idx;i>=0;i--){
          const hasKey = Object.prototype.hasOwnProperty.call(book.pages[i].content_json||{},'chapter');
          const t = hasKey ? (book.pages[i].content_json.chapter||'').trim() : '';
          if(t) return t;
        }
        return '';
      }
      function tocOffset(nChapters){
        let n = Math.ceil(nChapters / TOC_PER_PAGE);
        if(n%2===1) n+=1; // 目錄永遠偶數
        return n;
      }
      function displayPage(idx){
        const count = book.pages.filter(p=>{
          const hasKey = Object.prototype.hasOwnProperty.call(p.content_json||{},'chapter');
          return hasKey && (p.content_json.chapter||'').trim();
        }).length;
        return tocOffset(count) + (idx+1);
      }
      function buildTOC(){
        const list = book.pages
          .map((p,i)=>{
            const hasKey = Object.prototype.hasOwnProperty.call(p.content_json||{},'chapter');
            return {i, ch: hasKey ? (p.content_json.chapter||'').trim() : ''};
          })
          .filter(x=>x.ch);
        const box = $('#tocList');
        if(!list.length){ box.innerHTML='<div class="muted" style="padding:12px">尚無章節</div>'; return; }
        const off = tocOffset(list.length);
        box.innerHTML = list.map(x=>`
          <div style="display:flex;justify-content:space-between;padding:10px 12px;border-bottom:1px dashed #2a3555;cursor:pointer">
            <div>P${off + (x.i+1)}</div><div>${esc(x.ch)}</div>
          </div>`).join('');
        box.querySelectorAll('div[style*="cursor"]').forEach((row,k)=>{
          row.onclick = ()=>{ cur = list[k].i; $('#tocDialog').close(); render(); };
        });
      }

      /* ======= 翻頁控制 ======= */
      function stepDelta(sign){
        const mode = forceSingle ? 'single' : viewMode;
        return sign * (mode==='double' ? 2 : 1);
      }
      function getSpread(idx){
        // 回傳當前應該顯示的 [左,右] 頁 index
        let L,R, total=book.pages.length, one=idx+1;
        if(book.direction==='rtl'){ // 直式：奇數在左
          if(one%2===1){ L=idx; R=Math.min(total-1,idx+1); }
          else { R=idx; L=Math.max(0,idx-1); }
        }else{ // 橫式：奇數在右
          if(one%2===1){ R=idx; L=Math.max(0,idx-1); }
          else { L=idx; R=Math.min(total-1,idx+1); }
        }
        return [L,R];
      }

      function goto(n, animate=true){
        const mode = forceSingle ? 'single' : viewMode;
        n = clamp(n, 0, Math.max(0, book.pages.length-1));
        if(n===cur) return;

        const dir = (n>cur) ? 'next' : 'prev';

        if (mode==='double' && animate){
          flipDouble(dir, n);
          return;
        }

        // 單頁：保留原本簡單翻頁
        if (mode==='single' && animate){
          const host = $('#edSingle');
          const oldHTML = host.innerHTML;
          cur = n; render();
          makeTurnAnimationSingle(host, oldHTML, dir);
        }else{
          cur = n; render();
        }
      }

      function makeTurnAnimationSingle(host, oldHTML, dir){
        const sheet = document.createElement('div');
        sheet.className = 'turn-sheet' + (dir==='prev' ? ' turn-from-left':'');

        const wrap = document.createElement('div');
        wrap.className='page';
        wrap.innerHTML = oldHTML;
        sheet.appendChild(wrap);

        host.appendChild(sheet);
        void sheet.offsetWidth;
        sheet.style.animation = (dir==='next') ? 'turnLeft .35s ease both' : 'turnRight .35s ease both';
        sheet.addEventListener('animationend', ()=> sheet.remove(), {once:true});
      }

      function flipDouble(dir, targetIdx){
        // 準備資料
        const [L,R] = getSpread(cur);
        const isRTL = (book.direction==='rtl');
        // 決定翻哪一邊
        let side, frontIdx, backIdx, nextCur;
        if (!isRTL){
          if (dir==='next'){ side='right'; frontIdx=R; backIdx=R+1; nextCur=cur+2; }
          else { side='left'; frontIdx=L; backIdx=L-1; nextCur=cur-2; }
        }else{
          if (dir==='next'){ side='left'; frontIdx=L; backIdx=L+1; nextCur=cur+2; }
          else { side='right'; frontIdx=R; backIdx=R-1; nextCur=cur-2; }
        }

        // 邊界：next 需要確保 backIdx 存在；prev 不小於 0
        if (dir==='next'){
          while (backIdx >= book.pages.length){ book.pages.push(newPage(book.pages.length+1)); }
        }else{
          if (backIdx < 0){ return; } // 最前面了，不能再往前
        }

        // 先渲染當前 spread（靜態），再覆蓋翻頁
        render();

        // 取得尺寸與定位
        const dbl = $('#edDouble');
        const pageW = $('#edLeft').getBoundingClientRect().width;  // 以實際縮放後尺寸為準
        const pageH = $('#edLeft').getBoundingClientRect().height;
        const dblRect = dbl.getBoundingClientRect();

        // 建立翻頁覆蓋層
        const turn = document.createElement('div');
        turn.className = 'turn-page ' + (side==='right'?'turn-right':'turn-left');
        turn.style.width  = pageW + 'px';
        turn.style.height = pageH + 'px';
        turn.style.left   = (side==='right' ? pageW : 0) + 'px'; // 右頁在右半
        turn.style.top    = '0px';

        // 前面 = 當前那頁；背面 = 下一（或前一）頁
        const faceFront = document.createElement('div');
        faceFront.className = 'face front';
        faceFront.appendChild(renderPage(book.pages[frontIdx], frontIdx, side==='right'?'right':'left'));

        const faceBack = document.createElement('div');
        faceBack.className = 'face back';
        // 背面要用翻過去後的位置（右翻→背面在左；左翻→背面在右）
        faceBack.appendChild(renderPage(book.pages[backIdx], backIdx, side==='right'?'left':'right'));

        // 摺線陰影
        const shade = document.createElement('div');
        shade.className = 'fold-shadow';
        shade.style.background = side==='right'
          ? 'linear-gradient(90deg, rgba(0,0,0,.25), rgba(0,0,0,0) 35%, rgba(0,0,0,0) 65%, rgba(0,0,0,.15))'
          : 'linear-gradient(270deg, rgba(0,0,0,.25), rgba(0,0,0,0) 35%, rgba(0,0,0,0) 65%, rgba(0,0,0,.15))';

        turn.appendChild(faceFront);
        turn.appendChild(faceBack);
        turn.appendChild(shade);

        // 對頁加陰影（更像真的翻紙）
        const leftPaper  = $('#edLeft');
        const rightPaper = $('#edRight');
        if (side==='right'){ leftPaper.classList.add('static-shadow-left','shadow-on'); }
        else { rightPaper.classList.add('static-shadow-right','shadow-on'); }

        dbl.appendChild(turn);
        lockUI(true);

        // 啟動動畫
        void turn.offsetWidth; // reflow
        shade.style.animation = 'foldShade .42s ease both';
        turn.style.animation  = (side==='right') ? 'flipRightNext .42s ease both' : 'flipLeftPrev .42s ease both';

        turn.addEventListener('animationend', ()=>{
          // 換到下一個 spread
          cur = clamp(nextCur, 0, book.pages.length-1);
          render();
          // 清理
          turn.remove();
          leftPaper.classList.remove('static-shadow-left','shadow-on');
          rightPaper.classList.remove('static-shadow-right','shadow-on');
          lockUI(false);
        }, {once:true});
      }

      /* ======= 基本操作 ======= */
      function insertPageAfter(){
        const at = cur + 1;
        book.pages.splice(at,0,newPage(at+1));
        renumber(); cur = at; render();
      }
      function deleteBlank(){
        const p = book.pages[cur];
        const hasText=(p.content_json?.text||'').trim().length>0;
        const hasCh = Object.prototype.hasOwnProperty.call(p.content_json||{},'chapter')
                      && (p.content_json.chapter||'').trim().length>0;
        const hasImg=!!p.image_url;
        if(hasText||hasCh||hasImg) return alert(`第 ${displayPage(cur)} 頁有內容，無法刪除`);
        book.pages.splice(cur,1);
        if(book.pages.length<2){ while(book.pages.length<2) book.pages.push(newPage(book.pages.length+1)); }
        renumber(); cur=Math.max(0,cur-1); render();
      }
      function insertChapter(){
        const p = book.pages[cur];
        if(!p.content_json) p.content_json = {};
        if(!Object.prototype.hasOwnProperty.call(p.content_json,'chapter')) p.content_json.chapter='';
        saveShadow(); render();
        const root = (forceSingle||viewMode==='single') ? $('#edSingle') : (isLeft(cur)?$('#edLeft'):$('#edRight'));
        root.querySelector('.chapter-block')?.focus();
      }
      function setType(p,type){ p.type=type; saveShadow(); render(); }

      function renumber(){ for(let i=0;i<book.pages.length;i++) book.pages[i].page_index=i+1; }
      function newPage(idx){ return { id:'local_'+Math.random().toString(36).slice(2,9), page_index:idx, type:'novel', content_json:{text:''}, image_url:null }; }
      function isLeft(idx){
        if(forceSingle || viewMode==='single') return false;
        const one=idx+1;
        if(book.direction==='rtl') return (one%2===1); // 直式：奇數在左
        return (one%2===0);                             // 橫式：偶數在左
      }

      /* ======= 字級 ======= */
      function wrapFont(mult){
        const MIN = 0.7, MAX = 1.8;
        const curS = book.fontScale || 1;
        let next = curS * mult;
        if (!isFinite(next) || next <= 0) next = 1;
        next = Math.max(MIN, Math.min(MAX, next));
        book.fontScale = next;
        saveShadow(); render();
      }

      /* ======= 儲存（Local + 可選 DB） ======= */
      function saveAll(){
        // 清掉「沒有網址的圖片頁」
        const filtered = book.pages.filter(p=> !(p.type==='illustration' && !p.image_url));
        if(filtered.length!==book.pages.length){ book.pages=filtered; renumber(); cur=clamp(cur,0,book.pages.length-1); }
        if(book.pages.length<2){ while(book.pages.length<2) book.pages.push(newPage(book.pages.length+1)); }
        Store.set(book);
      }
      function saveShadow(){ Store.set(book); }

      async function saveToDatabase(){
        saveAll();
        if (!supabase){
          alert('未設定 Supabase 或 SDK 未載入，已先存到 LocalStorage。');
          return;
        }
        const { data:auth } = await supabase.auth.getUser();
        const user = auth?.user;
        if (!user){
          alert('請先登入 Supabase 才能儲存到資料庫（已存 LocalStorage）。');
          return;
        }

        const bookPayload = {
          title: book.title || '未命名書籍',
          binding: book.binding || 'short',
          direction: book.direction || 'ltr',
          page_count: book.pages.length,
          owner_id: user.id
        };

        try{
          lockUI(true, '儲存中…');

          if (!book.db_id){
            const { data: created, error: errCreate } = await supabase
              .from('books').insert(bookPayload).select().single();
            if (errCreate) throw errCreate;
            book.db_id = created.id;
          }else{
            const { error: errUpd } = await supabase
              .from('books').update(bookPayload).eq('id', book.db_id);
            if (errUpd) throw errUpd;
          }

          const bid = book.db_id;
          await supabase.from('chapters').delete().eq('book_id', bid);
          await supabase.from('pages').delete().eq('book_id', bid);

          const pageRows = book.pages.map((p,i)=>({
            book_id: bid, page_index: i+1, type: p.type || 'novel',
            content_json: p.content_json || {}, image_url: p.image_url || null
          }));
          const { data: insertedPages, error: errPages } = await supabase
            .from('pages').insert(pageRows).select();
          if (errPages) throw errPages;

          const chapters = [];
          insertedPages.forEach((row, i)=>{
            const hasKey = Object.prototype.hasOwnProperty.call(book.pages[i].content_json||{},'chapter');
            const title = hasKey ? (book.pages[i].content_json.chapter || '').trim() : '';
            if (title) chapters.push({ book_id: bid, page_id: row.id, title });
          });
          if (chapters.length){
            const { error: errCh } = await supabase.from('chapters').insert(chapters);
            if (errCh) throw errCh;
          }

          Store.set(book);
          alert('已儲存到資料庫 ✅');
        }catch(e){
          console.error(e);
          alert('儲存到資料庫失敗：' + (e?.message || e));
        }finally{
          lockUI(false);
        }
      }

      async function saveAndBack(){
        try{ await saveToDatabase(); }catch(_){}
        if(history.length>1) history.back();
        else location.href = '/books'; // TODO: 替換成你的書單頁 URL
      }

      /* ======= 縮放 ======= */
      function fit(){
        const scaler = $('#edScaler'); const stage = $('.stage');
        // 以左頁實際 px 畫面來估算縮放
        const paperWpx = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--paper-w-mm')) * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--mm'));
        const pad=40, maxW = stage.clientWidth - pad;
        let s = Math.min(1, (forceSingle || viewMode==='single') ? (maxW / paperWpx) : (maxW / (paperWpx*2)));
        if(!isFinite(s) || s<=0) s=1;
        scaler.style.transform = `scale(${s})`;
      }

      /* ======= 小工具 ======= */
      function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
      function isMobile(){ return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || Math.min(window.innerWidth, window.innerHeight) < 768; }
      function lockUI(on, msg){
        const dis = !!on;
        ['btnInsertPage','btnDeleteBlank','btnPrev','btnNext','btnSave','btnBack',
         'btnInsertChapter','btnTOC','btnFontUp','btnFontDown','btnBold','btnItalic','btnUnderline',
         'btnToggleDir','btnToggleBind','btnToggleView'
        ].forEach(id=>{
          const el = document.getElementById(id);
          if (el) el.disabled = dis;
        });
        const saveBtn = document.getElementById('btnSave');
        if (saveBtn){
          if (dis){ saveBtn.dataset._txt = saveBtn.textContent; saveBtn.textContent = msg || '儲存中…'; }
          else if (saveBtn.dataset._txt){ saveBtn.textContent = saveBtn.dataset._txt; delete saveBtn.dataset._txt; }
        }
      }
    })();
  </script>
</body>
</html>
