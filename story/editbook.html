<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>謝爾夏｜電子書編輯器</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- 字體 & 你的主樣式 -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css">
  <style id="bookflip-core-style-v1">
    /* ===== BookFlip 核心 CSS（請勿修改） ===== */
    .book, .book * { user-select: none; -webkit-user-select: none; }
    .paper { width: 100%; height: 100%; position: absolute; top: 0; left: 0; transform-style: preserve-3d; }
    .page { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: flex; align-items: center; justify-content: center; backface-visibility: hidden; -webkit-backface-visibility: hidden; border: 1px solid #ddd; }
    .back { transform: rotateY(180deg); }
    .paper.dir-ltr { transform-origin: left center; }
    .paper.dir-rtl { transform-origin: right center; }
    .single-stage { width: 100%; height: 100%; position: relative; overflow: hidden; }
    .single-page { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: flex; align-items: center; justify-content: center; border: 1px solid #ddd; will-change: transform; }
  </style>
  <style id="bookflip-theme">
    /* ===== 書本大小 / RWD 位置 / 紙張設定（可依需求調整） ===== */
    :root {
      --mm: 3.7795275591px;  /* 1mm 換算 px */
      --paper-w-mm: 148;      /* 短邊寬度（直放） */
      --paper-h-mm: 210;      /* 長邊高度（直放） */

      --pad: 6%;             /* 內縮留白 */
      --ink: #111827;         /* 文字顏色 */
      --muted: #6b7280;       /* 次色 */
      --fs: 1.02rem;          /* 正文字級（js 可覆蓋） */
      --lh: 1.8;              /* 行距（js 可覆蓋） */
    }

    .stage {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: calc(100vh - 160px);
      padding: 12px;
      position: relative;
      z-index: 10;
      overflow: hidden;
    }

    .scaler {
      transform-origin: top center;
      display: flex;
      justify-content: center;
      width: fit-content;
    }

    .scaler.align-left { justify-content: flex-start; }
    .scaler.align-right { justify-content: flex-end; }
    .scaler.align-center { justify-content: center; }

    .book {
      position: relative;
      width: calc(var(--paper-w-mm) * var(--mm));
      height: calc(var(--paper-h-mm) * var(--mm));
    }

    .binding-long .book {
      width: calc(var(--paper-h-mm) * var(--mm));
      height: calc(var(--paper-w-mm) * var(--mm));
    }

    .book .paper {
      border-radius: 10px;
      overflow: hidden;
    }

    .book .page {
      position: absolute;
      inset: 0;
      padding: var(--pad);
      display: flex;
      flex-direction: column;
      background: #fff;
      color: var(--ink);
    }

    .cover-inner {
      width: 100%;
      height: 100%;
      padding: 24px;
      display: grid;
      place-items: center;
      text-align: center;
    }

    .cover-title {
      font-size: 1.6em;
      font-weight: 700;
      line-height: 1.2;
    }

    .cover-sub {
      margin-top: 10px;
      opacity: .65;
    }

    .cover-image,
    .illustration-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      border-radius: 6px;
    }

    .illustration-placeholder {
      width: 100%;
      height: 100%;
      display: grid;
      place-items: center;
      color: #6b7280;
      border: 2px dashed #cfd5e3;
      border-radius: 8px;
    }

    .page-blank {
      flex: 1;
      background: #fff;
      border-radius: 8px;
    }

    .page-divider {
      width: 100%;
      height: 100%;
      display: grid;
      place-items: center;
      text-align: center;
      border-radius: 12px;
      padding: 12% 10%;
    }

    .page-divider.light {
      background: #fff;
      border: 2px dashed #cfd5e3;
      color: var(--ink);
    }

    .page-divider.dark {
      background: #555;
      color: #fff;
    }

    .page-divider .body-text {
      margin: 0;
      flex: 0;
      width: 100%;
      text-align: center;
      background: transparent;
    }

    .book .front { background: #fff; }
    .book .back { background: #fafafa; transform: rotateY(180deg); }

    .chapter-chip {
      position: absolute;
      top: var(--pad);
      font-size: .85rem;
      color: #6b7280;
    }

    .page-no {
      position: absolute;
      bottom: var(--pad);
      font-variant-numeric: tabular-nums;
      color: #9aa3b2;
    }

    .paper.left .chapter-chip { left: var(--pad); }
    .paper.right .chapter-chip { right: var(--pad); }
    .paper.left .page-no { left: var(--pad); }
    .paper.right .page-no { right: var(--pad); }

    .body-text {
      flex: 1;
      margin-top: .25rem;
      white-space: pre-wrap;
      line-height: var(--lh);
      font-size: var(--fs);
      overflow: hidden;
      outline: none;
      tab-size: 2;
    }

    .body-text:empty::before {
      content: attr(data-ph);
      color: #95a0c2;
    }

    .vertical .body-text {
      writing-mode: vertical-rl;
      text-orientation: upright;
      line-height: 1.9;
    }

    .tpl-divider-light .page { display: grid; place-items: center; text-align: center; }
    .tpl-divider-dark { background: #555; color: #fff; }
    .tpl-divider-dark .page { display: grid; place-items: center; text-align: center; }
    .tpl-illustration .page { padding: 0; }
    .tpl-illustration img { width: 100%; height: 100%; object-fit: cover; display: block; }
  </style>
</head>
<body>
  <!-- 上方導覽 -->
  <div class="appbar">
    <div class="brand">書名:<span id="bookTitle" contenteditable="true">未命名書籍</span></div>
    <div class="tools">
      <div>
        <span>頁面數：</span><b id="lblCount">7</b>
        <span style="width:5px"></span>
      </div>
      <div>
        <button class="btn primary" id="btnSave">儲存</button>
        <button class="btn" id="btnBack">回書單</button>
      </div>
    </div>
  </div>

  <!-- 左側工具列 -->
  <div class="side left">
    <button class="btn ghost" id="btnTOC">目錄</button>
    <button class="btn ghost" id="btnFontUp">A+</button>
    <button class="btn ghost" id="btnFontDown">A-</button>
    <button class="btn ghost" id="btnBold"><b>B</b></button>
    <button class="btn ghost" id="btnItalic"><i>I</i></button>
    <button class="btn ghost" id="btnUnderline"><u>U</u></button>
  </div>

  <!-- 翻頁左右鍵（保留） -->
  <div class="side left" style="top:20%;">
    <button class="btn ghost" id="btnleft"><</button>
  </div>
  <div class="side right" style="top:20%;">
    <button class="btn ghost" id="btnright">></button>
  </div>

  <!-- 右側工具列 -->
  <div class="side right">
    <button class="btn ghost" id="btnToggleDir">文字方向</button>
    <button class="btn ghost" id="btnToggleBind">長/短邊</button>
    <button class="btn ghost" id="btnToggleView">單/雙頁</button>
  </div>

  <!-- 中央舞台（交給 BookFlip） -->
  <div class="stage">
    <div class="scaler" id="scaler">
      <div class="book" id="bookCanvas">
        <!-- 預設一張紙：封面 + 背面白紙（JS 會在載入後覆寫） -->
        <div class="paper dir-ltr">
          <div class="page front">
            <div class="cover-inner">
              <div class="cover-title">未命名書籍</div>
              <div class="cover-sub">～ 封面 ～</div>
            </div>
          </div>
          <div class="page back">
            <div class="page-blank"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 下方 Dock -->
  <div class="dock" style="bottom: 6%;">
    <button class="btn" id="btnInsertChapter" style="min-width:128px">插入章節</button>
    <button class="btn" id="btnInsertPage">插入頁面</button>
    <button class="btn danger" id="btnDeleteBlank">刪除空白頁</button>
  </div>
  <div class="dock">
    <button class="btn" data-style="novel">一般文本</button>
    <button class="btn" data-style="divider-light">白置中</button>
    <button class="btn" data-style="divider-dark">黑置中</button>
    <button class="btn" data-style="illustration">圖片頁</button>
  </div>

  <!-- 目錄導覽 -->
  <dialog id="tocDialog">
    <form method="dialog" style="padding:14px 16px">
      <h3 style="margin:.2rem 0 1rem">目錄</h3>
      <div id="tocList" style="max-height:60vh;overflow:auto;border:1px solid #2a3555;border-radius:12px"></div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button>關閉</button></div>
    </form>
  </dialog>

  <!-- Supabase（保持） -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://ogzpfrkwnqqaitytncla.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9nenBmcmt3bnFxYWl0eXRuY2xhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxODQzNzEsImV4cCI6MjA3MDc2MDM3MX0.Ls83xOXcKIW7FUcavr8_sOs37I18VGFWYNW3sNFRS24";
    const BOOK_ID = "f695e2ac-b3b2-4714-ab93-925cdab47487";
  </script>

  <!-- 你的主程式（保持原樣路徑） -->
  <script defer src="./app.js"></script>

  <!-- ===== BookFlip 插件：獨立檔案 ===== -->
  <script src="./book-flip.js"></script>

  <!-- ===== 薄整合層：把你的 book 資料與 UI 按鈕接到 BookFlip ===== -->
  <script>
  (function () {
    if (!window.BookFlip) return;
    const el = document.getElementById('bookCanvas');
    if (!el) return;

    // ===== 你的全域 book 狀態（沿用 app.js） =====
    // 這裡只使用 book.pages / book.title / book.viewMode / book.direction / book.chapters

    function esc(s){return (s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]))}
    const isCover = (p)=> p && p.type==='cover-front';
function shouldMeta(p){
  if (!p || p.type==='cover-front' || p.type==='blank') return false;
  const t = p.type;
  return t!=='divider-light' && t!=='divider-dark' && t!=='illustration';
}


    function nearestChapter(pageNo){
      if (!window.book?.chapters) return '';
      const pages = window.book.pages||[];
      let i = pages.findIndex(p=>p.page_no===pageNo);
      if (i<0) return '';
      for(let x=i; x>=0; x--){ const P=pages[x]; if (P.page_no>0){ const e=window.book.chapters[P.id]; if(e&&e.title) return e.title; } }
      return '';
    }

    function pageHTML(page){
      if (isCover(page)){
        if (page.image_url){
          return `<img class="cover-image" src="${esc(page.image_url)}" alt="">`;
        }
        return `<div class="cover-inner"><div class="cover-title">${esc(window.book?.title||'未命名書籍')}</div><div class="cover-sub">～ 封面 ～</div></div>`;
      }
      if (page.type==='illustration'){
        return page.image_url
          ? `<img class="illustration-image" src="${esc(page.image_url)}" alt="">`
          : `<div class="illustration-placeholder">（雙擊貼上圖片網址）</div>`;
      }

      if (page.type === 'blank'){
        return `<div class="page-blank"></div>`;
      }

      const chips=[];
      if (shouldMeta(page)){
        const ch=nearestChapter(page.page_no); if(ch) chips.push(`<div class="chapter-chip">${esc(ch)}</div>`);
        chips.push(`<div class="page-no">${page.page_no||''}</div>`);
      }
      const bodyHTML = page.content_html ? page.content_html : esc(page.content_text||'');
      const placeholder = page.type==='novel'?'正文…':'置中文字…';
      const body = `<div class="body-text" contenteditable="true" data-ph="${esc(placeholder)}">${bodyHTML}</div>`;
      if (page.type==='divider-light' || page.type==='divider-dark'){
        const tone = page.type==='divider-dark'?'dark':'light';
        return `${chips.join('')}<div class="page-divider ${tone}">${body}</div>`;
      }
      return `${chips.join('')}${body}`;
    }
    function buildPairsFromBook(){
      const pages = Array.isArray(window.book?.pages) ? window.book.pages.slice() : [];
      if (!pages.length){
        return [
          { frontHTML: pageHTML({ type:'cover-front' }), backHTML: pageHTML({ type:'blank' }) },
          { frontHTML: pageHTML({ type:'novel', page_no: 1, content_text: '第 1 頁', content_html: '' }), backHTML: pageHTML({ type:'novel', page_no: 2, content_text: '第 2 頁', content_html: '' }) }
        ];
      }
      if (pages.length % 2 === 1){
        pages.push({ id:'__blank__', page_no:0, type:'blank', content_text:'', content_html:'', image_url:null });
      }
      const pairs = [];
      for (let i=0; i<pages.length; i+=2){
        const front = pages[i];
        const back = pages[i+1] ?? { type:'blank', page_no:0, content_text:'', content_html:'', image_url:null };
        pairs.push({ frontHTML: pageHTML(front), backHTML: pageHTML(back) });
      }
      return pairs;
    }

    let viewer = new BookFlip(el, {
      mode: (window.book?.viewMode === 'single') ? 'single' : 'spread',
      direction: window.book?.direction || 'ltr',
      speed: 500,
      singleSpeed: 300,
      perspective: 2000,
      startPageIndex: 0
    });

    window.BookFlipGoTo = (pageIndex = 0) => {
      if (!viewer) return;
      viewer.goTo(pageIndex);
      updateStageLayout();
      if (typeof window.requestStageFit === 'function') window.requestStageFit();
    };

    function wireEditableHandlers(){
      document.querySelectorAll('#bookCanvas .body-text[contenteditable="true"]').forEach((body)=>{
        let tmr=null; body.addEventListener('input', ()=>{
          const no = body.closest('.page')?.querySelector('.page-no')?.textContent;
          const pageNo = no ? Number(no) : null; if(!pageNo) return;
          const p = (window.book?.pages||[]).find(pp=>pp.page_no===pageNo); if(!p) return;
          p.content_html = body.innerHTML; p.content_text = body.textContent||'';
          if (window.persist) window.persist();
          clearTimeout(tmr); tmr=setTimeout(()=>{ if(window.autoPaginateFrom) window.autoPaginateFrom(pageNo, body); }, 60);
        });
      });
    }

    function updateStageLayout(){
      const scalerEl = document.getElementById('scaler');
      const bookEl = document.getElementById('bookCanvas');
      if (!scalerEl || !bookEl) return;
      const bookWidth = bookEl.offsetWidth;
      const viewMode = (window.book?.viewMode === 'single') ? 'single' : 'double';
      const dir = (window.book?.direction === 'rtl') ? 'rtl' : 'ltr';
      scalerEl.classList.remove('align-left','align-right','align-center');
      scalerEl.style.width = '';
      scalerEl.style.transformOrigin = 'top center';
      if (!bookWidth) {
        scalerEl.classList.add('align-center');
        return;
      }
      if (viewMode === 'single') {
        scalerEl.classList.add('align-center');
        scalerEl.style.width = bookWidth + 'px';
        scalerEl.style.transformOrigin = 'top center';
      } else {
        scalerEl.style.width = (bookWidth * 2) + 'px';
        if (dir === 'rtl') {
          scalerEl.classList.add('align-left');
          scalerEl.style.transformOrigin = 'top right';
        } else {
          scalerEl.classList.add('align-right');
          scalerEl.style.transformOrigin = 'top left';
        }
      }
    }

    function refreshViewer(keepPage=true){
      if (!window.book){
        clearTimeout(refreshViewer._waitHandle);
        refreshViewer._waitHandle = setTimeout(()=>refreshViewer(keepPage), 50);
        return;
      }
      clearTimeout(refreshViewer._waitHandle);
      const at = keepPage
        ? (typeof viewer.getCurrentPage === 'function' ? viewer.getCurrentPage() : (viewer?._cursorPage || 0))
        : 0;
      viewer.loadData({ pairs: buildPairsFromBook() });
      viewer.setMode(window.book?.viewMode==='single'?'single':'spread');
      viewer.setDirection(window.book?.direction||'ltr');
      viewer.goTo(at);
      wireEditableHandlers();
      const layout = ()=>{ updateStageLayout(); if (window.requestStageFit) window.requestStageFit(); };
      if (typeof requestAnimationFrame === 'function') requestAnimationFrame(layout); else layout();
    }

    // 綁 UI 按鈕（保留原體驗）
    document.getElementById('btnleft') ?.addEventListener('click', ()=> viewer.prev());
    document.getElementById('btnright')?.addEventListener('click', ()=> viewer.next());

    document.getElementById('btnToggleView')?.addEventListener('click', ()=>{
      if (!window.book) return; window.book.viewMode = (window.book.viewMode==='single')?'double':'single'; refreshViewer(true);
    });
    document.getElementById('btnToggleDir')?.addEventListener('click', ()=>{
      if (!window.book) return; window.book.direction = (window.book.direction==='rtl')?'ltr':'rtl'; refreshViewer(true);
    });

    // 初始一次
    refreshViewer(false);
    // 暴露給 app.js 需要時手動重繪
    window.BookFlipRefresh = refreshViewer;
    window.updateStageLayout = updateStageLayout;
  })();
  </script>
</body>
</html>

