<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>謝爾夏｜電子書編輯器</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- 字體 -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
/* ========== Reset / Base ========== */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:#e6ebff;
  font-family:'Noto Sans TC',system-ui,-apple-system,Segoe UI,sans-serif;
  background:#000 url('https://shierusha.github.io/school-battle/teachers/img/8.webp') center top / cover no-repeat fixed;
}
/* 隱藏滾動條但保留滾動 */
html, body { overflow-y: auto; }
body { -ms-overflow-style: none; scrollbar-width: none; }
body::-webkit-scrollbar { width:0; height:0; }

/* ========== App Bar ========== */
.appbar {
    position: fixed;
    top: 0;
    z-index: 100;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    background: rgba(15, 27, 51, .85);
    border-bottom: 1px solid #223057;
    height: 30px; 
    width: 100vw;
}
.brand{display:flex;gap:.6rem;align-items:center;font-weight:700}
#bookTitle{outline:none}
#bookTitle[contenteditable="true"]{border-bottom:1px dashed #8aa1ff}
.tools{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

/* ========== 舞台區 ========== */
.stage{
  position: absolute;
  left: 50%;
  top: 60px;
  transform: translateX(-50%);
  width: 90%;
  max-width: 1100px;
  height: 100vh;
}
.scaler{ position:relative; width:100%; }

/* ========== 按鈕（保留你的） ========== */
.btn{ background:#16244a; border:1px solid #3a4a78; color:#fff; padding:2px 10px; border-radius:10px; cursor:pointer }
.btn.primary{ background:#6f82ff; border-color:#6f82ff }
.btn.danger{ background:#2a0f18; border-color:#6b1b2e; color:#ffb3c2 }
.btn.ghost{border-color:#ffffff33 }
.side{ position:fixed;  display:flex; gap:8px; z-index:90 }
.side.left{     left: 10px;   top: 33px; }
.side.right{ right:10px; top: 33px; }
.dock{ position:fixed; left:0; right:0; bottom:1%; display:flex; gap:10px; justify-content:center; z-index:90 }

/* ========== 文字方向（外觀） ========== */
.mode-ltr .page{ writing-mode: horizontal-tb; }
.mode-rtl .page{ writing-mode: vertical-rl;  letter-spacing: 0.1em; }
.mode-ltr .single-page{ writing-mode: horizontal-tb; }
.mode-rtl .single-page{ writing-mode: vertical-rl; letter-spacing: 0.1em; }

/* ===== BookFlip 必要 CSS（請勿移除） ===== */
.book, .book * { user-select:none; -webkit-user-select:none; }
.book { position:absolute; top:0; color:black; }
.paper {
  width:100%; height:100%;
  position:absolute; top:0; left:0;
  transform-style:preserve-3d;
  background:#FFF;
  border: 1px solid #555;
}
.page {
  width:100%; height:100%;
  position:absolute; top:0; left:0;
  display:flex;
  backface-visibility:hidden; -webkit-backface-visibility:hidden;
  padding: calc(20px * var(--scale, 1));
}
.back { transform: rotateY(180deg); }
.paper.dir-ltr { transform-origin: left center; }
.paper.dir-rtl { transform-origin: right center; }

.single-stage { width:100%; height:100%; position:relative; overflow:hidden; }
.single-page  { width:100%; height:100%; position:absolute; top:0; left:0; display:flex; will-change:transform; background:#FFF; padding: calc(20px * var(--scale, 1)); }

/* 字級比例（方案2） */
.book-scope { font-size: calc(16px * var(--scale, 1)); }

/* ========== 章節角標＋頁碼 ========== */
.page-meta { position: absolute; pointer-events: none;     font-size: .7em;    opacity: .7;}
.meta-chapter { max-width: 45%; }

.meta-tl { top: 5px;  left: 6px; }
.meta-tr { top: 5px;  right: 3px; }
.meta-bl { bottom: 5px; left: 6px; }
.meta-br { bottom: 5px; right: 6px; }

/* ========== 四種頁型（底線版） ========== */
.page.page--divider_light,
.single-page.page--divider_light,
.page.page--divider_dark,
.single-page.page--divider_dark {
  display:flex; align-items:center; justify-content:center; text-align:center;
}
/* 不顯示角標 */
.page--divider_light .page-meta,
.page--divider_dark  .page-meta,
.page--illustration  .page-meta { display:none !important; }
/* 配色 */
.page.page--divider_light, .single-page.page--divider_light { background:#fff; color:#000; }
.page.page--divider_dark,  .single-page.page--divider_dark  { background:#555; color:#fff; }
/* 圖片滿版 */
.page.page--illustration, .single-page.page--illustration {
  background-size: cover; background-position: center; background-repeat: no-repeat; padding:0 !important;
}

/* ========== TOC Modal（自適應高度） ========== */
.modal-overlay { position: fixed; inset: 0; z-index: 2000; display: none; align-items: center; justify-content: center; animation: modal-fadein-bg 0.25s; background: rgba(0,0,0,0.45); }
.modal-overlay.show { display: flex; }
@keyframes modal-fadein-bg { from { background: rgba(0,0,0,0);} to { background: rgba(0,0,0,0.45);} }
.modal-content { background: rgb(13 27 77 / 82%); border-radius: 18px; border: 2px solid #1eb5e5; box-shadow: 0 0 16px 2px #62f1fe88, 0 8px 32px #1eb5e5aa; width: 500px; max-width: 93vw; height: auto; max-height: 80vh; display: flex; flex-direction: column; overflow: hidden; animation: modal-pop 0.32s cubic-bezier(.42,1.4,.51,1.01); }
@keyframes modal-pop { from { opacity: 0; transform: scale(0.92);} to { opacity: 1; transform: scale(1);} }
.modal-header { background: none; padding: 15px 20px 0px 24px; color: #fff; font-size: 1.5em; font-weight: bold; letter-spacing: 1px; text-shadow: 0 1px 4px #000a; }
.modal-header::after { content: ""; display: block; height: 5px; width: 70%; margin: 0.5rem 0 0 0; border-radius: 2px; background: linear-gradient(to right, #53e2ff99 65%, #53e2ff00 100%); pointer-events: none; }
.modal-body { color: #fff; padding: 12px 24px 16px 24px; font-size: 1.05em; line-height: 1.55; text-shadow: 0 1px 4px #0008; overflow-y: auto; word-break: break-word; white-space: normal; max-height: 64vh; scrollbar-width: none; -ms-overflow-style: none; }
.modal-body::-webkit-scrollbar { display: none; }
.toc-row { display: grid; grid-template-columns: 1fr auto; gap: 8px; padding: 6px 0; border-bottom: 1px dashed #53e2ff33; cursor: pointer; }
.toc-row:hover { background: #0d1b4d66; }
.toc-row .toc-title { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.toc-row .toc-page  { opacity: .9; }

/* 讓頁碼永遠水平書寫（單頁/雙頁都適用） */
.page .meta-page,
.single-page .meta-page {
  writing-mode: horizontal-tb !important;
  text-orientation: mixed !important; /* 確保數字不是直立顯示 */
  letter-spacing: 0 !important;       /* 避免繼承垂直模式的字距 */
  text-combine-upright: none !important;
}

/* 650px 以下換版型 */
@media (max-width: 650px) {
.stage{height: 85vh;}
#bookTitle {    width: 10em;}
.appbar {    height: 65px;}
.tools {    gap: 1px;    flex-direction: column-reverse;}
.stage {  top: 85px;  width: 80%;}
.side.right {bottom: 65px;        left: 50%;        transform: translateX(-50%);        right: 0px;        top: auto;        justify-content: center;        width: 100%;}
.side.left {    top: 65px;}}


    /* 編輯時不要出現巨大黑框/外框 */
.story { outline: none !important; }
.story:focus { outline: none !important; box-shadow: none !important; border: none !important; }
/* 也一併避免點擊高亮 */
.story { -webkit-tap-highlight-color: transparent; }
/* 你本來就有 overflow:hidden；再保險一下不顯示滾動條 */
.story::-webkit-scrollbar { width: 0; height: 0; }


  </style>
</head>

<body class="mode-ltr">
  <!-- 上方導覽 -->
  <div class="appbar">
    <div class="brand">書名:<span id="bookTitle" contenteditable="true">未命名書籍</span></div>
    <div class="tools">
      <div>
        <span>頁面數：</span><b id="lblCount">0</b>
        <span style="width:5px"></span>
      </div>
      <div>
        <button class="btn primary" id="btnSave">儲存</button>
        <button class="btn" id="btnBack">回書單</button>
      </div>
    </div>
  </div>

  <!-- 左側工具列（TOC 不再隱藏） -->
  <div class="side left">
    <button class="btn ghost" id="btnTOC">目錄</button>
    <button class="btn ghost" id="btnFontUp">A+</button>
    <button class="btn ghost" id="btnFontDown">A-</button>
    <button class="btn ghost" id="btnBold"><b>B</b></button>
    <button class="btn ghost" id="btnItalic"><i>I</i></button>
    <button class="btn ghost" id="btnUnderline"><u>U</u></button>
  </div>

  <!-- 右側工具列 -->
  <div class="side right">
   <button class="btn ghost" id="btnToggleDir" style="display: none;">文字方向</button>
    <button class="btn ghost" id="btnToggleBind" style="display: none;">長/短邊</button>
    <button class="btn ghost" id="btnToggleView">單/雙頁</button>
  </div>

  <!-- 中央舞台 -->
  <div class="stage">
    <div class="scaler" id="scaler">
      <div class="book" id="bookCanvas">
        <!-- ✅ 封面保留（插件不覆蓋） -->
        <div class="paper">
          <div class="page front">首頁</div>
          <div class="page back"></div>
        </div>
        <!-- 正文由 JS 追加 -->
      </div>
    </div>
  </div>

  <!-- 下方 Dock（不隱藏） -->
  <div class="dock" style="bottom:34px;">
    <button class="btn ghost" id="btnleft">&lt;</button>
    <button class="btn" id="btnInsertChapter">插入章節</button>
    <button class="btn" id="btnInsertPage" style="display: none;">插入白紙</button>
    <button class="btn danger" id="btnDeleteBlank">刪除白紙</button>
    <button class="btn ghost" id="btnright">&gt;</button>
  </div>
  <div class="dock">
    <button class="btn" data-style="novel">一般文本</button>
    <button class="btn" data-style="divider-light">白置中</button>
    <button class="btn" data-style="divider-dark">黑置中</button>
    <button class="btn" data-style="illustration">圖片頁</button>
  </div>

  <!-- TOC Modal -->
  <div id="tocModal" class="modal-overlay" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="tocTitle">
      <div class="modal-header" id="tocTitle">目錄</div>
      <div class="modal-body" id="tocBody"></div>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://ogzpfrkwnqqaitytncla.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9nenBmcmt3bnFxYWl0eXRuY2xhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxODQzNzEsImV4cCI6MjA3MDc2MDM3MX0.Ls83xOXcKIW7FUcavr8_sOs37I18VGFWYNW3sNFRS24";
    const BOOK_ID = ""; // 無 ?book= 時可填固定 id
    const SB = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <!-- 外掛-->
  <script src="book-flip.js"></script>
  <!-- 應用層-->
  <script src="app.js"></script>
<script src="editor-core.js"></script>
<script src="sheet-ops.js"></script>
<script src="paste-flow.js"></script>
<script src="text-controls.js"></script>
<script src="page-style.js"></script>
<script src="toc.js"></script>


</body>
</html>
