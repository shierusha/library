<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>謝爾夏｜電子書</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- 字體 -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
/* ========== Reset / Base ========== */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:#e6ebff;
  font-family:'Noto Sans TC',system-ui,-apple-system,Segoe UI,sans-serif;
  background:#000 url('https://shierusha.github.io/school-battle/teachers/img/8.webp') center top / cover no-repeat fixed;
}
/* 隱藏滾動條但保留滾動 */
html, body { overflow-y: auto; }
body { -ms-overflow-style: none; scrollbar-width: none; }
body::-webkit-scrollbar { width:0; height:0; }


#btnTOC{
    background: #b36969;
    border: 1px solid #3a4a78;
    color: #fff;}
 #btnBack{
    background: #b36969;
    border: 1px solid #3a4a78;
    color: #fff;}
#btnToggleView{
    background: #b36969;
    border: 1px solid #3a4a78;
    color: #fff;}

/* ========== App Bar ========== */
.appbar {
    position: fixed;
    top: 0;
    z-index: 100;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    background: rgba(15, 27, 51, .85);
    border-bottom: 1px solid #223057;
    height: 45px; 
    width: 100vw;
}
.brand{display:flex;gap:.6rem;align-items:center;font-weight:700}
#bookTitle{outline:none}
#bookTitle[contenteditable="true"]{border-bottom:1px dashed #8aa1ff}
.tools{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

/* ========== 舞台區 ========== */
.stage{
  position: absolute;
  left: 50%;
  top: 60px;
  transform: translateX(-50%);
  width: 80%;
  max-width: 1100px;
  height: 94vh;
}
.scaler{ position:relative; width:100%; }

/* ========== 按鈕（保留你的） ========== */
.btn{padding:2px 10px; border-radius:10px; cursor:pointer }
.btn.primary{ background:#6f82ff; border-color:#6f82ff }
.btn.danger{ background:#2a0f18; border-color:#6b1b2e; color:#ffb3c2 }
.btn.ghost{border-color:#ffffff33 }
.side{ position:fixed;  display:flex; gap:8px; z-index:90 }
.side.left{     left: 10px;   top: 50px; }
.side.right{ right:10px; top: 50px; }
.dock{ position:fixed; left:0; right:0; bottom:1%; display:flex; gap:10px; justify-content:center; z-index:90;    top: 75px;    bottom: 35px; }

/* ========== 文字方向（外觀） ========== */
.mode-ltr .page{ writing-mode: horizontal-tb; }
.mode-rtl .page{ writing-mode: vertical-rl; text-orientation: upright; letter-spacing: 0.1em; }
.mode-ltr .single-page{ writing-mode: horizontal-tb; }
.mode-rtl .single-page{ writing-mode: vertical-rl; text-orientation: upright; letter-spacing: 0.1em; }

/* ===== BookFlip 必要 CSS（請勿移除） ===== */
.book, .book * { user-select:none; -webkit-user-select:none; }
.book { position:absolute; top:0; color:black; }
.paper {
  width:100%; height:100%;
  position:absolute; top:0; left:0;
  transform-style:preserve-3d;
  background:#FFF;
  border: 1px solid #555;
}
.page {
  width:100%; height:100%;
  position:absolute; top:0; left:0;
  display:flex;
  backface-visibility:hidden; -webkit-backface-visibility:hidden;
  padding: calc(20px * var(--scale, 1));
}
.back { transform: rotateY(180deg); }
.paper.dir-ltr { transform-origin: left center; }
.paper.dir-rtl { transform-origin: right center; }

.single-stage { width:100%; height:100%; position:relative; overflow:hidden; }
.single-page  { width:100%; height:100%; position:absolute; top:0; left:0; display:flex; will-change:transform; background:#FFF; padding: calc(20px * var(--scale, 1)); }

/* 字級比例（方案2） */
.book-scope { font-size: calc(16px * var(--scale, 1)); }

/* ========== 章節角標＋頁碼 ========== */
.page-meta { position: absolute; pointer-events: none; font-size: .7em; opacity: .7;}
.meta-chapter { max-width: 45%; }
.meta-tl { top: 5px;  left: 2px; }
.meta-tr { top: 5px;  right: 2px; }
.meta-bl { bottom: 5px; left: 6px; }
.meta-br { bottom: 5px; right: 6px; }

/* 讓頁碼永遠水平書寫（單頁/雙頁都適用） */
.page .meta-page,
.single-page .meta-page {
  writing-mode: horizontal-tb !important;
  text-orientation: mixed !important; /* 確保數字不是直立顯示 */
  letter-spacing: 0 !important;       /* 避免繼承垂直模式的字距 */
  text-combine-upright: none !important;
}


/* ========== 四種頁型（底線版） ========== */
.page.page--divider_light,
.single-page.page--divider_light,
.page.page--divider_dark,
.single-page.page--divider_dark {
  display:flex; align-items:center; justify-content:center; text-align:center;
}
/* 不顯示角標 */
.page--divider_light .page-meta,
.page--divider_dark  .page-meta,
.page--illustration  .page-meta { display:none !important; }
/* 配色 */
.page.page--divider_light, .single-page.page--divider_light { background:#fff; color:#000; }
.page.page--divider_dark,  .single-page.page--divider_dark  { background:#555; color:#fff; }
/* 圖片滿版 */
.page.page--illustration, .single-page.page--illustration {
  background-size: cover; background-position: center; background-repeat: no-repeat; padding:0 !important;
}

/* ========== TOC Modal（自適應高度） ========== */
.modal-overlay { position: fixed; inset: 0; z-index: 2000; display: none; align-items: center; justify-content: center; animation: modal-fadein-bg 0.25s; background: rgba(0,0,0,0.45); }
.modal-overlay.show { display: flex; }
@keyframes modal-fadein-bg { from { background: rgba(0,0,0,0);} to { background: rgba(0,0,0,0.45);} }
.modal-content { background: rgb(13 27 77 / 82%); border-radius: 18px; border: 2px solid #1eb5e5; box-shadow: 0 0 16px 2px #62f1fe88, 0 8px 32px #1eb5e5aa; width: 500px; max-width: 93vw; height: auto; max-height: 80vh; display: flex; flex-direction: column; overflow: hidden; animation: modal-pop 0.32s cubic-bezier(.42,1.4,.51,1.01); }
@keyframes modal-pop { from { opacity: 0; transform: scale(0.92);} to { opacity: 1; transform: scale(1);} }
.modal-header { background: none; padding: 15px 20px 0px 24px; color: #fff; font-size: 1.5em; font-weight: bold; letter-spacing: 1px; text-shadow: 0 1px 4px #000a; }
.modal-header::after { content: ""; display: block; height: 5px; width: 70%; margin: 0.5rem 0 0 0; border-radius: 2px; background: linear-gradient(to right, #53e2ff99 65%, #53e2ff00 100%); pointer-events: none; }
.modal-body { color: #fff; padding: 12px 24px 16px 24px; font-size: 1.05em; line-height: 1.55; text-shadow: 0 1px 4px #0008; overflow-y: auto; word-break: break-word; white-space: normal; max-height: 64vh; scrollbar-width: none; -ms-overflow-style: none; }
.modal-body::-webkit-scrollbar { display: none; }
.toc-row { display: grid; grid-template-columns: 1fr auto; gap: 8px; padding: 6px 0; border-bottom: 1px dashed #53e2ff33; cursor: pointer; }
.toc-row:hover { background: #0d1b4d66; }
.toc-row .toc-title { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.toc-row .toc-page  { opacity: .9; }

/* 650px 以下換版型  */
@media (max-width: 650px) {
  #bookTitle { width: 10em; }
  .appbar    { height: 65px; }
  .tools     { gap: 1px; flex-direction: column-reverse; }
  .stage     { top: 85px;  }
  .side.right{ bottom: 10px; left: 50%; transform: translateX(-50%); right: 0; top: auto; justify-content:center; width: 100%; }
  .side.left { top: 65px; }
.dock{top: 99%;    bottom: 1%; }
.stage{height: 70vh;}
}

/* ========== Reader 模式（只保留 TOC、上一頁、下一頁、單/雙頁切換） ========== */
.reader .side.left .btn:not(#btnTOC) { display:none !important; }
.reader .side.right .btn:not(#btnToggleView) { display:none !important; }
.reader .dock:first-of-type .btn:not(#btnleft):not(#btnright) { display:none !important; }
/* 第二排樣式切換 Dock 直接整排隱藏 */
.reader .dock + .dock { display:none !important; }
/* （可選）如果閱讀器不需要右上角儲存/回書單，取消下面兩行註解 */
/* .reader #btnSave { display:none !important; } */
/* .reader #btnBack { display:none !important; } */
  </style>
</head>

<!-- ★★★ 這裡多加了 class="reader" ★★★ -->
<body class="mode-ltr reader">
  <!-- 上方導覽 -->
  <div class="appbar">
    <div class="brand">書名:<span id="bookTitle">未命名書籍</span></div>
    <div class="tools">
      <div>
        <span>頁面數：</span><b id="lblCount">0</b>
        <span style="width:5px"></span>
      </div>
      <div>
        <button class="btn" id="btnBack">回休息室</button>
      </div>
    </div>
  </div>

  <!-- 左側工具列（閱讀器保留 TOC） -->
  <div class="side left">
    <button class="btn ghost" id="btnTOC">目錄</button>
    <button class="btn ghost" id="btnFontUp">A+</button>
    <button class="btn ghost" id="btnFontDown">A-</button>
    <button class="btn ghost" id="btnBold"><b>B</b></button>
    <button class="btn ghost" id="btnItalic"><i>I</i></button>
    <button class="btn ghost" id="btnUnderline"><u>U</u></button>
  </div>

  <!-- 右側工具列（閱讀器保留單/雙頁切換） -->
  <div class="side right">
    <button class="btn ghost" id="btnToggleDir">文字方向</button>
    <button class="btn ghost" id="btnToggleBind">長/短邊</button>
    <button class="btn ghost" id="btnToggleView">單/雙頁</button>
  </div>

  <!-- 中央舞台 -->
  <div class="stage">
    <div class="scaler" id="scaler">
      <div class="book" id="bookCanvas">
        <!-- ✅ 封面保留（插件不覆蓋） -->
        <div class="paper">
          <div class="page front">首頁</div>
          <div class="page back"></div>
        </div>
        <!-- 正文由 JS 追加 -->
      </div>
    </div>
  </div>


<div class="dock" >


    <button class="btn ghost" id="btnleft" 
style="
    width: 45%;
    background: #00000000;
    border: 0;
    padding: 0;
    cursor: pointer;
    height: 100%;
"
></button>


    <button class="btn ghost" id="btnright" 
style="
    width: 45%;
    background: #160a0a00;
    border: 0;
    padding: 0;
    cursor: pointer;
    height: 100%;
"
></button>


  </div> 






  <div class="dock">
    <button class="btn" data-style="novel">一般文本</button>
    <button class="btn" data-style="divider-light">白置中</button>
    <button class="btn" data-style="divider-dark">黑置中</button>
    <button class="btn" data-style="illustration">圖片頁</button>
  </div>

  <!-- TOC Modal -->
  <div id="tocModal" class="modal-overlay" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="tocTitle">
      <div class="modal-header" id="tocTitle">目錄</div>
      <div class="modal-body" id="tocBody"></div>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://ogzpfrkwnqqaitytncla.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9nenBmcmt3bnFxYWl0eXRuY2xhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxODQzNzEsImV4cCI6MjA3MDc2MDM3MX0.Ls83xOXcKIW7FUcavr8_sOs37I18VGFWYNW3sNFRS24";
    const BOOK_ID = ""; // 無 ?book= 時可填固定 id
    const SB = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <!-- 外掛：不注入 CSS，含 mounted 事件 -->
  <script src="book-flip.js"></script>
  <!-- 應用層（沿用你現有的 app.js；無需改動） -->
  <script src="app.js"></script>
<script>
(function () {
  // 這裡改成你「書單頁」的固定網址做保底，例如：/books 或 /library
  const FALLBACK_URL = 'story';

  const btn = document.getElementById('btnBack');
  if (!btn) return;

  btn.addEventListener('click', function (e) {
    e.preventDefault();

    // 情況 1：有可回的歷史紀錄（通常 history.length > 1）
    if (window.history.length > 1) {
      const before = document.referrer;
      window.history.back();

      // 保底：有些環境 back 可能無效（或回到同頁），0.4 秒後檢查
      setTimeout(function () {
        // 若無 referrer（或 referrer 與當前相同），直接去 FALLBACK
        if (!before || before === location.href) {
          window.location.assign(FALLBACK_URL);
        }
      }, 400);
      return;
    }

    // 情況 2：沒有 history，但有 referrer（可能跨網域）
    if (document.referrer) {
      window.location.href = document.referrer;
      return;
    }

    // 情況 3：兩者都沒有 → 走保底固定頁
    window.location.assign(FALLBACK_URL);
  });
})();
</script>
<script>
(function () {
  // 取得左右大按鈕
  const btnLeft  = document.getElementById('btnleft');
  const btnRight = document.getElementById('btnright');

  if (!btnLeft || !btnRight) return;

  // 判斷目前是否為 LTR（你的 <body> 會有 class="mode-ltr" 或 "mode-rtl"）
  function isLTR() {
    return document.body.classList.contains('mode-ltr');
  }

  // 把鍵盤事件轉成點擊（避免重複觸發用 e.repeat 過濾）
  document.addEventListener('keydown', function (e) {
    // 在輸入欄位編輯時不攔截
    const tag = (e.target && e.target.tagName) || '';
    if (e.target && (e.target.isContentEditable ||
        tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT')) {
      return;
    }
    if (e.repeat) return;

    // LTR：←=上一頁(左鍵)  →=下一頁(右鍵)
    // RTL：←=下一頁(右鍵)  →=上一頁(左鍵)
    const ltr = isLTR();

    switch (e.key) {
      case 'ArrowLeft':
        (ltr ? btnLeft : btnRight).click();
        e.preventDefault();
        break;
      case 'ArrowRight':
        (ltr ? btnRight : btnLeft).click();
        e.preventDefault();
        break;
      // 方便一點：空白鍵=下一頁、Backspace=上一頁
      case ' ':
        (ltr ? btnRight : btnLeft).click();
        e.preventDefault();
        break;
      case 'Backspace':
        (ltr ? btnLeft : btnRight).click();
        e.preventDefault();
        break;
    }
  });
})();
</script>
<script>
(function () {
  // ====== 偵測裝置：手機 / 桌機 ======
  function isMobileLike() {
    return window.matchMedia('(pointer: coarse)').matches ||
           /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);
  }

  // ====== 生成並顯示提示彈窗（沿用你現成的 modal 樣式） ======
  function showTipModal() {
    const mobile = isMobileLike();
    const html = `
      <div class="modal-overlay show" id="tipModal" aria-hidden="false">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="tipTitle">
          <div class="modal-header" id="tipTitle">閱讀提示</div>
          <div class="modal-body">
            <p style="margin:.4em 0">
              ${mobile
                ? '📱 <b>手機版</b>：請「手勢滑動」翻頁（左右滑）'
                : '💻 <b>電腦版</b>：請用「左右方向鍵」或「點書本左右區塊」翻頁。'}
            </p>
            <div style="display:flex; gap:.5rem; margin-top:10px; justify-content:flex-end">
<button id="tipClose" class="btn" style="    background: #ffffff00;    color: #FFF;    border: 2px solid #1eb5e5;">我知道了</button>

              <button id="tipNever" class="btn ghost" style="    background: #ffffff00;    color: #FFF;    border: 2px solid #9ab5be;">不再提醒</button>
            </div>
          </div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', html);

    const $ = (s, r=document)=>r.querySelector(s);
    $('#tipClose')?.addEventListener('click', () => {
      $('#tipModal')?.remove();
    });
    $('#tipNever')?.addEventListener('click', () => {
      localStorage.setItem('reader_tip_seen_v1', '1');
      $('#tipModal')?.remove();
    });
    // 點背景關閉
    $('#tipModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'tipModal') e.currentTarget.remove();
    });
  }

  // ====== 確保「單頁模式」（手機才做） ======
  function ensureSinglePageWhenReady() {
    if (!isMobileLike()) return;

    // 已是單頁就不處理（單頁容器會有 .single-stage）
    function ensureOnce() {
      const isSingle = !!document.querySelector('.single-stage');
      if (isSingle) return true;

      const toggleBtn = document.getElementById('btnToggleView');
      if (!toggleBtn) return false;

      // 還是雙頁 → 點一次切到單頁
      toggleBtn.click();
      return !!document.querySelector('.single-stage');
    }

    // 嘗試立即切
    if (ensureOnce()) return;

    // 若尚未掛載翻頁 DOM，掛個觀察器等它出現再切
    const host = document.getElementById('bookCanvas') || document.body;
    const mo = new MutationObserver(() => {
      if (ensureOnce()) mo.disconnect();
    });
    mo.observe(host, { childList: true, subtree: true });

    // 最後保險：2 秒後再試一次（避免極端情境漏掉）
    setTimeout(ensureOnce, 2000);
  }

  // ====== 執行：第一次進站顯示提示、手機切單頁 ======
  window.addEventListener('load', () => {
    if (!localStorage.getItem('reader_tip_seen_v1')) {
      showTipModal();
    }
    ensureSinglePageWhenReady();
  });
})();
</script>


</body>
</html>
