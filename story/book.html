<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>è¬çˆ¾å¤ï½œé›»å­æ›¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- å­—é«” -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
/* ========== Reset / Base ========== */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:#e6ebff;
  font-family:'Noto Sans TC',system-ui,-apple-system,Segoe UI,sans-serif;
  background:#000 url('https://shierusha.github.io/school-battle/teachers/img/8.webp') center top / cover no-repeat fixed;
}
/* éš±è—æ»¾å‹•æ¢ä½†ä¿ç•™æ»¾å‹• */
html, body { overflow-y: auto; }
body { -ms-overflow-style: none; scrollbar-width: none; }
body::-webkit-scrollbar { width:0; height:0; }


#btnTOC{
    background: #b36969;
    border: 1px solid #3a4a78;
    color: #fff;}
 #btnBack{
    background: #b36969;
    border: 1px solid #3a4a78;
    color: #fff;}
#btnToggleView{
    background: #b36969;
    border: 1px solid #3a4a78;
    color: #fff;}

/* ========== App Bar ========== */
.appbar {
    position: fixed;
    top: 0;
    z-index: 100;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    background: rgba(15, 27, 51, .85);
    border-bottom: 1px solid #223057;
    height: 45px; 
    width: 100vw;
}
.brand{display:flex;gap:.6rem;align-items:center;font-weight:700}
#bookTitle{outline:none}
#bookTitle[contenteditable="true"]{border-bottom:1px dashed #8aa1ff}
.tools{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

/* ========== èˆå°å€ ========== */
.stage{
  position: absolute;
  left: 50%;
  top: 60px;
  transform: translateX(-50%);
  width: 80%;
  max-width: 1100px;
  height: 94vh;
}
.scaler{ position:relative; width:100%; }

/* ========== æŒ‰éˆ•ï¼ˆä¿ç•™ä½ çš„ï¼‰ ========== */
.btn{padding:2px 10px; border-radius:10px; cursor:pointer }
.btn.primary{ background:#6f82ff; border-color:#6f82ff }
.btn.danger{ background:#2a0f18; border-color:#6b1b2e; color:#ffb3c2 }
.btn.ghost{border-color:#ffffff33 }
.side{ position:fixed;  display:flex; gap:8px; z-index:90 }
.side.left{     left: 10px;   top: 50px; }
.side.right{ right:10px; top: 50px; }
.dock{ position:fixed; left:0; right:0; bottom:1%; display:flex; gap:10px; justify-content:center; z-index:90;    top: 75px;    bottom: 35px; }

/* ========== æ–‡å­—æ–¹å‘ï¼ˆå¤–è§€ï¼‰ ========== */
.mode-ltr .page{ writing-mode: horizontal-tb; }
.mode-rtl .page{ writing-mode: vertical-rl; text-orientation: upright; letter-spacing: 0.1em; }
.mode-ltr .single-page{ writing-mode: horizontal-tb; }
.mode-rtl .single-page{ writing-mode: vertical-rl; text-orientation: upright; letter-spacing: 0.1em; }

/* ===== BookFlip å¿…è¦ CSSï¼ˆè«‹å‹¿ç§»é™¤ï¼‰ ===== */
.book, .book * { user-select:none; -webkit-user-select:none; }
.book { position:absolute; top:0; color:black; }
.paper {
  width:100%; height:100%;
  position:absolute; top:0; left:0;
  transform-style:preserve-3d;
  background:#FFF;
  border: 1px solid #555;
}
.page {
  width:100%; height:100%;
  position:absolute; top:0; left:0;
  display:flex;
  backface-visibility:hidden; -webkit-backface-visibility:hidden;
  padding: calc(20px * var(--scale, 1));
}
.back { transform: rotateY(180deg); }
.paper.dir-ltr { transform-origin: left center; }
.paper.dir-rtl { transform-origin: right center; }

.single-stage { width:100%; height:100%; position:relative; overflow:hidden; }
.single-page  { width:100%; height:100%; position:absolute; top:0; left:0; display:flex; will-change:transform; background:#FFF; padding: calc(20px * var(--scale, 1)); }

/* å­—ç´šæ¯”ä¾‹ï¼ˆæ–¹æ¡ˆ2ï¼‰ */
.book-scope { font-size: calc(16px * var(--scale, 1)); }

/* ========== ç« ç¯€è§’æ¨™ï¼‹é ç¢¼ ========== */
.page-meta { position: absolute; pointer-events: none; font-size: .7em; opacity: .7;}
.meta-chapter { max-width: 45%; }
.meta-tl { top: 5px;  left: 2px; }
.meta-tr { top: 5px;  right: 2px; }
.meta-bl { bottom: 5px; left: 6px; }
.meta-br { bottom: 5px; right: 6px; }

/* è®“é ç¢¼æ°¸é æ°´å¹³æ›¸å¯«ï¼ˆå–®é /é›™é éƒ½é©ç”¨ï¼‰ */
.page .meta-page,
.single-page .meta-page {
  writing-mode: horizontal-tb !important;
  text-orientation: mixed !important; /* ç¢ºä¿æ•¸å­—ä¸æ˜¯ç›´ç«‹é¡¯ç¤º */
  letter-spacing: 0 !important;       /* é¿å…ç¹¼æ‰¿å‚ç›´æ¨¡å¼çš„å­—è· */
  text-combine-upright: none !important;
}


/* ========== å››ç¨®é å‹ï¼ˆåº•ç·šç‰ˆï¼‰ ========== */
.page.page--divider_light,
.single-page.page--divider_light,
.page.page--divider_dark,
.single-page.page--divider_dark {
  display:flex; align-items:center; justify-content:center; text-align:center;
}
/* ä¸é¡¯ç¤ºè§’æ¨™ */
.page--divider_light .page-meta,
.page--divider_dark  .page-meta,
.page--illustration  .page-meta { display:none !important; }
/* é…è‰² */
.page.page--divider_light, .single-page.page--divider_light { background:#fff; color:#000; }
.page.page--divider_dark,  .single-page.page--divider_dark  { background:#555; color:#fff; }
/* åœ–ç‰‡æ»¿ç‰ˆ */
.page.page--illustration, .single-page.page--illustration {
  background-size: cover; background-position: center; background-repeat: no-repeat; padding:0 !important;
}

/* ========== TOC Modalï¼ˆè‡ªé©æ‡‰é«˜åº¦ï¼‰ ========== */
.modal-overlay { position: fixed; inset: 0; z-index: 2000; display: none; align-items: center; justify-content: center; animation: modal-fadein-bg 0.25s; background: rgba(0,0,0,0.45); }
.modal-overlay.show { display: flex; }
@keyframes modal-fadein-bg { from { background: rgba(0,0,0,0);} to { background: rgba(0,0,0,0.45);} }
.modal-content { background: rgb(13 27 77 / 82%); border-radius: 18px; border: 2px solid #1eb5e5; box-shadow: 0 0 16px 2px #62f1fe88, 0 8px 32px #1eb5e5aa; width: 500px; max-width: 93vw; height: auto; max-height: 80vh; display: flex; flex-direction: column; overflow: hidden; animation: modal-pop 0.32s cubic-bezier(.42,1.4,.51,1.01); }
@keyframes modal-pop { from { opacity: 0; transform: scale(0.92);} to { opacity: 1; transform: scale(1);} }
.modal-header { background: none; padding: 15px 20px 0px 24px; color: #fff; font-size: 1.5em; font-weight: bold; letter-spacing: 1px; text-shadow: 0 1px 4px #000a; }
.modal-header::after { content: ""; display: block; height: 5px; width: 70%; margin: 0.5rem 0 0 0; border-radius: 2px; background: linear-gradient(to right, #53e2ff99 65%, #53e2ff00 100%); pointer-events: none; }
.modal-body { color: #fff; padding: 12px 24px 16px 24px; font-size: 1.05em; line-height: 1.55; text-shadow: 0 1px 4px #0008; overflow-y: auto; word-break: break-word; white-space: normal; max-height: 64vh; scrollbar-width: none; -ms-overflow-style: none; }
.modal-body::-webkit-scrollbar { display: none; }
.toc-row { display: grid; grid-template-columns: 1fr auto; gap: 8px; padding: 6px 0; border-bottom: 1px dashed #53e2ff33; cursor: pointer; }
.toc-row:hover { background: #0d1b4d66; }
.toc-row .toc-title { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.toc-row .toc-page  { opacity: .9; }

/* 650px ä»¥ä¸‹æ›ç‰ˆå‹  */
@media (max-width: 650px) {
  #bookTitle { width: 10em; }
  .appbar    { height: 65px; }
  .tools     { gap: 1px; flex-direction: column-reverse; }
  .stage     { top: 85px;  }
  .side.right{ bottom: 10px; left: 50%; transform: translateX(-50%); right: 0; top: auto; justify-content:center; width: 100%; }
  .side.left { top: 65px; }
.dock{top: 99%;    bottom: 1%; }
.stage{height: 70vh;}
}

/* ========== Reader æ¨¡å¼ï¼ˆåªä¿ç•™ TOCã€ä¸Šä¸€é ã€ä¸‹ä¸€é ã€å–®/é›™é åˆ‡æ›ï¼‰ ========== */
.reader .side.left .btn:not(#btnTOC) { display:none !important; }
.reader .side.right .btn:not(#btnToggleView) { display:none !important; }
.reader .dock:first-of-type .btn:not(#btnleft):not(#btnright) { display:none !important; }
/* ç¬¬äºŒæ’æ¨£å¼åˆ‡æ› Dock ç›´æ¥æ•´æ’éš±è— */
.reader .dock + .dock { display:none !important; }
/* ï¼ˆå¯é¸ï¼‰å¦‚æœé–±è®€å™¨ä¸éœ€è¦å³ä¸Šè§’å„²å­˜/å›æ›¸å–®ï¼Œå–æ¶ˆä¸‹é¢å…©è¡Œè¨»è§£ */
/* .reader #btnSave { display:none !important; } */
/* .reader #btnBack { display:none !important; } */
  </style>
</head>

<!-- â˜…â˜…â˜… é€™è£¡å¤šåŠ äº† class="reader" â˜…â˜…â˜… -->
<body class="mode-ltr reader">
  <!-- ä¸Šæ–¹å°è¦½ -->
  <div class="appbar">
    <div class="brand">æ›¸å:<span id="bookTitle">æœªå‘½åæ›¸ç±</span></div>
    <div class="tools">
      <div>
        <span>é é¢æ•¸ï¼š</span><b id="lblCount">0</b>
        <span style="width:5px"></span>
      </div>
      <div>
        <button class="btn" id="btnBack">å›ä¼‘æ¯å®¤</button>
      </div>
    </div>
  </div>

  <!-- å·¦å´å·¥å…·åˆ—ï¼ˆé–±è®€å™¨ä¿ç•™ TOCï¼‰ -->
  <div class="side left">
    <button class="btn ghost" id="btnTOC">ç›®éŒ„</button>
    <button class="btn ghost" id="btnFontUp">A+</button>
    <button class="btn ghost" id="btnFontDown">A-</button>
    <button class="btn ghost" id="btnBold"><b>B</b></button>
    <button class="btn ghost" id="btnItalic"><i>I</i></button>
    <button class="btn ghost" id="btnUnderline"><u>U</u></button>
  </div>

  <!-- å³å´å·¥å…·åˆ—ï¼ˆé–±è®€å™¨ä¿ç•™å–®/é›™é åˆ‡æ›ï¼‰ -->
  <div class="side right">
    <button class="btn ghost" id="btnToggleDir">æ–‡å­—æ–¹å‘</button>
    <button class="btn ghost" id="btnToggleBind">é•·/çŸ­é‚Š</button>
    <button class="btn ghost" id="btnToggleView">å–®/é›™é </button>
  </div>

  <!-- ä¸­å¤®èˆå° -->
  <div class="stage">
    <div class="scaler" id="scaler">
      <div class="book" id="bookCanvas">
        <!-- âœ… å°é¢ä¿ç•™ï¼ˆæ’ä»¶ä¸è¦†è“‹ï¼‰ -->
        <div class="paper">
          <div class="page front">é¦–é </div>
          <div class="page back"></div>
        </div>
        <!-- æ­£æ–‡ç”± JS è¿½åŠ  -->
      </div>
    </div>
  </div>


<div class="dock" >


    <button class="btn ghost" id="btnleft" 
style="
    width: 45%;
    background: #00000000;
    border: 0;
    padding: 0;
    cursor: pointer;
    height: 100%;
"
></button>


    <button class="btn ghost" id="btnright" 
style="
    width: 45%;
    background: #160a0a00;
    border: 0;
    padding: 0;
    cursor: pointer;
    height: 100%;
"
></button>


  </div> 






  <div class="dock">
    <button class="btn" data-style="novel">ä¸€èˆ¬æ–‡æœ¬</button>
    <button class="btn" data-style="divider-light">ç™½ç½®ä¸­</button>
    <button class="btn" data-style="divider-dark">é»‘ç½®ä¸­</button>
    <button class="btn" data-style="illustration">åœ–ç‰‡é </button>
  </div>

  <!-- TOC Modal -->
  <div id="tocModal" class="modal-overlay" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="tocTitle">
      <div class="modal-header" id="tocTitle">ç›®éŒ„</div>
      <div class="modal-body" id="tocBody"></div>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://ogzpfrkwnqqaitytncla.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9nenBmcmt3bnFxYWl0eXRuY2xhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxODQzNzEsImV4cCI6MjA3MDc2MDM3MX0.Ls83xOXcKIW7FUcavr8_sOs37I18VGFWYNW3sNFRS24";
    const BOOK_ID = ""; // ç„¡ ?book= æ™‚å¯å¡«å›ºå®š id
    const SB = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <!-- å¤–æ›ï¼šä¸æ³¨å…¥ CSSï¼Œå« mounted äº‹ä»¶ -->
  <script src="book-flip.js"></script>
  <!-- æ‡‰ç”¨å±¤ï¼ˆæ²¿ç”¨ä½ ç¾æœ‰çš„ app.jsï¼›ç„¡éœ€æ”¹å‹•ï¼‰ -->
  <script src="app.js"></script>
<script>
(function () {
  // é€™è£¡æ”¹æˆä½ ã€Œæ›¸å–®é ã€çš„å›ºå®šç¶²å€åšä¿åº•ï¼Œä¾‹å¦‚ï¼š/books æˆ– /library
  const FALLBACK_URL = 'story';

  const btn = document.getElementById('btnBack');
  if (!btn) return;

  btn.addEventListener('click', function (e) {
    e.preventDefault();

    // æƒ…æ³ 1ï¼šæœ‰å¯å›çš„æ­·å²ç´€éŒ„ï¼ˆé€šå¸¸ history.length > 1ï¼‰
    if (window.history.length > 1) {
      const before = document.referrer;
      window.history.back();

      // ä¿åº•ï¼šæœ‰äº›ç’°å¢ƒ back å¯èƒ½ç„¡æ•ˆï¼ˆæˆ–å›åˆ°åŒé ï¼‰ï¼Œ0.4 ç§’å¾Œæª¢æŸ¥
      setTimeout(function () {
        // è‹¥ç„¡ referrerï¼ˆæˆ– referrer èˆ‡ç•¶å‰ç›¸åŒï¼‰ï¼Œç›´æ¥å» FALLBACK
        if (!before || before === location.href) {
          window.location.assign(FALLBACK_URL);
        }
      }, 400);
      return;
    }

    // æƒ…æ³ 2ï¼šæ²’æœ‰ historyï¼Œä½†æœ‰ referrerï¼ˆå¯èƒ½è·¨ç¶²åŸŸï¼‰
    if (document.referrer) {
      window.location.href = document.referrer;
      return;
    }

    // æƒ…æ³ 3ï¼šå…©è€…éƒ½æ²’æœ‰ â†’ èµ°ä¿åº•å›ºå®šé 
    window.location.assign(FALLBACK_URL);
  });
})();
</script>
<script>
(function () {
  // å–å¾—å·¦å³å¤§æŒ‰éˆ•
  const btnLeft  = document.getElementById('btnleft');
  const btnRight = document.getElementById('btnright');

  if (!btnLeft || !btnRight) return;

  // åˆ¤æ–·ç›®å‰æ˜¯å¦ç‚º LTRï¼ˆä½ çš„ <body> æœƒæœ‰ class="mode-ltr" æˆ– "mode-rtl"ï¼‰
  function isLTR() {
    return document.body.classList.contains('mode-ltr');
  }

  // æŠŠéµç›¤äº‹ä»¶è½‰æˆé»æ“Šï¼ˆé¿å…é‡è¤‡è§¸ç™¼ç”¨ e.repeat éæ¿¾ï¼‰
  document.addEventListener('keydown', function (e) {
    // åœ¨è¼¸å…¥æ¬„ä½ç·¨è¼¯æ™‚ä¸æ””æˆª
    const tag = (e.target && e.target.tagName) || '';
    if (e.target && (e.target.isContentEditable ||
        tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT')) {
      return;
    }
    if (e.repeat) return;

    // LTRï¼šâ†=ä¸Šä¸€é (å·¦éµ)  â†’=ä¸‹ä¸€é (å³éµ)
    // RTLï¼šâ†=ä¸‹ä¸€é (å³éµ)  â†’=ä¸Šä¸€é (å·¦éµ)
    const ltr = isLTR();

    switch (e.key) {
      case 'ArrowLeft':
        (ltr ? btnLeft : btnRight).click();
        e.preventDefault();
        break;
      case 'ArrowRight':
        (ltr ? btnRight : btnLeft).click();
        e.preventDefault();
        break;
      // æ–¹ä¾¿ä¸€é»ï¼šç©ºç™½éµ=ä¸‹ä¸€é ã€Backspace=ä¸Šä¸€é 
      case ' ':
        (ltr ? btnRight : btnLeft).click();
        e.preventDefault();
        break;
      case 'Backspace':
        (ltr ? btnLeft : btnRight).click();
        e.preventDefault();
        break;
    }
  });
})();
</script>
<script>
(function () {
  // ====== åµæ¸¬è£ç½®ï¼šæ‰‹æ©Ÿ / æ¡Œæ©Ÿ ======
  function isMobileLike() {
    return window.matchMedia('(pointer: coarse)').matches ||
           /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);
  }

  // ====== ç”Ÿæˆä¸¦é¡¯ç¤ºæç¤ºå½ˆçª—ï¼ˆæ²¿ç”¨ä½ ç¾æˆçš„ modal æ¨£å¼ï¼‰ ======
  function showTipModal() {
    const mobile = isMobileLike();
    const html = `
      <div class="modal-overlay show" id="tipModal" aria-hidden="false">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="tipTitle">
          <div class="modal-header" id="tipTitle">é–±è®€æç¤º</div>
          <div class="modal-body">
            <p style="margin:.4em 0">
              ${mobile
                ? 'ğŸ“± <b>æ‰‹æ©Ÿç‰ˆ</b>ï¼šè«‹ã€Œæ‰‹å‹¢æ»‘å‹•ã€ç¿»é ï¼ˆå·¦å³æ»‘ï¼‰'
                : 'ğŸ’» <b>é›»è…¦ç‰ˆ</b>ï¼šè«‹ç”¨ã€Œå·¦å³æ–¹å‘éµã€æˆ–ã€Œé»æ›¸æœ¬å·¦å³å€å¡Šã€ç¿»é ã€‚'}
            </p>
            <div style="display:flex; gap:.5rem; margin-top:10px; justify-content:flex-end">
<button id="tipClose" class="btn" style="    background: #ffffff00;    color: #FFF;    border: 2px solid #1eb5e5;">æˆ‘çŸ¥é“äº†</button>

              <button id="tipNever" class="btn ghost" style="    background: #ffffff00;    color: #FFF;    border: 2px solid #9ab5be;">ä¸å†æé†’</button>
            </div>
          </div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', html);

    const $ = (s, r=document)=>r.querySelector(s);
    $('#tipClose')?.addEventListener('click', () => {
      $('#tipModal')?.remove();
    });
    $('#tipNever')?.addEventListener('click', () => {
      localStorage.setItem('reader_tip_seen_v1', '1');
      $('#tipModal')?.remove();
    });
    // é»èƒŒæ™¯é—œé–‰
    $('#tipModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'tipModal') e.currentTarget.remove();
    });
  }

  // ====== ç¢ºä¿ã€Œå–®é æ¨¡å¼ã€ï¼ˆæ‰‹æ©Ÿæ‰åšï¼‰ ======
  function ensureSinglePageWhenReady() {
    if (!isMobileLike()) return;

    // å·²æ˜¯å–®é å°±ä¸è™•ç†ï¼ˆå–®é å®¹å™¨æœƒæœ‰ .single-stageï¼‰
    function ensureOnce() {
      const isSingle = !!document.querySelector('.single-stage');
      if (isSingle) return true;

      const toggleBtn = document.getElementById('btnToggleView');
      if (!toggleBtn) return false;

      // é‚„æ˜¯é›™é  â†’ é»ä¸€æ¬¡åˆ‡åˆ°å–®é 
      toggleBtn.click();
      return !!document.querySelector('.single-stage');
    }

    // å˜—è©¦ç«‹å³åˆ‡
    if (ensureOnce()) return;

    // è‹¥å°šæœªæ›è¼‰ç¿»é  DOMï¼Œæ›å€‹è§€å¯Ÿå™¨ç­‰å®ƒå‡ºç¾å†åˆ‡
    const host = document.getElementById('bookCanvas') || document.body;
    const mo = new MutationObserver(() => {
      if (ensureOnce()) mo.disconnect();
    });
    mo.observe(host, { childList: true, subtree: true });

    // æœ€å¾Œä¿éšªï¼š2 ç§’å¾Œå†è©¦ä¸€æ¬¡ï¼ˆé¿å…æ¥µç«¯æƒ…å¢ƒæ¼æ‰ï¼‰
    setTimeout(ensureOnce, 2000);
  }

  // ====== åŸ·è¡Œï¼šç¬¬ä¸€æ¬¡é€²ç«™é¡¯ç¤ºæç¤ºã€æ‰‹æ©Ÿåˆ‡å–®é  ======
  window.addEventListener('load', () => {
    if (!localStorage.getItem('reader_tip_seen_v1')) {
      showTipModal();
    }
    ensureSinglePageWhenReady();
  });
})();
</script>


</body>
</html>
