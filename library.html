<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>åœ–æ›¸é¤¨ï½œå¤šå°ˆæ¡ˆå¯«æ›¸æ¸¬è©¦</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; background: #f4f7fa; padding: 2rem;}
    .main { max-width: 600px; margin: 2em auto; background: #fff; border-radius: 1.2em; box-shadow: 0 2px 16px #0001; padding: 2em;}
    .btn { background: #1767a0; color: #fff; border: none; border-radius: .5em; padding: .5em 1.2em; margin: 1em 0;}
    .book-list { margin-top: 2em; }
    .book-item { padding: .9em 0; border-bottom: 1px solid #eee; }
  </style>
</head>
<body>
  <div class="main" id="main"><div>è¼‰å…¥ä¸­â€¦</div></div>
<script>
// === A å°ˆæ¡ˆï¼ˆè§’è‰²/ç©å®¶è³‡è¨Šï¼‰===
const A = window.supabase.createClient(
  'https://wfhwhvodgikpducrhgda.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmaHdodm9kZ2lrcGR1Y3JoZ2RhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwMTAwNjEsImV4cCI6MjA2MzU4NjA2MX0.P6P-x4SxjiR4VdWH6VFgY_ktgMac_OzuI4Bl7HWskz8'
);
// === B å°ˆæ¡ˆï¼ˆåœ–æ›¸é¤¨æ›¸ç±å¯«å…¥ï¼‰===
const B = window.supabase.createClient(
  'https://ogzpfrkwnqqaitytncla.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9nenBmcmt3bnFxYWl0eXRuY2xhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxODQzNzEsImV4cCI6MjA3MDc2MDM3MX0.Ls83xOXcKIW7FUcavr8_sOs37I18VGFWYNW3sNFRS24'
);

(async function() {
  const main = document.getElementById('main');
  // 1. å–å¾—ç™»å…¥è€…ï¼ˆéŠå®¢ä¹Ÿå¯é€²å…¥ï¼Œä¸å¼·åˆ¶ï¼‰
  let loginUser = null;
  try {
    const { data: { user } } = await A.auth.getUser();
    loginUser = user || null;
  } catch (e) {
    loginUser = null;
  }

  // 2. å–å¾— URL åƒæ•¸
  const params = new URLSearchParams(window.location.search);
  const student_name = params.get('student_name');
  if(!student_name){
    main.innerHTML = "<div>ç¼ºå°‘è§’è‰²è³‡è¨Šï¼è«‹å¾å­¸ç”Ÿè­‰é é€²å…¥ã€‚</div>";
    return;
  }

  // 3. æŸ¥è§’è‰²è³‡è¨Šï¼ˆç”¨ student_nameï¼ŒæŸ¥ä¸åˆ°å°±ç›´æ¥é¡¯ç¤ºæ‰¾ä¸åˆ°ï¼‰
  let { data: student } = await A
    .from('students')
    .select('student_id, player_id, name')
    .eq('name', student_name)
    .single();

  if(!student){
    main.innerHTML = `<div>æŸ¥ç„¡è§’è‰²ã€${student_name}ã€‘</div>`;
    return;
  }

  // 4. æŸ¥åœ–æ›¸é¤¨çš„é€™å€‹è§’è‰²æ‰€æœ‰æ›¸æœ¬
  let { data: books } = await B
    .from('books')
    .select('id, title, updated_at, owner_id')
    .eq('student_id', student.student_id)
    .order('updated_at', { ascending: false });

  // 5. æ¬Šé™åˆ¤æ–·ï¼šåªæœ‰ç™»å…¥è€…ä¸”æœ¬äººæ‰èƒ½å‰µä½œï¼Œå…¶ä»–åªèƒ½çœ‹
  let canEdit = !!loginUser && student.player_id === loginUser.id;

  // 6. é¡¯ç¤ºé é¢
  main.innerHTML = `
    <h2>ã€${student.name || "æœªçŸ¥è§’è‰²"}ã€‘çš„æ•…äº‹é›†</h2>
    <div style="color:#888;">${canEdit ? "ä½ å¯ä»¥ç‚ºæ­¤è§’è‰²å‰µä½œæ–°æ›¸" : "ä½ åªèƒ½é–±è®€ï¼Œç„¡æ³•å‰µå»ºæ–°æ›¸"}</div>
    ${canEdit ? '<button class="btn" id="btnNewBook">ï¼‹æ–°å¢æ›¸ç±</button>' : ''}
    <div class="book-list">${books && books.length ? books.map(b=>`
      <div class="book-item">ğŸ“— <b>${b.title}</b> <span style="color:#aaa;font-size:.95em;">(${b.updated_at?.slice(0,10)||""})</span></div>
    `).join('') : '<div style="color:#aaa;">ç›®å‰æ²’æœ‰æ›¸ç±ã€‚</div>'}</div>
  `;

  // 7. æ–°å¢æ›¸æœ¬åŠŸèƒ½
  if(canEdit){
    document.getElementById('btnNewBook').onclick = async ()=>{
      const title = prompt("è«‹è¼¸å…¥æ›¸åï¼š", "æˆ‘çš„æ•…äº‹æ›¸");
      if(!title) return;
      let { error } = await B.from('books').insert([{
        owner_id: loginUser.id,
        student_id: student.student_id,
        title,
      }]);
      if(error) return alert('æ–°å¢å¤±æ•—: ' + error.message);
      location.reload();
    }
  }
})();
</script>
</body>
</html>
